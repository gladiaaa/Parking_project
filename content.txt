Directory structure:
â””â”€â”€ gladiaaa-parking_project/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ ARCHITECTURE.md
    â”œâ”€â”€ CONNEXION_BACKEND.md
    â”œâ”€â”€ parking_Postman.json
    â”œâ”€â”€ SETUP.md
    â”œâ”€â”€ .env.exemple
    â”œâ”€â”€ Backend/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ composer.json
    â”‚   â”œâ”€â”€ phpunit.xml.dist
    â”‚   â”œâ”€â”€ public/
    â”‚   â”‚   â””â”€â”€ index.php
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”œâ”€â”€ bootstrap.php
    â”‚   â”‚   â”œâ”€â”€ seed.php
    â”‚   â”‚   â”œâ”€â”€ Controller/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Auth2FAController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ AuthController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ MeController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ OwnerParkingController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ ParkingController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ ReservationController.php
    â”‚   â”‚   â”‚   â””â”€â”€ SubscriptionController.php
    â”‚   â”‚   â”œâ”€â”€ Domain/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Entity/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ parking.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Reservation.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Stationnement.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Subscription.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ User.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ Repository/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ParkingRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ReservationRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StationnementRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SubscriptionRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserRepository.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Exception/
    â”‚   â”‚   â”‚   â”‚       â””â”€â”€ DomainException.php
    â”‚   â”‚   â”‚   â””â”€â”€ Service/
    â”‚   â”‚   â”‚       â””â”€â”€ SubscriptionSchedule.php
    â”‚   â”‚   â”œâ”€â”€ Infrastructure/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Http/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IsGranted.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Response.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Router.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ Persistence/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PersistenceFactory.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlParkingRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlReservationRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlStationnementRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlSubscriptionRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlUserRepository.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Json/
    â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ JsonReservationRepository.php
    â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ JsonStationnementRepository.php
    â”‚   â”‚   â”‚   â”‚       â””â”€â”€ JsonSubscriptionRepository.php
    â”‚   â”‚   â”‚   â””â”€â”€ Security/
    â”‚   â”‚   â”‚       â”œâ”€â”€ JwtManager.php
    â”‚   â”‚   â”‚       â””â”€â”€ PasswordHasher.php
    â”‚   â”‚   â””â”€â”€ UseCase/
    â”‚   â”‚       â”œâ”€â”€ Auth/
    â”‚   â”‚       â”‚   â”œâ”€â”€ ConfigureTwoFactorMethod.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetCurrentUser.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ LoginUser.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ Mailer.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ RefreshToken.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ RegisterUser.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ SmsSender.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ StartTwoFactor.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ TotpVerifier.php
    â”‚   â”‚       â”‚   â””â”€â”€ VerifyTwoFactor.php
    â”‚   â”‚       â”œâ”€â”€ Billing/
    â”‚   â”‚       â”‚   â””â”€â”€ BillingCalculator.php
    â”‚   â”‚       â”œâ”€â”€ Owner/
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetMonthlyRevenueForOwner.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ ListActiveStationnementsForOwner.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ ListOwnerParkings.php
    â”‚   â”‚       â”‚   â””â”€â”€ ListParkingReservationsForOwner.php
    â”‚   â”‚       â”œâ”€â”€ Parking/
    â”‚   â”‚       â”‚   â”œâ”€â”€ CalculateOccupancy.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ CheckAvailability.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ CreateParking.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetOwnerParkings.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetOwnerStatistics.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetParkingDetails.php
    â”‚   â”‚       â”‚   â””â”€â”€ SearchParkings.php
    â”‚   â”‚       â”œâ”€â”€ Reservation/
    â”‚   â”‚       â”‚   â”œâ”€â”€ CreateReservation.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ EnterReservation.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ ExitReservation.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetInvoiceHtml.php
    â”‚   â”‚       â”‚   â””â”€â”€ GetUserReservations.php
    â”‚   â”‚       â””â”€â”€ Subscription/
    â”‚   â”‚           â””â”€â”€ CreateSubscription.php
    â”‚   â””â”€â”€ tests/
    â”‚       â”œâ”€â”€ Domain/
    â”‚       â”‚   â””â”€â”€ JwtManagerTest.php
    â”‚       â”œâ”€â”€ Infrastructure/
    â”‚       â”‚   â”œâ”€â”€ Persistence/
    â”‚       â”‚   â”‚   â”œâ”€â”€ RepositoryParityTest.php
    â”‚       â”‚   â”‚   â””â”€â”€ Json/
    â”‚       â”‚   â”‚       â”œâ”€â”€ JsonReservationRepositoryTest.php
    â”‚       â”‚   â”‚       â””â”€â”€ JsonStationnementRepositoryTest.php
    â”‚       â”‚   â””â”€â”€ Security/
    â”‚       â”‚       â””â”€â”€ PasswordHasherTest.php
    â”‚       â”œâ”€â”€ Unit/
    â”‚       â”‚   â”œâ”€â”€ BillingCalculatorTest.php
    â”‚       â”‚   â””â”€â”€ CalculateOccupancyTest.php
    â”‚       â””â”€â”€ UseCase/
    â”‚           â”œâ”€â”€ Auth/
    â”‚           â”‚   â”œâ”€â”€ InMemoryUserRepository.php
    â”‚           â”‚   â””â”€â”€ LoginUserTest.php
    â”‚           â””â”€â”€ Reservation/
    â”‚               â”œâ”€â”€ CreateReservationTest.php
    â”‚               â”œâ”€â”€ EnterReservationTest.php
    â”‚               â””â”€â”€ ExitReservationTest.php
    â”œâ”€â”€ frontend/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ AUTHENTIFICATION.md
    â”‚   â”œâ”€â”€ package.json
    â”‚   â”œâ”€â”€ postcss.config.js
    â”‚   â”œâ”€â”€ tailwind.config.js
    â”‚   â”œâ”€â”€ public/
    â”‚   â”‚   â””â”€â”€ index.html
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”œâ”€â”€ App.jsx
    â”‚   â”‚   â”œâ”€â”€ index.css
    â”‚   â”‚   â”œâ”€â”€ index.js
    â”‚   â”‚   â”œâ”€â”€ components/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Footer.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ Header.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ LoadingScreen.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ ParkingCard.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ ProtectedRoute.jsx
    â”‚   â”‚   â”‚   â””â”€â”€ SearchBar.jsx
    â”‚   â”‚   â”œâ”€â”€ pages/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Dashboard.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ Login.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ Maps.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ MesReservations.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ OwnerDashboard.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ ParkingDetails.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ Register.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ Reservation.jsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ Subscription.jsx
    â”‚   â”‚   â”‚   â””â”€â”€ UserDashboard.jsx
    â”‚   â”‚   â”œâ”€â”€ routes/
    â”‚   â”‚   â”‚   â””â”€â”€ index.jsx
    â”‚   â”‚   â”œâ”€â”€ services/
    â”‚   â”‚   â”‚   â””â”€â”€ apiService.js
    â”‚   â”‚   â””â”€â”€ UI/
    â”‚   â”‚       â””â”€â”€ Countup.jsx
    â”‚   â””â”€â”€ tailwind-test/
    â”‚       â”œâ”€â”€ README.md
    â”‚       â”œâ”€â”€ package.json
    â”‚       â”œâ”€â”€ public/
    â”‚       â”‚   â”œâ”€â”€ index.html
    â”‚       â”‚   â”œâ”€â”€ manifest.json
    â”‚       â”‚   â””â”€â”€ robots.txt
    â”‚       â””â”€â”€ src/
    â”‚           â”œâ”€â”€ App.css
    â”‚           â”œâ”€â”€ App.js
    â”‚           â”œâ”€â”€ App.test.js
    â”‚           â”œâ”€â”€ index.css
    â”‚           â”œâ”€â”€ index.js
    â”‚           â”œâ”€â”€ reportWebVitals.js
    â”‚           â””â”€â”€ setupTests.js
    â””â”€â”€ sql/
        â”œâ”€â”€ 001_init_core.sql
        â”œâ”€â”€ 002_insert_parkings.sql
        â”œâ”€â”€ 003_generate_password_hash.php
        â”œâ”€â”€ 004_add_api_token.sql
        â””â”€â”€ sqlite_init.sql



================================================
FILE: README.md
================================================
# ğŸ…¿ï¸ ParkingPartagÃ©

SystÃ¨me de rÃ©servation de parkings en temps rÃ©el - Projet de groupe

## ğŸ¯ Description

Application web moderne permettant de rÃ©server des places de parking dans toute la France. Interface ultra-Ã©purÃ©e et minimaliste inspirÃ©e des grandes marques (Apple, Tesla, Airbnb).

## ğŸ—ï¸ Architecture

```
Parking_project/
â”œâ”€â”€ frontend/          # React + Tailwind CSS
â”œâ”€â”€ Backend/           # API PHP + MySQL
â”œâ”€â”€ sql/               # Scripts de base de donnÃ©es
â””â”€â”€ README.md          # Ce fichier
```

## ğŸš€ Installation rapide

### Frontend

```bash
cd frontend
npm install
npm start
# Ouvre http://localhost:3000
```

### Backend

```bash
# 1. CrÃ©er la base de donnÃ©es
mysql -u root -p < sql/001_init_core.sql
mysql -u root -p < sql/002_insert_parkings.sql

# 2. Configurer .env
cp .env.example .env
# Ã‰diter .env avec vos paramÃ¨tres

# 3. DÃ©marrer le serveur
cd Backend
php -S localhost:8001 -t public
```

## ğŸ“Š Base de donnÃ©es

### Tables principales

- **users** : Utilisateurs (email, password, role, abonnement)
- **parkings** : Parkings (nom, adresse, coordonnÃ©es GPS, tarifs)
- **reservations** : RÃ©servations (dates, montant, statut)
- **stationnements** : Stationnements actifs
- **parking_services** : Services proposÃ©s
- **parking_type_vehicules** : Types de vÃ©hicules acceptÃ©s

### Scripts SQL

1. `sql/001_init_core.sql` - CrÃ©ation des tables
2. `sql/002_insert_parkings.sql` - DonnÃ©es de test

## ğŸ” Comptes de test

**Utilisateur :**
- Email: `user@example.com`
- Password: `password123`

**PropriÃ©taire :**
- Email: `owner@example.com`
- Password: `password123`

## âœ¨ FonctionnalitÃ©s

- âœ… Authentification complÃ¨te (login/register)
- âœ… Recherche de parkings avec filtres avancÃ©s
- âœ… Carte interactive avec tous les parkings
- âœ… SystÃ¨me de rÃ©servation complet
- âœ… Gestion des rÃ©servations
- âœ… EmpÃªchement des rÃ©servations simultanÃ©es
- âœ… Calcul automatique des prix
- âœ… Design ultra-moderne et minimaliste

## ğŸ› ï¸ Technologies

**Frontend :**
- React 18
- Tailwind CSS
- React Router
- Leaflet (cartes)

**Backend :**
- PHP 8.0+
- MySQL 8.0+
- PDO

## ğŸ“ Structure du projet

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/          # Pages principales
â”‚   â”œâ”€â”€ components/      # Composants rÃ©utilisables
â”‚   â”œâ”€â”€ services/        # API service (mock pour l'instant)
â”‚   â””â”€â”€ App.jsx         # Routeur principal

Backend/
â”œâ”€â”€ public/             # Point d'entrÃ©e API
â”œâ”€â”€ src/                # Code source PHP
â””â”€â”€ README.md

sql/
â”œâ”€â”€ 001_init_core.sql   # SchÃ©ma de base de donnÃ©es
â””â”€â”€ 002_insert_parkings.sql  # DonnÃ©es de test
```

## ğŸ‘¥ Pour les membres du groupe

### PremiÃ¨re installation

1. **Cloner le projet**
   ```bash
   git clone [url-du-repo]
   cd Parking_project
   ```

2. **Installer les dÃ©pendances frontend**
   ```bash
   cd frontend
   npm install
   ```

3. **Configurer la base de donnÃ©es**
   ```bash
   mysql -u root -p < sql/001_init_core.sql
   mysql -u root -p < sql/002_insert_parkings.sql
   ```

4. **Configurer l'environnement**
   ```bash
   cp .env.example .env
   # Ã‰diter .env avec vos paramÃ¨tres MySQL
   ```

5. **DÃ©marrer les serveurs**
   ```bash
   # Terminal 1 - Frontend
   cd frontend
   npm start

   # Terminal 2 - Backend
   cd Backend
   php -S localhost:8001 -t public
   ```

### Utilisation quotidienne

- **Frontend** : http://localhost:3000 (ou 4000)
- **Backend API** : http://localhost:8001
- **Health check** : http://localhost:8001/health

## ğŸ“ Notes importantes

- Le frontend utilise actuellement un **mock API** (`apiService.js`)
- Pour connecter le vrai backend, modifier `API_BASE_URL` dans `frontend/src/services/apiService.js`
- Les utilisateurs sont persistÃ©s dans `localStorage` (frontend)
- Les rÃ©servations sont stockÃ©es en mÃ©moire (sera remplacÃ© par la DB)

## ğŸ”„ Prochaines Ã©tapes

1. Connecter le frontend au vrai backend PHP
2. ImplÃ©menter l'authentification JWT
3. Ajouter la gÃ©olocalisation
4. SystÃ¨me de paiement
5. Notifications en temps rÃ©el

## ğŸ“ Support

Pour toute question, consulter :
- `frontend/AUTHENTIFICATION.md` - Documentation authentification
- `Backend/README.md` - Documentation backend
- `sql/001_init_core.sql` - SchÃ©ma de base de donnÃ©es

---

**DÃ©veloppÃ© avec â¤ï¸ pour le projet de groupe**



================================================
FILE: ARCHITECTURE.md
================================================
# ğŸ—ï¸ Architecture du Projet - ParkingPartagÃ©

Documentation complÃ¨te de l'architecture pour le travail en groupe.

## ğŸ“ Vue d'ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â”‚    Frontend     â”‚ â”€â”€â”€â”€â”€â”€> â”‚    Backend      â”‚ â”€â”€â”€â”€â”€â”€> â”‚   MySQL DB      â”‚
â”‚   (React)       â”‚  HTTP   â”‚     (PHP)       â”‚   SQL   â”‚                 â”‚
â”‚   Port 4000     â”‚         â”‚   Port 8001     â”‚         â”‚   Port 3306     â”‚
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flux de donnÃ©es

### 1. Authentification

```
User â†’ Frontend (Login.jsx)
  â†“
apiService.login()
  â†“
Backend POST /api/auth/login
  â†“
MySQL SELECT users WHERE email
  â†“
Retour token + user data
  â†“
localStorage.setItem('token', token)
```

### 2. Recherche de parkings

```
User â†’ Frontend (Reservation.jsx)
  â†“
apiService.searchParkings()
  â†“
Backend GET /api/parkings?ville=Paris
  â†“
MySQL SELECT parkings + calcul places disponibles
  â†“
Retour liste parkings
```

### 3. RÃ©servation

```
User â†’ Frontend (BookingModal)
  â†“
apiService.reserveParking()
  â†“
Backend POST /api/reservations
  â†“
MySQL INSERT reservations + vÃ©rification disponibilitÃ©
  â†“
Retour confirmation
```

## ğŸ“ Structure des fichiers

### Frontend (`frontend/`)

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Home.jsx              # Page d'accueil
â”‚   â”‚   â”œâ”€â”€ Login.jsx              # Connexion
â”‚   â”‚   â”œâ”€â”€ Register.jsx           # Inscription
â”‚   â”‚   â”œâ”€â”€ Reservation.jsx        # Recherche/RÃ©servation
â”‚   â”‚   â”œâ”€â”€ Maps.jsx               # Carte interactive
â”‚   â”‚   â””â”€â”€ MesReservations.jsx    # Gestion rÃ©servations
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Header.jsx             # Navigation
â”‚   â”‚   â”œâ”€â”€ Footer.jsx             # Pied de page
â”‚   â”‚   â””â”€â”€ LoadingScreen.jsx     # Ã‰cran de chargement
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ apiService.js          # âš ï¸ MOCK API (Ã  connecter)
â”‚   â””â”€â”€ App.jsx                    # Routeur principal
â””â”€â”€ package.json
```

### Backend (`Backend/`)

```
Backend/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.php                  # Point d'entrÃ©e API
â”œâ”€â”€ src/
â”‚   â””â”€â”€ bootstrap.php              # Configuration DB + helpers
â””â”€â”€ README.md
```

### Base de donnÃ©es (`sql/`)

```
sql/
â”œâ”€â”€ 001_init_core.sql              # SchÃ©ma complet
â””â”€â”€ 002_insert_parkings.sql        # DonnÃ©es de test
```

## ğŸ—„ï¸ SchÃ©ma de base de donnÃ©es

### Relations principales

```
users (1) â”€â”€â”€â”€< (N) parkings
  â”‚                    â”‚
  â”‚                    â”‚
  â””â”€â”€â”€< (N) reservations >â”€â”€â”€â”˜
              â”‚
              â”‚
              â””â”€â”€â”€< (1) stationnements
```

### Tables dÃ©taillÃ©es

#### `users`
- `id` (PK)
- `email` (UNIQUE)
- `password_hash`
- `firstname`, `lastname`
- `role` (user/owner)
- `type_abonnement` (gratuit/premium/business)

#### `parkings`
- `id` (PK)
- `owner_id` (FK â†’ users)
- `nom`, `adresse`, `ville`
- `latitude`, `longitude`
- `nombre_places`
- `tarif_horaire`, `tarif_journalier`, `tarif_mensuel`
- `note` (rating)

#### `reservations`
- `id` (PK)
- `user_id` (FK â†’ users)
- `parking_id` (FK â†’ parkings)
- `date_debut`, `date_fin`
- `vehicule`, `immatriculation`
- `montant`
- `statut` (confirmÃ©e/annulÃ©e/terminÃ©e)

## ğŸ”Œ API Endpoints

### Actuellement implÃ©mentÃ©s

| MÃ©thode | Route | Description |
|---------|-------|-------------|
| GET | `/health` | Health check |
| GET | `/db/ping` | Test connexion DB |
| GET | `/api/parkings` | Liste tous les parkings |
| GET | `/api/parkings/:id` | DÃ©tails d'un parking |
| POST | `/api/auth/login` | Connexion |
| GET | `/api/users` | Liste utilisateurs (debug) |

### Ã€ implÃ©menter

- `POST /api/auth/register` - Inscription
- `GET /api/auth/profile` - Profil utilisateur
- `GET /api/parkings/search` - Recherche avec filtres
- `POST /api/reservations` - CrÃ©er rÃ©servation
- `GET /api/reservations` - Mes rÃ©servations
- `DELETE /api/reservations/:id` - Annuler rÃ©servation

## ğŸ”„ Ã‰tat actuel

### âœ… Fonctionnel

- **Frontend** : Interface complÃ¨te avec mock API
- **Base de donnÃ©es** : SchÃ©ma complet et logique
- **Backend** : Structure de base avec quelques endpoints

### âš ï¸ Ã€ connecter

Le frontend utilise actuellement `apiService.js` qui simule un backend. Pour connecter au vrai backend :

1. Modifier `API_BASE_URL` dans `apiService.js`
2. Adapter les fonctions pour faire de vrais appels HTTP
3. GÃ©rer les tokens JWT
4. GÃ©rer les erreurs rÃ©seau

## ğŸ” SÃ©curitÃ©

### Actuellement

- Hashage des mots de passe (bcrypt)
- Validation des donnÃ©es cÃ´tÃ© backend
- CORS configurÃ©

### Ã€ amÃ©liorer

- Tokens JWT au lieu de tokens simples
- Validation cÃ´tÃ© frontend
- Rate limiting
- Sanitization des inputs

## ğŸ“ Pour le groupe

### Chaque membre doit comprendre

1. **Frontend** : React + Tailwind, composants rÃ©utilisables
2. **Backend** : PHP simple, PDO pour MySQL
3. **Base de donnÃ©es** : Relations claires, schÃ©ma logique
4. **API** : RESTful, JSON, CORS

### Workflow recommandÃ©

1. **DÃ©veloppement local** : Chacun sur sa machine
2. **Base de donnÃ©es** : SchÃ©ma partagÃ© (mÃªme structure)
3. **Git** : Branches par fonctionnalitÃ©
4. **Tests** : VÃ©rifier avec les comptes de test

### Partage de code

- âœ… **Partager** : Code source, schÃ©ma DB, documentation
- âŒ **Ne pas partager** : `.env`, `node_modules`, fichiers de log

## ğŸš€ Prochaines Ã©tapes

1. Connecter frontend au vrai backend
2. ImplÃ©menter tous les endpoints API
3. Ajouter authentification JWT
4. Tests unitaires
5. DÃ©ploiement

---

**Documentation maintenue pour faciliter le travail en groupe**








================================================
FILE: CONNEXION_BACKEND.md
================================================
# ğŸ”Œ Guide de Connexion Frontend â†” Backend

Comment connecter le frontend React au backend PHP rÃ©el.

## ğŸ“ Ã‰tat actuel

Le frontend utilise actuellement un **mock API** (`apiService.js`) qui simule toutes les fonctionnalitÃ©s en mÃ©moire et localStorage.

## ğŸ¯ Objectif

Remplacer le mock par de vrais appels HTTP vers le backend PHP.

## ğŸ”„ Ã‰tapes de migration

### 1. VÃ©rifier que le backend fonctionne

```bash
# DÃ©marrer le backend
cd Backend
php -S localhost:8001 -t public

# Tester
curl http://localhost:8001/health
# Devrait retourner: {"ok":true,"php":"8.x"}
```

### 2. Modifier `apiService.js`

Le fichier `frontend/src/services/apiService.js` contient dÃ©jÃ  `API_BASE_URL = 'http://localhost:8001/api'`.

**Option A : Migration progressive**

CrÃ©er une fonction helper pour les appels HTTP :

```javascript
const apiCall = async (endpoint, options = {}) => {
  const token = localStorage.getItem('token');
  
  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` }),
      ...options.headers,
    },
  });
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  return response.json();
};
```

**Option B : Remplacer fonction par fonction**

Commencer par `login()` :

```javascript
export const login = async (email, password) => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    
    const data = await response.json();
    
    if (data.success) {
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      return data;
    } else {
      throw new Error(data.error || 'Erreur de connexion');
    }
  } catch (error) {
    throw new Error(error.message || 'Erreur rÃ©seau');
  }
};
```

### 3. Endpoints Ã  implÃ©menter dans le backend

#### Authentification

```php
// POST /api/auth/login
// Body: { "email": "...", "password": "..." }
// Retour: { "success": true, "token": "...", "user": {...} }

// POST /api/auth/register
// Body: { "email": "...", "password": "...", "firstname": "...", "lastname": "...", "role": "user" }
// Retour: { "success": true, "token": "...", "user": {...} }

// GET /api/auth/profile
// Header: Authorization: Bearer {token}
// Retour: { "success": true, "user": {...} }
```

#### Parkings

```php
// GET /api/parkings
// Query: ?ville=Paris&prixMax=50
// Retour: { "success": true, "parkings": [...], "total": 10 }

// GET /api/parkings/:id
// Retour: { "success": true, "parking": {...} }
```

#### RÃ©servations

```php
// POST /api/reservations
// Body: { "parking_id": 1, "date_debut": "...", "date_fin": "...", "vehicule": "..." }
// Retour: { "success": true, "reservation": {...} }

// GET /api/reservations
// Header: Authorization: Bearer {token}
// Retour: { "success": true, "reservations": [...] }

// DELETE /api/reservations/:id
// Header: Authorization: Bearer {token}
// Retour: { "success": true }
```

## ğŸ” Gestion des tokens

### Backend : GÃ©nÃ©rer un token JWT

```php
// Installer: composer require firebase/php-jwt

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

function generateToken($user) {
    $payload = [
        'user_id' => $user['id'],
        'email' => $user['email'],
        'role' => $user['role'],
        'exp' => time() + (60 * 60 * 24) // 24h
    ];
    
    return JWT::encode($payload, env('JWT_SECRET'), 'HS256');
}

function verifyToken($token) {
    try {
        return JWT::decode($token, new Key(env('JWT_SECRET'), 'HS256'));
    } catch (Exception $e) {
        return null;
    }
}
```

### Frontend : Utiliser le token

```javascript
// Dans apiService.js
const getAuthHeaders = () => {
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': `Bearer ${token}` } : {};
};

// Exemple d'appel authentifiÃ©
const getMyReservations = async () => {
  const response = await fetch(`${API_BASE_URL}/reservations`, {
    headers: {
      'Content-Type': 'application/json',
      ...getAuthHeaders(),
    },
  });
  return response.json();
};
```

## ğŸ§ª Tests

### Tester chaque endpoint

```bash
# Login
curl -X POST http://localhost:8001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password123"}'

# Liste parkings
curl http://localhost:8001/api/parkings

# CrÃ©er rÃ©servation (avec token)
curl -X POST http://localhost:8001/api/reservations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"parking_id":1,"date_debut":"2025-01-20 10:00:00","date_fin":"2025-01-20 12:00:00","vehicule":"Voiture"}'
```

## ğŸ“ Checklist de migration

- [ ] Backend dÃ©marrÃ© et accessible
- [ ] Endpoint `/health` fonctionne
- [ ] Endpoint `/api/auth/login` implÃ©mentÃ©
- [ ] Frontend `login()` utilise le vrai backend
- [ ] Token stockÃ© et envoyÃ© dans les headers
- [ ] Endpoint `/api/parkings` implÃ©mentÃ©
- [ ] Frontend `searchParkings()` utilise le vrai backend
- [ ] Endpoint `/api/reservations` implÃ©mentÃ©
- [ ] Frontend `reserveParking()` utilise le vrai backend
- [ ] Gestion des erreurs rÃ©seau
- [ ] Tests de bout en bout

## âš ï¸ Points d'attention

1. **CORS** : Le backend doit autoriser les requÃªtes depuis `http://localhost:4000`
2. **Validation** : Valider toutes les donnÃ©es cÃ´tÃ© backend
3. **Erreurs** : Retourner des messages d'erreur clairs
4. **SÃ©curitÃ©** : Ne jamais exposer les mots de passe en clair
5. **Performance** : Optimiser les requÃªtes SQL (indexes)

## ğŸš€ Exemple complet

### Backend : `Backend/public/index.php`

```php
// POST /api/auth/login
if ($route === 'auth/login' && $method === 'POST') {
    $data = json_decode(file_get_contents('php://input'), true);
    $email = trim(strtolower($data['email'] ?? ''));
    $password = $data['password'] ?? '';
    
    $stmt = pdo()->prepare('SELECT * FROM users WHERE email = ?');
    $stmt->execute([$email]);
    $user = $stmt->fetch();
    
    if ($user && password_verify($password, $user['password_hash'])) {
        $token = generateToken($user);
        
        echo json_encode([
            'success' => true,
            'token' => $token,
            'user' => [
                'id' => $user['id'],
                'email' => $user['email'],
                'firstname' => $user['firstname'],
                'lastname' => $user['lastname'],
                'role' => $user['role']
            ]
        ]);
    } else {
        http_response_code(401);
        echo json_encode(['success' => false, 'error' => 'Email ou mot de passe incorrect']);
    }
    exit;
}
```

### Frontend : `frontend/src/services/apiService.js`

```javascript
export const login = async (email, password) => {
  const response = await fetch(`${API_BASE_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      email: email.trim().toLowerCase(), 
      password 
    }),
  });
  
  const data = await response.json();
  
  if (data.success) {
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user));
    return data;
  }
  
  throw new Error(data.error || 'Erreur de connexion');
};
```

---

**Guide pour connecter progressivement le frontend au backend rÃ©el**








================================================
FILE: parking_Postman.json
================================================
{
  "info": {
    "_postman_id": "e0c08f67-43d8-4d09-8a7a-b305ead55551",
    "name": "Parking Project - Auth & Security Tests",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Login",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"email\": \"test@test.com\",\n    \"password\": \"Test123456789\"\n}"
        },
        "url": {
          "raw": "http://localhost:8001/api/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "login"]
        }
      },
      "response": []
    },

    {
      "name": "Get Me (Authenticated)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status is 200\", function () {",
              "  pm.response.to.have.status(200);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:8001/api/me",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "me"]
        }
      },
      "response": []
    },

    {
      "name": "Get Me (Unauthorized)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:8001/api/me",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "me"]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Force suppression des cookies",
              "pm.cookies.jar().clear(pm.request.url.getHost());"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Unauthorized\", function () {",
              "   pm.response.to.have.status(401);",
              "});"
            ]
          }
        }
      ]
    },

    {
      "name": "Refresh Token",
      "request": {
        "method": "POST",
        "header": [],
        "url": {
          "raw": "http://localhost:8001/api/auth/refresh",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "refresh"]
        }
      },
      "response": []
    },

    {
      "name": "Role Test - Owner Only",
      "request": {
        "method": "GET",
        "url": {
          "raw": "http://localhost:8001/api/owner/dashboard",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "owner", "dashboard"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Forbidden\", function () {",
              "  pm.response.to.have.status(403);",
              "});"
            ]
          }
        }
      ]
    },

    {
      "name": "Start 2FA",
      "request": {
        "method": "POST",
        "url": {
          "raw": "http://localhost:8001/api/auth/2fa/start",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "2fa", "start"]
        }
      }
    },

    {
      "name": "Verify 2FA",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"code\": \"123456\"\n}"
        },
        "url": {
          "raw": "http://localhost:8001/api/auth/2fa/verify",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "2fa", "verify"]
        }
      }
    }
  ]
}



================================================
FILE: SETUP.md
================================================
# ğŸš€ Guide d'Installation - ParkingPartagÃ©

Guide complet pour installer et configurer le projet en groupe.

## ğŸ“‹ PrÃ©requis

- **Node.js** 16+ et npm
- **PHP** 8.0+ avec extensions PDO et MySQL
- **MySQL** 8.0+
- **Git**

## ğŸ”§ Installation Ã©tape par Ã©tape

### 1. Cloner le projet

```bash
git clone [url-du-repo]
cd Parking_project
```

### 2. Configuration de la base de donnÃ©es

```bash
# Se connecter Ã  MySQL
mysql -u root -p

# Ou crÃ©er un utilisateur dÃ©diÃ©
mysql -u root -p
CREATE USER 'parking_user'@'localhost' IDENTIFIED BY 'votre_mot_de_passe';
GRANT ALL PRIVILEGES ON parking_app.* TO 'parking_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# CrÃ©er la base de donnÃ©es et les tables
mysql -u root -p < sql/001_init_core.sql

# InsÃ©rer les donnÃ©es de test
mysql -u root -p < sql/002_insert_parkings.sql
```

### 3. Configuration Backend

```bash
# CrÃ©er le fichier .env Ã  la racine du projet
cat > .env << EOF
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=parking_app
DB_USER=root
DB_PASS=votre_mot_de_passe_mysql
API_BASE_URL=http://localhost:8001/api
FRONTEND_URL=http://localhost:4000
JWT_SECRET=changez-moi-en-production
APP_ENV=development
APP_DEBUG=true
EOF
```

### 4. Installation Frontend

```bash
cd frontend
npm install
```

### 5. DÃ©marrer les serveurs

**Terminal 1 - Backend :**
```bash
cd Backend
php -S localhost:8001 -t public
```

**Terminal 2 - Frontend :**
```bash
cd frontend
PORT=4000 npm start
```

## âœ… VÃ©rification

1. **Backend** : http://localhost:8001/health
   - Devrait retourner : `{"ok":true,"php":"8.x"}`

2. **Base de donnÃ©es** : http://localhost:8001/db/ping
   - Devrait retourner : `{"ok":true,"mysql_version":"8.x"}`

3. **Frontend** : http://localhost:4000
   - Devrait afficher la page d'accueil

## ğŸ” Comptes de test

**Utilisateur :**
- Email: `user@example.com`
- Password: `password123`

**PropriÃ©taire :**
- Email: `owner@example.com`
- Password: `password123`

## ğŸ“Š Structure de la base de donnÃ©es

### Tables crÃ©Ã©es

1. **users** - Utilisateurs (user/owner)
2. **parkings** - Parkings disponibles
3. **parking_services** - Services par parking
4. **parking_type_vehicules** - Types de vÃ©hicules acceptÃ©s
5. **reservations** - RÃ©servations
6. **stationnements** - Stationnements actifs

### Relations

- `users` â†’ `parkings` (owner_id)
- `users` â†’ `reservations` (user_id)
- `parkings` â†’ `reservations` (parking_id)
- `reservations` â†’ `stationnements` (reservation_id)

## ğŸ› DÃ©pannage

### Erreur de connexion MySQL

```bash
# VÃ©rifier que MySQL tourne
sudo service mysql status

# RedÃ©marrer MySQL
sudo service mysql restart
```

### Port dÃ©jÃ  utilisÃ©

```bash
# Changer le port dans .env
DB_PORT=3307

# Ou pour le frontend
PORT=4001 npm start
```

### Erreur "Table doesn't exist"

```bash
# RÃ©exÃ©cuter les scripts SQL
mysql -u root -p < sql/001_init_core.sql
mysql -u root -p < sql/002_insert_parkings.sql
```

## ğŸ“ Notes importantes

- Le frontend utilise actuellement un **mock API** (`apiService.js`)
- Pour connecter au vrai backend, modifier `API_BASE_URL` dans `frontend/src/services/apiService.js`
- Les donnÃ©es sont persistÃ©es dans MySQL (backend) et localStorage (frontend mock)

## ğŸ‘¥ Pour le groupe

Chaque membre doit :
1. Cloner le repo
2. Installer les dÃ©pendances
3. Configurer sa base de donnÃ©es locale
4. CrÃ©er son fichier `.env`
5. DÃ©marrer les serveurs

**Tous les membres partagent le mÃªme schÃ©ma de base de donnÃ©es !**








================================================
FILE: .env.exemple
================================================
# ===========================
#   APP CONFIG
# ===========================
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8001

# ===========================
#   DATABASE CONFIG
# ===========================
DB_DRIVER=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=parking_project
DB_USER=root
DB_PASSWORD=

# Pour SQLite si vous l'utilisez en stockage secondaire
SQLITE_PATH=/path/to/storage/database.sqlite

# ===========================
#   JWT CONFIG
# ===========================
JWT_SECRET=changemeTousDeSuiteParceQueSinonCestLaHonte
JWT_ISSUER=parking-app
JWT_EXPIRES_IN=3600

# ===========================
#   STORAGE CONFIG
# ===========================
STORAGE_PATH=/path/to/storage

# ===========================
#   LOGS
# ===========================
LOG_PATH=/path/to/logs
LOG_LEVEL=debug

# ===========================
#   MAIL (si vous faites 2FA, reset password, etc.)
# ===========================
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=super-secret
MAIL_FROM=your-email@example.com
MAIL_FROM_NAME="Parking App"

# ===========================
#   OPTIONS PARKING
# ===========================
# Tranches durÃ©e tarifaires
PARKING_BILLING_INTERVAL=15
PARKING_PENALITY_AMOUNT=20



================================================
FILE: Backend/README.md
================================================
# ğŸš€ Backend - ParkingPartagÃ©

API REST en PHP pour le systÃ¨me de rÃ©servation de parkings.

## ğŸ“‹ PrÃ©requis

- PHP 8.0+
- MySQL 8.0+
- Composer (optionnel)

## ğŸ› ï¸ Installation

### 1. Configuration de la base de donnÃ©es

```bash
# CrÃ©er la base de donnÃ©es
mysql -u root -p < sql/001_init_core.sql

# InsÃ©rer les donnÃ©es de test
mysql -u root -p < sql/002_insert_parkings.sql
```

### 2. Configuration de l'environnement

```bash
# Copier le fichier .env.example
cp .env.example .env

# Ã‰diter .env avec vos paramÃ¨tres
nano .env
```

### 3. DÃ©marrer le serveur PHP

```bash
# Depuis le dossier Backend
cd Backend
php -S localhost:8001 -t public
```

## ğŸ“Š Structure de la base de donnÃ©es

### Tables principales

- **users** : Utilisateurs (user/owner)
- **parkings** : Parkings disponibles
- **parking_services** : Services proposÃ©s par parking
- **parking_type_vehicules** : Types de vÃ©hicules acceptÃ©s
- **reservations** : RÃ©servations des utilisateurs
- **stationnements** : Stationnements actifs

## ğŸ”Œ Endpoints API

### Authentification
- `POST /api/auth/login` - Connexion
- `POST /api/auth/register` - Inscription
- `GET /api/auth/profile` - Profil utilisateur

### Parkings
- `GET /api/parkings` - Liste des parkings
- `GET /api/parkings/search` - Recherche de parkings
- `GET /api/parkings/:id` - DÃ©tails d'un parking

### RÃ©servations
- `GET /api/reservations` - Mes rÃ©servations
- `POST /api/reservations` - CrÃ©er une rÃ©servation
- `DELETE /api/reservations/:id` - Annuler une rÃ©servation

## ğŸ” SÃ©curitÃ©

- Hashage des mots de passe avec bcrypt
- Tokens JWT pour l'authentification
- Validation des donnÃ©es
- Protection CORS

## ğŸ‘¥ Pour le groupe

1. Cloner le projet
2. Installer MySQL
3. ExÃ©cuter les scripts SQL dans l'ordre
4. Configurer le `.env`
5. DÃ©marrer le serveur PHP

## ğŸ“ Notes

- Le frontend utilise actuellement un mock API (`apiService.js`)
- Pour connecter le vrai backend, modifier `API_BASE_URL` dans `apiService.js`
- Les mots de passe de test : `password123` (hashÃ© avec bcrypt)








================================================
FILE: Backend/composer.json
================================================
{
  "require": {
    "php": "^8.2",
    "firebase/php-jwt": "^6.10",
    "vlucas/phpdotenv": "^5.6"
  },
  "autoload": {
    "psr-4": {
      "App\\": "src/"
    }
  },
  "require-dev": {
    "phpunit/phpunit": "11"
  }
}



================================================
FILE: Backend/phpunit.xml.dist
================================================
<?xml version="1.0" encoding="UTF-8"?>
<phpunit
    bootstrap="vendor/autoload.php"
    colors="true"
>
    <php>
        <env name="APP_ENV" value="test"/>
    </php>

    <testsuites>
        <testsuite name="Parking Test Suite">
            <directory>tests</directory>
        </testsuite>
    </testsuites>

    <source>
        <include>
            <directory suffix=".php">src</directory>
        </include>
    </source>
</phpunit>



================================================
FILE: Backend/public/index.php
================================================
<?php
declare(strict_types=1);

require __DIR__ . '/../src/bootstrap.php';

// bootstrap.php a dÃ©jÃ  appelÃ© cors() + gÃ©rÃ© OPTIONS
// Donc ici on ne refait pas cors/preflight.

$method = $_SERVER['REQUEST_METHOD'] ?? 'GET';
$path   = parse_url($_SERVER['REQUEST_URI'] ?? '/', PHP_URL_PATH) ?: '/';

$router->dispatch($method, $path);



================================================
FILE: Backend/src/bootstrap.php
================================================
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use Dotenv\Dotenv;
use App\Infrastructure\Http\Router;
use App\Infrastructure\Security\JwtManager;
use App\Infrastructure\Security\PasswordHasher;

use App\Infrastructure\Persistence\PersistenceFactory;


use App\Infrastructure\Persistence\SqlUserRepository;
use App\Infrastructure\Persistence\SqlParkingRepository;
use App\Infrastructure\Persistence\SqlReservationRepository;
use App\Infrastructure\Persistence\SqlStationnementRepository;

use App\Controller\AuthController;
use App\Controller\Auth2FAController;
use App\Controller\MeController;
use App\Controller\ReservationController;
use App\Controller\ParkingController;
use App\Controller\OwnerParkingController;
use App\Controller\SubscriptionController;


use App\UseCase\Subscription\CreateSubscription;

use App\UseCase\Auth\LoginUser;
use App\UseCase\Auth\RegisterUser;
use App\UseCase\Auth\RefreshToken;
use App\UseCase\Auth\StartTwoFactor;
use App\UseCase\Auth\VerifyTwoFactor;
use App\UseCase\Auth\Mailer;
use App\UseCase\Auth\SmsSender;
use App\UseCase\Auth\TotpVerifier;

use App\UseCase\Parking\GetParkingDetails;
use App\UseCase\Parking\CheckAvailability;
use App\UseCase\Parking\CalculateOccupancy;
use App\UseCase\Parking\CreateParking;


use App\UseCase\Billing\BillingCalculator;

use App\UseCase\Reservation\CreateReservation;
use App\UseCase\Reservation\EnterReservation;
use App\UseCase\Reservation\ExitReservation;
use App\UseCase\Reservation\GetInvoiceHtml;

use App\UseCase\Owner\ListOwnerParkings;
use App\UseCase\Owner\ListParkingReservationsForOwner;
use App\UseCase\Owner\ListActiveStationnementsForOwner;
use App\UseCase\Owner\GetMonthlyRevenueForOwner;


// =====================
// ENV
// =====================
$dotenv = Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

define('APP_ROOT', realpath(__DIR__ . '/..'));       
define('STORAGE_DIR', APP_ROOT . DIRECTORY_SEPARATOR . 'var' . DIRECTORY_SEPARATOR . 'storage');

// =====================
// Helpers
// =====================
function cors(): void
{
    header('Access-Control-Allow-Origin: ' . ($_ENV['APP_ORIGIN'] ?? '*'));
    header('Access-Control-Allow-Credentials: true');
    header('Access-Control-Allow-Headers: Content-Type, X-Requested-With');
    header('Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS');
    header('Content-Type: application/json; charset=utf-8');
}

function pdo(): PDO
{
    static $pdo = null;
    if ($pdo) return $pdo;

    $dsn = 'mysql:host=' . $_ENV['DB_HOST'] .
        ';dbname=' . $_ENV['DB_NAME'] .
        ';charset=' . ($_ENV['DB_CHARSET'] ?? 'utf8mb4');

    $pdo = new PDO($dsn, $_ENV['DB_USER'], $_ENV['DB_PASS'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ]);

    return $pdo;
}

// =====================
// CORS + preflight
// =====================
cors();
if (($_SERVER['REQUEST_METHOD'] ?? '') === 'OPTIONS') {
    http_response_code(204);
    exit;
}

// =====================
// Infra / Repos
// =====================
$db = pdo();

$userRepository = new SqlUserRepository($db);
$parkingRepository = new SqlParkingRepository($db);

// Switchable (sql/json) WITHOUT touching UseCases

$reservationRepository = PersistenceFactory::reservationRepository($db);
$stationnementRepository = PersistenceFactory::stationnementRepository($db, $reservationRepository);
$subscriptionRepository = PersistenceFactory::subscriptionRepository($db);

$passwordHasher = new PasswordHasher();

$jwtManager = new JwtManager(
    $_ENV['JWT_SECRET'],
    (int)$_ENV['JWT_ACCESS_TTL'],
    (int)$_ENV['JWT_REFRESH_TTL']
);

// =====================
// Fake providers (2FA)
// =====================
$mailer = new class implements Mailer {
    public function sendTwoFactorCodeEmail(string $to, string $code): void
    {
        error_log("[2FA EMAIL] $to -> code $code");
    }
};

$smsSender = new class implements SmsSender {
    public function sendTwoFactorSms(string $phone, string $code): void
    {
        error_log("[2FA SMS] $phone -> code $code");
    }
};

$totpVerifier = new class implements TotpVerifier {
    public function verify(string $secret, string $code): bool
    {
        return true;
    }
};

// =====================
// UseCases
// =====================
// Auth
$loginUser = new LoginUser($userRepository, $passwordHasher);
$registerUser = new RegisterUser($userRepository, $passwordHasher);
$refreshToken = new RefreshToken($jwtManager, $userRepository);
$startTwoFA = new StartTwoFactor($userRepository, $mailer, $smsSender);
$verify2FA = new VerifyTwoFactor($userRepository, $jwtManager, $totpVerifier);

// Parking
$getParkingDetails = new GetParkingDetails($parkingRepository);
$occupancy = new CalculateOccupancy($stationnementRepository, $reservationRepository, $subscriptionRepository);
$checkAvailability = new CheckAvailability($parkingRepository, $occupancy);
$createParking = new CreateParking($parkingRepository);

// Reservations
$createReservation = new CreateReservation($parkingRepository, $reservationRepository, $occupancy, $subscriptionRepository);

$billing = new BillingCalculator();
$enterReservation = new EnterReservation($reservationRepository, $stationnementRepository);
$exitReservation = new ExitReservation($reservationRepository, $stationnementRepository, $parkingRepository, $billing);
$getInvoiceHtml = new GetInvoiceHtml($reservationRepository, $stationnementRepository, $parkingRepository);

// Owner
$listOwnerParkings = new ListOwnerParkings($parkingRepository);
$listParkingReservationsForOwner = new ListParkingReservationsForOwner($parkingRepository, $reservationRepository);
$listActiveStationnementsForOwner = new ListActiveStationnementsForOwner($parkingRepository, $stationnementRepository);
$getMonthlyRevenueForOwner = new GetMonthlyRevenueForOwner($parkingRepository, $stationnementRepository);
// =====================
// Controllers
// =====================
$meController = new MeController($jwtManager, $userRepository);

$authController = new AuthController(
    $loginUser,
    $refreshToken,
    $registerUser,
    $startTwoFA,
    $jwtManager
);

$auth2FAController = new Auth2FAController($verify2FA, $jwtManager);


$ownerParkingController = new OwnerParkingController(
    $jwtManager,
    $listOwnerParkings,
    $listParkingReservationsForOwner,
    $listActiveStationnementsForOwner,
    $createParking,
    $getMonthlyRevenueForOwner
);

$parkingController = new ParkingController(
    $jwtManager,
    $getParkingDetails,
    $checkAvailability,
    $stationnementRepository
);

$reservationController = new ReservationController(
    $createReservation,
    $reservationRepository,
    $jwtManager,
    $enterReservation,
    $exitReservation,
    $getInvoiceHtml
);

$createSubscription = new CreateSubscription($subscriptionRepository);

$subscriptionController = new SubscriptionController(
    $jwtManager,
    $createSubscription,
    $subscriptionRepository
);



// =====================
// Router
// =====================
$router = new Router();

$router
    ->get('/health', fn() => print json_encode(['ok' => true]))

    // Auth / me
    ->get('/api/me', [$meController, 'me'])
    ->post('/api/auth/login', [$authController, 'login'])
    ->post('/api/auth/register', [$authController, 'register'])
    ->post('/api/auth/refresh', [$authController, 'refresh'])
    ->post('/api/auth/logout', [$authController, 'logout'])
    ->post('/api/auth/2fa/verify', [$auth2FAController, 'verify'])


    //Subscriptions
    ->get('/api/subscriptions/me', [$subscriptionController, 'me'])
    ->post('/api/subscriptions', [$subscriptionController, 'create'])

    
    // Parking
    ->get('/api/parkings/details', [$parkingController, 'details'])
    ->get('/api/parkings/availability', [$parkingController, 'availability'])
    ->get('/api/parkings/occupancy-now', [$parkingController, 'occupancyNow'])

    // Owner
    ->get('/api/owner/parkings', [$ownerParkingController, 'listMyParkings'])
    ->get('/api/owner/parkings/{id}/reservations', [$ownerParkingController, 'listParkingReservations'])
    ->get('/api/owner/parkings/{id}/stationnements/active', [$ownerParkingController, 'listActiveStationnements'])
    ->get('/api/owner/parkings/{id}/revenue', [$ownerParkingController, 'monthlyRevenue'])
    ->post('/api/owner/parkings', [$ownerParkingController, 'createParking'])

    // Reservations
    ->get('/api/reservations/me', [$reservationController, 'myReservations'])
    ->post('/api/reservations', [$reservationController, 'create'])
    ->post('/api/reservations/{id}/enter', [$reservationController, 'enter'])
    ->post('/api/reservations/{id}/exit', [$reservationController, 'exit'])
    ->get('/api/reservations/{id}/invoice', [$reservationController, 'invoice']);




================================================
FILE: Backend/src/seed.php
================================================
<?php
require __DIR__ . '/bootstrap.php';

$pdo = pdo();

echo "Seeding database...\n";

// 1. Create Owner
$stmt = $pdo->prepare('SELECT id FROM users WHERE email = ?');
$stmt->execute(['owner@example.com']);
$owner = $stmt->fetch();

if (!$owner) {
    $stmt = $pdo->prepare("INSERT INTO users (email, password_hash, firstname, lastname, role, api_token) VALUES (?, ?, ?, ?, ?, ?)");
    $hash = password_hash('password123', PASSWORD_DEFAULT);
    $token = bin2hex(random_bytes(32));
    $stmt->execute(['owner@example.com', $hash, 'Owner', 'Demo', 'owner', $token]);
    $ownerId = $pdo->lastInsertId();
    echo "Created owner (id: $ownerId)\n";
} else {
    $ownerId = $owner['id'];
    echo "Owner exists (id: $ownerId)\n";
}

// 2. Insert Parkings
$parkings = [
    ['Parking OpÃ©ra Premium', '15 Rue Scribe, 75009 Paris', 'Paris', 48.8706, 2.3319, 150, 3.50, 25.00, 280.00, '00:00:00', '23:59:59', 4.8],
    ['Station ChÃ¢telet', '1 Place du ChÃ¢telet, 75001 Paris', 'Paris', 48.8584, 2.3470, 200, 4.00, 30.00, 320.00, '00:00:00', '23:59:59', 4.9],
    ['Parking Gare du Nord', '18 Rue de Dunkerque, 75010 Paris', 'Paris', 48.8809, 2.3553, 300, 3.00, 22.00, 250.00, '00:00:00', '23:59:59', 4.6],
    ['Park Saint-Lazare', '108 Rue Saint-Lazare, 75008 Paris', 'Paris', 48.8756, 2.3262, 120, 4.50, 35.00, 350.00, '06:00:00', '22:00:00', 4.7],
    ['Parking Bastille Central', '120 Rue de Lyon, 75012 Paris', 'Paris', 48.8522, 2.3697, 180, 3.20, 24.00, 270.00, '00:00:00', '23:59:59', 4.5],
    ['Lyon Part-Dieu Premium', '21 Boulevard Vivier Merle, 69003 Lyon', 'Lyon', 45.7606, 4.8564, 250, 2.80, 20.00, 220.00, '00:00:00', '23:59:59', 4.9],
    ['Station Bellecour', '12 Place Bellecour, 69002 Lyon', 'Lyon', 45.7578, 4.8320, 180, 3.50, 26.00, 280.00, '00:00:00', '23:59:59', 4.7],
    ['Parking Vieux-Port', '46 Quai du Port, 13002 Marseille', 'Marseille', 43.2965, 5.3698, 220, 3.00, 22.00, 240.00, '00:00:00', '23:59:59', 4.6]
];

$stmtCheck = $pdo->prepare('SELECT id FROM parkings WHERE nom = ?');
$stmtInsert = $pdo->prepare("INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

foreach ($parkings as $p) {
    $stmtCheck->execute([$p[0]]);
    if (!$stmtCheck->fetch()) {
        $stmtInsert->execute(array_merge([$ownerId], $p));
        echo "Inserted parking: {$p[0]}\n";
        $pId = $pdo->lastInsertId();

        // Add services and vehicles
        $services = ['Couvert', 'SÃ©curisÃ©', 'VidÃ©o-surveillance', 'Bornes Ã©lectriques', 'AccÃ¨s handicapÃ©'];
        $vehicles = ['Voiture', 'Moto', 'VÃ©lo', 'Utilitaire'];
        
        // Randomly assign services and vehicles
        $myServices = array_rand(array_flip($services), rand(2, 5));
        if (!is_array($myServices)) $myServices = [$myServices];
        
        $stmtSvc = $pdo->prepare("INSERT INTO parking_services (parking_id, service) VALUES (?, ?)");
        foreach ($myServices as $svc) {
            $stmtSvc->execute([$pId, $svc]);
        }

        $myVehicles = array_rand(array_flip($vehicles), rand(1, 3));
        if (!is_array($myVehicles)) $myVehicles = [$myVehicles];

        $stmtVeh = $pdo->prepare("INSERT INTO parking_type_vehicules (parking_id, type_vehicule) VALUES (?, ?)");
        foreach ($myVehicles as $veh) {
            $stmtVeh->execute([$pId, $veh]);
        }
    }
}

echo "Seeding complete.\n";



================================================
FILE: Backend/src/Controller/Auth2FAController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Auth\VerifyTwoFactor;

final class Auth2FAController
{
    public function __construct(
        private VerifyTwoFactor $verifyTwoFactor,
        private JwtManager $jwt,
    ) {}

    public function verify(): void
    {
        $data = json_decode(file_get_contents('php://input'), true) ?? [];
        $code = (string)($data['code'] ?? '');

        // On lit le token "pending 2FA" (P2_AUTH)
        $p2 = $this->jwt->readPending2FA();
        if (!$p2 || ($p2['typ'] ?? '') !== 'p2') {
            Response::json(['error' => 'Missing 2FA session'], 401);
            return;
        }

        $userId = (int)($p2['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['error' => 'Invalid 2FA context'], 401);
            return;
        }

        try {
            // Use case = logique mÃ©tier
            $tokens = $this->verifyTwoFactor->execute($userId, $code);
        } catch (\Throwable) {
            Response::json(['error' => 'Invalid 2FA'], 401);
            return;
        }

        // Pose les cookies ACCESS / REFRESH
        $this->jwt->setAccessCookie($tokens['access_token']);
        $this->jwt->setRefreshCookie($tokens['refresh_token']);

        // On dÃ©truit le cookie P2_AUTH
        $this->jwt->setPending2FACookie(''); // ou setcookie('P2_AUTH', '', time()-3600, '/');

        Response::json(['ok' => true]);
    }

    public function resend(): void
    {
        // Ã  implÃ©menter si tu veux renvoyer un code, pour lâ€™instant juste OK
        Response::json(['ok' => true]);
    }
}



================================================
FILE: Backend/src/Controller/AuthController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Auth\LoginUser;
use App\UseCase\Auth\RefreshToken;
use App\UseCase\Auth\RegisterUser;
use App\UseCase\Auth\StartTwoFactor;

final class AuthController
{
    public function __construct(
        private LoginUser $loginUser,
        private RefreshToken $refreshToken,
        private RegisterUser $registerUser,
        private StartTwoFactor $startTwoFactor,
        private JwtManager $jwt,
    ) {
    }

    /** POST /api/auth/login */
    public function login(): void
    {
        $data = json_decode(file_get_contents('php://input'), true) ?? [];
        $email = (string) ($data['email'] ?? '');
        $password = (string) ($data['password'] ?? '');

        try {
            $result = $this->loginUser->execute($email, $password);

            if (!$result['success']) {
                Response::json(['error' => 'Invalid credentials'], 401);
                return;
            }

            // Si 2FA requise : pas de JWT dÃ©finitifs, juste un pending token
            if (!empty($result['two_factor_required']) && $result['two_factor_required'] === true) {
                $userId = $result['user_id'];

                $p2 = $this->jwt->issuePending2FAToken($userId);
                $this->jwt->setPending2FACookie($p2);

                $this->startTwoFactor->execute($userId);

                Response::json(['status' => '2fa_required']);
                return;
            }

            // Pas de 2FA â†’ on gÃ©nÃ¨re les vrais tokens
            $userId = $result['user_id'];
            $role = $result['role'];

            [$access, $refresh] = $this->jwt->issueFor($userId, $role);
            $this->jwt->setAccessCookie($access);
            $this->jwt->setRefreshCookie($refresh);

            Response::json(['ok' => true]);
        } catch (\Throwable) {
            Response::json(['error' => 'Invalid credentials'], 401);
        }
    }

    /** POST /api/auth/register */
    public function register(): void
{
    $data = json_decode(file_get_contents('php://input'), true) ?? [];

    $email = $data['email'] ?? '';
    $password = $data['password'] ?? '';
    $role = $data['role'] ?? 'USER';
    $firstname = $data['firstname'] ?? null;
    $lastname = $data['lastname'] ?? null;

    try {
        $user = $this->registerUser->execute(
            $email,
            $password,
            strtoupper($role),
            $firstname,
            $lastname
        );

        // Login automatique
        [$access, $refresh] = $this->jwt->issueFor($user['id'], $user['role']);
        $this->jwt->setAccessCookie($access);
        $this->jwt->setRefreshCookie($refresh);

        Response::json([
            'success' => true,
            'user' => $user,
        ], 201);

    } catch (\RuntimeException $e) {
        Response::json(['error' => $e->getMessage()], 409);
    } catch (\Throwable $e) {
        Response::json(['error' => 'Error registering user'], 400);
    }
}

    /** POST /api/auth/refresh */
    public function refresh(): void
    {
        $result = $this->refreshToken->execute();

        if (!$result) {
            Response::json(['error' => 'Invalid refresh'], 401);
            return;
        }

        $this->jwt->setAccessCookie($result['access']);
        Response::json(['ok' => true]);
    }

    /** POST /api/auth/logout */
    public function logout(): void
    {
        $this->jwt->clearAuthCookies();
        Response::json(['ok' => true]);
    }
}



================================================
FILE: Backend/src/Controller/MeController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\Domain\Repository\UserRepository;

final class MeController
{
    public function __construct(
        private JwtManager $jwt,
        private UserRepository $users,
    ) {}

    /** GET /api/me */
    public function me(): void
    {
        // On lit le JWT d'accÃ¨s depuis le cookie ACCESS_TOKEN
        $payload = $this->jwt->readAccessFromCookie();

        if (!$payload || ($payload['typ'] ?? '') !== 'access') {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $user = $this->users->findById($userId);
        if (!$user) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        Response::json([
            'id'    => $user->id(),
            'email' => $user->email(),
            'role'  => $user->role(),
            'firstname' => $user->firstname(),
            'lastname' => $user->lastname(),
        ]);
    }
}



================================================
FILE: Backend/src/Controller/OwnerParkingController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Http\IsGranted;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Owner\ListOwnerParkings;
use App\UseCase\Owner\ListParkingReservationsForOwner;
use App\UseCase\Owner\ListActiveStationnementsForOwner;
use App\UseCase\Owner\GetMonthlyRevenueForOwner;
use App\UseCase\Parking\CreateParking;


final class OwnerParkingController
{
    public function __construct(
        private JwtManager $jwt,
        private ListOwnerParkings $listOwnerParkings,
        private ListParkingReservationsForOwner $listParkingReservationsForOwner,
        private ListActiveStationnementsForOwner $listActiveStationnementsForOwner,
        private CreateParking $createParking,
        private GetMonthlyRevenueForOwner $getMonthlyRevenueForOwner,

    ) {
    }


    public function jwt(): JwtManager
    {
        return $this->jwt;
    }

    #[IsGranted('OWNER')]
    public function createParking(): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $ownerId = (int) ($payload['sub'] ?? 0);
        $data = json_decode(file_get_contents('php://input') ?: '[]', true) ?: [];

        try {
            $result = $this->createParking->execute($ownerId, $data);
            Response::json(['success' => true] + $result, 201);
        } catch (\Throwable $e) {
            Response::json(['success' => false, 'error' => $e->getMessage()], 400);
        }
    }


    #[IsGranted('OWNER')]
    public function listMyParkings(): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $ownerId = (int) ($payload['sub'] ?? 0);
        $data = $this->listOwnerParkings->execute($ownerId);

        Response::json(['data' => $data], 200);
    }

    #[IsGranted('OWNER')]
    public function listParkingReservations(int $id): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $ownerId = (int) ($payload['sub'] ?? 0);
        $from = isset($_GET['from']) ? (string) $_GET['from'] : null;
        $to = isset($_GET['to']) ? (string) $_GET['to'] : null;

        $data = $this->listParkingReservationsForOwner->execute(
            ownerId: $ownerId,
            parkingId: $id,
            from: $from,
            to: $to
        );

        Response::json(['data' => $data], 200);
    }

    #[IsGranted('OWNER')]
    public function listActiveStationnements(int $id): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $ownerId = (int) ($payload['sub'] ?? 0);

        try {
            $data = $this->listActiveStationnementsForOwner->execute($ownerId, $id);
            Response::json(['data' => $data], 200);
        } catch (\RuntimeException $e) {
            $msg = $e->getMessage();
            $code = ($msg === 'AccÃ¨s refusÃ©') ? 403 : 404;
            Response::json(['error' => $msg], $code);
        }
    }
    #[IsGranted('OWNER')]
    public function monthlyRevenue(int $id): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $ownerId = (int) ($payload['sub'] ?? 0);
        $month = (string) ($_GET['month'] ?? '');

        try {
            $data = $this->getMonthlyRevenueForOwner->execute($ownerId, $id, $month);
            Response::json(['data' => $data], 200);
        } catch (\RuntimeException $e) {
            $msg = $e->getMessage();
            $code = ($msg === 'AccÃ¨s refusÃ©') ? 403 : 400;
            if ($msg === 'Parking not found')
                $code = 404;
            Response::json(['error' => $msg], $code);
        }
    }

}



================================================
FILE: Backend/src/Controller/ParkingController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Http\IsGranted;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Parking\GetParkingDetails;
use App\UseCase\Parking\CheckAvailability;
use App\Domain\Repository\StationnementRepository;

final class ParkingController
{
    public function __construct(
        private readonly JwtManager $jwt,
        private readonly GetParkingDetails $getParkingDetails,
        private readonly CheckAvailability $checkAvailability,
        private readonly StationnementRepository $stationnementRepo
    ) {}

    public function jwt(): JwtManager
    {
        return $this->jwt;
    }

    // GET /api/parkings/details?id=1
    public function details(): void
    {
        $id = (int)($_GET['id'] ?? 0);
        if ($id <= 0) {
            Response::json(['success' => false, 'error' => 'Missing id'], 400);
            return;
        }

        try {
            $parking = $this->getParkingDetails->execute($id);
            Response::json(['success' => true, 'parking' => $parking], 200);
        } catch (\Throwable $e) {
            Response::json(['success' => false, 'error' => $e->getMessage()], 404);
        }
    }

    // GET /api/parkings/availability?parking_id=1&start_at=...&end_at=...
    #[IsGranted('USER')]
    public function availability(): void
    {
        try {
            $data = [
                'parking_id' => $_GET['parking_id'] ?? null,
                'start_at'   => $_GET['start_at'] ?? null,
                'end_at'     => $_GET['end_at'] ?? null,
            ];

            $result = $this->checkAvailability->execute($data);
            Response::json($result, 200);
        } catch (\Throwable $e) {
            Response::json(['success' => false, 'error' => $e->getMessage()], 400);
        }
    }
    // GET /api/parkings/occupancy-now?parking_id=2
public function occupancyNow(): void
{
    $parkingId = (int)($_GET['parking_id'] ?? 0);
    if ($parkingId <= 0) {
        Response::json(['success' => false, 'error' => 'Missing parking_id'], 400);
        return;
    }

    try {
        $parking = $this->getParkingDetails->execute($parkingId);
        $capacity = (int)($parking['capacity'] ?? 0);

        // IMPORTANT: countActiveByParkingId vient du repo stationnements
        $occupied = $this->stationnementRepo->countActiveByParkingId($parkingId);
        $remaining = max(0, $capacity - $occupied);

        Response::json([
            'parking_id' => $parkingId,
            'capacity' => $capacity,
            'occupied_now' => $occupied,
            'remaining_now' => $remaining,
            'available_now' => $remaining > 0,
        ], 200);
    } catch (\Throwable $e) {
        Response::json(['success' => false, 'error' => $e->getMessage()], 404);
    }
}

}



================================================
FILE: Backend/src/Controller/ReservationController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Domain\Repository\ReservationRepository;
use App\Infrastructure\Http\IsGranted;
use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Reservation\CreateReservation;
use App\UseCase\Reservation\EnterReservation;
use App\UseCase\Reservation\ExitReservation;
use App\UseCase\Reservation\GetInvoiceHtml;

final class ReservationController
{
    public function __construct(
        private readonly CreateReservation $createReservation,
        private readonly ReservationRepository $reservationRepository,
        private readonly JwtManager $jwt,
        private readonly EnterReservation $enterReservation,
        private readonly ExitReservation $exitReservation,
        private readonly GetInvoiceHtml $getInvoiceHtml
    ) {}

    // Pour ton Router/IsGranted
    public function jwt(): JwtManager
    {
        return $this->jwt;
    }

    private function fail(string $message, int $status = 400): void
    {
        Response::json(['success' => false, 'error' => $message], $status);
    }

    private function ok(array $payload = [], int $status = 200): void
    {
        Response::json(['success' => true] + $payload, $status);
    }

    private function requireUserId(): int
    {
        $payload = $this->jwt->readAccessFromCookie();

        if (!$payload || ($payload['typ'] ?? '') !== 'access') {
            $this->fail('Unauthorized', 401);
            exit;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            $this->fail('Unauthorized', 401);
            exit;
        }

        return $userId;
    }

    #[IsGranted('USER')]
    public function create(): void
    {
        $userId = $this->requireUserId();
        $data = json_decode(file_get_contents('php://input'), true) ?? [];

        $parkingId = (int)($data['parking_id'] ?? 0);
        $startAt = (string)($data['start_at'] ?? '');
        $endAt = (string)($data['end_at'] ?? '');
        $vehicleType = (string)($data['vehicle_type'] ?? '');
        $amount = (float)($data['amount'] ?? -1);

        if ($parkingId <= 0 || $startAt === '' || $endAt === '' || $vehicleType === '' || $amount < 0) {
            $this->fail('Missing fields', 400);
            return;
        }

        try {
            $res = $this->createReservation->execute(
                $userId,
                $parkingId,
                $startAt,
                $endAt,
                $vehicleType,
                $amount
            );

            $this->ok([
                'reservation' => [
                    'id' => $res->id(),
                    'user_id' => $res->userId(),
                    'parking_id' => $res->parkingId(),
                    'start_at' => $res->startAt()->format(DATE_ATOM),
                    'end_at' => $res->endAt()->format(DATE_ATOM),
                    'vehicle_type' => $res->vehicleType(),
                    'amount' => $res->amount(),
                    'created_at' => $res->createdAt()->format(DATE_ATOM),
                ]
            ], 201);
        } catch (\Throwable $e) {
            $this->fail($e->getMessage(), 400);
        }
    }

    #[IsGranted('USER')]
    public function myReservations(): void
    {
        $userId = $this->requireUserId();

        try {
            $rows = $this->reservationRepository->findByUserId($userId);

            $this->ok([
                'data' => array_map(static fn($r) => [
                    'id' => $r->id(),
                    'user_id' => $r->userId(),
                    'parking_id' => $r->parkingId(),
                    'start_at' => $r->startAt()->format(DATE_ATOM),
                    'end_at' => $r->endAt()->format(DATE_ATOM),
                    'vehicle_type' => $r->vehicleType(),
                    'amount' => $r->amount(),
                    'created_at' => $r->createdAt()->format(DATE_ATOM),
                ], $rows),
            ], 200);
        } catch (\Throwable $e) {
            $this->fail($e->getMessage(), 400);
        }
    }

    #[IsGranted('USER')]
    public function enter(int $id): void
    {
        $userId = $this->requireUserId();

        try {
            $st = $this->enterReservation->execute($userId, $id);

            $this->ok([
                'stationnement_id' => $st->id(),
                'reservation_id' => $st->reservationId(),
                'entered_at' => $st->enteredAt()->format(DATE_ATOM),
            ], 200);
        } catch (\Throwable $e) {
            $this->fail($e->getMessage(), 400);
        }
    }

    #[IsGranted('USER')]
    public function exit(int $id): void
    {
        $userId = $this->requireUserId();

        try {
            $result = $this->exitReservation->execute($userId, $id);
            $this->ok($result, 200);
        } catch (\Throwable $e) {
            $this->fail($e->getMessage(), 400);
        }
    }

    #[IsGranted('USER')]
    public function invoice(int $id): void
    {
        $userId = $this->requireUserId();

        try {
            $html = $this->getInvoiceHtml->execute($userId, $id);
            http_response_code(200);
            header('Content-Type: text/html; charset=utf-8');
            echo $html;
        } catch (\Throwable $e) {
            $this->fail($e->getMessage(), 400);
        }
    }
}



================================================
FILE: Backend/src/Controller/SubscriptionController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Http\IsGranted;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Subscription\CreateSubscription;
use App\Domain\Repository\SubscriptionRepository;

final class SubscriptionController
{
    public function __construct(
        private readonly JwtManager $jwt,
        private readonly CreateSubscription $createSubscription,
        private readonly SubscriptionRepository $subscriptions
    ) {}

    public function jwt(): JwtManager
    {
        return $this->jwt;
    }

    // POST /api/subscriptions
    #[IsGranted('USER')]
    public function create(): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['success' => false, 'error' => 'Unauthorized'], 401);
            return;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['success' => false, 'error' => 'Unauthorized'], 401);
            return;
        }

        $data = json_decode(file_get_contents('php://input') ?: '[]', true) ?: [];

        $parkingId   = (int)($data['parking_id'] ?? 0);
        $startDate   = (string)($data['start_date'] ?? '');
        $months      = (int)($data['months'] ?? 0);
        $weeklySlots = $data['weekly_slots'] ?? [];

        if ($parkingId <= 0) {
            Response::json(['success' => false, 'error' => 'parking_id required'], 400);
            return;
        }

        try {
            $sub = $this->createSubscription->execute(
                $userId,
                $parkingId,
                $startDate,
                $months,
                is_array($weeklySlots) ? $weeklySlots : []
            );

            Response::json([
                'success' => true,
                'subscription' => [
                    'id'          => $sub->id(),
                    'user_id'     => $sub->userId(),
                    'parking_id'  => $sub->parkingId(),
                    'start_date'  => $sub->startDate()->format('Y-m-d'),
                    'end_date'    => $sub->endDate()->format('Y-m-d'),
                    'weekly_slots'=> $sub->weeklySlots(),
                ],
            ], 201);
        } catch (\Throwable $e) {
            Response::json(['success' => false, 'error' => $e->getMessage()], 400);
        }
    }

    // GET /api/subscriptions/me
    #[IsGranted('USER')]
    public function me(): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload) {
            Response::json(['success' => false, 'error' => 'Unauthorized'], 401);
            return;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['success' => false, 'error' => 'Unauthorized'], 401);
            return;
        }

        $subs = $this->subscriptions->listByUserId($userId);

        $out = [];
        foreach ($subs as $s) {
            $out[] = [
                'id' => $s->id(),
                'parking_id' => $s->parkingId(),
                'start_date' => $s->startDate()->format('Y-m-d'),
                'end_date' => $s->endDate()->format('Y-m-d'),
                'weekly_slots' => $s->weeklySlots(),
            ];
        }

        Response::json(['success' => true, 'data' => $out], 200);
    }
}



================================================
FILE: Backend/src/Domain/Entity/parking.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Entity;

use DateTimeImmutable;

final class Parking
{
    private int $id;
    private int $capacity;

    // GPS stockÃ© en string "lat,long" (rapide et suffisant pour lâ€™instant)
    private string $gps;

    // Tarif horaire
    private float $tarif;

    // Horaires
    private DateTimeImmutable $heureDebut;
    private DateTimeImmutable $heureFin;

    // Relations (pour plus tard)
    private array $list_reservation;
    private array $list_stationnement;

    public function __construct(
        int $id,
        int $capacity,
        string $gps,
        float $tarif,
        DateTimeImmutable $heureDebut,
        DateTimeImmutable $heureFin,
        array $list_stationnement = [],
        array $list_reservation = []
    ) {
        if ($capacity < 0) {
            throw new \InvalidArgumentException('capacity must be >= 0');
        }

        $this->id = $id;
        $this->capacity = $capacity;
        $this->gps = $gps;
        $this->tarif = $tarif;
        $this->heureDebut = $heureDebut;
        $this->heureFin = $heureFin;
        $this->list_reservation = $list_reservation;
        $this->list_stationnement = $list_stationnement;
    }

    /* ============================
       IdentitÃ© & capacitÃ©
       ============================ */

    public function id(): int
    {
        return $this->id;
    }

    public function capacity(): int
    {
        return $this->capacity;
    }

    /* ============================
       AccÃ¨s FR (legacy)
       ============================ */

    public function getGps(): string
    {
        return $this->gps;
    }

    public function getTarif(): float
    {
        return $this->tarif;
    }

    public function getHeureDebut(): DateTimeImmutable
    {
        return $this->heureDebut;
    }

    public function getHeureFin(): DateTimeImmutable
    {
        return $this->heureFin;
    }

    public function getListReservation(): array
    {
        return $this->list_reservation;
    }

    public function getListStationnement(): array
    {
        return $this->list_stationnement;
    }

    /* ============================
       Aliases EN (API / UseCases)
       ============================ */

    public function gps(): string
    {
        return $this->getGps();
    }

    public function hourlyRate(): float
    {
        return $this->getTarif();
    }

    public function openingTime(): DateTimeImmutable
    {
        return $this->getHeureDebut();
    }

    public function closingTime(): DateTimeImmutable
    {
        return $this->getHeureFin();
    }
}



================================================
FILE: Backend/src/Domain/Entity/Reservation.php
================================================
<?php

namespace App\Domain\Entity;

final class Reservation
{
    public function __construct(
        private ?int $id,
        private int $userId,
        private int $parkingId,
        private \DateTimeImmutable $startAt,
        private \DateTimeImmutable $endAt,
        private \DateTimeImmutable $createdAt,
        private string $vehicleType,
        private float $amount,
    ) {
        if ($endAt <= $startAt) {
            throw new \InvalidArgumentException("endAt must be after startAt");
        }
        if ($this->vehicleType === '') {
            throw new \InvalidArgumentException("vehicleType is required");
        }
        if ($this->amount < 0) {
            throw new \InvalidArgumentException("amount must be >= 0");
        }
    }

    public static function create(
        int $userId,
        int $parkingId,
        \DateTimeImmutable $startAt,
        \DateTimeImmutable $endAt,
        string $vehicleType,
        float $amount
    ): self {
        return new self(
            null,
            $userId,
            $parkingId,
            $startAt,
            $endAt,
            new \DateTimeImmutable('now'),
            $vehicleType,
            $amount
        );
    }

    public function id(): ?int { return $this->id; }
    public function userId(): int { return $this->userId; }
    public function parkingId(): int { return $this->parkingId; }
    public function startAt(): \DateTimeImmutable { return $this->startAt; }
    public function endAt(): \DateTimeImmutable { return $this->endAt; }
    public function createdAt(): \DateTimeImmutable { return $this->createdAt; }
    public function vehicleType(): string { return $this->vehicleType; }
    public function amount(): float { return $this->amount; }

    public function withId(int $id): self
    {
        return new self(
            $id,
            $this->userId,
            $this->parkingId,
            $this->startAt,
            $this->endAt,
            $this->createdAt,
            $this->vehicleType,
            $this->amount
        );
    }
}



================================================
FILE: Backend/src/Domain/Entity/Stationnement.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Entity;

final class Stationnement
{
    public function __construct(
        private ?int $id,
        private int $reservationId,
        private \DateTimeImmutable $enteredAt,
        private ?\DateTimeImmutable $exitedAt,
        private ?float $billedAmount,
        private ?float $penaltyAmount,
        private \DateTimeImmutable $createdAt
    ) {}

    public static function enter(int $reservationId, \DateTimeImmutable $now): self
    {
        return new self(
            null,
            $reservationId,
            $now,
            null,
            null,
            null,
            new \DateTimeImmutable('now')
        );
    }

    public function id(): ?int { return $this->id; }
    public function reservationId(): int { return $this->reservationId; }
    public function enteredAt(): \DateTimeImmutable { return $this->enteredAt; }
    public function exitedAt(): ?\DateTimeImmutable { return $this->exitedAt; }
    public function billedAmount(): ?float { return $this->billedAmount; }
    public function penaltyAmount(): ?float { return $this->penaltyAmount; }
    public function createdAt(): \DateTimeImmutable { return $this->createdAt; }

    public function withId(int $id): self
    {
        return new self($id, $this->reservationId, $this->enteredAt, $this->exitedAt, $this->billedAmount, $this->penaltyAmount, $this->createdAt);
    }
}



================================================
FILE: Backend/src/Domain/Entity/Subscription.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Entity;

final class Subscription
{
    /**
     * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
     */
    public function __construct(
        private ?int $id,
        private int $userId,
        private int $parkingId,
        private \DateTimeImmutable $startDate, // date only (00:00)
        private \DateTimeImmutable $endDate,   // date only (00:00)
        private array $weeklySlots
    ) {}

    public function id(): ?int { return $this->id; }
    public function userId(): int { return $this->userId; }
    public function parkingId(): int { return $this->parkingId; }
    public function startDate(): \DateTimeImmutable { return $this->startDate; }
    public function endDate(): \DateTimeImmutable { return $this->endDate; }

    /** @return array<int, array{dow:int,start:string,end:string}> */
    public function weeklySlots(): array { return $this->weeklySlots; }

    public function withId(int $id): self
    {
        return new self($id, $this->userId, $this->parkingId, $this->startDate, $this->endDate, $this->weeklySlots);
    }
}



================================================
FILE: Backend/src/Domain/Entity/User.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Entity;

final class User
{
    public function __construct(
        private int $id,
        private string $email,
        private string $passwordHash,
        private string $role = 'USER',

        private ?string $firstname = null,
        private ?string $lastname = null,

        // Config 2FA
        private bool $twoFactorEnabled = true,
        // 'email' | 'sms' | 'totp'
        private string $twoFactorMethod = 'email',

        // 2FA par code (email / sms)
        private ?string $twoFactorLastCode = null,
        private ?\DateTimeImmutable $twoFactorExpiresAt = null,

        // 2FA SMS
        private ?string $twoFactorPhone = null,

        // 2FA TOTP (Google Authenticator, etc.)
        private ?string $twoFactorTotpSecret = null,
    ) {
    }

    // ====================
    // Getters de base
    // ====================

    public function id(): int
    {
        return $this->id;
    }

    public function email(): string
    {
        return $this->email;
    }

    public function passwordHash(): string
    {
        return $this->passwordHash;
    }

    public function role(): string
    {
        return $this->role;
    }

    public function firstname(): ?string
    {
        return $this->firstname;
    }
    public function lastname(): ?string
    {
        return $this->lastname;
    }
    // ====================
    // 2FA - configuration
    // ====================

    public function twoFactorEnabled(): bool
    {
        return $this->twoFactorEnabled;
    }

    public function twoFactorMethod(): string
    {
        return $this->twoFactorMethod;
    }

    public function twoFactorPhone(): ?string
    {
        return $this->twoFactorPhone;
    }

    public function twoFactorTotpSecret(): ?string
    {
        return $this->twoFactorTotpSecret;
    }

    // immuable : config complÃ¨te de la 2FA (mÃ©thode + Ã©ventuel numÃ©ro)
    public function withTwoFactorConfig(
        bool $enabled,
        string $method,
        ?string $phone = null
    ): self {
        $allowed = ['email', 'sms', 'totp'];
        if (!\in_array($method, $allowed, true)) {
            throw new \InvalidArgumentException('Invalid 2FA method');
        }

        $c = clone $this;
        $c->twoFactorEnabled = $enabled;
        $c->twoFactorMethod = $method;
        $c->twoFactorPhone = $phone;

        return $c;
    }

    // Pour TOTP uniquement
    public function withTotpSecret(string $secret): self
    {
        $c = clone $this;
        $c->twoFactorTotpSecret = $secret;
        return $c;
    }

    public function hasTotpConfigured(): bool
    {
        return $this->twoFactorTotpSecret !== null && $this->twoFactorTotpSecret !== '';
    }

    // ====================
    // 2FA - challenge code (email / sms)
    // ====================

    public function twoFactorLastCode(): ?string
    {
        return $this->twoFactorLastCode;
    }

    public function twoFactorExpiresAt(): ?\DateTimeImmutable
    {
        return $this->twoFactorExpiresAt;
    }

    public function with2FACode(string $code, \DateTimeImmutable $expires): self
    {
        $c = clone $this;
        $c->twoFactorLastCode = $code;
        $c->twoFactorExpiresAt = $expires;
        return $c;
    }

    public function clear2FA(): self
    {
        $c = clone $this;
        $c->twoFactorLastCode = null;
        $c->twoFactorExpiresAt = null;
        return $c;
    }

    public function hasValid2FACode(string $code, \DateTimeImmutable $now): bool
    {
        if ($this->twoFactorLastCode === null || $this->twoFactorExpiresAt === null) {
            return false;
        }

        if ($this->twoFactorExpiresAt < $now) {
            return false;
        }

        return hash_equals($this->twoFactorLastCode, $code);
    }
}



================================================
FILE: Backend/src/Domain/Repository/ParkingRepository.php
================================================
<?php

namespace App\Domain\Repository;

use App\Domain\Entity\Parking;

interface ParkingRepository
{
    public function create(array $data): int;

    public function findById(int $id): ?Parking;

    /** @return array<int, array<string,mixed>> */
    public function listByOwnerId(int $ownerId): array;
    public function findOwnerIdByParkingId(int $parkingId): ?int;

}



================================================
FILE: Backend/src/Domain/Repository/ReservationRepository.php
================================================
<?php

namespace App\Domain\Repository;

use App\Domain\Entity\Reservation;

interface ReservationRepository
{
    public function findById(int $id): ?Reservation;

    public function save(Reservation $reservation): Reservation;

    /** @return Reservation[] */
    public function findByUserId(int $userId): array;

    /** @return Reservation[] */
    public function findByParkingId(int $parkingId): array;

    public function countOverlappingForParking(
        int $parkingId,
        \DateTimeImmutable $startAt,
        \DateTimeImmutable $endAt
    ): int;
    /** @return array<int, array<string,mixed>> */
    public function listByParking(int $parkingId, ?string $from, ?string $to): array;

    public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int;
    public function existsOverlappingForUser(int $userId, string $startAt, string $endAt): bool;

}



================================================
FILE: Backend/src/Domain/Repository/StationnementRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Repository;

use App\Domain\Entity\Stationnement;

interface StationnementRepository
{
    public function save(Stationnement $s): Stationnement;

    public function findActiveByReservationId(int $reservationId): ?Stationnement;

    public function close(
        int $stationnementId,
        \DateTimeImmutable $exitedAt,
        float $billedAmount,
        float $penaltyAmount
    ): void;

    public function findLastByReservationId(int $reservationId): ?Stationnement;
    /** @return array<int, array<string,mixed>> */
    public function listActiveByParkingId(int $parkingId): array;
    public function countActiveByParkingId(int $parkingId): int;

/** @return array{count_exits:int, total_billed:float, total_penalty:float, total:float} */
public function revenueForParking(string $from, string $to, int $parkingId): array;

}



================================================
FILE: Backend/src/Domain/Repository/SubscriptionRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Repository;

use App\Domain\Entity\Subscription;

interface SubscriptionRepository
{
    public function save(Subscription $subscription): Subscription;

    /** @return Subscription[] */
    public function listByUserId(int $userId): array;

    /** @return Subscription[] */
    public function listByParkingId(int $parkingId): array;

    public function countActiveNow(int $parkingId, string $at): int;
    public function countActiveForSlot(int $parkingId, string $startAt, string $endAt): int;

    public function existsOverlappingForUserParking(
        int $userId,
        int $parkingId,
        string $startDate, // 'Y-m-d'
        string $endDate    // 'Y-m-d'
    ): bool;
    public function coversUserForSlot(
    int $userId,
    int $parkingId,
    string $startAt, // 'Y-m-d H:i:s'
    string $endAt    // 'Y-m-d H:i:s'
): bool;

}



================================================
FILE: Backend/src/Domain/Repository/UserRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Repository;

use App\Domain\Entity\User;

interface UserRepository
{
    public function findById(int $id): ?User;
    public function findByEmail(string $email): ?User;

    // ğŸ‘‡ on remplace save2FA par Ã§a
    public function save(User $user): void;
  public function create(
    string $email,
    string $passwordHash,
    string $role = 'USER',
    ?string $firstname = null,
    ?string $lastname = null
): User;
}



================================================
FILE: Backend/src/Domain/Repository/Exception/DomainException.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Exception;

final class DomainException extends \RuntimeException {}



================================================
FILE: Backend/src/Domain/Service/SubscriptionSchedule.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Service;

final class SubscriptionSchedule
{
    /**
     * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
     */
    public static function isActiveAt(
        string $date,        // 'Y-m-d'
        string $time,        // 'H:i'
        string $startDate,   // 'Y-m-d'
        string $endDate,     // 'Y-m-d'
        array $weeklySlots
    ): bool {
        if ($date < $startDate || $date > $endDate) return false;

        $dt = \DateTimeImmutable::createFromFormat('Y-m-d H:i', $date . ' ' . $time);
        if (!$dt) return false;

        $dow = (int)$dt->format('N'); // 1..7

        foreach ($weeklySlots as $slot) {
            $sdow = (int)($slot['dow'] ?? 0);
            $s = (string)($slot['start'] ?? '');
            $e = (string)($slot['end'] ?? '');
            if ($sdow < 1 || $sdow > 7 || !self::isTime($s) || !self::isTime($e)) continue;

            if (self::timeWindowContains($dow, $time, $sdow, $s, $e)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Overlap entre un abonnement (date range + weekly slots) et un crÃ©neau concret [startAt,endAt]
     * startAt/endAt format: 'Y-m-d H:i:s'
     * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
     */
    public static function overlapsSlot(
        string $startAt,
        string $endAt,
        string $startDate,
        string $endDate,
        array $weeklySlots
    ): bool {
        $start = \DateTimeImmutable::createFromFormat('Y-m-d H:i:s', $startAt);
        $end   = \DateTimeImmutable::createFromFormat('Y-m-d H:i:s', $endAt);
        if (!$start || !$end || $end <= $start) return false;

        // pas de micro-optimisation dÃ©bile: pas de 15 minutes = cohÃ©rent avec ta facturation
        $cursor = $start;
        while ($cursor < $end) {
            $d = $cursor->format('Y-m-d');
            $t = $cursor->format('H:i');
            if (self::isActiveAt($d, $t, $startDate, $endDate, $weeklySlots)) {
                return true;
            }
            $cursor = $cursor->modify('+15 minutes');
        }
        return false;
    }

    private static function timeWindowContains(int $dowNow, string $timeNow, int $slotDow, string $slotStart, string $slotEnd): bool
    {
        // slot dans la mÃªme journÃ©e
        if ($slotStart <= $slotEnd) {
            return $dowNow === $slotDow && ($slotStart <= $timeNow && $timeNow <= $slotEnd);
        }

        // slot traverse minuit (ex 18:00 -> 08:00)
        if ($dowNow === $slotDow && $timeNow >= $slotStart) return true;

        $nextDow = $slotDow === 7 ? 1 : $slotDow + 1;
        if ($dowNow === $nextDow && $timeNow <= $slotEnd) return true;

        return false;
    }

    private static function isTime(string $hhmm): bool
    {
        return (bool)\preg_match('/^(?:[01]\d|2[0-3]):[0-5]\d$/', $hhmm);
    }
}



================================================
FILE: Backend/src/Infrastructure/Http/IsGranted.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Http;

use App\Infrastructure\Security\JwtManager;

#[\Attribute(\Attribute::TARGET_METHOD)]
final class IsGranted
{
    public function __construct(private string $role = 'USER') {}

    public function assert(JwtManager $jwt): void
    {
        $payload = $jwt->readAccessFromCookie();

        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            exit;
        }

        // âœ… Normalisation: Ã©vite OWNER vs owner, USER vs user, etc.
        $userRole = strtoupper((string)($payload['role'] ?? 'USER'));
        $needed   = strtoupper((string)$this->role);

        $ranks = [
            'USER'  => 1,
            'OWNER' => 2,
            'ADMIN' => 3,
        ];

        if (($ranks[$userRole] ?? 0) < ($ranks[$needed] ?? 99)) {
            Response::json(['error' => 'Forbidden'], 403);
            exit;
        }
    }
}



================================================
FILE: Backend/src/Infrastructure/Http/Response.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Http;

final class Response
{
    public static function json(array $data, int $status = 200): void
    {
        http_response_code($status);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($data, JSON_UNESCAPED_UNICODE);
    }
}



================================================
FILE: Backend/src/Infrastructure/Http/Router.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Http;

use ReflectionMethod;

final class Router
{
    /** @var array<string, array<int, array{path:string, handler:mixed, regex:?string, vars:array<int,string>}>> */
    private array $routes = [];

    public function get(string $path, $handler): self { return $this->map('GET', $path, $handler); }
    public function post(string $path, $handler): self { return $this->map('POST', $path, $handler); }

    public function map(string $method, string $path, $handler): self
    {
        $path = rtrim($path, '/');
        if ($path === '') $path = '/';

        [$regex, $vars] = $this->compilePath($path);

        $this->routes[$method][] = [
            'path' => $path,
            'handler' => $handler,
            'regex' => $regex,
            'vars' => $vars,
        ];

        return $this;
    }

public function dispatch(string $method, string $path): void
{
    $path = rtrim($path, '/');
    if ($path === '') $path = '/';

    [$handler, $params] = $this->match($method, $path);

    if (!$handler) {
        Response::json(['error' => 'Not found'], 404);
        return;
    }

    if (is_array($handler) && is_object($handler[0])) {
        $controller = $handler[0];
        $methodName = $handler[1];

        $this->applyGuards($controller, $methodName);

        $this->call($handler, $params);
        return;
    }

    if (is_array($handler) && is_string($handler[0])) {
        $obj = new $handler[0]();
        $this->call([$obj, $handler[1]], $params);
        return;
    }

    $this->call($handler, $params);
}


    private function match(string $method, string $path): array
    {
        $routes = $this->routes[$method] ?? [];

        foreach ($routes as $route) {
            // Exact match first
            if ($route['regex'] === null && $route['path'] === $path) {
                return [$route['handler'], []];
            }

            // Regex match for {vars}
            if ($route['regex'] !== null && preg_match($route['regex'], $path, $m)) {
                $params = [];
                foreach ($route['vars'] as $varName) {
                    if (isset($m[$varName])) {
                        $params[] = ctype_digit($m[$varName]) ? (int)$m[$varName] : $m[$varName];
                    }
                }
                return [$route['handler'], $params];
            }
        }

        return [null, []];
    }

    private function compilePath(string $path): array
    {
        if (strpos($path, '{') === false) {
            return [null, []];
        }

        $vars = [];
        $regex = preg_replace_callback('/\{([a-zA-Z_][a-zA-Z0-9_]*)\}/', function ($m) use (&$vars) {
            $vars[] = $m[1];
            return '(?P<' . $m[1] . '>[^/]+)';
        }, $path);

        return ['#^' . $regex . '$#', $vars];
    }

    private function applyGuards(object $controller, string $methodName): void
    {
        $ref = new ReflectionMethod($controller, $methodName);
        $attributes = $ref->getAttributes(IsGranted::class);

        foreach ($attributes as $attribute) {
            $instance = $attribute->newInstance();

            // If controller has method jwt(): JwtManager
            if (method_exists($controller, 'jwt')) {
                $instance->assert($controller->jwt());
                continue;
            }

            // If controller has readable property $jwt
            if (property_exists($controller, 'jwt')) {
                try {
                    /** @phpstan-ignore-next-line */
                    $instance->assert($controller->jwt);
                    continue;
                } catch (\Throwable) {
                    Response::json(['error' => 'Controller JWT is not accessible'], 500);
                    exit;
                }
            }

            Response::json(['error' => 'Controller missing JWT'], 500);
            exit;
        }
    }

    private function call($handler, array $params): void
    {
        if (is_array($handler)) {
            call_user_func_array($handler, $params);
            return;
        }

        // Closure
        call_user_func($handler, ...$params);
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/PersistenceFactory.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use PDO;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Repository\SubscriptionRepository; // +++
use App\Infrastructure\Persistence\SqlReservationRepository;
use App\Infrastructure\Persistence\SqlStationnementRepository;
use App\Infrastructure\Persistence\SqlSubscriptionRepository; // +++
use App\Infrastructure\Persistence\Json\JsonReservationRepository;
use App\Infrastructure\Persistence\Json\JsonStationnementRepository;
use App\Infrastructure\Persistence\Json\JsonSubscriptionRepository; // +++

final class PersistenceFactory
{
    private static function driver(): string
    {
        return strtolower((string) ($_ENV['PERSISTENCE_DRIVER'] ?? 'sql'));
    }

    private static function storagePath(string $filename): string
    {
        // STORAGE_DIR dÃ©fini dans bootstrap.php
        return STORAGE_DIR . DIRECTORY_SEPARATOR . $filename;
    }
    public static function subscriptionRepository(PDO $pdo): SubscriptionRepository
    {
        return match (self::driver()) {
            'json' => new JsonSubscriptionRepository(
                self::storagePath('subscriptions.json')
            ),
            default => new SqlSubscriptionRepository($pdo),
        };
    }
    public static function reservationRepository(PDO $pdo): ReservationRepository
    {
        return match (self::driver()) {
            'json' => new JsonReservationRepository(
                self::storagePath('reservations.json'),
                self::storagePath('stationnements.json')
            ),
            default => new SqlReservationRepository($pdo),
        };
    }

    public static function stationnementRepository(PDO $pdo, ReservationRepository $reservationRepo): StationnementRepository
    {
        return match (self::driver()) {
            'json' => new JsonStationnementRepository(
                self::storagePath('stationnements.json'),
                $reservationRepo
            ),
            default => new SqlStationnementRepository($pdo),
        };
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlParkingRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\Parking;
use App\Domain\Repository\ParkingRepository;
use PDO;

final class SqlParkingRepository implements ParkingRepository
{
    public function __construct(private PDO $db) {}

public function create(array $data): int
{
    $stmt = $this->db->prepare("
        INSERT INTO parkings (owner_id, latitude, longitude, capacity, hourly_rate, opening_time, closing_time)
        VALUES (:owner_id, :lat, :lng, :cap, :rate, :open, :close)
    ");

    $stmt->execute([
        ':owner_id' => (int)($data['owner_id'] ?? 0),
        ':lat'      => (float)($data['latitude'] ?? 0),
        ':lng'      => (float)($data['longitude'] ?? 0),
        ':cap'      => (int)($data['capacity'] ?? 0),
        ':rate'     => (float)($data['hourly_rate'] ?? 0),
        ':open'     => (string)($data['opening_time'] ?? '00:00:00'),
        ':close'    => (string)($data['closing_time'] ?? '23:59:59'),
    ]);

    return (int)$this->db->lastInsertId();
}


    public function findById(int $id): ?Parking
    {
        $stmt = $this->db->prepare("
            SELECT
              id,
              latitude,
              longitude,
              capacity,
              hourly_rate,
              opening_time,
              closing_time
            FROM parkings
            WHERE id = :id
            LIMIT 1
        ");
        $stmt->execute([':id' => $id]);
        $row = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$row) {
            return null;
        }

        $gps = $row['latitude'] . "," . $row['longitude'];

        return new Parking(
            (int)$row['id'],
            (int)$row['capacity'],
            (string)$gps,
            (float)$row['hourly_rate'],
            new \DateTimeImmutable((string)$row['opening_time']),
            new \DateTimeImmutable((string)$row['closing_time']),
            [],
            []
        );
    }

    public function listByOwnerId(int $ownerId): array
    {
        // Ajuste le SELECT selon tes colonnes rÃ©elles.
        // Ici je pars sur une table parkings avec owner_id + latitude/longitude/etc.
        $stmt = $this->db->prepare('
            SELECT
              id,
              latitude,
              longitude,
              capacity,
              hourly_rate,
              opening_time,
              closing_time
            FROM parkings
            WHERE owner_id = :owner_id
            ORDER BY id DESC
        ');
        $stmt->execute(['owner_id' => $ownerId]);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function findOwnerIdByParkingId(int $parkingId): ?int
    {
        $stmt = $this->db->prepare('
            SELECT owner_id
            FROM parkings
            WHERE id = :id
            LIMIT 1
        ');
        $stmt->execute(['id' => $parkingId]);

        $ownerId = $stmt->fetchColumn();
        return $ownerId !== false ? (int)$ownerId : null;
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlReservationRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\Reservation;
use App\Domain\Repository\ReservationRepository;
use PDO;

final class SqlReservationRepository implements ReservationRepository
{
    public function __construct(private PDO $db)
    {
    }

    public function save(Reservation $reservation): Reservation
    {
        if ($reservation->id() === null) {
            $stmt = $this->db->prepare("
                INSERT INTO reservations (user_id, parking_id, start_at, end_at, vehicle_type, amount, created_at)
                VALUES (:user_id, :parking_id, :start_at, :end_at, :vehicle_type, :amount, :created_at)
            ");

            $stmt->execute([
                ':user_id' => $reservation->userId(),
                ':parking_id' => $reservation->parkingId(),
                ':start_at' => $reservation->startAt()->format('Y-m-d H:i:s'),
                ':end_at' => $reservation->endAt()->format('Y-m-d H:i:s'),
                ':vehicle_type' => $reservation->vehicleType(),
                ':amount' => $reservation->amount(),
                ':created_at' => $reservation->createdAt()->format('Y-m-d H:i:s'),
            ]);

            return $reservation->withId((int) $this->db->lastInsertId());
        }

        // Si plus tard tu veux update, tu le feras ici.
        return $reservation;
    }

    public function findById(int $id): ?Reservation
    {
        $stmt = $this->db->prepare("SELECT * FROM reservations WHERE id = :id LIMIT 1");
        $stmt->execute([':id' => $id]);

        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        return $row ? $this->hydrate($row) : null;
    }

    public function findByUserId(int $userId): array
    {
        $stmt = $this->db->prepare("
            SELECT *
            FROM reservations
            WHERE user_id = :uid
            ORDER BY start_at DESC
        ");
        $stmt->execute([':uid' => $userId]);

        return array_map([$this, 'hydrate'], $stmt->fetchAll(PDO::FETCH_ASSOC));
    }

    public function findByParkingId(int $parkingId): array
    {
        $stmt = $this->db->prepare("
            SELECT *
            FROM reservations
            WHERE parking_id = :pid
            ORDER BY start_at DESC
        ");
        $stmt->execute([':pid' => $parkingId]);

        return array_map([$this, 'hydrate'], $stmt->fetchAll(PDO::FETCH_ASSOC));
    }

    public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int
    {
        $stmt = $this->db->prepare("
            SELECT COUNT(*) as c
            FROM reservations
            WHERE parking_id = :pid
              AND start_at < :end_at
              AND end_at > :start_at
        ");
        $stmt->execute([
            ':pid' => $parkingId,
            ':start_at' => $startAt->format('Y-m-d H:i:s'),
            ':end_at' => $endAt->format('Y-m-d H:i:s'),
        ]);

        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        return (int) ($row['c'] ?? 0);
    }

    /**
     * Version "Owner" pour listing simple en tableaux (pas des Entities),
     * avec filtre optionnel from/to.
     */
    public function listByParking(int $parkingId, ?string $from, ?string $to): array
    {
        $sql = '
            SELECT id, user_id, parking_id, start_at, end_at, vehicle_type, amount, created_at
            FROM reservations
            WHERE parking_id = :parking_id
        ';

        $params = ['parking_id' => $parkingId];

        if ($from) {
            $sql .= ' AND end_at >= :from';
            $params['from'] = $from;
        }
        if ($to) {
            $sql .= ' AND start_at <= :to';
            $params['to'] = $to;
        }

        $sql .= ' ORDER BY start_at ASC';

        $stmt = $this->db->prepare($sql);
        $stmt->execute($params);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    private function hydrate(array $row): Reservation
    {
        return new Reservation(
            (int) $row['id'],
            (int) $row['user_id'],
            (int) $row['parking_id'],
            new \DateTimeImmutable((string) $row['start_at']),
            new \DateTimeImmutable((string) $row['end_at']),
            new \DateTimeImmutable((string) $row['created_at']),
            (string) $row['vehicle_type'],
            (float) $row['amount']
        );
    }
    public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int
    {
        $stmt = $this->db->prepare('
        SELECT COUNT(*)
        FROM reservations r
        LEFT JOIN stationnements s 
          ON s.reservation_id = r.id
         AND s.exited_at IS NULL
        WHERE r.parking_id = :parking_id
          AND NOT (r.end_at <= :start_at OR r.start_at >= :end_at)
          AND s.id IS NULL
    ');

        $stmt->execute([
            'parking_id' => $parkingId,
            'start_at' => $startAt,
            'end_at' => $endAt,
        ]);

        return (int) $stmt->fetchColumn();
    }
    public function existsOverlappingForUser(int $userId, string $startAt, string $endAt): bool
{
    $sql = "SELECT 1
            FROM reservations
            WHERE user_id = :uid
              AND start_at < :endAt
              AND end_at > :startAt
            LIMIT 1";

    $st = $this->db->prepare($sql);
    $st->execute([
        ':uid' => $userId,
        ':startAt' => $startAt,
        ':endAt' => $endAt,
    ]);

    return (bool)$st->fetchColumn();
}


}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlStationnementRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\Stationnement;
use App\Domain\Repository\StationnementRepository;
use PDO;

final class SqlStationnementRepository implements StationnementRepository
{
    public function __construct(private PDO $db) {}

    public function save(Stationnement $s): Stationnement
    {
        if ($s->id() === null) {
            $stmt = $this->db->prepare("
                INSERT INTO stationnements (reservation_id, entered_at, exited_at, billed_amount, penalty_amount, created_at)
                VALUES (:rid, :entered, :exited, :billed, :penalty, :created)
            ");
            $stmt->execute([
                ':rid' => $s->reservationId(),
                ':entered' => $s->enteredAt()->format('Y-m-d H:i:s'),
                ':exited' => $s->exitedAt()?->format('Y-m-d H:i:s'),
                ':billed' => $s->billedAmount(),
                ':penalty' => $s->penaltyAmount(),
                ':created' => $s->createdAt()->format('Y-m-d H:i:s'),
            ]);

            return $s->withId((int)$this->db->lastInsertId());
        }

        return $s;
    }

    public function findActiveByReservationId(int $reservationId): ?Stationnement
    {
        $stmt = $this->db->prepare("
            SELECT * FROM stationnements
            WHERE reservation_id = :rid AND exited_at IS NULL
            ORDER BY entered_at DESC
            LIMIT 1
        ");
        $stmt->execute([':rid' => $reservationId]);
        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        return $row ? $this->hydrate($row) : null;
    }

    public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void
    {
        $stmt = $this->db->prepare("
            UPDATE stationnements
            SET exited_at = :exited, billed_amount = :billed, penalty_amount = :penalty
            WHERE id = :id
        ");
        $stmt->execute([
            ':id' => $stationnementId,
            ':exited' => $exitedAt->format('Y-m-d H:i:s'),
            ':billed' => $billedAmount,
            ':penalty' => $penaltyAmount,
        ]);
    }

    public function findLastByReservationId(int $reservationId): ?Stationnement
    {
        $stmt = $this->db->prepare("
            SELECT * FROM stationnements
            WHERE reservation_id = :rid
            ORDER BY entered_at DESC
            LIMIT 1
        ");
        $stmt->execute([':rid' => $reservationId]);
        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        return $row ? $this->hydrate($row) : null;
    }

    private function hydrate(array $row): Stationnement
    {
        return new Stationnement(
            (int)$row['id'],
            (int)$row['reservation_id'],
            new \DateTimeImmutable($row['entered_at']),
            $row['exited_at'] ? new \DateTimeImmutable($row['exited_at']) : null,
            $row['billed_amount'] !== null ? (float)$row['billed_amount'] : null,
            $row['penalty_amount'] !== null ? (float)$row['penalty_amount'] : null,
            new \DateTimeImmutable($row['created_at'])
        );
    }

    public function listActiveByParkingId(int $parkingId): array
{
    $stmt = $this->db->prepare('
        SELECT
          s.id,
          s.reservation_id,
          s.entered_at,
          s.exited_at,
          s.billed_amount,
          s.penalty_amount,
          s.created_at
        FROM stationnements s
        JOIN reservations r ON r.id = s.reservation_id
        WHERE r.parking_id = :parking_id
          AND s.exited_at IS NULL
        ORDER BY s.entered_at DESC
    ');
    $stmt->execute(['parking_id' => $parkingId]);
    return $stmt->fetchAll(\PDO::FETCH_ASSOC);
}
public function countActiveByParkingId(int $parkingId): int
{
    $stmt = $this->db->prepare('
        SELECT COUNT(*)
        FROM stationnements s
        JOIN reservations r ON r.id = s.reservation_id
        WHERE r.parking_id = :parking_id
          AND s.exited_at IS NULL
    ');
    $stmt->execute(['parking_id' => $parkingId]);
    return (int)$stmt->fetchColumn();
}

public function revenueForParking(string $from, string $to, int $parkingId): array
{
    $stmt = $this->db->prepare('
        SELECT
          COUNT(*) AS count_exits,
          COALESCE(SUM(s.billed_amount), 0) AS total_billed,
          COALESCE(SUM(s.penalty_amount), 0) AS total_penalty,
          COALESCE(SUM(COALESCE(s.billed_amount,0) + COALESCE(s.penalty_amount,0)), 0) AS total
        FROM stationnements s
        JOIN reservations r ON r.id = s.reservation_id
        WHERE r.parking_id = :parking_id
          AND s.exited_at IS NOT NULL
          AND s.exited_at >= :from
          AND s.exited_at < :to
    ');

    $stmt->execute([
        'parking_id' => $parkingId,
        'from' => $from,
        'to' => $to,
    ]);

    $row = $stmt->fetch(\PDO::FETCH_ASSOC) ?: [];

    return [
        'count_exits'   => (int)($row['count_exits'] ?? 0),
        'total_billed'  => (float)($row['total_billed'] ?? 0),
        'total_penalty' => (float)($row['total_penalty'] ?? 0),
        'total'         => (float)($row['total'] ?? 0),
    ];
}

}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlSubscriptionRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use PDO;
use App\Domain\Entity\Subscription;
use App\Domain\Repository\SubscriptionRepository;
use App\Domain\Service\SubscriptionSchedule;

final class SqlSubscriptionRepository implements SubscriptionRepository
{
    public function __construct(private readonly PDO $pdo)
    {
    }

    public function save(Subscription $subscription): Subscription
    {
        $slotsJson = json_encode($subscription->weeklySlots(), JSON_UNESCAPED_UNICODE);

        $sql = "INSERT INTO subscriptions (user_id, parking_id, start_date, end_date, weekly_slots)
                VALUES (:uid, :pid, :sd, :ed, :slots)";
        $st = $this->pdo->prepare($sql);
        $st->execute([
            ':uid' => $subscription->userId(),
            ':pid' => $subscription->parkingId(),
            ':sd' => $subscription->startDate()->format('Y-m-d'),
            ':ed' => $subscription->endDate()->format('Y-m-d'),
            ':slots' => $slotsJson ?: '[]',
        ]);

        $id = (int) $this->pdo->lastInsertId();
        return $subscription->withId($id);
    }

    public function listByUserId(int $userId): array
    {
        $sql = "SELECT * FROM subscriptions WHERE user_id = :uid ORDER BY id DESC";
        $st = $this->pdo->prepare($sql);
        $st->execute([':uid' => $userId]);

        $out = [];
        while ($r = $st->fetch(PDO::FETCH_ASSOC)) {
            $out[] = $this->hydrate($r);
        }
        return $out;
    }

    public function listByParkingId(int $parkingId): array
    {
        $sql = "SELECT * FROM subscriptions WHERE parking_id = :pid ORDER BY id DESC";
        $st = $this->pdo->prepare($sql);
        $st->execute([':pid' => $parkingId]);

        $out = [];
        while ($r = $st->fetch(PDO::FETCH_ASSOC)) {
            $out[] = $this->hydrate($r);
        }
        return $out;
    }

    public function countActiveNow(int $parkingId, string $at): int
    {
        $dt = \DateTimeImmutable::createFromFormat('Y-m-d H:i:s', $at);
        if (!$dt)
            return 0;

        $date = $dt->format('Y-m-d');
        $time = $dt->format('H:i');

        $sql = "SELECT start_date, end_date, weekly_slots
                FROM subscriptions
                WHERE parking_id = :pid
                  AND start_date <= :d
                  AND end_date >= :d";
        $st = $this->pdo->prepare($sql);
        $st->execute([':pid' => $parkingId, ':d' => $date]);

        $count = 0;
        while ($row = $st->fetch(PDO::FETCH_ASSOC)) {
            $slots = json_decode((string) $row['weekly_slots'], true);
            if (!is_array($slots))
                $slots = [];

            if (SubscriptionSchedule::isActiveAt($date, $time, (string) $row['start_date'], (string) $row['end_date'], $slots)) {
                $count++;
            }
        }
        return $count;
    }

    public function countActiveForSlot(int $parkingId, string $startAt, string $endAt): int
    {
        $start = \DateTimeImmutable::createFromFormat('Y-m-d H:i:s', $startAt);
        $end = \DateTimeImmutable::createFromFormat('Y-m-d H:i:s', $endAt);
        if (!$start || !$end || $end <= $start)
            return 0;

        $fromDate = $start->format('Y-m-d');
        $toDate = $end->format('Y-m-d');

        $sql = "SELECT start_date, end_date, weekly_slots
                FROM subscriptions
                WHERE parking_id = :pid
                  AND start_date <= :toDate
                  AND end_date >= :fromDate";
        $st = $this->pdo->prepare($sql);
        $st->execute([':pid' => $parkingId, ':fromDate' => $fromDate, ':toDate' => $toDate]);

        $count = 0;
        while ($row = $st->fetch(PDO::FETCH_ASSOC)) {
            $slots = json_decode((string) $row['weekly_slots'], true);
            if (!is_array($slots))
                $slots = [];

            if (SubscriptionSchedule::overlapsSlot($startAt, $endAt, (string) $row['start_date'], (string) $row['end_date'], $slots)) {
                $count++;
            }
        }
        return $count;
    }

    private function hydrate(array $r): Subscription
    {
        $slots = json_decode((string) ($r['weekly_slots'] ?? '[]'), true);
        if (!is_array($slots))
            $slots = [];

        return new Subscription(
            isset($r['id']) ? (int) $r['id'] : null,
            (int) $r['user_id'],
            (int) $r['parking_id'],
            new \DateTimeImmutable((string) $r['start_date']),
            new \DateTimeImmutable((string) $r['end_date']),
            $slots
        );
    }
    public function existsOverlappingForUserParking(int $userId, int $parkingId, string $startDate, string $endDate): bool
    {
        // Overlap date-range: A.start <= B.end AND A.end >= B.start
        $sql = "SELECT 1
            FROM subscriptions
            WHERE user_id = :uid
              AND parking_id = :pid
              AND start_date <= :endDate
              AND end_date >= :startDate
            LIMIT 1";

        $st = $this->pdo->prepare($sql);
        $st->execute([
            ':uid' => $userId,
            ':pid' => $parkingId,
            ':startDate' => $startDate,
            ':endDate' => $endDate,
        ]);

        return (bool) $st->fetchColumn();
    }
public function coversUserForSlot(int $userId, int $parkingId, string $startAt, string $endAt): bool
{
    $start = new \DateTimeImmutable($startAt);
    $end   = new \DateTimeImmutable($endAt);

    $sql = "SELECT id, user_id, parking_id, start_date, end_date, weekly_slots
            FROM subscriptions
            WHERE user_id = :uid
              AND parking_id = :pid
              AND start_date <= :endDate
              AND end_date >= :startDate";

    $st = $this->pdo->prepare($sql);
    $st->execute([
        ':uid' => $userId,
        ':pid' => $parkingId,
        ':startDate' => $start->format('Y-m-d'),
        ':endDate' => $end->format('Y-m-d'),
    ]);

    $rows = $st->fetchAll(\PDO::FETCH_ASSOC) ?: [];
    foreach ($rows as $r) {
        $weekly = json_decode((string)($r['weekly_slots'] ?? '[]'), true);
        if (!is_array($weekly)) $weekly = [];

        if ($this->intervalIsCoveredByWeeklySlots($start, $end, $weekly)) {
            return true;
        }
    }

    return false;
}

/**
 * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
 */
private function intervalIsCoveredByWeeklySlots(\DateTimeImmutable $start, \DateTimeImmutable $end, array $weeklySlots): bool
{
    $cur = $start;

    while ($cur->format('Y-m-d') !== $end->format('Y-m-d')) {
        $dayEnd = $cur->setTime(23, 59, 59);
        if (!$this->segmentCoveredForDay($cur, $dayEnd, $weeklySlots)) return false;
        $cur = $dayEnd->modify('+1 second');
    }

    return $this->segmentCoveredForDay($cur, $end, $weeklySlots);
}

/**
 * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
 */
private function segmentCoveredForDay(\DateTimeImmutable $segStart, \DateTimeImmutable $segEnd, array $weeklySlots): bool
{
    $dow = (int)$segStart->format('N');
    $startTime = $segStart->format('H:i');
    $endTime   = $segEnd->format('H:i');

    foreach ($weeklySlots as $slot) {
        $sdow  = (int)($slot['dow'] ?? 0);
        $sfrom = (string)($slot['start'] ?? '');
        $sto   = (string)($slot['end'] ?? '');

        if ($sdow < 1 || $sdow > 7 || $sfrom === '' || $sto === '') continue;

        if ($sfrom <= $sto && $sdow === $dow) {
            if ($startTime >= $sfrom && $endTime <= $sto) return true;
        }

        if ($sfrom > $sto) {
            if ($sdow === $dow && $startTime >= $sfrom) return true;

            $nextDow = $sdow === 7 ? 1 : $sdow + 1;
            if ($nextDow === $dow && $endTime <= $sto) return true;
        }
    }

    return false;
}

}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlUserRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\User;
use App\Domain\Repository\UserRepository;
use PDO;

final class SqlUserRepository implements UserRepository
{
    public function __construct(private PDO $pdo) {}

    private function hydrate(array $r): User
    {
        return new User(
            (int)$r['id'],
            (string)$r['email'],
            (string)$r['password_hash'],
            (string)$r['role'],

            $r['firstname'] ?? null,
            $r['lastname'] ?? null,

            (bool)$r['two_factor_enabled'],
            (string)$r['two_factor_method'],
            $r['two_factor_last_code'] ?? null,
            !empty($r['two_factor_expires_at']) ? new \DateTimeImmutable($r['two_factor_expires_at']) : null,
            $r['two_factor_phone'] ?? null,
            $r['two_factor_totp_secret'] ?? null,
        );
    }

    public function findById(int $id): ?User
    {
        $st = $this->pdo->prepare('SELECT * FROM users WHERE id = ?');
        $st->execute([$id]);
        $r = $st->fetch(PDO::FETCH_ASSOC);
        return $r ? $this->hydrate($r) : null;
    }

    public function findByEmail(string $email): ?User
    {
        $st = $this->pdo->prepare('SELECT * FROM users WHERE email = ?');
        $st->execute([$email]);
        $r = $st->fetch(PDO::FETCH_ASSOC);
        return $r ? $this->hydrate($r) : null;
    }

    public function create(
        string $email,
        string $passwordHash,
        string $role = 'user',
        ?string $firstname = null,
        ?string $lastname = null
    ): User {
        $st = $this->pdo->prepare(
            "INSERT INTO users (email, password_hash, role, firstname, lastname, two_factor_enabled, two_factor_method)
             VALUES (?, ?, ?, ?, ?, 0, 'email')"
        );

        $st->execute([$email, $passwordHash, $role, $firstname, $lastname]);
        $id = (int)$this->pdo->lastInsertId();

        return new User(
            $id, $email, $passwordHash, $role,
            $firstname, $lastname,
            false, 'email', null, null, null, null
        );
    }

    public function save(User $u): void
    {
        $st = $this->pdo->prepare(
            "UPDATE users SET
                email = ?,
                password_hash = ?,
                role = ?,
                firstname = ?,
                lastname = ?,
                two_factor_enabled = ?,
                two_factor_method = ?,
                two_factor_last_code = ?,
                two_factor_expires_at = ?,
                two_factor_phone = ?,
                two_factor_totp_secret = ?
             WHERE id = ?"
        );

        $exp = $u->twoFactorExpiresAt()?->format('Y-m-d H:i:s');

        $st->execute([
            $u->email(),
            $u->passwordHash(),
            $u->role(),
            $u->firstname(),
            $u->lastname(),
            $u->twoFactorEnabled() ? 1 : 0,
            $u->twoFactorMethod(),
            $u->twoFactorLastCode(),
            $exp,
            $u->twoFactorPhone(),
            $u->twoFactorTotpSecret(),
            $u->id(),
        ]);
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/Json/JsonReservationRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence\Json;

use App\Domain\Entity\Reservation;
use App\Domain\Repository\ReservationRepository;

final class JsonReservationRepository implements ReservationRepository
{
    public function __construct(
        private readonly string $reservationsPath,
        private readonly ?string $stationnementsPath = null
    ) {}

    /** @return array<int, array<string,mixed>> */
    private function readRows(): array
    {
        if (!is_file($this->reservationsPath)) {
            return [];
        }

        $raw = file_get_contents($this->reservationsPath);
        $data = json_decode($raw ?: '[]', true);

        return is_array($data) ? $data : [];
    }

    private function debug(string $msg): void
    {
        if (($_ENV['APP_ENV'] ?? '') === 'test') {
            return;
        }
        error_log($msg);
    }

    /** @param array<int, array<string,mixed>> $rows */
    private function writeRows(array $rows): void
    {
        $dir = dirname($this->reservationsPath);
        if (!is_dir($dir)) {
            mkdir($dir, 0777, true);
        }

        $json = json_encode(array_values($rows), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);

        $this->debug("[JSON] reservationsPath=" . $this->reservationsPath);
        $this->debug("[JSON] reservationsDir=" . $dir);
        $this->debug("[JSON] dirExists=" . (is_dir($dir) ? "yes" : "no"));
        $this->debug("[JSON] dirWritable=" . (is_writable($dir) ? "yes" : "no"));

        $bytes = file_put_contents($this->reservationsPath, $json, LOCK_EX);
        $this->debug("[JSON] bytesWritten=" . var_export($bytes, true));

        if ($bytes === false) {
            $err = error_get_last();
            $this->debug("[JSON] write error=" . var_export($err, true));
        }
    }

    /** @param array<string,mixed> $row */
    private function hydrate(array $row): Reservation
    {
        return new Reservation(
            isset($row['id']) ? (int) $row['id'] : null,
            (int) $row['user_id'],
            (int) $row['parking_id'],
            new \DateTimeImmutable((string) $row['start_at']),
            new \DateTimeImmutable((string) $row['end_at']),
            new \DateTimeImmutable((string) $row['created_at']),
            (string) $row['vehicle_type'],
            (float) $row['amount']
        );
    }

    /** @return Reservation[] */
    private function hydrateAll(array $rows): array
    {
        return array_map(fn(array $r) => $this->hydrate($r), $rows);
    }

    /** @return array<string,mixed> */
    private function toRow(Reservation $r): array
    {
        return [
            'id' => $r->id(),
            'user_id' => $r->userId(),
            'parking_id' => $r->parkingId(),
            'start_at' => $r->startAt()->format('Y-m-d H:i:s'),
            'end_at' => $r->endAt()->format('Y-m-d H:i:s'),
            'vehicle_type' => $r->vehicleType(),
            'amount' => $r->amount(),
            'created_at' => $r->createdAt()->format('Y-m-d H:i:s'),
        ];
    }

    private function nextId(array $rows): int
    {
        $max = 0;
        foreach ($rows as $r) {
            $max = max($max, (int) ($r['id'] ?? 0));
        }
        return $max + 1;
    }

    // -------------------------
    // Interface ReservationRepository
    // -------------------------

    public function findById(int $id): ?Reservation
    {
        foreach ($this->readRows() as $row) {
            if ((int) ($row['id'] ?? 0) === $id) {
                return $this->hydrate($row);
            }
        }
        return null;
    }

    public function save(Reservation $reservation): Reservation
    {
        $rows = $this->readRows();

        if ($reservation->id() === null) {
            $id = $this->nextId($rows);
            $saved = $reservation->withId($id);

            $rows[] = $this->toRow($saved);
            $this->writeRows($rows);

            return $saved;
        }

        // Update si jamais tu lâ€™utilises plus tard
        $updated = false;
        foreach ($rows as $i => $row) {
            if ((int) ($row['id'] ?? 0) === (int) $reservation->id()) {
                $rows[$i] = $this->toRow($reservation);
                $updated = true;
                break;
            }
        }

        if ($updated) {
            $this->writeRows($rows);
        }

        return $reservation;
    }

    public function findByUserId(int $userId): array
    {
        $rows = array_filter(
            $this->readRows(),
            fn(array $r) => (int) $r['user_id'] === $userId
        );

        // ORDER BY start_at DESC
        usort($rows, fn($a, $b) => strcmp((string) $b['start_at'], (string) $a['start_at']));

        return $this->hydrateAll($rows);
    }

    public function findByParkingId(int $parkingId): array
    {
        $rows = array_filter(
            $this->readRows(),
            fn(array $r) => (int) $r['parking_id'] === $parkingId
        );

        // ORDER BY start_at DESC
        usort($rows, fn($a, $b) => strcmp((string) $b['start_at'], (string) $a['start_at']));

        return $this->hydrateAll($rows);
    }

    public function countOverlappingForParking(
        int $parkingId,
        \DateTimeImmutable $startAt,
        \DateTimeImmutable $endAt
    ): int {
        $start = $startAt->format('Y-m-d H:i:s');
        $end = $endAt->format('Y-m-d H:i:s');

        $count = 0;
        foreach ($this->readRows() as $r) {
            if ((int) $r['parking_id'] !== $parkingId) {
                continue;
            }

            // start_at < end_at AND end_at > start_at
            if ((string) $r['start_at'] < $end && (string) $r['end_at'] > $start) {
                $count++;
            }
        }

        return $count;
    }

    public function listByParking(int $parkingId, ?string $from, ?string $to): array
    {
        $rows = array_filter(
            $this->readRows(),
            fn(array $r) => (int) $r['parking_id'] === $parkingId
        );

        if ($from) {
            // end_at >= from
            $rows = array_filter($rows, fn(array $r) => (string) $r['end_at'] >= $from);
        }
        if ($to) {
            // start_at <= to
            $rows = array_filter($rows, fn(array $r) => (string) $r['start_at'] <= $to);
        }

        // ORDER BY start_at ASC
        usort($rows, fn($a, $b) => strcmp((string) $a['start_at'], (string) $b['start_at']));

        return array_map(
            fn(array $r) => [
                'id' => (int) $r['id'],
                'user_id' => (int) $r['user_id'],
                'parking_id' => (int) $r['parking_id'],
                'start_at' => (string) $r['start_at'],
                'end_at' => (string) $r['end_at'],
                'vehicle_type' => (string) $r['vehicle_type'],
                'amount' => (float) $r['amount'],
                'created_at' => (string) $r['created_at'],
            ],
            $rows
        );
    }

    public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int
    {
        // Si stationnementsPath n'est pas fourni, on ne peut pas exclure les "dÃ©jÃ  entrÃ©s"
        // => on retombe sur overlap simple (au moins Ã§a reste cohÃ©rent et Ã§a ne crashe pas).
        $activeReservationIds = [];

        if ($this->stationnementsPath && is_file($this->stationnementsPath)) {
            $raw = file_get_contents($this->stationnementsPath);
            $st = json_decode($raw ?: '[]', true);

            if (is_array($st)) {
                foreach ($st as $s) {
                    if (($s['exited_at'] ?? null) === null) {
                        $rid = (int) ($s['reservation_id'] ?? 0);
                        if ($rid > 0) {
                            $activeReservationIds[$rid] = true;
                        }
                    }
                }
            }
        }

        $rows = array_filter(
            $this->readRows(),
            fn(array $r) => (int) $r['parking_id'] === $parkingId
        );

        $count = 0;
        foreach ($rows as $r) {
            $rid = (int) ($r['id'] ?? 0);

            if ($rid > 0 && isset($activeReservationIds[$rid])) {
                continue;
            }

            $rs = (string) $r['start_at'];
            $re = (string) $r['end_at'];

            // NOT (end_at <= start OR start_at >= end)
            $overlap = !($re <= $startAt || $rs >= $endAt);
            if ($overlap) {
                $count++;
            }
        }

        return $count;
    }

    public function existsOverlappingForUser(int $userId, string $startAt, string $endAt): bool
    {
        foreach ($this->readRows() as $r) {
            if ((int)($r['user_id'] ?? 0) !== $userId) {
                continue;
            }

            $s = (string)($r['start_at'] ?? '');
            $e = (string)($r['end_at'] ?? '');

            if ($s === '' || $e === '') {
                continue;
            }

            // overlap strict: start_at < endAt AND end_at > startAt
            if ($s < $endAt && $e > $startAt) {
                return true;
            }
        }

        return false;
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/Json/JsonStationnementRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence\Json;

use App\Domain\Entity\Stationnement;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;

final class JsonStationnementRepository implements StationnementRepository
{
    public function __construct(
        private readonly string $path,
        private readonly ReservationRepository $reservationRepo
    ) {}

    /** @return array<int, array<string,mixed>> */
    private function readRows(): array
    {
        if (!is_file($this->path)) return [];

        $raw = file_get_contents($this->path);
        $data = json_decode($raw ?: '[]', true);

        return is_array($data) ? $data : [];
    }

    /** @param array<int, array<string,mixed>> $rows */
    private function writeRows(array $rows): void
    {
        $dir = dirname($this->path);
        if (!is_dir($dir)) {
            mkdir($dir, 0777, true);
        }

        file_put_contents(
            $this->path,
            json_encode(array_values($rows), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE),
            LOCK_EX
        );
    }

    private function nextId(array $rows): int
    {
        $max = 0;
        foreach ($rows as $r) {
            $max = max($max, (int)($r['id'] ?? 0));
        }
        return $max + 1;
    }

    /** @param array<string,mixed> $row */
    private function hydrate(array $row): Stationnement
    {
        return new Stationnement(
            isset($row['id']) ? (int)$row['id'] : null,
            (int)$row['reservation_id'],
            new \DateTimeImmutable((string)$row['entered_at']),
            ($row['exited_at'] ?? null) ? new \DateTimeImmutable((string)$row['exited_at']) : null,
            array_key_exists('billed_amount', $row) ? ($row['billed_amount'] !== null ? (float)$row['billed_amount'] : null) : null,
            array_key_exists('penalty_amount', $row) ? ($row['penalty_amount'] !== null ? (float)$row['penalty_amount'] : null) : null,
            new \DateTimeImmutable((string)$row['created_at'])
        );
    }

    /** @return array<string,mixed> */
    private function toRow(Stationnement $s): array
    {
        return [
            'id' => $s->id(),
            'reservation_id' => $s->reservationId(),
            'entered_at' => $s->enteredAt()->format('Y-m-d H:i:s'),
            'exited_at' => $s->exitedAt()?->format('Y-m-d H:i:s'),
            'billed_amount' => $s->billedAmount(),
            'penalty_amount' => $s->penaltyAmount(),
            'created_at' => $s->createdAt()->format('Y-m-d H:i:s'),
        ];
    }

    private function parkingIdFromReservationId(int $reservationId): ?int
    {
        $res = $this->reservationRepo->findById($reservationId);
        return $res ? $res->parkingId() : null;
    }

    public function save(Stationnement $s): Stationnement
    {
        $rows = $this->readRows();

        if ($s->id() === null) {
            $id = $this->nextId($rows);
            $saved = $s->withId($id);

            $rows[] = $this->toRow($saved);
            $this->writeRows($rows);

            return $saved;
        }

        // Pas d'update en SQL dans save(), mais on peut le supporter sans casser
        foreach ($rows as $i => $row) {
            if ((int)($row['id'] ?? 0) === (int)$s->id()) {
                $rows[$i] = $this->toRow($s);
                $this->writeRows($rows);
                break;
            }
        }

        return $s;
    }

    public function findActiveByReservationId(int $reservationId): ?Stationnement
    {
        $rows = array_values(array_filter(
            $this->readRows(),
            fn(array $r) => (int)$r['reservation_id'] === $reservationId && ($r['exited_at'] ?? null) === null
        ));

        if (!$rows) return null;

        // SQL: ORDER BY entered_at DESC LIMIT 1
        usort($rows, fn($a, $b) => strcmp((string)$b['entered_at'], (string)$a['entered_at']));
        return $this->hydrate($rows[0]);
    }

    public function close(
        int $stationnementId,
        \DateTimeImmutable $exitedAt,
        float $billedAmount,
        float $penaltyAmount
    ): void {
        $rows = $this->readRows();

        foreach ($rows as $i => $row) {
            if ((int)($row['id'] ?? 0) === $stationnementId) {
                $rows[$i]['exited_at'] = $exitedAt->format('Y-m-d H:i:s');
                $rows[$i]['billed_amount'] = $billedAmount;
                $rows[$i]['penalty_amount'] = $penaltyAmount;
                $this->writeRows($rows);
                return;
            }
        }
    }

    public function findLastByReservationId(int $reservationId): ?Stationnement
    {
        $rows = array_values(array_filter(
            $this->readRows(),
            fn(array $r) => (int)$r['reservation_id'] === $reservationId
        ));

        if (!$rows) return null;

        // SQL: ORDER BY entered_at DESC LIMIT 1
        usort($rows, fn($a, $b) => strcmp((string)$b['entered_at'], (string)$a['entered_at']));
        return $this->hydrate($rows[0]);
    }

    public function listActiveByParkingId(int $parkingId): array
    {
        $active = [];

        foreach ($this->readRows() as $r) {
            if (($r['exited_at'] ?? null) !== null) continue;

            $rid = (int)$r['reservation_id'];
            $pid = $this->parkingIdFromReservationId($rid);

            if ($pid === $parkingId) {
                $active[] = $r;
            }
        }

        // SQL: ORDER BY s.entered_at DESC
        usort($active, fn($a, $b) => strcmp((string)$b['entered_at'], (string)$a['entered_at']));

        // SQL renvoie des tableaux avec ces colonnes
        return array_map(
            fn(array $r) => [
                'id' => (int)$r['id'],
                'reservation_id' => (int)$r['reservation_id'],
                'entered_at' => (string)$r['entered_at'],
                'exited_at' => $r['exited_at'] ?? null,
                'billed_amount' => ($r['billed_amount'] ?? null) !== null ? (float)$r['billed_amount'] : null,
                'penalty_amount' => ($r['penalty_amount'] ?? null) !== null ? (float)$r['penalty_amount'] : null,
                'created_at' => (string)$r['created_at'],
            ],
            $active
        );
    }

    public function countActiveByParkingId(int $parkingId): int
    {
        // SQL fait un COUNT sur active, donc on reproduit
        $count = 0;

        foreach ($this->readRows() as $r) {
            if (($r['exited_at'] ?? null) !== null) continue;

            $rid = (int)$r['reservation_id'];
            $pid = $this->parkingIdFromReservationId($rid);

            if ($pid === $parkingId) $count++;
        }

        return $count;
    }

    public function revenueForParking(string $from, string $to, int $parkingId): array
    {
        // SQL:
        // exited_at IS NOT NULL
        // exited_at >= from
        // exited_at < to (borne haute exclusive)
        $countExits = 0;
        $totalBilled = 0.0;
        $totalPenalty = 0.0;

        foreach ($this->readRows() as $r) {
            $exited = $r['exited_at'] ?? null;
            if ($exited === null) continue;

            $rid = (int)$r['reservation_id'];
            $pid = $this->parkingIdFromReservationId($rid);
            if ($pid !== $parkingId) continue;

            $exitedAt = (string)$exited;
            if ($exitedAt < $from) continue;
            if ($exitedAt >= $to) continue; // borne exclusive

            $countExits++;
            $totalBilled += (float)($r['billed_amount'] ?? 0.0);
            $totalPenalty += (float)($r['penalty_amount'] ?? 0.0);
        }

        return [
            'count_exits'   => $countExits,
            'total_billed'  => $totalBilled,
            'total_penalty' => $totalPenalty,
            'total'         => $totalBilled + $totalPenalty,
        ];
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/Json/JsonSubscriptionRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence\Json;

use App\Domain\Entity\Subscription;
use App\Domain\Repository\SubscriptionRepository;
use App\Domain\Service\SubscriptionSchedule;

final class JsonSubscriptionRepository implements SubscriptionRepository
{
    public function __construct(private readonly string $path)
    {
    }

    /** @return array<int, array<string,mixed>> */
    private function read(): array
    {
        if (!is_file($this->path))
            return [];
        $raw = file_get_contents($this->path);
        $data = json_decode($raw ?: '[]', true);
        return is_array($data) ? $data : [];
    }

    private function write(array $rows): void
    {
        $dir = dirname($this->path);
        if (!is_dir($dir))
            @mkdir($dir, 0777, true);
        file_put_contents($this->path, json_encode($rows, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    }

    public function save(Subscription $subscription): Subscription
    {
        $rows = $this->read();
        $nextId = 1;
        foreach ($rows as $r)
            $nextId = max($nextId, (int) ($r['id'] ?? 0) + 1);

        $row = [
            'id' => $subscription->id() ?? $nextId,
            'user_id' => $subscription->userId(),
            'parking_id' => $subscription->parkingId(),
            'start_date' => $subscription->startDate()->format('Y-m-d'),
            'end_date' => $subscription->endDate()->format('Y-m-d'),
            'weekly_slots' => $subscription->weeklySlots(),
            'created_at' => (new \DateTimeImmutable('now'))->format('c'),
        ];

        $rows[] = $row;
        $this->write($rows);

        return $subscription->withId((int) $row['id']);
    }

    public function listByUserId(int $userId): array
    {
        $out = [];
        foreach ($this->read() as $r) {
            if ((int) ($r['user_id'] ?? 0) !== $userId)
                continue;
            $out[] = $this->hydrate($r);
        }
        return $out;
    }

    public function listByParkingId(int $parkingId): array
    {
        $out = [];
        foreach ($this->read() as $r) {
            if ((int) ($r['parking_id'] ?? 0) !== $parkingId)
                continue;
            $out[] = $this->hydrate($r);
        }
        return $out;
    }

    public function countActiveNow(int $parkingId, string $at): int
    {
        $dt = \DateTimeImmutable::createFromFormat('Y-m-d H:i:s', $at);
        if (!$dt)
            return 0;

        $date = $dt->format('Y-m-d');
        $time = $dt->format('H:i');

        $count = 0;
        foreach ($this->read() as $r) {
            if ((int) ($r['parking_id'] ?? 0) !== $parkingId)
                continue;

            $startDate = (string) ($r['start_date'] ?? '');
            $endDate = (string) ($r['end_date'] ?? '');
            $slots = $r['weekly_slots'] ?? [];
            if (!is_array($slots))
                $slots = [];

            if (SubscriptionSchedule::isActiveAt($date, $time, $startDate, $endDate, $slots)) {
                $count++;
            }
        }
        return $count;
    }

    public function countActiveForSlot(int $parkingId, string $startAt, string $endAt): int
    {
        $count = 0;
        foreach ($this->read() as $r) {
            if ((int) ($r['parking_id'] ?? 0) !== $parkingId)
                continue;

            $startDate = (string) ($r['start_date'] ?? '');
            $endDate = (string) ($r['end_date'] ?? '');
            $slots = $r['weekly_slots'] ?? [];
            if (!is_array($slots))
                $slots = [];

            if (SubscriptionSchedule::overlapsSlot($startAt, $endAt, $startDate, $endDate, $slots)) {
                $count++;
            }
        }
        return $count;
    }

    private function hydrate(array $r): Subscription
    {
        $slots = $r['weekly_slots'] ?? [];
        if (!is_array($slots))
            $slots = [];

        return new Subscription(
            isset($r['id']) ? (int) $r['id'] : null,
            (int) $r['user_id'],
            (int) $r['parking_id'],
            new \DateTimeImmutable((string) $r['start_date']),
            new \DateTimeImmutable((string) $r['end_date']),
            $slots
        );
    }
    public function existsOverlappingForUserParking(int $userId, int $parkingId, string $startDate, string $endDate): bool
    {
        foreach ($this->read() as $r) {
            if ((int) ($r['user_id'] ?? 0) !== $userId)
                continue;
            if ((int) ($r['parking_id'] ?? 0) !== $parkingId)
                continue;

            $sd = (string) ($r['start_date'] ?? '');
            $ed = (string) ($r['end_date'] ?? '');

            if ($sd === '' || $ed === '')
                continue;

            // overlap: sd <= endDate && ed >= startDate
            if ($sd <= $endDate && $ed >= $startDate) {
                return true;
            }
        }
        return false;
    }
    public function coversUserForSlot(int $userId, int $parkingId, string $startAt, string $endAt): bool
{
    $start = new \DateTimeImmutable($startAt);
    $end   = new \DateTimeImmutable($endAt);

    foreach ($this->listByUserId($userId) as $sub) {
        if ($sub->parkingId() !== $parkingId) continue;

        // date range du contrat
        if ($sub->startDate() > $end || $sub->endDate() < $start) {
            continue;
        }

        if ($this->intervalIsCoveredByWeeklySlots($start, $end, $sub->weeklySlots())) {
            return true;
        }
    }

    return false;
}

/**
 * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
 */
private function intervalIsCoveredByWeeklySlots(\DateTimeImmutable $start, \DateTimeImmutable $end, array $weeklySlots): bool
{
    // On split par jour pour gÃ©rer proprement les slots qui traversent minuit.
    $cur = $start;

    while ($cur->format('Y-m-d') !== $end->format('Y-m-d')) {
        $dayEnd = $cur->setTime(23, 59, 59);
        if (!$this->segmentCoveredForDay($cur, $dayEnd, $weeklySlots)) return false;
        $cur = $dayEnd->modify('+1 second');
    }

    return $this->segmentCoveredForDay($cur, $end, $weeklySlots);
}

/**
 * VÃ©rifie que [segStart..segEnd] est couvert par AU MOINS un slot (en tenant compte des slots â€œcross midnightâ€).
 * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
 */
private function segmentCoveredForDay(\DateTimeImmutable $segStart, \DateTimeImmutable $segEnd, array $weeklySlots): bool
{
    $dow = (int)$segStart->format('N'); // 1..7
    $startTime = $segStart->format('H:i');
    $endTime   = $segEnd->format('H:i');

    foreach ($weeklySlots as $slot) {
        $sdow  = (int)($slot['dow'] ?? 0);
        $sfrom = (string)($slot['start'] ?? '');
        $sto   = (string)($slot['end'] ?? '');

        if ($sdow < 1 || $sdow > 7 || $sfrom === '' || $sto === '') continue;

        // Slot normal (ex 09:00->18:00) couvre le mÃªme dow
        if ($sfrom <= $sto && $sdow === $dow) {
            if ($startTime >= $sfrom && $endTime <= $sto) return true;
        }

        // Slot qui traverse minuit (ex 18:00->08:00)
        if ($sfrom > $sto) {
            // Partie â€œsoirâ€ du mÃªme jour: [18:00 -> 23:59]
            if ($sdow === $dow && $startTime >= $sfrom) {
                return true; // segment du jour est forcÃ©ment <= 23:59:59
            }

            // Partie â€œmatinâ€ du lendemain: [00:00 -> 08:00]
            $nextDow = $sdow === 7 ? 1 : $sdow + 1;
            if ($nextDow === $dow && $endTime <= $sto) {
                return true;
            }
        }
    }

    return false;
}

}



================================================
FILE: Backend/src/Infrastructure/Security/JwtManager.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Security;

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

final class JwtManager
{
    public function __construct(
        private string $secret,
        private int $accessTtl,
        private int $refreshTtl
    ) {
    }

    public function issueFor(int $userId, string $role): array
    {
        $now = time();
        $access = [
            'iat' => $now,
            'nbf' => $now,
            'exp' => $now + $this->accessTtl,
            'sub' => $userId,
            'role' => $role,
            'typ' => 'access'
        ];
        $refresh = [
            'iat' => $now,
            'nbf' => $now,
            'exp' => $now + $this->refreshTtl,
            'sub' => $userId,
            'typ' => 'refresh'
        ];
        return [$this->encode($access), $this->encode($refresh)];
    }

    public function encode(array $payload): string
    {
        return JWT::encode($payload, $this->secret, 'HS256');
    }

    public function decode(string $jwt): ?array
    {
        try {
            return (array) JWT::decode($jwt, new Key($this->secret, 'HS256'));
        } catch (\Throwable) {
            return null;
        }
    }

    // --- Cookies (HttpOnly)
    public function setAccessCookie(string $token): void
    {
        $this->cookie('ACCESS_TOKEN', $token, $this->accessTtl);
    }
    public function setRefreshCookie(string $token): void
    {
        $this->cookie('REFRESH_TOKEN', $token, $this->refreshTtl);
    }
    public function clearAuthCookies(): void
    {
        $this->cookie('ACCESS_TOKEN', '', -3600);
        $this->cookie('REFRESH_TOKEN', '', -3600);
        $this->cookie('P2_AUTH', '', -3600);
    }
    private function cookie(string $name, string $value, int $ttl): void
    {
        $secure = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on';
        setcookie($name, $value, [
            'expires' => time() + $ttl,
            'path' => '/',
            'secure' => $secure,
            'httponly' => true,
            'samesite' => $secure ? 'None' : 'Lax'
        ]);
    }

    // --- Helpers â€œlectureâ€
    public function readAccessFromCookie(): ?array
    {
        $raw = $_COOKIE['ACCESS_TOKEN'] ?? '';
        return $raw ? $this->decode($raw) : null;
    }
    public function readRefreshFromCookie(): ?array
    {
        $raw = $_COOKIE['REFRESH_TOKEN'] ?? '';
        return $raw ? $this->decode($raw) : null;
    }

    // --- 2FA (pending token court)
    public function issuePending2FAToken(int $userId): string
    {
        $now = time();
        $p2 = ['iat' => $now, 'nbf' => $now, 'exp' => $now + 300, 'sub' => $userId, 'typ' => 'p2'];
        return $this->encode($p2);
    }
    public function setPending2FACookie(string $token): void
    {
        $this->cookie('P2_AUTH', $token, 300);
    }
    public function readPending2FA(): ?array
    {
        $raw = $_COOKIE['P2_AUTH'] ?? '';
        return $raw ? $this->decode($raw) : null;
    }
}



================================================
FILE: Backend/src/Infrastructure/Security/PasswordHasher.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Security;

final class PasswordHasher {
  public function hash(string $plain): string {
    return password_hash($plain, PASSWORD_ARGON2ID);
  }
  public function verify(string $plain, string $hash): bool {
    return password_verify($plain, $hash);
  }
}



================================================
FILE: Backend/src/UseCase/Auth/ConfigureTwoFactorMethod.php
================================================
class ConfigureTwoFactorMethod
{
    public function __construct(
        private UserRepository $userRepository
    ) {}

    public function execute(int $userId, string $method): array
    {
        $allowed = ['email', 'sms', 'totp'];
        if (!in_array($method, $allowed, true)) {
            throw new \InvalidArgumentException('Invalid 2FA method');
        }

        $user = $this->userRepository->findById($userId);

        if (!$user) {
            throw new \RuntimeException('User not found');
        }

        $user->enableTwoFactor($method);

        $qrData = null;

        if ($method === 'totp') {
            // GÃ©nÃ©ration dâ€™un secret TOTP (genre base32)
            $secret = $this->generateTotpSecret();
            $user->setTotpSecret($secret);

            // URI TOTP standard (pour les apps)
            $qrData = $this->buildTotpProvisioningUri($user->getEmail(), $secret);
        }

        $this->userRepository->save($user);

        return [
            'method' => $method,
            'totp_uri' => $qrData, // null si pas TOTP
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Auth/GetCurrentUser.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Infrastructure\Security\JwtManager;
use App\Domain\Repository\UserRepository;

final class GetCurrentUser {
  public function __construct(private JwtManager $jwt, private UserRepository $users) {}

  public function __invoke(): ?array {
    $p = $this->jwt->readAccessFromCookie();
    if (!$p || ($p['typ'] ?? '') !== 'access') return null;
    $u = $this->users->findById((int)$p['sub']);
    if (!$u) return null;
    return ['id'=>$u->id(), 'email'=>$u->email(), 'role'=>$u->role()];
  }
}



================================================
FILE: Backend/src/UseCase/Auth/LoginUser.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\PasswordHasher;

final class LoginUser
{
    public function __construct(
        private UserRepository $users,
        private PasswordHasher $hasher,
    ) {}

    public function execute(string $email, string $password): array
    {
        $u = $this->users->findByEmail($email);

        if (!$u || !$this->hasher->verify($password, $u->passwordHash())) {
            return ['success' => false];
        }

        if ($u->twoFactorEnabled()) {
            return [
                'success'             => true,
                'two_factor_required' => true,
                'user_id'             => $u->id(),
                'role'                => $u->role(),
            ];
        }

        return [
            'success'             => true,
            'two_factor_required' => false,
            'user_id'             => $u->id(),
            'role'                => $u->role(),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Auth/Mailer.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

interface Mailer
{
    public function sendTwoFactorCodeEmail(string $to, string $code): void;
}



================================================
FILE: Backend/src/UseCase/Auth/RefreshToken.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Infrastructure\Security\JwtManager;
use App\Domain\Repository\UserRepository;

final class RefreshToken
{
  public function execute(): ?array
  {
    return $this->__invoke();
  }

  public function __construct(private JwtManager $jwt, private UserRepository $users)
  {
  }

  /** @return array{access:string}|null */
  public function __invoke(): ?array
  {
    $refresh = $this->jwt->readRefreshFromCookie();
    if (!$refresh || ($refresh['typ'] ?? '') !== 'refresh') {
      return null;
    }
    $u = $this->users->findById((int) $refresh['sub']);
    if (!$u) {
      return null;
    }
    [$access,] = $this->jwt->issueFor($u->id(), $u->role());
    return ['access' => $access];
  }
}



================================================
FILE: Backend/src/UseCase/Auth/RegisterUser.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\PasswordHasher;

final class RegisterUser
{
    public function __construct(
        private UserRepository $repo,
        private PasswordHasher $hasher
    ) {}

    public function execute(
        string $email,
        string $password,
        string $role= 'USER',
        ?string $firstname,
        ?string $lastname
    ): array {
        if ($this->repo->findByEmail($email)) {
            throw new \RuntimeException("Email already in use");
        }

        $hash = $this->hasher->hash($password);

        $user = $this->repo->create(
            $email,
            $hash,
            $role,
            $firstname,
            $lastname
        );

        return [
            'id' => $user->id(),
            'email' => $user->email(),
            'firstname' => $user->firstname(),
            'lastname' => $user->lastname(),
            'role' => $user->role(),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Auth/SmsSender.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

interface SmsSender
{
    public function sendTwoFactorSms(string $phone, string $code): void;
}



================================================
FILE: Backend/src/UseCase/Auth/StartTwoFactor.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;

final class StartTwoFactor
{
    public function __construct(
        private UserRepository $userRepository,
        private Mailer $mailer,
        private SmsSender $smsSender
    ) {}

    public function execute(int $userId): void
    {
        $user = $this->userRepository->findById($userId);

        if (!$user) {
            throw new \RuntimeException('User not found');
        }

        $method = $user->twoFactorMethod();

        // TOTP : pas de code Ã  gÃ©nÃ©rer, lâ€™app TOTP a dÃ©jÃ  le secret
        if ($method === 'totp') {
            return;
        }

        $code = str_pad((string) random_int(0, 999999), 6, '0', STR_PAD_LEFT);
        $expiresAt = (new \DateTimeImmutable())->modify('+5 minutes');

        // User est immuable -> on rÃ©cupÃ¨re la nouvelle instance
        $user = $user->with2FACode($code, $expiresAt);
        $this->userRepository->save($user);

        if ($method === 'email') {
            $this->mailer->sendTwoFactorCodeEmail($user->email(), $code);
        } elseif ($method === 'sms') {
            $phone = $user->twoFactorPhone();
            if ($phone === null) {
                throw new \RuntimeException('User has no phone number for SMS 2FA');
            }
            $this->smsSender->sendTwoFactorSms($phone, $code);
        } else {
            throw new \RuntimeException('Unknown 2FA method: '.$method);
        }
    }
}



================================================
FILE: Backend/src/UseCase/Auth/TotpVerifier.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

interface TotpVerifier
{
    public function verify(string $secret, string $code): bool;
}



================================================
FILE: Backend/src/UseCase/Auth/VerifyTwoFactor.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\JwtManager;

final class VerifyTwoFactor
{
  public function __construct(
    private UserRepository $userRepository,
    private JwtManager $jwtManager,
    private TotpVerifier $totpVerifier
  ) {
  }

  public function execute(int $userId, string $code): array
  {
    $user = $this->userRepository->findById($userId);

    if (!$user) {
      throw new \RuntimeException('User not found');
    }

    $method = $user->twoFactorMethod();
    $now = new \DateTimeImmutable();

    $valid = false;

    if ($method === 'email' || $method === 'sms') {
      // helper du domaine
      $valid = $user->hasValid2FACode($code, $now);
    } elseif ($method === 'totp') {
      if (!$user->hasTotpConfigured()) {
        throw new \RuntimeException('TOTP not configured');
      }

      $secret = $user->twoFactorTotpSecret();
      if ($secret === null) {
        throw new \RuntimeException('Missing TOTP secret');
      }

      $valid = $this->totpVerifier->verify($secret, $code);
    } else {
      throw new \RuntimeException('Unknown 2FA method: ' . $method);
    }

    if (!$valid) {
      throw new \RuntimeException('Invalid 2FA code');
    }

    // Nettoyer le challenge pour email/sms
    if ($method === 'email' || $method === 'sms') {
      $user = $user->clear2FA();
      $this->userRepository->save($user);
    }

    // GÃ©nÃ©ration des JWT
    [$accessToken, $refreshToken] = $this->jwtManager->issueFor(
      $user->id(),
      $user->role()
    );

    return [
      'access_token' => $accessToken,
      'refresh_token' => $refreshToken,
    ];
  }
}



================================================
FILE: Backend/src/UseCase/Billing/BillingCalculator.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Billing;

final class BillingCalculator
{
    public function __construct(
        private readonly int $slotMinutes = 15,
        private readonly float $penaltyMultiplier = 2.0
    ) {}

    public function billedMinutes(\DateTimeImmutable $start, \DateTimeImmutable $end): int
    {
        $seconds = max(0, $end->getTimestamp() - $start->getTimestamp());
        $minutes = (int)ceil($seconds / 60);
        $slot = $this->slotMinutes;
        return (int)(ceil($minutes / $slot) * $slot);
    }

    public function amountForMinutes(int $minutes, float $hourlyRate): float
    {
        return round(($minutes / 60) * $hourlyRate, 2);
    }

    public function compute(
        \DateTimeImmutable $enteredAt,
        \DateTimeImmutable $exitedAt,
        \DateTimeImmutable $reservedEndAt,
        float $hourlyRate
    ): array {
        $billedMin = $this->billedMinutes($enteredAt, $exitedAt);
        $base = $this->amountForMinutes($billedMin, $hourlyRate);

        $penalty = 0.0;
        if ($exitedAt > $reservedEndAt) {
            $overtimeMin = $this->billedMinutes($reservedEndAt, $exitedAt);
            $overtimeAmount = $this->amountForMinutes($overtimeMin, $hourlyRate);
            $penalty = round($overtimeAmount * ($this->penaltyMultiplier - 1.0), 2); // surcharge, pas double facturation totale
        }

        return [
            'billed_minutes' => $billedMin,
            'base_amount' => $base,
            'penalty_amount' => $penalty,
            'total_amount' => round($base + $penalty, 2),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Owner/GetMonthlyRevenueForOwner.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Owner;

use App\Domain\Repository\ParkingRepository;
use App\Domain\Repository\StationnementRepository;

final class GetMonthlyRevenueForOwner
{
    public function __construct(
        private readonly ParkingRepository $parkings,
        private readonly StationnementRepository $stationnements
    ) {}

    /** @return array<string,mixed> */
    public function execute(int $ownerId, int $parkingId, string $month): array
    {
        // month format: YYYY-MM
        if (!preg_match('/^\d{4}-\d{2}$/', $month)) {
            throw new \RuntimeException('Invalid month format. Expected YYYY-MM');
        }

        $ownerOfParking = $this->parkings->findOwnerIdByParkingId($parkingId);
        if ($ownerOfParking === null) {
            throw new \RuntimeException('Parking not found');
        }
        if ($ownerOfParking !== $ownerId) {
            throw new \RuntimeException('AccÃ¨s refusÃ©');
        }

        $from = new \DateTimeImmutable($month . '-01 00:00:00');
        $to = $from->modify('+1 month');

        $totals = $this->stationnements->revenueForParking(
            $from->format('Y-m-d H:i:s'),
            $to->format('Y-m-d H:i:s'),
            $parkingId
        );

        return [
            'parking_id' => $parkingId,
            'month' => $month,
            'from' => $from->format(\DATE_ATOM),
            'to' => $to->format(\DATE_ATOM),
            ...$totals,
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Owner/ListActiveStationnementsForOwner.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Owner;

use App\Domain\Repository\ParkingRepository;
use App\Domain\Repository\StationnementRepository;

final class ListActiveStationnementsForOwner
{
    public function __construct(
        private ParkingRepository $parkings,
        private StationnementRepository $stationnements
    ) {}

    public function execute(int $ownerId, int $parkingId): array
    {
        $parkingOwnerId = $this->parkings->findOwnerIdByParkingId($parkingId);
        if ($parkingOwnerId === null) {
            throw new \RuntimeException('Parking introuvable');
        }
        if ($parkingOwnerId !== $ownerId) {
            throw new \RuntimeException('AccÃ¨s refusÃ©');
        }

        return $this->stationnements->listActiveByParkingId($parkingId);
    }
}



================================================
FILE: Backend/src/UseCase/Owner/ListOwnerParkings.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Owner;

use App\Domain\Repository\ParkingRepository;

final class ListOwnerParkings
{
    public function __construct(private ParkingRepository $parkings) {}

    public function execute(int $ownerId): array
    {
        return $this->parkings->listByOwnerId($ownerId);
    }
}



================================================
FILE: Backend/src/UseCase/Owner/ListParkingReservationsForOwner.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Owner;

use App\Domain\Repository\ParkingRepository;
use App\Domain\Repository\ReservationRepository;

final class ListParkingReservationsForOwner
{
    public function __construct(
        private ParkingRepository $parkings,
        private ReservationRepository $reservations,
    ) {}

    public function execute(int $ownerId, int $parkingId, ?string $from, ?string $to): array
    {
        $parking = $this->parkings->findById($parkingId);
        if ($parking === null) {
            throw new \RuntimeException('Parking introuvable');
        }

        $parkingOwnerId = $this->parkings->findOwnerIdByParkingId($parkingId);
        if ($parkingOwnerId === null) {
            throw new \RuntimeException('Parking introuvable');
        }

        if ($parkingOwnerId !== $ownerId) {
            throw new \RuntimeException('AccÃ¨s refusÃ©');
        }

        return $this->reservations->listByParking($parkingId, $from, $to);
    }
}



================================================
FILE: Backend/src/UseCase/Parking/CalculateOccupancy.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Repository\SubscriptionRepository;

final class CalculateOccupancy
{
    public function __construct(
        private readonly StationnementRepository $stationnements,
        private readonly ReservationRepository $reservations,
        private readonly SubscriptionRepository $subscriptions
    ) {}

    /** Nombre de voitures actuellement dans le parking (temps rÃ©el) + abonnements actifs NOW. */
    public function now(int $parkingId): int
    {
        $at = (new \DateTimeImmutable('now'))->format('Y-m-d H:i:s');

        return $this->stationnements->countActiveByParkingId($parkingId)
            + $this->subscriptions->countActiveNow($parkingId, $at);
    }

    /**
     * Occupation sur un crÃ©neau.
     * StratÃ©gie:
     * - rÃ©servations qui chevauchent le crÃ©neau, en excluant celles dÃ©jÃ  entrÃ©es
     * - + abonnements actifs sur le crÃ©neau (occupent une place mÃªme sans entrÃ©e)
     */
    public function forSlot(int $parkingId, string $startAt, string $endAt): int
    {
        return $this->reservations->countOverlappingNotEntered($parkingId, $startAt, $endAt)
            + $this->subscriptions->countActiveForSlot($parkingId, $startAt, $endAt);
    }

    public function totalForAvailability(int $parkingId, string $startAt, string $endAt): int
    {
        return $this->now($parkingId) + $this->forSlot($parkingId, $startAt, $endAt);
    }
}



================================================
FILE: Backend/src/UseCase/Parking/CheckAvailability.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Domain\Repository\ParkingRepository;

final class CheckAvailability
{
    public function __construct(
        private readonly ParkingRepository $parkingRepo,
        private readonly CalculateOccupancy $occupancy
    ) {}

    public function execute(array $data): array
    {
        $parkingId = (int)($data['parking_id'] ?? 0);
        $startAt   = (string)($data['start_at'] ?? '');
        $endAt     = (string)($data['end_at'] ?? '');

        if ($parkingId <= 0 || $startAt === '' || $endAt === '') {
            throw new \RuntimeException('Missing fields');
        }

        $parking = $this->parkingRepo->findById($parkingId);
        if ($parking === null) {
            throw new \RuntimeException('Parking not found');
        }

        $capacity = $parking->capacity();

        // Occupation sur le crÃ©neau = prÃ©sents + rÃ©servÃ©s (pas encore entrÃ©s)
        $occupied = $this->occupancy->totalForAvailability($parkingId, $startAt, $endAt);

        $remaining = max(0, $capacity - $occupied);

        return [
            'parking_id' => $parkingId,
            'capacity'   => $capacity,
            'occupied'   => $occupied,
            'remaining'  => $remaining,
            'available'  => $remaining > 0,
            'start_at'   => (new \DateTimeImmutable($startAt))->format(DATE_ATOM),
            'end_at'     => (new \DateTimeImmutable($endAt))->format(DATE_ATOM),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/CreateParking.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Domain\Repository\ParkingRepository;

final class CreateParking
{
    public function __construct(private readonly ParkingRepository $parkingRepo) {}

    /**
     * @return array{parking_id:int}
     */
    public function execute(int $ownerId, array $data): array
    {
        $latitude    = $data['latitude'] ?? null;
        $longitude   = $data['longitude'] ?? null;
        $capacity    = (int)($data['capacity'] ?? 0);
        $hourlyRate  = $data['hourly_rate'] ?? null;
        $openingTime = (string)($data['opening_time'] ?? '');
        $closingTime = (string)($data['closing_time'] ?? '');

        if ($ownerId <= 0) {
            throw new \RuntimeException('Invalid owner');
        }

        if (!is_numeric($latitude) || !is_numeric($longitude) || $capacity <= 0 || !is_numeric($hourlyRate) || $openingTime === '' || $closingTime === '') {
            throw new \RuntimeException('Missing fields');
        }

        $id = $this->parkingRepo->create([
            'owner_id'     => $ownerId,
            'latitude'     => (float)$latitude,
            'longitude'    => (float)$longitude,
            'capacity'     => $capacity,
            'hourly_rate'  => (float)$hourlyRate,
            'opening_time' => $openingTime,
            'closing_time' => $closingTime,
        ]);

        return ['parking_id' => $id];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/GetOwnerParkings.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Domain\Repository\ParkingRepository;
use Exception;

class GetOwnerParkings {
    private ParkingRepository $parkingRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
    }

    public function execute(array $user): array {
        if ($user['role'] !== 'owner') {
            throw new Exception('Non autorisÃ©', 401);
        }

        $parkings = $this->parkingRepo->findByOwner((int)$user['id']);
        return ['parkings' => $parkings];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/GetOwnerStatistics.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ReservationRepository;
use Exception;

class GetOwnerStatistics {
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $user): array {
        if ($user['role'] !== 'owner') {
            throw new Exception('Non autorisÃ©', 401);
        }

        $revenue = $this->reservationRepo->getMonthlyRevenue((int)$user['id']);
        $activeReservations = $this->reservationRepo->countActiveByOwner((int)$user['id']);
        $activeStationnements = $this->reservationRepo->countActiveStationnementsByOwner((int)$user['id']);

        return [
            'revenus_mensuels' => $revenue,
            'reservations_en_cours' => $activeReservations,
            'stationnements_actifs' => $activeStationnements
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/GetParkingDetails.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Domain\Repository\ParkingRepository;

final class GetParkingDetails
{
    public function __construct(
        private readonly ParkingRepository $parkingRepo
    ) {}

    public function execute(int $parkingId): array
    {
        $parking = $this->parkingRepo->findById($parkingId);
        if ($parking === null) {
            throw new \RuntimeException('Parking not found');
        }

        return [
            'id' => $parking->id(),
            'capacity' => $parking->capacity(),
            'gps' => $parking->gps(),
            'hourly_rate' => $parking->hourlyRate(),
            'opening_time' => $parking->openingTime()->format('H:i:s'),
            'closing_time' => $parking->closingTime()->format('H:i:s'),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/SearchParkings.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ParkingRepository;
use App\Infrastructure\Repository\ReservationRepository;

class SearchParkings {
    private ParkingRepository $parkingRepo;
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $params): array {
        $filters = [
            'ville' => $params['ville'] ?? '',
            'vehicule' => $params['vehicule'] ?? ''
        ];
        $sort = $params['sort'] ?? null;
        $dateDebut = $params['dateDebut'] ?? null;
        $dateFin = $params['dateFin'] ?? null;

        $parkings = $this->parkingRepo->findAll($filters, $sort);

        // Si on a des dates, on calcule la dispo rÃ©elle
        if ($dateDebut && $dateFin) {
            foreach ($parkings as &$parking) {
                $reserved = $this->reservationRepo->countConfirmed((int)$parking['id'], $dateDebut, $dateFin);
                $parking['places_disponibles'] = max(0, $parking['nombre_places'] - $reserved);
            }
        } else {
            // Sinon on affiche le total
            foreach ($parkings as &$parking) {
                $parking['places_disponibles'] = $parking['nombre_places'];
            }
        }

        return [
            'parkings' => $parkings,
            'total' => count($parkings)
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/CreateReservation.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Domain\Entity\Reservation;
use App\Domain\Repository\ParkingRepository;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\SubscriptionRepository;
use App\UseCase\Parking\CalculateOccupancy;

final class CreateReservation
{
    public function __construct(
        private readonly ParkingRepository $parkingRepo,
        private readonly ReservationRepository $reservationRepo,
        private readonly CalculateOccupancy $occupancy,
        private readonly SubscriptionRepository $subscriptions
    ) {}

    public function execute(
        int $userId,
        int $parkingId,
        string $startAt,
        string $endAt,
        string $vehicleType,
        float $amount
    ): Reservation {
        $parking = $this->parkingRepo->findById($parkingId);
        if ($parking === null) {
            throw new \RuntimeException('Parking not found');
        }

        $start = new \DateTimeImmutable($startAt);
        $end   = new \DateTimeImmutable($endAt);
        if ($end <= $start) {
            throw new \RuntimeException('Invalid time range');
        }

        $startStr = $start->format('Y-m-d H:i:s');
        $endStr   = $end->format('Y-m-d H:i:s');

        // âœ… anti-abus: un user ne peut pas avoir 2 rÃ©servations qui se chevauchent
        if ($this->reservationRepo->existsOverlappingForUser($userId, $startStr, $endStr)) {
            throw new \RuntimeException('User already has a reservation overlapping this time range');
        }

        // âœ… NEW: si lâ€™utilisateur est couvert par un abonnement sur ce crÃ©neau, il nâ€™a pas besoin de rÃ©server
        if ($this->subscriptions->coversUserForSlot($userId, $parkingId, $startStr, $endStr)) {
            throw new \RuntimeException('Reservation not required: covered by an active subscription');
        }

        $capacity = $parking->capacity();

        $occupied = $this->occupancy->totalForAvailability($parkingId, $startStr, $endStr);
        if ($occupied >= $capacity) {
            throw new \RuntimeException('Parking full for this time slot');
        }

        $reservation = Reservation::create(
            $userId,
            $parkingId,
            $start,
            $end,
            $vehicleType,
            $amount
        );

        return $this->reservationRepo->save($reservation);
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/EnterReservation.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Entity\Stationnement;

final class EnterReservation
{
    public function __construct(
        private readonly ReservationRepository $reservationRepo,
        private readonly StationnementRepository $stationnementRepo
    ) {}

    public function execute(int $userId, int $reservationId): Stationnement
    {
        $res = $this->reservationRepo->findById($reservationId);
        if (!$res) {
            throw new \RuntimeException('Reservation not found');
        }

        if ($res->userId() !== $userId) {
            throw new \RuntimeException('Forbidden');
        }

        $now = new \DateTimeImmutable('now');

        // "rÃ©servation active" = now entre start et end
        if ($now < $res->startAt() || $now > $res->endAt()) {
            throw new \RuntimeException('Reservation not active');
        }

        $active = $this->stationnementRepo->findActiveByReservationId($reservationId);
        if ($active) {
            throw new \RuntimeException('Already entered');
        }

        $s = Stationnement::enter($reservationId, $now);
        return $this->stationnementRepo->save($s);
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/ExitReservation.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Repository\ParkingRepository;
use App\UseCase\Billing\BillingCalculator;

final class ExitReservation
{
    public function __construct(
        private readonly ReservationRepository $reservationRepo,
        private readonly StationnementRepository $stationnementRepo,
        private readonly ParkingRepository $parkingRepo,
        private readonly BillingCalculator $billing
    ) {}

    public function execute(int $userId, int $reservationId): array
    {
        $res = $this->reservationRepo->findById($reservationId);
        if (!$res) throw new \RuntimeException('Reservation not found');
        if ($res->userId() !== $userId) throw new \RuntimeException('Forbidden');

        $active = $this->stationnementRepo->findActiveByReservationId($reservationId);
        if (!$active) throw new \RuntimeException('Not entered');

        $parking = $this->parkingRepo->findById($res->parkingId());
        if (!$parking) throw new \RuntimeException('Parking not found');

        $now = new \DateTimeImmutable('now');

        $calc = $this->billing->compute(
            $active->enteredAt(),
            $now,
            $res->endAt(),
            $parking->hourlyRate()
        );

        $this->stationnementRepo->close(
            (int)$active->id(),
            $now,
            (float)$calc['base_amount'],
            (float)$calc['penalty_amount']
        );

        return [
            'reservation_id' => $reservationId,
            'exited_at' => $now->format(DATE_ATOM),
            'base_amount' => $calc['base_amount'],
            'penalty_amount' => $calc['penalty_amount'],
            'total_amount' => $calc['total_amount'],
            'billed_minutes' => $calc['billed_minutes'],
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/GetInvoiceHtml.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Repository\ParkingRepository;

final class GetInvoiceHtml
{
    public function __construct(
        private readonly ReservationRepository $reservationRepo,
        private readonly StationnementRepository $stationnementRepo,
        private readonly ParkingRepository $parkingRepo
    ) {}

    public function execute(int $userId, int $reservationId): string
    {
        $res = $this->reservationRepo->findById($reservationId);
        if (!$res) throw new \RuntimeException('Reservation not found');
        if ($res->userId() !== $userId) throw new \RuntimeException('Forbidden');

        $parking = $this->parkingRepo->findById($res->parkingId());
        if (!$parking) throw new \RuntimeException('Parking not found');

        $st = $this->stationnementRepo->findLastByReservationId($reservationId);

        $entered = $st?->enteredAt()?->format('Y-m-d H:i:s') ?? 'â€”';
        $exited  = $st?->exitedAt()?->format('Y-m-d H:i:s') ?? 'â€”';

        $base = $st?->billedAmount();
        $pen  = $st?->penaltyAmount();
        $total = ($base ?? 0) + ($pen ?? 0);

        return "<!doctype html>
<html lang='fr'>
<head>
<meta charset='utf-8'>
<title>Facture rÃ©servation #{$reservationId}</title>
<style>
body{font-family:Arial,sans-serif;margin:24px;color:#111}
h1{margin:0 0 12px}
.card{border:1px solid #ddd;border-radius:10px;padding:16px;margin:12px 0}
.row{display:flex;justify-content:space-between;margin:6px 0}
.small{color:#555;font-size:12px}
</style>
</head>
<body>
<h1>Facture - RÃ©servation #{$reservationId}</h1>
<div class='small'>GÃ©nÃ©rÃ©e le ".date('Y-m-d H:i:s')."</div>

<div class='card'>
  <h3>RÃ©servation</h3>
  <div class='row'><div>Parking</div><div>#{$res->parkingId()}</div></div>
  <div class='row'><div>DÃ©but rÃ©servÃ©</div><div>{$res->startAt()->format('Y-m-d H:i:s')}</div></div>
  <div class='row'><div>Fin rÃ©servÃ©e</div><div>{$res->endAt()->format('Y-m-d H:i:s')}</div></div>
  <div class='row'><div>VÃ©hicule</div><div>{$res->vehicleType()}</div></div>
</div>

<div class='card'>
  <h3>Stationnement</h3>
  <div class='row'><div>EntrÃ©e</div><div>{$entered}</div></div>
  <div class='row'><div>Sortie</div><div>{$exited}</div></div>
</div>

<div class='card'>
  <h3>Montants</h3>
  <div class='row'><div>Base</div><div>".($base !== null ? number_format($base, 2, ',', ' ') . " â‚¬" : "â€”")."</div></div>
  <div class='row'><div>PÃ©nalitÃ©</div><div>".($pen !== null ? number_format($pen, 2, ',', ' ') . " â‚¬" : "â€”")."</div></div>
  <hr>
  <div class='row'><strong>Total</strong><strong>".number_format($total, 2, ',', ' ')." â‚¬</strong></div>
</div>

<div class='small'>Tarif horaire parking: ".number_format($parking->hourlyRate(), 2, ',', ' ')." â‚¬</div>
</body>
</html>";
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/GetUserReservations.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Infrastructure\Repository\ReservationRepository;

class GetUserReservations {
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $user): array {
        $reservations = $this->reservationRepo->findByUser((int)$user['id']);
        return ['reservations' => $reservations];
    }
}



================================================
FILE: Backend/src/UseCase/Subscription/CreateSubscription.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Subscription;

use App\Domain\Entity\Subscription;
use App\Domain\Repository\SubscriptionRepository;

final class CreateSubscription
{
    public function __construct(
        private readonly SubscriptionRepository $subscriptions
    ) {}

    /**
     * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
     */
    public function execute(
        int $userId,
        int $parkingId,
        string $startDate, // 'Y-m-d'
        int $months,
        array $weeklySlots
    ): Subscription {
        if ($parkingId <= 0) {
            throw new \RuntimeException('Invalid parking_id');
        }

        if ($months < 1 || $months > 12) {
            throw new \RuntimeException('Invalid subscription duration (must be 1..12 months)');
        }

        $sd = \DateTimeImmutable::createFromFormat('Y-m-d', $startDate);
        if (!$sd) {
            throw new \RuntimeException('Invalid start_date');
        }

        // end_date: +N months - 1 day (ex: 2025-12-17 +1m => 2026-01-17 -1d => 2026-01-16)
        $ed = $sd->modify('+' . $months . ' months')->modify('-1 day');
        if ($ed < $sd) {
            throw new \RuntimeException('Invalid date range');
        }

        $weeklySlots = $this->normalizeAndValidateSlots($weeklySlots);

        $sdStr = $sd->format('Y-m-d');
        $edStr = $ed->format('Y-m-d');

        if ($this->subscriptions->existsOverlappingForUserParking($userId, $parkingId, $sdStr, $edStr)) {
            throw new \RuntimeException('Subscription already exists for this period (overlap)');
        }

        $sub = new Subscription(
            null,
            $userId,
            $parkingId,
            $sd,
            $ed,
            $weeklySlots
        );

        return $this->subscriptions->save($sub);
    }

    /**
     * @param array<int, array{dow:int,start:string,end:string}> $weeklySlots
     * @return array<int, array{dow:int,start:string,end:string}>
     */
    private function normalizeAndValidateSlots(array $weeklySlots): array
    {
        if (empty($weeklySlots)) {
            throw new \RuntimeException('weekly_slots is required');
        }

        $out = [];
        foreach ($weeklySlots as $slot) {
            $dow = (int)($slot['dow'] ?? 0);
            $start = (string)($slot['start'] ?? '');
            $end = (string)($slot['end'] ?? '');

            if ($dow < 1 || $dow > 7) {
                throw new \RuntimeException('Invalid dow in weekly_slots');
            }

            if (!preg_match('/^(?:[01]\d|2[0-3]):[0-5]\d$/', $start)) {
                throw new \RuntimeException('Invalid start time in weekly_slots');
            }

            if (!preg_match('/^(?:[01]\d|2[0-3]):[0-5]\d$/', $end)) {
                throw new \RuntimeException('Invalid end time in weekly_slots');
            }

            // Note: start > end = traverse minuit (autorisÃ©)
            $out[] = ['dow' => $dow, 'start' => $start, 'end' => $end];
        }

        return $out;
    }
}



================================================
FILE: Backend/tests/Domain/JwtManagerTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\Domain;

use App\Infrastructure\Security\JwtManager;
use PHPUnit\Framework\TestCase;

final class JwtManagerTest extends TestCase
{
    private JwtManager $jwt;

    protected function setUp(): void
    {

        $this->jwt = new JwtManager('test-secret-key', 3600, 7200);
    }

    public function testIssueForReturnsTwoValidTokens(): void
    {
        [$access, $refresh] = $this->jwt->issueFor(42, 'USER');


        $this->assertIsString($access);
        $this->assertIsString($refresh);
        $this->assertNotSame($access, $refresh);


        $accessPayload  = $this->jwt->decode($access);
        $refreshPayload = $this->jwt->decode($refresh);

        $this->assertNotNull($accessPayload);
        $this->assertNotNull($refreshPayload);

        // Access token : bon sub / role / typ
        $this->assertSame(42, $accessPayload['sub'] ?? null);
        $this->assertSame('USER', $accessPayload['role'] ?? null);
        $this->assertSame('access', $accessPayload['typ'] ?? null);

        // Refresh token : bon sub / typ
        $this->assertSame(42, $refreshPayload['sub'] ?? null);
        $this->assertSame('refresh', $refreshPayload['typ'] ?? null);

        // Les deux ont un exp
        $this->assertArrayHasKey('exp', $accessPayload);
        $this->assertArrayHasKey('exp', $refreshPayload);
    }

    public function testDecodeReturnsNullForInvalidToken(): void
    {
        $result = $this->jwt->decode('ceci-n-est-pas-un-jwt');
        $this->assertNull($result);
    }

    public function testIssuePending2FATokenHasTypeP2(): void
    {
        $token   = $this->jwt->issuePending2FAToken(99);
        $payload = $this->jwt->decode($token);

        $this->assertNotNull($payload);
        $this->assertSame(99, $payload['sub'] ?? null);
        $this->assertSame('p2', $payload['typ'] ?? null);
    }
}



================================================
FILE: Backend/tests/Infrastructure/Persistence/RepositoryParityTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\Infrastructure\Persistence;

use PDO;
use PHPUnit\Framework\TestCase;
use App\Infrastructure\Persistence\SqlReservationRepository;
use App\Infrastructure\Persistence\SqlStationnementRepository;
use App\Infrastructure\Persistence\Json\JsonReservationRepository;
use App\Infrastructure\Persistence\Json\JsonStationnementRepository;
use App\Domain\Entity\Reservation;
use App\Domain\Entity\Stationnement;

final class RepositoryParityTest extends TestCase
{
    private const DELTA = 0.0001;

    private string $tmpDir;
    private string $reservationsJson;
    private string $stationnementsJson;

    protected function setUp(): void
    {
        parent::setUp();

        $this->tmpDir = rtrim(sys_get_temp_dir(), DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR . 'parking_repo_parity';
        if (!is_dir($this->tmpDir)) {
            @mkdir($this->tmpDir, 0777, true);
        }

        $this->reservationsJson = $this->tmpDir . DIRECTORY_SEPARATOR . 'reservations_parity.json';
        $this->stationnementsJson = $this->tmpDir . DIRECTORY_SEPARATOR . 'stationnements_parity.json';

        @unlink($this->reservationsJson);
        @unlink($this->stationnementsJson);

        file_put_contents($this->reservationsJson, "[]");
        file_put_contents($this->stationnementsJson, "[]");
    }

    private function sqlPdoOrSkip(): PDO
    {
        $dsn  = $_ENV['TEST_DB_DSN']  ?? null;
        $user = $_ENV['TEST_DB_USER'] ?? null;
        $pass = $_ENV['TEST_DB_PASS'] ?? '';

        if (!$dsn || !$user) {
            $this->markTestSkipped('TEST_DB_DSN/TEST_DB_USER not set (SQL parity tests skipped).');
        }

        $pdo = new PDO((string)$dsn, (string)$user, (string)$pass, [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        ]);

        // Juste pour Ãªtre sÃ»r que tu ne pointes pas sur une DB â€œrÃ©elleâ€
        $dbName = $pdo->query('SELECT DATABASE()')->fetchColumn();
        if (is_string($dbName) && $dbName === 'parking_app') {
            $this->markTestSkipped('Refusing to run SQL parity tests on parking_app. Use parking_app_test.');
        }

        return $pdo;
    }

    private function resetSqlTables(PDO $pdo): void
    {
        // Ordre important Ã  cause des FK
        $pdo->exec('DELETE FROM stationnements');
        $pdo->exec('DELETE FROM reservations');
    }

    /**
     * Seed identique cÃ´tÃ© SQL et JSON.
     *
     * ParkingId=3
     * - reservation 1: overlap slot (pas entrÃ©e)
     * - reservation 2: overlap slot + stationnement actif (donc NOT ENTERED doit lâ€™exclure)
     * - reservation 3: pas overlap slot
     *
     * Stationnements:
     * - s1: actif (exited_at null) sur reservation 2
     * - s2: terminÃ© (exited_at dans la fenÃªtre) sur reservation 1 => revenue inclus
     * - s3: terminÃ© (exited_at hors fenÃªtre) sur reservation 3 => revenue exclu
     */
    private function seedBoth(PDO $pdo): array
    {
        $parkingId = 3;
        $userId = 10;

        // FenÃªtre test slot
        $slotStart = '2025-12-17 10:00:00';
        $slotEnd   = '2025-12-17 12:00:00';

        // FenÃªtre revenue (borne haute exclusive)
        $revFrom = '2025-12-01 00:00:00';
        $revTo   = '2026-01-01 00:00:00';

        // Reservations (en DB, id auto; en JSON, id auto aussi, donc on crÃ©e en ordre et on rÃ©cupÃ¨re ensuite)
        $r1 = Reservation::create(
            $userId,
            $parkingId,
            new \DateTimeImmutable('2025-12-17 09:30:00'),
            new \DateTimeImmutable('2025-12-17 12:30:00'),
            'car',
            12.50
        );

        $r2 = Reservation::create(
            $userId,
            $parkingId,
            new \DateTimeImmutable('2025-12-17 10:30:00'),
            new \DateTimeImmutable('2025-12-17 11:30:00'),
            'car',
            12.50
        );

        $r3 = Reservation::create(
            $userId,
            $parkingId,
            new \DateTimeImmutable('2025-12-17 14:00:00'),
            new \DateTimeImmutable('2025-12-17 15:00:00'),
            'car',
            12.50
        );

        // JSON repos
        $jsonResRepo = new JsonReservationRepository($this->reservationsJson, $this->stationnementsJson);
        $jsonStRepo  = new JsonStationnementRepository($this->stationnementsJson, $jsonResRepo);

        $jr1 = $jsonResRepo->save($r1);
        $jr2 = $jsonResRepo->save($r2);
        $jr3 = $jsonResRepo->save($r3);

        // SQL repos
        $sqlResRepo = new SqlReservationRepository($pdo);
        $sqlStRepo  = new SqlStationnementRepository($pdo);

        $sr1 = $sqlResRepo->save($r1);
        $sr2 = $sqlResRepo->save($r2);
        $sr3 = $sqlResRepo->save($r3);

        // Stationnements JSON
        // s1 actif pour r2
        $js1 = $jsonStRepo->save(Stationnement::enter((int)$jr2->id(), new \DateTimeImmutable('2025-12-17 10:40:00')));

        // s2 terminÃ© pour r1, dans fenÃªtre revenue
        $js2 = $jsonStRepo->save(Stationnement::enter((int)$jr1->id(), new \DateTimeImmutable('2025-12-17 09:40:00')));
        $jsonStRepo->close((int)$js2->id(), new \DateTimeImmutable('2025-12-17 11:00:00'), 10.00, 2.50);

        // s3 terminÃ© pour r3, hors fenÃªtre revenue (novembre)
        $js3 = $jsonStRepo->save(Stationnement::enter((int)$jr3->id(), new \DateTimeImmutable('2025-11-17 14:00:00')));
        $jsonStRepo->close((int)$js3->id(), new \DateTimeImmutable('2025-11-17 15:00:00'), 7.00, 1.00);

        // Stationnements SQL
        $ss1 = $sqlStRepo->save(Stationnement::enter((int)$sr2->id(), new \DateTimeImmutable('2025-12-17 10:40:00')));

        $ss2 = $sqlStRepo->save(Stationnement::enter((int)$sr1->id(), new \DateTimeImmutable('2025-12-17 09:40:00')));
        $sqlStRepo->close((int)$ss2->id(), new \DateTimeImmutable('2025-12-17 11:00:00'), 10.00, 2.50);

        $ss3 = $sqlStRepo->save(Stationnement::enter((int)$sr3->id(), new \DateTimeImmutable('2025-11-17 14:00:00')));
        $sqlStRepo->close((int)$ss3->id(), new \DateTimeImmutable('2025-11-17 15:00:00'), 7.00, 1.00);

        return [
            'parking_id' => $parkingId,
            'slot_start' => $slotStart,
            'slot_end' => $slotEnd,
            'rev_from' => $revFrom,
            'rev_to' => $revTo,
            'json_res' => $jsonResRepo,
            'json_st' => $jsonStRepo,
            'sql_res' => $sqlResRepo,
            'sql_st' => $sqlStRepo,
        ];
    }

    public function test_countOverlappingNotEntered_is_identical_in_json_and_sql(): void
    {
        $pdo = $this->sqlPdoOrSkip();
        $pdo->beginTransaction();
        try {
            $this->resetSqlTables($pdo);
            $ctx = $this->seedBoth($pdo);

            $parkingId = $ctx['parking_id'];
            $startAt = $ctx['slot_start'];
            $endAt = $ctx['slot_end'];

            $json = $ctx['json_res']->countOverlappingNotEntered($parkingId, $startAt, $endAt);
            $sql  = $ctx['sql_res']->countOverlappingNotEntered($parkingId, $startAt, $endAt);

            $this->assertSame($sql, $json);
        } finally {
            $pdo->rollBack();
        }
    }

    public function test_countActiveByParkingId_is_identical_in_json_and_sql(): void
    {
        $pdo = $this->sqlPdoOrSkip();
        $pdo->beginTransaction();
        try {
            $this->resetSqlTables($pdo);
            $ctx = $this->seedBoth($pdo);

            $parkingId = $ctx['parking_id'];

            $json = $ctx['json_st']->countActiveByParkingId($parkingId);
            $sql  = $ctx['sql_st']->countActiveByParkingId($parkingId);

            $this->assertSame($sql, $json);
        } finally {
            $pdo->rollBack();
        }
    }

    public function test_revenueForParking_is_identical_in_json_and_sql(): void
    {
        $pdo = $this->sqlPdoOrSkip();
        $pdo->beginTransaction();
        try {
            $this->resetSqlTables($pdo);
            $ctx = $this->seedBoth($pdo);

            $parkingId = $ctx['parking_id'];
            $from = $ctx['rev_from'];
            $to   = $ctx['rev_to'];

            $json = $ctx['json_st']->revenueForParking($from, $to, $parkingId);
            $sql  = $ctx['sql_st']->revenueForParking($from, $to, $parkingId);

            // Ints strict
            $this->assertSame((int)$sql['count_exits'], (int)$json['count_exits']);

            // Floats tolÃ©rance
            $this->assertEqualsWithDelta((float)$sql['total_billed'], (float)$json['total_billed'], self::DELTA);
            $this->assertEqualsWithDelta((float)$sql['total_penalty'], (float)$json['total_penalty'], self::DELTA);
            $this->assertEqualsWithDelta((float)$sql['total'], (float)$json['total'], self::DELTA);

            // Bonus: invariants (si Ã§a casse, tu sauras vite oÃ¹)
            $this->assertEqualsWithDelta(
                (float)$json['total_billed'] + (float)$json['total_penalty'],
                (float)$json['total'],
                self::DELTA
            );
        } finally {
            $pdo->rollBack();
        }
    }
}



================================================
FILE: Backend/tests/Infrastructure/Persistence/Json/JsonReservationRepositoryTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\Infrastructure\Persistence\Json;

use PHPUnit\Framework\TestCase;
use App\Infrastructure\Persistence\Json\JsonReservationRepository;
use App\Domain\Entity\Reservation;

final class JsonReservationRepositoryTest extends TestCase
{
    private string $file;

    protected function setUp(): void
    {
        $this->file = sys_get_temp_dir() . '/reservations_test.json';
        @unlink($this->file);
    }

    public function testSaveAndFindById(): void
    {
        $repo = new JsonReservationRepository($this->file);

        $r = Reservation::create(
            10,
            3,
            new \DateTimeImmutable('2025-01-01 10:00'),
            new \DateTimeImmutable('2025-01-01 12:00'),
            'car',
            20.0
        );

        $saved = $repo->save($r);

        $this->assertNotNull($saved->id());

        $found = $repo->findById($saved->id());

        $this->assertNotNull($found);
        $this->assertSame(10, $found->userId());
        $this->assertSame(3, $found->parkingId());
    }

    public function testFindByUserId(): void
    {
        $repo = new JsonReservationRepository($this->file);

        $repo->save(Reservation::create(
            1, 1,
            new \DateTimeImmutable('2025-01-01 08:00'),
            new \DateTimeImmutable('2025-01-01 09:00'),
            'car',
            10
        ));

        $repo->save(Reservation::create(
            2, 1,
            new \DateTimeImmutable('2025-01-01 10:00'),
            new \DateTimeImmutable('2025-01-01 11:00'),
            'car',
            10
        ));

        $list = $repo->findByUserId(1);

        $this->assertCount(1, $list);
        $this->assertSame(1, $list[0]->userId());
    }
}



================================================
FILE: Backend/tests/Infrastructure/Persistence/Json/JsonStationnementRepositoryTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\Infrastructure\Persistence\Json;

use PHPUnit\Framework\TestCase;
use App\Infrastructure\Persistence\Json\JsonStationnementRepository;
use App\Infrastructure\Persistence\Json\JsonReservationRepository;
use App\Domain\Entity\Stationnement;

final class JsonStationnementRepositoryTest extends TestCase
{
    private string $stationnements;
    private string $reservations;

    protected function setUp(): void
    {
        $this->stationnements = sys_get_temp_dir() . '/stationnements_test.json';
        $this->reservations   = sys_get_temp_dir() . '/reservations_test.json';

        @unlink($this->stationnements);
        @unlink($this->reservations);
    }

    public function testSaveAndCloseStationnement(): void
    {
        $reservationRepo = new JsonReservationRepository($this->reservations);
        $repo = new JsonStationnementRepository($this->stationnements, $reservationRepo);

        $enteredAt = new \DateTimeImmutable('2025-01-01 10:00');
        $s = Stationnement::enter(1, $enteredAt);

        $saved = $repo->save($s);
        $this->assertNotNull($saved->id());

        $exitAt = new \DateTimeImmutable('2025-01-01 11:00');

        $repo->close(
            $saved->id(),
            $exitAt,
            15.0,
            5.0
        );

        $closed = $repo->findLastByReservationId(1);

        $this->assertNotNull($closed->exitedAt());
        $this->assertSame(15.0, $closed->billedAmount());
        $this->assertSame(5.0, $closed->penaltyAmount());
    }
}



================================================
FILE: Backend/tests/Infrastructure/Security/PasswordHasherTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Infrastructure\Security;

use App\Infrastructure\Security\PasswordHasher;
use PHPUnit\Framework\TestCase;

final class PasswordHasherTest extends TestCase
{
    public function testHashIsNotPlainPassword(): void
    {
        $hasher = new PasswordHasher();
        $plain  = 'MySecurePassword123!';
        $hash   = $hasher->hash($plain);

        $this->assertIsString($hash);
        $this->assertNotSame($plain, $hash, 'Le hash ne doit pas Ãªtre le mot de passe en clair');
        $this->assertGreaterThan(20, strlen($hash), 'Le hash doit Ãªtre suffisamment long');
    }

    public function testVerifyReturnsTrueWithCorrectPassword(): void
    {
        $hasher = new PasswordHasher();
        $plain  = 'Secret123!';
        $hash   = $hasher->hash($plain);

        $this->assertTrue($hasher->verify($plain, $hash));
    }

    public function testVerifyReturnsFalseWithWrongPassword(): void
    {
        $hasher = new PasswordHasher();
        $hash   = $hasher->hash('correct-password');

        $this->assertFalse($hasher->verify('wrong-password', $hash));
    }
}



================================================
FILE: Backend/tests/Unit/BillingCalculatorTest.php
================================================
<?php
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use App\UseCase\Billing\BillingCalculator;

final class BillingCalculatorTest extends TestCase
{
    public function test_billed_minutes_rounds_up_to_slot(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15);

        $start = new DateTimeImmutable('2025-12-17 10:00:00');
        $end   = new DateTimeImmutable('2025-12-17 10:01:00'); // 1 min => 15

        $this->assertSame(15, $calc->billedMinutes($start, $end));
    }

    public function test_billed_minutes_exact_slot_stays_slot(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15);

        $start = new DateTimeImmutable('2025-12-17 10:00:00');
        $end   = new DateTimeImmutable('2025-12-17 10:15:00'); // exact => 15

        $this->assertSame(15, $calc->billedMinutes($start, $end));
    }

    public function test_billed_minutes_just_over_slot_rounds_up(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15);

        $start = new DateTimeImmutable('2025-12-17 10:00:00');
        $end   = new DateTimeImmutable('2025-12-17 10:15:01'); // 16 min => 30

        $this->assertSame(30, $calc->billedMinutes($start, $end));
    }

    public function test_billed_minutes_zero_when_end_before_start(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15);

        $start = new DateTimeImmutable('2025-12-17 10:00:00');
        $end   = new DateTimeImmutable('2025-12-17 09:59:00'); // nÃ©gatif => 0

        $this->assertSame(0, $calc->billedMinutes($start, $end));
    }

    public function test_amount_for_minutes_is_proportional_and_rounded_2_decimals(): void
    {
        $calc = new BillingCalculator();

        // 15 minutes Ã  12â‚¬/h => 3.00
        $this->assertSame(3.00, $calc->amountForMinutes(15, 12.0));

        // 30 minutes Ã  10â‚¬/h => 5.00
        $this->assertSame(5.00, $calc->amountForMinutes(30, 10.0));

        // 45 minutes Ã  7â‚¬/h => 5.25
        $this->assertSame(5.25, $calc->amountForMinutes(45, 7.0));
    }

    public function test_compute_no_penalty_when_exited_before_or_at_reserved_end(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15, penaltyMultiplier: 2.0);

        $entered = new DateTimeImmutable('2025-12-17 10:00:00');
        $exited  = new DateTimeImmutable('2025-12-17 11:00:00');
        $end     = new DateTimeImmutable('2025-12-17 11:00:00');

        // 60min => base 10â‚¬/h => 10.00, penalty 0
        $out = $calc->compute($entered, $exited, $end, 10.0);

        $this->assertSame(60, $out['billed_minutes']);
        $this->assertSame(10.00, $out['base_amount']);
        $this->assertSame(0.00, $out['penalty_amount']);
        $this->assertSame(10.00, $out['total_amount']);
    }

    public function test_compute_penalty_is_surcharge_on_overtime_only_not_double_total(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15, penaltyMultiplier: 2.0);

        $entered = new DateTimeImmutable('2025-12-17 10:00:00');
        $reservedEnd = new DateTimeImmutable('2025-12-17 11:00:00');
        $exited = new DateTimeImmutable('2025-12-17 11:01:00'); // overtime 1min => 15

        // billed: 61min => 75min (slot 15)
        // base: 75/60*10 = 12.50
        // overtime: 15/60*10 = 2.50
        // penaltyMultiplier=2.0 => surcharge = overtime*(2-1)=2.50
        // total = 12.50 + 2.50 = 15.00 (pas 12.50 + 5.00)
        $out = $calc->compute($entered, $exited, $reservedEnd, 10.0);

        $this->assertSame(75, $out['billed_minutes']);
        $this->assertSame(12.50, $out['base_amount']);
        $this->assertSame(2.50, $out['penalty_amount']);
        $this->assertSame(15.00, $out['total_amount']);
    }

    public function test_compute_penalty_multiplier_3x_means_surcharge_2x_overtime(): void
    {
        $calc = new BillingCalculator(slotMinutes: 15, penaltyMultiplier: 3.0);

        $entered = new DateTimeImmutable('2025-12-17 10:00:00');
        $reservedEnd = new DateTimeImmutable('2025-12-17 11:00:00');
        $exited = new DateTimeImmutable('2025-12-17 11:16:00'); // overtime 16min => 30

        // overtime: 30min Ã  10â‚¬/h => 5.00
        // surcharge = 5.00*(3-1)=10.00
        $out = $calc->compute($entered, $exited, $reservedEnd, 10.0);

        $this->assertSame(90, $out['billed_minutes']); // 76min => 90
        $this->assertSame(15.00, $out['base_amount']); // 90/60*10
        $this->assertSame(10.00, $out['penalty_amount']);
        $this->assertSame(25.00, $out['total_amount']);
    }
}



================================================
FILE: Backend/tests/Unit/CalculateOccupancyTest.php
================================================
<?php
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use App\UseCase\Parking\CalculateOccupancy;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Entity\Stationnement;
use App\Domain\Entity\Reservation;

final class CalculateOccupancyTest extends TestCase
{
    public function test_now_delegates_to_stationnement_repo(): void
    {
        $stationnements = new class implements StationnementRepository {
            public int $calledWith = -1;

            public function countActiveByParkingId(int $parkingId): int {
                $this->calledWith = $parkingId;
                return 7;
            }

            // Unused methods
            public function save(Stationnement $s): Stationnement { throw new RuntimeException("unused"); }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $reservations = new class implements ReservationRepository {
            // Unused in this test
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, DateTimeImmutable $startAt, DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $occ = new CalculateOccupancy($stationnements, $reservations);

        $this->assertSame(7, $occ->now(3));
        $this->assertSame(3, $stationnements->calledWith);
    }

    public function test_for_slot_delegates_to_reservation_repo_with_exact_params(): void
    {
        $stationnements = new class implements StationnementRepository {
            public function countActiveByParkingId(int $parkingId): int { return 0; }

            // Unused methods
            public function save(Stationnement $s): Stationnement { throw new RuntimeException("unused"); }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $reservations = new class implements ReservationRepository {
            public array $called = [];

            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int {
                $this->called = [$parkingId, $startAt, $endAt];
                return 4;
            }

            // Unused methods
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, DateTimeImmutable $startAt, DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
        };

        $occ = new CalculateOccupancy($stationnements, $reservations);

        $start = '2025-12-17 10:00:00';
        $end   = '2025-12-17 12:00:00';

        $this->assertSame(4, $occ->forSlot(9, $start, $end));
        $this->assertSame([9, $start, $end], $reservations->called);
    }

    public function test_total_for_availability_calls_both_and_sums(): void
    {
        $stationnements = new class implements StationnementRepository {
            public int $calls = 0;

            public function countActiveByParkingId(int $parkingId): int {
                $this->calls++;
                return 2;
            }

            // Unused methods
            public function save(Stationnement $s): Stationnement { throw new RuntimeException("unused"); }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $reservations = new class implements ReservationRepository {
            public int $calls = 0;

            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int {
                $this->calls++;
                return 3;
            }

            // Unused methods
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, DateTimeImmutable $startAt, DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
        };

        $occ = new CalculateOccupancy($stationnements, $reservations);

        $total = $occ->totalForAvailability(3, '2025-12-17 10:00:00', '2025-12-17 12:00:00');

        $this->assertSame(5, $total);
        $this->assertSame(1, $stationnements->calls);
        $this->assertSame(1, $reservations->calls);
    }
}



================================================
FILE: Backend/tests/UseCase/Auth/InMemoryUserRepository.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Auth;

use App\Domain\Entity\User;
use App\Domain\Repository\UserRepository;

final class InMemoryUserRepository implements UserRepository
{
    /** @var User[] */
    private array $users = [];
    private int $autoIncrement = 1;

    public function __construct(User ...$users)
    {
        foreach ($users as $user) {
            $this->save($user);
        }
    }

    public function create(
        string $email,
        string $passwordHash,
        string $role = 'USER',
        ?string $firstname = null,
        ?string $lastname = null
    ): User {
        $user = new User(
            $this->autoIncrement++,
            $email,
            $passwordHash,
            $role,
            $firstname,
            $lastname,
        );
        $this->save($user);
        return $user;
    }

    public function findById(int $id): ?User
    {
        return $this->users[$id] ?? null;
    }

    public function findByEmail(string $email): ?User
    {
        foreach ($this->users as $user) {
            if ($user->email() === $email) {
                return $user;
            }
        }
        return null;
    }

    public function save(User $user): void
    {
        $this->users[$user->id()] = $user;

        if ($user->id() >= $this->autoIncrement) {
            $this->autoIncrement = $user->id() + 1;
        }
    }
}



================================================
FILE: Backend/tests/UseCase/Auth/LoginUserTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Auth;

use App\Domain\Entity\User;
use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\PasswordHasher;
use App\UseCase\Auth\LoginUser;
use PHPUnit\Framework\TestCase;

/**
 * Petit repository en mÃ©moire uniquement pour les tests.
 */
final class InMemoryUserRepository implements UserRepository
{
    /** @var User[] */
    private array $users = [];
    private int $autoIncrement = 1;

    public function __construct(User ...$users)
    {
        foreach ($users as $user) {
            $this->save($user);
        }
    }

    public function create(string $email, string $passwordHash, string $role = 'USER',    ?string $firstname = null,
    ?string $lastname = null): User
    {
        $user = new User($this->autoIncrement++, $email, $passwordHash, $role);
        $this->save($user);
        return $user;
    }

    public function findById(int $id): ?User
    {
        return $this->users[$id] ?? null;
    }

    public function findByEmail(string $email): ?User
    {
        foreach ($this->users as $user) {
            if ($user->email() === $email) {
                return $user;
            }
        }
        return null;
    }

    public function save(User $user): void
    {
        $this->users[$user->id()] = $user;

        if ($user->id() >= $this->autoIncrement) {
            $this->autoIncrement = $user->id() + 1;
        }
    }
}

/**
 * Tests du cas dâ€™usage LoginUser.
 */
final class LoginUserTest extends TestCase
{
    private PasswordHasher $hasher;

    protected function setUp(): void
    {
        $this->hasher = new PasswordHasher();
    }

    public function testLoginSucceedsWithValidCredentialsAnd2FAEnabled(): void
    {
        $plain = 'MyStrongPassword!';
        $hash  = $this->hasher->hash($plain);

        // 2FA activÃ©e par dÃ©faut
        $user = new User(
            1,
            'user@example.com',
            $hash,
            'USER'
        );

        $repo    = new InMemoryUserRepository($user);
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('user@example.com', $plain);

        $this->assertTrue($result['success'] ?? false);
        $this->assertTrue($result['two_factor_required'] ?? false);
        $this->assertSame(1, $result['user_id'] ?? null);
        $this->assertSame('USER', $result['role'] ?? null);
    }

    public function testLoginSucceedsWithValidCredentialsAnd2FADisabled(): void
    {
        $plain = 'MyStrongPassword!';
        $hash  = $this->hasher->hash($plain);

        // On dÃ©sactive la 2FA via withTwoFactorConfig
        $user = new User(
            2,
            'no2fa@example.com',
            $hash,
            'USER'
        );
        $user = $user->withTwoFactorConfig(false, 'email');

        $repo    = new InMemoryUserRepository($user);
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('no2fa@example.com', $plain);

        $this->assertTrue($result['success'] ?? false);
        $this->assertFalse($result['two_factor_required'] ?? true);
        $this->assertSame(2, $result['user_id'] ?? null);
        $this->assertSame('USER', $result['role'] ?? null);
    }

    public function testLoginFailsWithWrongPassword(): void
    {
        $plain = 'MyStrongPassword!';
        $hash  = $this->hasher->hash($plain);

        $user = new User(
            3,
            'user@example.com',
            $hash,
            'USER'
        );

        $repo    = new InMemoryUserRepository($user);
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('user@example.com', 'wrong-password');

        $this->assertFalse($result['success'] ?? true);
        $this->assertArrayNotHasKey('user_id', $result);
        $this->assertArrayNotHasKey('role', $result);
    }

    public function testLoginFailsWithUnknownUser(): void
    {
        $repo    = new InMemoryUserRepository(); // aucun user enregistrÃ©
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('doesnotexist@example.com', 'whatever');

        $this->assertFalse($result['success'] ?? true);
        $this->assertArrayNotHasKey('user_id', $result);
        $this->assertArrayNotHasKey('role', $result);
    }
}



================================================
FILE: Backend/tests/UseCase/Reservation/CreateReservationTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Reservation;

use PHPUnit\Framework\TestCase;

use App\UseCase\Reservation\CreateReservation;
use App\UseCase\Parking\CalculateOccupancy;

use App\Domain\Entity\Parking;
use App\Domain\Entity\Reservation;
use App\Domain\Entity\Stationnement;

use App\Domain\Repository\ParkingRepository;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;

final class CreateReservationTest extends TestCase
{
    private function makeParking(
        int $id = 3,
        int $capacity = 10,
        float $hourlyRate = 10.0
    ): Parking {
        return new Parking(
            $id,
            $capacity,
            '48.8566,2.3522',
            $hourlyRate,
            new \DateTimeImmutable('08:00:00'),
            new \DateTimeImmutable('20:00:00'),
            [],
            []
        );
    }

    private function makeOccupancyReturning(int $total): CalculateOccupancy
    {
        // Stationnement repo: now() = 0 (pas important ici)
        $stationnements = new class implements StationnementRepository {
            public function save(Stationnement $s): Stationnement { throw new \RuntimeException('unused'); }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array {
                return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0];
            }
        };

        // Reservation repo: forSlot() retourne $total via countOverlappingNotEntered()
        $reservations = new class($total) implements ReservationRepository {
            public function __construct(private int $total) {}

            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }

            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int {
                return $this->total;
            }
        };

        return new CalculateOccupancy($stationnements, $reservations);
    }

    public function test_throws_when_parking_not_found(): void
    {
        $parkingRepo = new class implements ParkingRepository {
            public function create(array $data): int { return 0; }
            public function findById(int $id): ?Parking { return null; }
            public function listByOwnerId(int $ownerId): array { return []; }
            public function findOwnerIdByParkingId(int $parkingId): ?int { return null; }
        };

        $reservationRepo = new class implements ReservationRepository {
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $uc = new CreateReservation($parkingRepo, $reservationRepo, $this->makeOccupancyReturning(0));

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Parking not found');

        $uc->execute(10, 3, '2025-12-17 10:00:00', '2025-12-17 12:00:00', 'car', 12.5);
    }

    public function test_throws_when_invalid_time_range(): void
    {
        $parking = $this->makeParking();

        $parkingRepo = new class($parking) implements ParkingRepository {
            public function __construct(private Parking $parking) {}
            public function create(array $data): int { return 3; }
            public function findById(int $id): ?Parking { return $this->parking; }
            public function listByOwnerId(int $ownerId): array { return []; }
            public function findOwnerIdByParkingId(int $parkingId): ?int { return 1; }
        };

        $reservationRepo = new class implements ReservationRepository {
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $uc = new CreateReservation($parkingRepo, $reservationRepo, $this->makeOccupancyReturning(0));

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Invalid time range');

        $uc->execute(10, 3, '2025-12-17 10:00:00', '2025-12-17 10:00:00', 'car', 12.5);
    }

    public function test_throws_when_parking_full_for_slot(): void
    {
        $parking = $this->makeParking(id: 3, capacity: 2);

        $parkingRepo = new class($parking) implements ParkingRepository {
            public function __construct(private Parking $parking) {}
            public function create(array $data): int { return 3; }
            public function findById(int $id): ?Parking { return $this->parking; }
            public function listByOwnerId(int $ownerId): array { return []; }
            public function findOwnerIdByParkingId(int $parkingId): ?int { return 1; }
        };

        $reservationRepo = new class implements ReservationRepository {
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        // occupied >= capacity (2 >= 2)
        $uc = new CreateReservation($parkingRepo, $reservationRepo, $this->makeOccupancyReturning(2));

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Parking full for this time slot');

        $uc->execute(10, 3, '2025-12-17 10:00:00', '2025-12-17 12:00:00', 'car', 12.5);
    }

    public function test_saves_and_returns_reservation_when_ok(): void
    {
        $parking = $this->makeParking(id: 3, capacity: 10);

        $parkingRepo = new class($parking) implements ParkingRepository {
            public function __construct(private Parking $parking) {}
            public function create(array $data): int { return 3; }
            public function findById(int $id): ?Parking { return $this->parking; }
            public function listByOwnerId(int $ownerId): array { return []; }
            public function findOwnerIdByParkingId(int $parkingId): ?int { return 1; }
        };

        $reservationRepo = new class implements ReservationRepository {
            public ?Reservation $saved = null;

            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation {
                $this->saved = $reservation;
                return $reservation; // le vrai repo lui mettra un id
            }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $uc = new CreateReservation($parkingRepo, $reservationRepo, $this->makeOccupancyReturning(0));

        $res = $uc->execute(10, 3, '2025-12-17 10:00:00', '2025-12-17 12:00:00', 'car', 12.5);

        $this->assertInstanceOf(Reservation::class, $res);
        $this->assertNotNull($reservationRepo->saved);

        $this->assertSame(10, $res->userId());
        $this->assertSame(3, $res->parkingId());
        $this->assertSame('car', $res->vehicleType());
        $this->assertSame(12.5, $res->amount());
    }
}



================================================
FILE: Backend/tests/UseCase/Reservation/EnterReservationTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Reservation;

use PHPUnit\Framework\TestCase;
use App\UseCase\Reservation\EnterReservation;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;
use App\Domain\Entity\Reservation;
use App\Domain\Entity\Stationnement;

final class EnterReservationTest extends TestCase
{
    public function test_throws_when_reservation_not_found(): void
    {
        $resRepo = new class implements ReservationRepository {
            public function findById(int $id): ?Reservation { return null; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $stRepo = new class implements StationnementRepository {
            public function save(Stationnement $s): Stationnement { return $s; }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $uc = new EnterReservation($resRepo, $stRepo);

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Reservation not found');

        $uc->execute(10, 1);
    }

    public function test_throws_when_forbidden_user(): void
    {
        $reservation = Reservation::create(
            999, 3,
            new \DateTimeImmutable('-1 hour'),
            new \DateTimeImmutable('+1 hour'),
            'car', 12.5
        )->withId(1);

        $resRepo = new class($reservation) implements ReservationRepository {
            public function __construct(private Reservation $r) {}
            public function findById(int $id): ?Reservation { return $this->r; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $stRepo = new class implements StationnementRepository {
            public function save(Stationnement $s): Stationnement { return $s; }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $uc = new EnterReservation($resRepo, $stRepo);

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Forbidden');

        $uc->execute(10, 1);
    }

    public function test_throws_when_reservation_not_active(): void
    {
        $reservation = Reservation::create(
            10, 3,
            new \DateTimeImmutable('+1 hour'),
            new \DateTimeImmutable('+2 hours'),
            'car', 12.5
        )->withId(1);

        $resRepo = new class($reservation) implements ReservationRepository {
            public function __construct(private Reservation $r) {}
            public function findById(int $id): ?Reservation { return $this->r; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $stRepo = new class implements StationnementRepository {
            public function save(Stationnement $s): Stationnement { return $s; }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $uc = new EnterReservation($resRepo, $stRepo);

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Reservation not active');

        $uc->execute(10, 1);
    }

    public function test_throws_when_already_entered(): void
    {
        $reservation = Reservation::create(
            10, 3,
            new \DateTimeImmutable('-1 hour'),
            new \DateTimeImmutable('+1 hour'),
            'car', 12.5
        )->withId(1);

        $active = Stationnement::enter(1, new \DateTimeImmutable('now'))->withId(10);

        $resRepo = new class($reservation) implements ReservationRepository {
            public function __construct(private Reservation $r) {}
            public function findById(int $id): ?Reservation { return $this->r; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $stRepo = new class($active) implements StationnementRepository {
            public function __construct(private Stationnement $active) {}
            public function save(Stationnement $s): Stationnement { return $s; }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return $this->active; }
            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $uc = new EnterReservation($resRepo, $stRepo);

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Already entered');

        $uc->execute(10, 1);
    }

    public function test_enters_and_saves_stationnement_when_ok(): void
    {
        $reservation = Reservation::create(
            10, 3,
            new \DateTimeImmutable('-1 hour'),
            new \DateTimeImmutable('+1 hour'),
            'car', 12.5
        )->withId(1);

        $resRepo = new class($reservation) implements ReservationRepository {
            public function __construct(private Reservation $r) {}
            public function findById(int $id): ?Reservation { return $this->r; }
            public function save(Reservation $reservation): Reservation { return $reservation; }
            public function findByUserId(int $userId): array { return []; }
            public function findByParkingId(int $parkingId): array { return []; }
            public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
            public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
            public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
        };

        $stRepo = new class implements StationnementRepository {
            public ?Stationnement $saved = null;

            public function save(Stationnement $s): Stationnement { $this->saved = $s; return $s; }
            public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array { return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0]; }
        };

        $uc = new EnterReservation($resRepo, $stRepo);
        $s = $uc->execute(10, 1);

        $this->assertInstanceOf(Stationnement::class, $s);
        $this->assertNotNull($stRepo->saved);
        $this->assertSame(1, $s->reservationId());
        $this->assertNull($s->exitedAt());
    }
}



================================================
FILE: Backend/tests/UseCase/Reservation/ExitReservationTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Reservation;

use PHPUnit\Framework\TestCase;

use App\UseCase\Reservation\ExitReservation;
use App\UseCase\Billing\BillingCalculator;

use App\Domain\Entity\Parking;
use App\Domain\Entity\Reservation;
use App\Domain\Entity\Stationnement;

use App\Domain\Repository\ParkingRepository;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\StationnementRepository;

final class ExitReservationTest extends TestCase
{
    private function makeParking(float $hourlyRate = 10.0): Parking
    {
        return new Parking(
            3,
            10,
            '48.8566,2.3522',
            $hourlyRate,
            new \DateTimeImmutable('08:00:00'),
            new \DateTimeImmutable('20:00:00'),
            [],
            []
        );
    }

    public function test_throws_when_reservation_not_found(): void
    {
        $uc = new ExitReservation(
            new class implements ReservationRepository {
                public function findById(int $id): ?Reservation { return null; }
                public function save(Reservation $reservation): Reservation { return $reservation; }
                public function findByUserId(int $userId): array { return []; }
                public function findByParkingId(int $parkingId): array { return []; }
                public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
                public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
                public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
            },
            new class implements StationnementRepository {
                public function save(Stationnement $s): Stationnement { return $s; }
                public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
                public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
                public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
                public function listActiveByParkingId(int $parkingId): array { return []; }
                public function countActiveByParkingId(int $parkingId): int { return 0; }
                public function revenueForParking(string $from, string $to, int $parkingId): array {
                    return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0];
                }
            },
            new class implements ParkingRepository {
                public function create(array $data): int { return 0; }
                public function findById(int $id): ?Parking { return null; }
                public function listByOwnerId(int $ownerId): array { return []; }
                public function findOwnerIdByParkingId(int $parkingId): ?int { return null; }
            },
            new BillingCalculator()
        );

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Reservation not found');

        $uc->execute(10, 1);
    }

    public function test_throws_when_forbidden(): void
    {
        $res = Reservation::create(
            999,
            3,
            new \DateTimeImmutable('-2 hours'),
            new \DateTimeImmutable('+2 hours'),
            'car',
            12.5
        )->withId(1);

        $uc = new ExitReservation(
            new class($res) implements ReservationRepository {
                public function __construct(private Reservation $r) {}
                public function findById(int $id): ?Reservation { return $this->r; }
                public function save(Reservation $reservation): Reservation { return $reservation; }
                public function findByUserId(int $userId): array { return []; }
                public function findByParkingId(int $parkingId): array { return []; }
                public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
                public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
                public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
            },
            new class implements StationnementRepository {
                public function save(Stationnement $s): Stationnement { return $s; }
                public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
                public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
                public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
                public function listActiveByParkingId(int $parkingId): array { return []; }
                public function countActiveByParkingId(int $parkingId): int { return 0; }
                public function revenueForParking(string $from, string $to, int $parkingId): array {
                    return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0];
                }
            },
            new class implements ParkingRepository {
                public function create(array $data): int { return 0; }
                public function findById(int $id): ?Parking { return null; }
                public function listByOwnerId(int $ownerId): array { return []; }
                public function findOwnerIdByParkingId(int $parkingId): ?int { return null; }
            },
            new BillingCalculator()
        );

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Forbidden');

        $uc->execute(10, 1);
    }

    public function test_throws_when_not_entered(): void
    {
        $res = Reservation::create(
            10,
            3,
            new \DateTimeImmutable('-2 hours'),
            new \DateTimeImmutable('+2 hours'),
            'car',
            12.5
        )->withId(1);

        $uc = new ExitReservation(
            new class($res) implements ReservationRepository {
                public function __construct(private Reservation $r) {}
                public function findById(int $id): ?Reservation { return $this->r; }
                public function save(Reservation $reservation): Reservation { return $reservation; }
                public function findByUserId(int $userId): array { return []; }
                public function findByParkingId(int $parkingId): array { return []; }
                public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
                public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
                public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
            },
            new class implements StationnementRepository {
                public function save(Stationnement $s): Stationnement { return $s; }
                public function findActiveByReservationId(int $reservationId): ?Stationnement { return null; }
                public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
                public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
                public function listActiveByParkingId(int $parkingId): array { return []; }
                public function countActiveByParkingId(int $parkingId): int { return 0; }
                public function revenueForParking(string $from, string $to, int $parkingId): array {
                    return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0];
                }
            },
            new class implements ParkingRepository {
                public function create(array $data): int { return 0; }
                public function findById(int $id): ?Parking { return null; }
                public function listByOwnerId(int $ownerId): array { return []; }
                public function findOwnerIdByParkingId(int $parkingId): ?int { return null; }
            },
            new BillingCalculator()
        );

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Not entered');

        $uc->execute(10, 1);
    }

    public function test_closes_stationnement_and_returns_amounts(): void
    {
        $res = Reservation::create(
            10,
            3,
            new \DateTimeImmutable('-2 hours'),
            new \DateTimeImmutable('+2 hours'),
            'car',
            12.5
        )->withId(1);

        $active = Stationnement::enter(1, new \DateTimeImmutable('-30 minutes'))->withId(99);

        $parking = $this->makeParking(10.0);

        $stationnementRepo = new class($active) implements StationnementRepository {
            public array $closed = [];

            public function __construct(private Stationnement $active) {}

            public function save(Stationnement $s): Stationnement { return $s; }

            public function findActiveByReservationId(int $reservationId): ?Stationnement {
                return $this->active;
            }

            public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void
            {
                $this->closed = [$stationnementId, $billedAmount, $penaltyAmount, $exitedAt];
            }

            public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
            public function listActiveByParkingId(int $parkingId): array { return []; }
            public function countActiveByParkingId(int $parkingId): int { return 0; }
            public function revenueForParking(string $from, string $to, int $parkingId): array {
                return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0];
            }
        };

        $uc = new ExitReservation(
            new class($res) implements ReservationRepository {
                public function __construct(private Reservation $r) {}
                public function findById(int $id): ?Reservation { return $this->r; }
                public function save(Reservation $reservation): Reservation { return $reservation; }
                public function findByUserId(int $userId): array { return []; }
                public function findByParkingId(int $parkingId): array { return []; }
                public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
                public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
                public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
            },
            $stationnementRepo,
            new class($parking) implements ParkingRepository {
                public function __construct(private Parking $parking) {}
                public function create(array $data): int { return 3; }
                public function findById(int $id): ?Parking { return $this->parking; }
                public function listByOwnerId(int $ownerId): array { return []; }
                public function findOwnerIdByParkingId(int $parkingId): ?int { return 1; }
            },
            new BillingCalculator()
        );

        $out = $uc->execute(10, 1);

        $this->assertSame(1, $out['reservation_id']);
        $this->assertArrayHasKey('exited_at', $out);
        $this->assertArrayHasKey('base_amount', $out);
        $this->assertArrayHasKey('penalty_amount', $out);
        $this->assertArrayHasKey('total_amount', $out);
        $this->assertArrayHasKey('billed_minutes', $out);

        $this->assertNotEmpty($stationnementRepo->closed);
        $this->assertSame(99, $stationnementRepo->closed[0]); // stationnementId
        $this->assertIsFloat($stationnementRepo->closed[1]);  // billed
        $this->assertIsFloat($stationnementRepo->closed[2]);  // penalty
        $this->assertInstanceOf(\DateTimeImmutable::class, $stationnementRepo->closed[3]);
    }

    public function test_throws_when_parking_not_found(): void
    {
        $res = Reservation::create(
            10,
            3,
            new \DateTimeImmutable('-2 hours'),
            new \DateTimeImmutable('+2 hours'),
            'car',
            12.5
        )->withId(1);

        $active = Stationnement::enter(1, new \DateTimeImmutable('-30 minutes'))->withId(99);

        $uc = new ExitReservation(
            new class($res) implements ReservationRepository {
                public function __construct(private Reservation $r) {}
                public function findById(int $id): ?Reservation { return $this->r; }
                public function save(Reservation $reservation): Reservation { return $reservation; }
                public function findByUserId(int $userId): array { return []; }
                public function findByParkingId(int $parkingId): array { return []; }
                public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int { return 0; }
                public function listByParking(int $parkingId, ?string $from, ?string $to): array { return []; }
                public function countOverlappingNotEntered(int $parkingId, string $startAt, string $endAt): int { return 0; }
            },
            new class($active) implements StationnementRepository {
                public function __construct(private Stationnement $active) {}
                public function save(Stationnement $s): Stationnement { return $s; }
                public function findActiveByReservationId(int $reservationId): ?Stationnement { return $this->active; }
                public function close(int $stationnementId, \DateTimeImmutable $exitedAt, float $billedAmount, float $penaltyAmount): void {}
                public function findLastByReservationId(int $reservationId): ?Stationnement { return null; }
                public function listActiveByParkingId(int $parkingId): array { return []; }
                public function countActiveByParkingId(int $parkingId): int { return 0; }
                public function revenueForParking(string $from, string $to, int $parkingId): array {
                    return ['count_exits'=>0,'total_billed'=>0,'total_penalty'=>0,'total'=>0];
                }
            },
            new class implements ParkingRepository {
                public function create(array $data): int { return 0; }
                public function findById(int $id): ?Parking { return null; }
                public function listByOwnerId(int $ownerId): array { return []; }
                public function findOwnerIdByParkingId(int $parkingId): ?int { return null; }
            },
            new BillingCalculator()
        );

        $this->expectException(\RuntimeException::class);
        $this->expectExceptionMessage('Parking not found');

        $uc->execute(10, 1);
    }
}



================================================
FILE: frontend/README.md
================================================
# SystÃ¨me de Parking PartagÃ© - Frontend

Application React pour la gestion de parkings partagÃ©s - Projet HETIC 2025

## Installation

```bash
npm install
npm start
```

L'application sera accessible sur http://localhost:3000

## Technologies

- React 19.2.0
- React Router DOM 6.30.1
- TailwindCSS 3.4.18
- PostCSS + Autoprefixer

## Structure

```
src/
â”œâ”€â”€ components/      # Composants rÃ©utilisables
â”œâ”€â”€ pages/           # Pages de l'application
â”œâ”€â”€ routes/          # Configuration des routes
â”œâ”€â”€ services/        # Appels API
â”œâ”€â”€ App.jsx          # Configuration Router
â””â”€â”€ index.js         # Point d'entrÃ©e
```

## Pages principales

- `/` - Accueil
- `/login` - Connexion
- `/register` - Inscription (utilisateur/propriÃ©taire)
- `/dashboard-user` - Espace utilisateur
- `/dashboard-owner` - Espace propriÃ©taire
- `/parking/:id` - DÃ©tails d'un parking

## FonctionnalitÃ©s

### Utilisateurs

- Inscription avec choix de rÃ´le
- RÃ©servation de parking
- Suivi des rÃ©servations et stationnements

### PropriÃ©taires

- Ajout et gestion de parkings
- Visualisation des statistiques (CA, rÃ©servations, stationnements)
- Modification des tarifs et horaires

## Configuration

Configuration TailwindCSS dans `tailwind.config.js` et `postcss.config.js`

Couleur principale : #34A853

## Scripts

```bash
npm start     # DÃ©veloppement
npm run build # Production
npm test      # Tests
```

## Backend

Application prÃªte Ã  Ãªtre connectÃ©e au backend PHP sur http://localhost:8001

Tous les appels API sont simulÃ©s dans `src/services/apiService.js`



================================================
FILE: frontend/AUTHENTIFICATION.md
================================================
# ğŸ” Documentation Authentification - ParkingPartagÃ©

## ğŸ“‹ Structure ComplÃ¨te de l'Utilisateur

Chaque utilisateur dans le systÃ¨me possÃ¨de les champs suivants :

### Champs de Base
| Champ | Type | Description | Obligatoire |
|-------|------|-------------|-------------|
| `id` | number | Identifiant unique | âœ… |
| `email` | string | Email de connexion | âœ… |
| `password` | string | Mot de passe (hashÃ© en production) | âœ… |
| `firstname` | string | PrÃ©nom | âœ… |
| `lastname` | string | Nom | âœ… |
| `role` | string | 'user' ou 'owner' | âœ… |

### Champs AvancÃ©s
| Champ | Type | Description | Par dÃ©faut |
|-------|------|-------------|------------|
| `reservations` | array | Liste des rÃ©servations | `[]` |
| `stationnements` | array | Liste des stationnements | `[]` |
| `typeAbonnement` | string | 'gratuit', 'premium', 'business' | `'gratuit'` |
| `debutAbonnement` | string/null | Date de dÃ©but (YYYY-MM-DD) | `null` |
| `finAbonnement` | string/null | Date de fin (YYYY-MM-DD) | `null` |

---

## ğŸ¯ Types d'Abonnements

### 1. **Gratuit** (par dÃ©faut)
- âœ… AccÃ¨s aux fonctionnalitÃ©s de base
- âœ… RÃ©servations limitÃ©es
- âŒ Pas de prioritÃ©
- âŒ Pas de rÃ©ductions

### 2. **Premium**
- âœ… RÃ©servations illimitÃ©es
- âœ… PrioritÃ© sur les places
- âœ… 20% de rÃ©duction
- âœ… Support prioritaire

### 3. **Business**
- âœ… Tout de Premium +
- âœ… Facturation mensuelle
- âœ… Gestion multi-vÃ©hicules
- âœ… API d'intÃ©gration

---

## ğŸ”§ Fonctions API Disponibles

### 1. **Authentification**

#### `login(email, password)`
Connecte un utilisateur existant.

```javascript
const result = await apiService.login('user@example.com', 'password123');
// Retourne: { success, token, user }
```

#### `register(userData)`
CrÃ©e un nouveau compte utilisateur.

```javascript
const result = await apiService.register({
  email: 'nouveau@email.com',
  password: 'motdepasse123',
  firstname: 'Jean',
  lastname: 'Dupont',
  role: 'user'
});
// Retourne: { success, message, token, user }
```

---

### 2. **Gestion Utilisateur**

#### `getUserProfile(token)`
RÃ©cupÃ¨re les informations complÃ¨tes de l'utilisateur.

```javascript
const result = await apiService.getUserProfile(token);
// Retourne: { success, user }
```

#### `upgradeAbonnement(token, typeAbonnement, dureeEnMois)`
Met Ã  niveau l'abonnement de l'utilisateur.

```javascript
const result = await apiService.upgradeAbonnement(token, 'premium', 12);
// Retourne: { success, message, user }
```

---

### 3. **RÃ©servations**

#### `getReservations(token)`
RÃ©cupÃ¨re toutes les rÃ©servations de l'utilisateur.

```javascript
const result = await apiService.getReservations(token);
// Retourne: { success, reservations }
```

#### `reserveParking(token, parkingId, reservationData)`
CrÃ©e une nouvelle rÃ©servation.

```javascript
const result = await apiService.reserveParking(token, 1, {
  date_debut: '2025-01-15T10:00:00',
  date_fin: '2025-01-15T18:00:00',
  montant: 20
});
// Retourne: { success, reservation }
```

---

### 4. **Stationnements**

#### `getStationnements(token)`
RÃ©cupÃ¨re les stationnements actifs de l'utilisateur.

```javascript
const result = await apiService.getStationnements(token);
// Retourne: { success, stationnements }
```

---

### 5. **PropriÃ©taires (Owner)**

#### `getOwnerParkings(token)`
RÃ©cupÃ¨re tous les parkings du propriÃ©taire.

```javascript
const result = await apiService.getOwnerParkings(token);
// Retourne: { success, parkings }
```

#### `addParking(token, parkingData)`
Ajoute un nouveau parking.

```javascript
const result = await apiService.addParking(token, {
  nom: 'Mon Parking',
  adresse: '123 Rue Example',
  nombre_places: 50,
  tarif_horaire: 2.5,
  tarif_journalier: 15,
  tarif_mensuel: 120,
  horaire_ouverture: '06:00',
  horaire_fermeture: '23:00'
});
// Retourne: { success, parking }
```

#### `getMonthlyRevenue(token)`
RÃ©cupÃ¨re les revenus mensuels du propriÃ©taire.

```javascript
const result = await apiService.getMonthlyRevenue(token);
// Retourne: { success, revenus_mensuels }
```

---

## ğŸ“¦ Exemple d'Utilisation ComplÃ¨te

### Inscription et Connexion

```javascript
// 1. Inscription d'un nouvel utilisateur
try {
  const registerResult = await apiService.register({
    email: 'jean.dupont@email.com',
    password: 'motdepasse123',
    firstname: 'Jean',
    lastname: 'Dupont',
    role: 'user'
  });
  
  // Stocker le token et les infos utilisateur
  localStorage.setItem('token', registerResult.token);
  localStorage.setItem('user', JSON.stringify(registerResult.user));
  
  console.log('Compte crÃ©Ã©:', registerResult.user);
  // user.typeAbonnement === 'gratuit' par dÃ©faut
  
} catch (error) {
  console.error('Erreur inscription:', error.message);
}

// 2. Connexion d'un utilisateur existant
try {
  const loginResult = await apiService.login(
    'jean.dupont@email.com',
    'motdepasse123'
  );
  
  localStorage.setItem('token', loginResult.token);
  localStorage.setItem('user', JSON.stringify(loginResult.user));
  
  console.log('ConnectÃ©:', loginResult.user);
  
} catch (error) {
  console.error('Erreur connexion:', error.message);
}
```

### Mise Ã  Niveau d'Abonnement

```javascript
const token = localStorage.getItem('token');

try {
  const upgradeResult = await apiService.upgradeAbonnement(
    token,
    'premium',
    12 // 12 mois
  );
  
  console.log(upgradeResult.message);
  // "Abonnement premium activÃ© avec succÃ¨s"
  
  // Mettre Ã  jour les infos utilisateur en local
  const userStr = localStorage.getItem('user');
  const user = JSON.parse(userStr);
  user.typeAbonnement = upgradeResult.user.typeAbonnement;
  user.debutAbonnement = upgradeResult.user.debutAbonnement;
  user.finAbonnement = upgradeResult.user.finAbonnement;
  localStorage.setItem('user', JSON.stringify(user));
  
} catch (error) {
  console.error('Erreur upgrade:', error.message);
}
```

### RÃ©server un Parking

```javascript
const token = localStorage.getItem('token');

try {
  const reservationResult = await apiService.reserveParking(
    token,
    1, // ID du parking
    {
      date_debut: '2025-01-15T10:00:00',
      date_fin: '2025-01-15T18:00:00',
      montant: 20
    }
  );
  
  console.log('RÃ©servation confirmÃ©e:', reservationResult.reservation);
  
} catch (error) {
  console.error('Erreur rÃ©servation:', error.message);
}
```

---

## ğŸ”’ SÃ©curitÃ©

### En Production (Backend PHP)

1. **Hachage des mots de passe**
   - Utiliser `password_hash()` en PHP
   - Ne jamais stocker les mots de passe en clair

2. **Tokens JWT**
   - GÃ©nÃ©rer des tokens JWT sÃ©curisÃ©s
   - Expiration aprÃ¨s 24h
   - Refresh tokens pour renouvellement

3. **Validation des donnÃ©es**
   - Valider tous les inputs cÃ´tÃ© serveur
   - Protection contre les injections SQL
   - Sanitization des donnÃ©es

4. **HTTPS**
   - Toujours utiliser HTTPS en production
   - SÃ©curiser les cookies

---

## âœ… Checklist Trello - Status

- âœ… **email** - ImplÃ©mentÃ©
- âœ… **password** - ImplÃ©mentÃ©
- âœ… **nom** - ImplÃ©mentÃ© (lastname)
- âœ… **prÃ©nom** - ImplÃ©mentÃ© (firstname)
- âœ… **une liste de rÃ©servations** - ImplÃ©mentÃ© (reservations: [])
- âœ… **une liste de stationnements** - ImplÃ©mentÃ© (stationnements: [])
- âœ… **type d'abonnement** - ImplÃ©mentÃ© (typeAbonnement)
- âœ… **dÃ©but abonnement** - ImplÃ©mentÃ© (debutAbonnement)
- âœ… **fin abonnement** - ImplÃ©mentÃ© (finAbonnement)

---

## ğŸ¨ IntÃ©gration Frontend

### Afficher les Infos Utilisateur

```jsx
// Dans un composant React
const user = JSON.parse(localStorage.getItem('user'));

return (
  <div>
    <h2>Profil de {user.firstname} {user.lastname}</h2>
    <p>Email: {user.email}</p>
    <p>RÃ´le: {user.role}</p>
    <p>Abonnement: {user.typeAbonnement}</p>
    {user.typeAbonnement !== 'gratuit' && (
      <>
        <p>DÃ©but: {user.debutAbonnement}</p>
        <p>Fin: {user.finAbonnement}</p>
      </>
    )}
    <p>RÃ©servations: {user.reservations.length}</p>
    <p>Stationnements: {user.stationnements.length}</p>
  </div>
);
```

---

## ğŸš€ Prochaines Ã‰tapes

1. **Backend PHP**
   - CrÃ©er les endpoints API rÃ©els
   - ImplÃ©menter l'authentification JWT
   - Connecter Ã  MySQL

2. **Paiements**
   - IntÃ©grer Stripe pour les abonnements
   - GÃ©rer les renouvellements automatiques

3. **Notifications**
   - Email de confirmation
   - Rappels de rÃ©servation
   - Alertes d'expiration d'abonnement

---

**Documentation mise Ã  jour le:** 2025-11-20  
**Version:** 1.0.0





================================================
FILE: frontend/package.json
================================================
{
  "name": "frontend",
  "version": "1.0.0",
  "description": "Application React pour le systÃ¨me de parking partagÃ© - Projet HETIC 2025",
  "main": "src/main.jsx",
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "eslintConfig": {
    "extends": [
      "react-app"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "dependencies": {
    "leaflet": "^1.9.4",
    "lucide-react": "^0.560.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-leaflet": "^5.0.0",
    "react-router-dom": "^6.30.1",
    "react-scripts": "5.0.1"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.18"
  }
}



================================================
FILE: frontend/postcss.config.js
================================================
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};




================================================
FILE: frontend/tailwind.config.js
================================================
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{js,jsx,ts,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: '#E6375F', // Rose Yespark
        'primary-50': '#fdf2f4',
        'primary-100': '#fbe5e9',
        'primary-200': '#f7ccd5',
        'primary-300': '#f0a3b3',
        'primary-400': '#e6375f', // Main color
        'primary-500': '#d12f54',
        'primary-600': '#ab1f40',
        'primary-700': '#8a1632',
        'primary-800': '#6b1126',
        'primary-900': '#500c1c',
      },
      fontFamily: {
        sans: ['Inter', 'SF Pro Display', 'system-ui', '-apple-system', 'sans-serif'],
        display: ['Cabinet Grotesk', 'Inter', 'sans-serif'],
      },
    },
  },
  plugins: [],
}




================================================
FILE: frontend/public/index.html
================================================
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#34A853" />
    <meta
      name="description"
      content="SystÃ¨me de Parking PartagÃ© - Trouvez et rÃ©servez votre place de parking facilement"
    />
    <title>ParkingPartagÃ© - SystÃ¨me de Parking PartagÃ©</title>
  </head>
  <body>
    <noscript>Vous devez activer JavaScript pour utiliser cette application.</noscript>
    <div id="root"></div>
  </body>
</html>




================================================
FILE: frontend/src/App.jsx
================================================
import React from "react";
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import Home from "./pages/Home.jsx";
import Login from "./pages/Login.jsx";
import Register from "./pages/Register.jsx";
import Reservation from "./pages/Reservation.jsx";
import MesReservations from "./pages/MesReservations.jsx";
import Maps from "./pages/Maps.jsx";
import UserDashboard from "./pages/UserDashboard.jsx";
import OwnerDashboard from "./pages/OwnerDashboard.jsx";
import ParkingDetails from "./pages/ParkingDetails.jsx";
import Subscription from "./pages/Subscription.jsx";
import ProtectedRoute from "./components/ProtectedRoute.jsx";

function App() {
  return (
    <BrowserRouter>
      <Routes>
        {/* Routes publiques */}
        <Route path="/" element={<Home />} />
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        <Route path="/reservation" element={<Reservation />} />
        <Route path="/maps" element={<Maps />} />
        
        {/* Routes protÃ©gÃ©es */}
        <Route
          path="/abonnement"
          element={
            <ProtectedRoute>
              <Subscription />
            </ProtectedRoute>
          }
        />
        <Route
          path="/mes-reservations"
          element={
            <ProtectedRoute>
              <MesReservations />
            </ProtectedRoute>
          }
        />
        <Route
          path="/dashboard-user"
          element={
            <ProtectedRoute>
              <UserDashboard />
            </ProtectedRoute>
          }
        />
        <Route
          path="/dashboard-owner"
          element={
            <ProtectedRoute>
              <OwnerDashboard />
            </ProtectedRoute>
          }
        />
        
        {/* Route publique pour les dÃ©tails de parking */}
        <Route path="/parking/:id" element={<ParkingDetails />} />
        
        {/* Redirection pour les routes obsolÃ¨tes */}
        <Route path="/dashboard" element={<Navigate to="/dashboard-user" replace />} />
        <Route path="/owner" element={<Navigate to="/dashboard-owner" replace />} />
        
        {/* Route 404 */}
        <Route path="*" element={<Navigate to="/" />} />
      </Routes>
    </BrowserRouter>
  );
}

export default App;



================================================
FILE: frontend/src/index.css
================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

@layer base {
body {
  margin: 0;
    font-family: 'Inter', 'SF Pro Display', system-ui, -apple-system, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
    scroll-behavior: smooth;
    letter-spacing: -0.01em;
  }
  
  /* Curseur personnalisÃ© */
  * {
    cursor: default;
  }
  
  button, a, input, [role="button"] {
    cursor: pointer;
  }
  
  /* Typographie moderne */
  h1, h2, h3, h4, h5, h6 {
    letter-spacing: -0.02em;
    /* font-weight: 300; - REMOVED to allow utility classes to work */
  }
}

@layer utilities {
  /* Animations ultra-fun style Framer */
  .animate-float {
    animation: float 3s ease-in-out infinite;
  }
  
  .animate-pulse-fun {
    animation: pulseFun 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  .animate-bounce-subtle {
    animation: bounceSubtle 1s ease-in-out;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  
  @keyframes pulseFun {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.9; transform: scale(1.02); }
  }
  
  @keyframes bounceSubtle {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  
  /* Glass effect fun */
  .glass-effect {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  
  /* Gradient texts fun */
  .gradient-text {
    background: linear-gradient(135deg, #4A7C59 0%, #6B9E7B 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
}

/* Styles Leaflet personnalisÃ©s - Ultra-moderne */
.leaflet-popup-content-wrapper {
  border-radius: 1.5rem !important;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
  border: 1px solid rgba(0, 0, 0, 0.05) !important;
  padding: 0 !important;
}

.leaflet-popup-content {
  margin: 0 !important;
}

.leaflet-popup-tip {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
}

.leaflet-container {
  font-family: 'Inter', system-ui, -apple-system, sans-serif !important;
}

.leaflet-control-zoom {
  border: none !important;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1) !important;
  border-radius: 1rem !important;
  overflow: hidden;
}

.leaflet-control-zoom a {
  background-color: white !important;
  color: #1f2937 !important;
  border: none !important;
  font-size: 18px !important;
  line-height: 30px !important;
  transition: all 0.2s !important;
}

.leaflet-control-zoom a:hover {
  background-color: #f9fafb !important;
}

.leaflet-control-zoom-in,
.leaflet-control-zoom-out {
  width: 40px !important;
  height: 40px !important;
}

/* Animation fade-in */
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fade-in 0.4s ease-out;
}



================================================
FILE: frontend/src/index.js
================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);



================================================
FILE: frontend/src/components/Footer.jsx
================================================
import React from "react";
import { Link } from "react-router-dom";
import { Facebook, Twitter, Instagram } from 'lucide-react';

export default function Footer() {
  return (
    <footer className="bg-gray-50 text-gray-600 border-t border-gray-100">
      <div className="container mx-auto px-6 lg:px-12 py-20">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
          {/* Logo & Description */}
          <div className="md:col-span-2 space-y-6">
            <div className="flex items-center space-x-2">
              <div className="w-8 h-8 bg-primary rounded-full"></div>
              <span className="text-xl font-light text-gray-900">parkingpartagÃ©</span>
            </div>
            <p className="text-gray-500 leading-relaxed max-w-md font-light">
              La solution simple et moderne pour trouver et rÃ©server votre place de parking partout en France.
            </p>
            <div className="flex space-x-4">
              <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors">
                <Facebook className="w-5 h-5" />
              </a>
              <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors">
                <Twitter className="w-5 h-5" />
              </a>
              <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors">
                <Instagram className="w-5 h-5" />
              </a>
            </div>
          </div>

          {/* Links */}
          <div>
            <h3 className="text-gray-900 font-light mb-4 text-lg">Liens</h3>
            <ul className="space-y-3">
              <li>
                <Link to="/" className="text-gray-500 hover:text-gray-900 transition-colors font-light">
                  Accueil
                </Link>
              </li>
              <li>
                <Link to="/login" className="text-gray-500 hover:text-gray-900 transition-colors font-light">
                  Connexion
                </Link>
              </li>
              <li>
                <Link to="/register" className="text-gray-500 hover:text-gray-900 transition-colors font-light">
                  Inscription
                </Link>
              </li>
            </ul>
          </div>

          {/* Contact */}
          <div>
            <h3 className="text-gray-900 font-light mb-4 text-lg">Contact</h3>
            <ul className="space-y-3 text-gray-500 font-light">
              <li>support@parkingpartage.fr</li>
              <li>01 23 45 67 89</li>
            </ul>
          </div>
        </div>

        <div className="border-t border-gray-200 pt-8 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
          <p className="text-gray-400 text-sm font-light">
            Â© 2025 ParkingPartagÃ©. Tous droits rÃ©servÃ©s.
          </p>
          <div className="flex space-x-8 text-sm">
            <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors font-light">
              ConfidentialitÃ©
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors font-light">
              Conditions
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors font-light">
              Mentions lÃ©gales
            </a>
          </div>
        </div>
      </div>
    </footer>
  );
}



================================================
FILE: frontend/src/components/Header.jsx
================================================
import React from "react";
import { Link, useNavigate } from "react-router-dom";

export default function Header() {
  const navigate = useNavigate();
  const token = localStorage.getItem("token");
  const userStr = localStorage.getItem("user");
  const user = userStr ? JSON.parse(userStr) : null;
  const userRole = user?.role || null;

  const handleLogout = () => {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    navigate("/");
  };

  return (
    <header className="fixed top-6 left-0 right-0 z-50 px-6">
      <div className="max-w-7xl mx-auto flex justify-between items-center">
        {/* Logo Ã  gauche */}
        <Link to="/" className="flex items-center space-x-2">
          <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg">
            <span className="text-primary font-bold text-xl">P</span>
          </div>
        </Link>

        {/* Navigation centrale - Arrondie et sÃ©parÃ©e */}
        <nav className="flex items-center bg-gray-900 rounded-full shadow-2xl px-2 py-2">
          <Link 
            to="/" 
            className="px-6 py-2.5 bg-white text-gray-900 rounded-full font-medium text-sm transition-all duration-300 hover:bg-gray-100"
          >
            Accueil
          </Link>
          <Link 
            to="/reservation" 
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300"
          >
            RÃ©server
          </Link>
          <Link 
            to="/abonnement" 
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300"
          >
            Abonnement
          </Link>
          <Link 
            to="/maps" 
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300"
          >
            Carte
          </Link>
          <a 
            href="#services" 
            onClick={(e) => {
              e.preventDefault();
              document.querySelector('#services')?.scrollIntoView({ behavior: 'smooth' });
            }}
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300 cursor-pointer"
          >
            Services
          </a>
          <a 
            href="#tarifs" 
            onClick={(e) => {
              e.preventDefault();
              document.querySelector('#tarifs')?.scrollIntoView({ behavior: 'smooth' });
            }}
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300 cursor-pointer"
          >
            Tarifs
          </a>
        </nav>

        {/* Boutons Connexion/Inscription ou Dashboard */}
        {token ? (
          <div className="flex items-center gap-3">
            {userRole === 'owner' ? (
              <Link 
                to="/dashboard-owner" 
                className="bg-gray-900 text-white px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-gray-800 transition-all duration-300"
              >
                Dashboard
              </Link>
            ) : (
              <>
                <Link 
                  to="/mes-reservations" 
                  className="text-gray-900 bg-white border border-gray-200 px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-gray-50 transition-all duration-300"
                >
                  Mes rÃ©servations
                </Link>
                <Link 
                  to="/dashboard-user" 
                  className="bg-gray-900 text-white px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-gray-800 transition-all duration-300"
                >
                  Mon compte
                </Link>
              </>
            )}
            <button
              onClick={handleLogout}
              className="bg-primary text-white px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-primary-800 transition-all duration-300"
            >
              DÃ©connexion
            </button>
          </div>
        ) : (
          <div className="flex items-center gap-3">
            <Link
              to="/login"
              className="text-gray-900 bg-white border border-gray-200 px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-gray-50 transition-all duration-300"
            >
              Connexion
            </Link>
            <Link
              to="/register"
              className="bg-gray-900 text-white px-6 py-2.5 rounded-full font-light text-sm shadow-2xl hover:bg-gray-800 transition-all duration-300"
            >
              Inscription
            </Link>
          </div>
        )}
      </div>
    </header>
  );
}



================================================
FILE: frontend/src/components/LoadingScreen.jsx
================================================
import React, { useEffect, useState } from 'react';

export default function LoadingScreen({ onLoadingComplete }) {
  const [progress, setProgress] = useState(0);
  const [isComplete, setIsComplete] = useState(false);

  useEffect(() => {
    // Animation de la barre de progression
    const interval = setInterval(() => {
      setProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          setIsComplete(true);
          setTimeout(() => {
            onLoadingComplete();
          }, 500);
          return 100;
        }
        return prev + 2;
      });
    }, 30);

    return () => clearInterval(interval);
  }, [onLoadingComplete]);

  return (
    <div
      className={`fixed inset-0 z-[9999] bg-white flex items-center justify-center transition-opacity duration-500 ${
        isComplete ? 'opacity-0 pointer-events-none' : 'opacity-100'
      }`}
    >
      <div className="max-w-md w-full px-8">
        {/* Logo / IcÃ´ne */}
        <div className="flex justify-center mb-12">
          <div className="relative">
            <div className="w-20 h-20 bg-gray-900 rounded-full flex items-center justify-center animate-pulse">
              <span className="text-white text-3xl font-bold">P</span>
            </div>
            {/* Cercle animÃ© autour */}
            <div className="absolute inset-0 border-4 border-gray-900 rounded-full animate-spin" style={{ borderTopColor: 'transparent', borderRightColor: 'transparent' }}></div>
          </div>
        </div>

        {/* Titre */}
        <h2 className="text-3xl font-light text-gray-900 text-center mb-3 tracking-tight">
          ParkingPartagÃ©
        </h2>
        <p className="text-sm text-gray-500 font-light text-center mb-12">
          Chargement en cours...
        </p>

        {/* Barre de progression minimaliste */}
        <div className="relative">
          <div className="w-full h-1 bg-gray-100 rounded-full overflow-hidden">
            <div
              className="h-full bg-gray-900 rounded-full transition-all duration-300 ease-out"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
          {/* Pourcentage */}
          <div className="text-xs text-gray-400 font-light text-center mt-4">
            {progress}%
          </div>
        </div>

        {/* Dots animÃ©s */}
        <div className="flex justify-center gap-2 mt-12">
          <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style={{ animationDelay: '0s' }}></div>
          <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
          <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style={{ animationDelay: '0.4s' }}></div>
        </div>
      </div>
    </div>
  );
}





================================================
FILE: frontend/src/components/ParkingCard.jsx
================================================
import React from "react";
import { useNavigate } from "react-router-dom";

export default function ParkingCard({ parking }) {
  const navigate = useNavigate();
  const token = localStorage.getItem("token");

  const handleReserve = () => {
    if (!token) {
      navigate("/login");
      return;
    }
    navigate(`/parking/${parking.id}/reserve`);
  };

  return (
    <div className="bg-white rounded-2xl shadow hover:shadow-lg transition overflow-hidden cursor-pointer">
      {/* Image du parking */}
      <div className="relative h-48 bg-gray-200 overflow-hidden">
        {parking.image ? (
          <img
            src={parking.image}
            alt={parking.nom}
            className="w-full h-full object-cover hover:scale-110 transition duration-500"
          />
        ) : (
          <div className="w-full h-full bg-gradient-to-br from-zenpark-100 to-zenpark-200 flex items-center justify-center">
            <svg className="w-16 h-16 text-zenpark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
            </svg>
          </div>
        )}
        
        {/* Badge disponibilitÃ© */}
        {parking.nombre_places && (
          <div className="absolute top-4 right-4 bg-white px-3 py-1.5 rounded-full shadow">
            <span className="text-sm font-semibold text-zenpark">
              {parking.nombre_places} places
            </span>
          </div>
        )}
      </div>

      {/* Contenu */}
      <div className="p-6">
        <h3 className="text-xl font-semibold mb-2 text-gray-900">
          {parking.nom || "Parking"}
        </h3>
        
        <div className="flex items-start mb-4">
          <svg className="w-4 h-4 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <p className="text-gray-600 text-sm">
          {parking.adresse || "Adresse non disponible"}
        </p>
        </div>

        {/* Informations tarifaires */}
        <div className="space-y-2 mb-5">
          {parking.tarif_horaire && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Horaire</span>
              <span className="font-semibold text-zenpark">{parking.tarif_horaire} â‚¬</span>
            </div>
          )}
          {parking.tarif_journalier && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Journalier</span>
              <span className="font-semibold text-zenpark">{parking.tarif_journalier} â‚¬</span>
            </div>
          )}
          {parking.tarif_mensuel && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Mensuel</span>
              <span className="font-semibold text-zenpark">{parking.tarif_mensuel} â‚¬</span>
            </div>
          )}
        </div>

        {/* Bouton rÃ©server */}
        <button
          onClick={handleReserve}
          className="w-full bg-zenpark text-white py-3 rounded-xl hover:bg-zenpark-700 transition font-medium"
        >
          RÃ©server
        </button>
      </div>
    </div>
  );
}



================================================
FILE: frontend/src/components/ProtectedRoute.jsx
================================================
import React from "react";
import { Navigate } from "react-router-dom";

export default function ProtectedRoute({ children }) {
  const token = localStorage.getItem("token");

  if (!token) {
    return <Navigate to="/login" replace />;
  }

  return children;
}




================================================
FILE: frontend/src/components/SearchBar.jsx
================================================
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";

export default function SearchBar() {
  const [location, setLocation] = useState("");
  const [date, setDate] = useState("");
  const [focused, setFocused] = useState(null);
  const navigate = useNavigate();

  const handleSearch = async (e) => {
    e.preventDefault();
    if (location) {
      try {
        const response = await fetch(
          `http://localhost:8001/api/parkings?location=${encodeURIComponent(location)}`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}` || "",
            },
          }
        );
        if (response.ok) {
          const data = await response.json();
          console.log("Parkings trouvÃ©s:", data);
        }
      } catch (error) {
        console.error("Erreur lors de la recherche:", error);
      }
    }
  };

  return (
    <form onSubmit={handleSearch} className="w-full max-w-4xl mx-auto scale-in">
      <div className="bg-white rounded-3xl shadow-2xl overflow-hidden hover:shadow-3xl transition-all duration-500 border border-gray-100">
        <div className="flex flex-col md:flex-row divide-y md:divide-y-0 md:divide-x divide-gray-100">
          {/* Location Input */}
          <div 
            className={`flex-1 p-6 md:p-8 transition-all duration-300 ${
              focused === 'location' ? 'bg-gray-50' : 'bg-white'
            }`}
          >
            <label className="block text-xs font-medium text-gray-500 mb-3 uppercase tracking-wider">
              Destination
            </label>
        <input
          type="text"
              placeholder="OÃ¹ souhaitez-vous vous garer ?"
          value={location}
          onChange={(e) => setLocation(e.target.value)}
              onFocus={() => setFocused('location')}
              onBlur={() => setFocused(null)}
              className="w-full text-lg md:text-xl text-gray-900 font-light focus:outline-none placeholder-gray-300 bg-transparent"
            />
          </div>

          {/* Date Input */}
          <div 
            className={`flex-1 p-6 md:p-8 transition-all duration-300 ${
              focused === 'date' ? 'bg-gray-50' : 'bg-white'
            }`}
          >
            <label className="block text-xs font-medium text-gray-500 mb-3 uppercase tracking-wider">
              Date & heure
            </label>
            <input
              type="datetime-local"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              onFocus={() => setFocused('date')}
              onBlur={() => setFocused(null)}
              className="w-full text-lg md:text-xl text-gray-900 font-light focus:outline-none bg-transparent"
        />
          </div>

          {/* Search Button */}
          <div className="p-4 md:p-6 flex items-center justify-center">
        <button
          type="submit"
              className="w-full md:w-auto bg-zenpark text-white px-10 py-4 rounded-2xl hover:bg-zenpark-700 transition-all duration-300 font-light text-lg shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center justify-center space-x-2"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span>Rechercher</span>
            </button>
          </div>
        </div>
      </div>

      {/* Quick suggestions */}
      <div className="mt-6 flex flex-wrap justify-center gap-3">
        {['Paris', 'Lyon', 'Marseille', 'Toulouse', 'Nice'].map((city) => (
          <button
            key={city}
            type="button"
            onClick={() => setLocation(city)}
            className="px-5 py-2 bg-white/20 backdrop-blur-xl border border-white/30 text-white rounded-full hover:bg-white/30 transition-all duration-300 text-sm font-light"
          >
            {city}
        </button>
        ))}
      </div>
    </form>
  );
}



================================================
FILE: frontend/src/pages/Dashboard.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";

export default function Dashboard() {
  const navigate = useNavigate();
  const [reservations, setReservations] = useState([]);
  const [abonnements, setAbonnements] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!token) {
      navigate("/login");
      return;
    }

    // RÃ©cupÃ©rer les rÃ©servations
    fetch("http://localhost:8001/api/reservations", {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (res.status === 401) {
          localStorage.removeItem("token");
          navigate("/login");
          return null;
        }
        return res.json();
      })
      .then((data) => {
        if (data) {
          setReservations(data.reservations || data || []);
        }
      })
      .catch((err) => {
        console.error("Erreur lors de la rÃ©cupÃ©ration des rÃ©servations:", err);
        setError("Erreur lors du chargement des donnÃ©es");
      });

    // RÃ©cupÃ©rer les abonnements
    fetch("http://localhost:8001/api/abonnements", {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (res.status === 401) {
          return null;
        }
        return res.json();
      })
      .then((data) => {
        if (data) {
          setAbonnements(data.abonnements || data || []);
        }
        setLoading(false);
      })
      .catch((err) => {
        console.error("Erreur lors de la rÃ©cupÃ©ration des abonnements:", err);
        setLoading(false);
      });
  }, [navigate]);

  const handleEnterParking = (reservationId) => {
    // Simuler l'entrÃ©e dans un parking
    const token = localStorage.getItem("token");
    fetch(`http://localhost:8001/api/reservations/${reservationId}/enter`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    })
      .then((res) => res.json())
      .then((data) => {
        alert("Vous Ãªtes entrÃ© dans le parking !");
        // Recharger les donnÃ©es
        window.location.reload();
      })
      .catch((err) => {
        alert("Erreur lors de l'entrÃ©e dans le parking");
      });
  };

  const handleExitParking = (reservationId) => {
    // Simuler la sortie d'un parking
    const token = localStorage.getItem("token");
    fetch(`http://localhost:8001/api/reservations/${reservationId}/exit`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    })
      .then((res) => res.json())
      .then((data) => {
        alert("Vous Ãªtes sorti du parking !");
        // Recharger les donnÃ©es
        window.location.reload();
      })
      .catch((err) => {
        alert("Erreur lors de la sortie du parking");
      });
  };

  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold mb-8 text-gray-800">
          Mon tableau de bord
        </h1>

          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
              {error}
            </div>
          )}

          {/* RÃ©servations */}
          <section className="mb-12">
            <h2 className="text-2xl font-semibold mb-4 text-gray-700">
              Mes rÃ©servations
            </h2>
            {loading ? (
              <p className="text-gray-500">Chargement...</p>
            ) : reservations.length === 0 ? (
              <div className="bg-gray-50 rounded-lg p-8 text-center">
                <p className="text-gray-600">
                  Vous n'avez aucune rÃ©servation pour le moment.
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {reservations.map((reservation) => (
                  <div
                    key={reservation.id}
                    className="bg-white rounded-xl shadow-md p-6"
                  >
                    <h3 className="text-xl font-bold mb-2">
                      {reservation.parking_nom || "Parking"}
                    </h3>
                    <p className="text-gray-600 mb-2">
                      {reservation.date_debut && reservation.date_fin
                        ? `${new Date(reservation.date_debut).toLocaleDateString()} - ${new Date(reservation.date_fin).toLocaleDateString()}`
                        : "Date non spÃ©cifiÃ©e"}
                    </p>
                    <p className="text-gray-700 mb-4">
                      <span className="font-semibold">Statut:</span>{" "}
                      {reservation.statut || "En attente"}
                    </p>
                    <div className="flex gap-2">
                      {reservation.statut === "confirmÃ©e" && (
                        <>
                          <button
                            onClick={() => handleEnterParking(reservation.id)}
                            className="flex-1 bg-[#34A853] text-white py-2 rounded-lg hover:bg-[#2d8f45] transition font-medium"
                          >
                            Entrer
                          </button>
                          <button
                            onClick={() => handleExitParking(reservation.id)}
                            className="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition font-medium"
                          >
                            Sortir
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </section>

          {/* Abonnements */}
          <section>
            <h2 className="text-2xl font-semibold mb-4 text-gray-700">
              Mes abonnements
            </h2>
            {loading ? (
              <p className="text-gray-500">Chargement...</p>
            ) : abonnements.length === 0 ? (
              <div className="bg-gray-50 rounded-lg p-8 text-center">
                <p className="text-gray-600">
                  Vous n'avez aucun abonnement pour le moment.
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {abonnements.map((abonnement) => (
                  <div
                    key={abonnement.id}
                    className="bg-white rounded-xl shadow-md p-6"
                  >
                    <h3 className="text-xl font-bold mb-2">
                      {abonnement.parking_nom || "Parking"}
                    </h3>
                    <p className="text-gray-600 mb-2">
                      Abonnement mensuel
                    </p>
                    <p className="text-gray-700">
                      <span className="font-semibold">Prix:</span>{" "}
                      {abonnement.prix_mensuel || "N/A"} â‚¬/mois
                    </p>
                  </div>
                ))}
              </div>
            )}
          </section>
      </main>
      <Footer />
    </div>
  );
}
  


================================================
FILE: frontend/src/pages/Login.jsx
================================================
import React, { useState } from "react";
import { useNavigate, Link } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function Login() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");
    
    // Validation cÃ´tÃ© client
    if (!email || !password) {
      setError("Veuillez remplir tous les champs");
      return;
    }
    
    if (!email.includes('@')) {
      setError("Veuillez entrer une adresse email valide");
      return;
    }
    
    if (password.length < 6) {
      setError("Le mot de passe doit contenir au moins 6 caractÃ¨res");
      return;
    }
    
    setLoading(true);

    try {
      // Normaliser l'email
      const normalizedEmail = email.trim().toLowerCase();
      
      // Debug: vÃ©rifier localStorage avant connexion
      const storedUsers = localStorage.getItem('mockUsers');
      console.log('ğŸ“¦ Utilisateurs dans localStorage:', storedUsers ? JSON.parse(storedUsers) : 'Aucun');
      
      const result = await apiService.login(normalizedEmail, password);
      
      if (result.success && result.token && result.user) {
        // Sauvegarder dans localStorage
        localStorage.setItem("token", result.token);
        localStorage.setItem("user", JSON.stringify(result.user));
        
        console.log('âœ… Token sauvegardÃ©:', result.token);
        console.log('âœ… Utilisateur sauvegardÃ©:', result.user);
        
        // Redirection selon le rÃ´le
        if (result.user.role === 'owner') {
          navigate("/dashboard-owner", { replace: true });
        } else {
          navigate("/dashboard-user", { replace: true });
        }
      } else {
        setError("Erreur lors de la connexion. Veuillez rÃ©essayer.");
      }
    } catch (err) {
      console.error('âŒ Erreur connexion:', err);
      console.error('ğŸ“§ Email utilisÃ©:', email.trim().toLowerCase());
      console.error('ğŸ”‘ Mot de passe utilisÃ©:', password);
      
      // Message d'erreur plus dÃ©taillÃ©
      let errorMessage = err.message || "Email ou mot de passe incorrect";
      if (errorMessage.includes('Email ou mot de passe incorrect')) {
        errorMessage += "\n\nğŸ’¡ VÃ©rifiez que vous avez bien crÃ©Ã© un compte. Si c'est le cas, vÃ©rifiez l'email et le mot de passe dans la console (F12).";
      }
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-br from-gray-50 to-white">
      <Header />
      <main className="flex-1 flex items-center justify-center py-32 px-6">
        <div className="w-full max-w-md">
          <div className="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
            {/* Logo */}
            <div className="flex justify-center mb-8">
              <div className="w-16 h-16 bg-gray-900 rounded-full flex items-center justify-center">
                <span className="text-white text-2xl font-bold">P</span>
              </div>
            </div>

            <h1 className="text-4xl font-light text-center mb-3 text-gray-900 tracking-tight">
              Connexion
            </h1>
            <p className="text-center text-gray-500 mb-10 font-light">
              Bienvenue ! Connectez-vous Ã  votre compte
            </p>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-gray-700 font-light mb-3 text-sm">
                  Adresse email
                </label>
                <input
                  type="email"
                  placeholder="votre@email.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                  required
                />
              </div>

              <div>
                <label className="block text-gray-700 font-light mb-3 text-sm">
                  Mot de passe
                </label>
                <input
                  type="password"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                  required
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-5 py-4 rounded-2xl text-sm font-light flex items-center gap-2 animate-pulse">
                  <span>âŒ</span>
                  <span>{error}</span>
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gray-900 text-white py-5 rounded-2xl hover:bg-gray-800 transition-all duration-300 font-light text-base disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl hover:-translate-y-0.5"
              >
                {loading ? "Connexion en cours..." : "Se connecter"}
              </button>
            </form>

            <div className="mt-10 text-center">
              <p className="text-gray-500 font-light text-sm">
                Pas encore de compte ?{" "}
                <Link
                  to="/register"
                  className="text-gray-900 hover:text-gray-700 font-medium transition-colors"
                >
                  CrÃ©er un compte
                </Link>
              </p>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/pages/Maps.jsx
================================================
import React, { useState, useEffect } from 'react';
import { MapContainer, TileLayer, Marker, Popup, useMap, CircleMarker } from 'react-leaflet';
import L from 'leaflet';
import { apiService } from '../services/apiService';
import Header from '../components/Header';
import Footer from '../components/Footer';
import 'leaflet/dist/leaflet.css';

// Fix pour les icÃ´nes Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// Composant pour centrer la carte
const MapController = ({ center, zoom }) => {
  const map = useMap();
  useEffect(() => {
    map.setView(center, zoom);
  }, [map, center, zoom]);
  return null;
};

const Maps = () => {
  const [parkings, setParkings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedParking, setSelectedParking] = useState(null);
  const [mapStyle, setMapStyle] = useState('light'); // light, dark, satellite
  const [center, setCenter] = useState([46.6034, 1.8883]);
  const [zoom, setZoom] = useState(6);

  useEffect(() => {
    loadParkings();
  }, []);

  const loadParkings = async () => {
    setLoading(true);
    try {
      const response = await apiService.searchParkings({});
      setParkings(response.parkings || []);
    } catch (error) {
      console.error('Erreur chargement parkings:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleMarkerClick = (parking) => {
    setSelectedParking(parking);
    setCenter([parking.latitude, parking.longitude]);
    setZoom(13);
  };

  const handleReserve = (parking) => {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
      return;
    }
    window.location.href = `/reservation?parking=${parking.id}`;
  };

  const getTileUrl = () => {
    switch (mapStyle) {
      case 'dark':
        return 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
      case 'satellite':
        return 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
      default:
        return 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
    }
  };

  if (loading) {
    return (
      <>
        <Header />
        <div className="min-h-screen bg-white pt-24 flex items-center justify-center">
          <div className="w-16 h-16 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
        </div>
        <Footer />
      </>
    );
  }

  return (
    <>
      <Header />
      <div className="min-h-screen bg-white relative">
        {/* Header Flottant Ultra-Moderne */}
        <div className="absolute top-24 left-0 right-0 z-[100] pointer-events-none">
          <div className="max-w-7xl mx-auto px-6 py-6">
            <div className="flex items-center justify-between gap-4">
              <div className="bg-white/95 backdrop-blur-2xl rounded-3xl border border-gray-200/50 shadow-2xl p-6 pointer-events-auto">
                <h1 className="text-4xl font-extralight text-gray-900 tracking-tighter mb-1">
                  Carte des parkings
                </h1>
                <p className="text-xs text-gray-400 font-light uppercase tracking-wider">
                  {parkings.length} parkings disponibles
                </p>
              </div>

              {/* SÃ©lecteur de style de carte */}
              <div className="bg-white/95 backdrop-blur-2xl rounded-3xl border border-gray-200/50 shadow-2xl p-2 pointer-events-auto flex gap-2">
                {[
                  { value: 'light', label: 'Clair', icon: 'â˜€ï¸' },
                  { value: 'dark', label: 'Sombre', icon: 'ğŸŒ™' },
                  { value: 'satellite', label: 'Satellite', icon: 'ğŸ›°ï¸' }
                ].map(style => (
                  <button
                    key={style.value}
                    onClick={() => setMapStyle(style.value)}
                    className={`px-4 py-2.5 rounded-2xl text-sm font-light transition-all ${
                      mapStyle === style.value
                        ? 'bg-gray-900 text-white shadow-lg'
                        : 'text-gray-600 hover:bg-gray-50'
                    }`}
                  >
                    <span className="mr-2">{style.icon}</span>
                    {style.label}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Carte Plein Ã‰cran */}
        <div className="relative h-screen w-full">
          <MapContainer
            center={center}
            zoom={zoom}
            style={{ height: '100%', width: '100%', zIndex: 0 }}
            scrollWheelZoom={true}
            zoomControl={true}
            className="modern-map"
          >
            <TileLayer
              attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>'
              url={getTileUrl()}
            />
            <MapController center={center} zoom={zoom} />
            
            {parkings.map((parking) => {
              if (!parking.latitude || !parking.longitude) return null;
              
              return (
                <React.Fragment key={parking.id}>
                  {/* Cercle animÃ© autour du marqueur */}
                  <CircleMarker
                    center={[parking.latitude, parking.longitude]}
                    radius={8}
                    pathOptions={{
                      fillColor: parking.places_disponibles > 50 ? '#10b981' : parking.places_disponibles > 20 ? '#f59e0b' : '#ef4444',
                      fillOpacity: 0.3,
                      color: parking.places_disponibles > 50 ? '#10b981' : parking.places_disponibles > 20 ? '#f59e0b' : '#ef4444',
                      weight: 2
                    }}
                  />
                  <Marker
                    position={[parking.latitude, parking.longitude]}
                    eventHandlers={{
                      click: () => handleMarkerClick(parking),
                    }}
                  >
                    <Popup className="modern-popup" autoClose={false} closeOnClick={false}>
                      <div className="p-5 min-w-[300px]">
                        <div className="flex items-start justify-between mb-4">
                          <div className="flex-1">
                            <h3 className="text-xl font-extralight text-gray-900 mb-2">
                              {parking.nom}
                            </h3>
                            <p className="text-sm text-gray-500 font-light mb-3">
                              ğŸ“ {parking.adresse}
                            </p>
                            <div className="flex items-center gap-4 mb-4 text-xs text-gray-400 font-light">
                              <span className="flex items-center gap-1">
                                â­ {parking.note}
                              </span>
                              <span className="flex items-center gap-1">
                                ğŸ…¿ï¸ {parking.places_disponibles} places
                              </span>
                              <span className="flex items-center gap-1">
                                ğŸ’° {parking.tarif_horaire}â‚¬/h
                              </span>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-4">
                              {parking.services.slice(0, 3).map(service => (
                                <span
                                  key={service}
                                  className="px-2.5 py-1 bg-gray-100 text-gray-600 rounded-lg text-xs font-light"
                                >
                                  {service}
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={() => handleReserve(parking)}
                          className="w-full bg-gray-900 text-white py-3 px-4 rounded-xl text-sm font-light hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl"
                        >
                          RÃ©server maintenant
                        </button>
                      </div>
                    </Popup>
                  </Marker>
                </React.Fragment>
              );
            })}
          </MapContainer>
        </div>

        {/* Card sÃ©lectionnÃ©e - Design Ultra-Moderne */}
        {selectedParking && (
          <div className="fixed bottom-6 left-6 right-6 z-[100] pointer-events-none animate-fade-in">
            <div className="max-w-lg mx-auto">
              <div className="bg-white/98 backdrop-blur-2xl rounded-3xl border border-gray-200/50 shadow-2xl p-8 pointer-events-auto transform transition-all duration-500">
                <div className="flex items-start justify-between mb-6">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-12 h-12 bg-gray-900 rounded-2xl flex items-center justify-center text-white text-xl">
                        ğŸ…¿ï¸
                      </div>
                      <div>
                        <h3 className="text-2xl font-extralight text-gray-900 mb-1">
                          {selectedParking.nom}
                        </h3>
                        <p className="text-xs text-gray-400 font-light uppercase tracking-wider">
                          {selectedParking.ville}
                        </p>
                      </div>
                    </div>
                    <p className="text-gray-500 font-light text-sm mb-4">
                      ğŸ“ {selectedParking.adresse}
                    </p>
                    <div className="grid grid-cols-3 gap-3 mb-6">
                      <div className="bg-gray-50 rounded-xl p-3 text-center">
                        <div className="text-lg font-extralight text-gray-900 mb-1">
                          â­ {selectedParking.note}
                        </div>
                        <div className="text-xs text-gray-400 font-light">Note</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 text-center">
                        <div className="text-lg font-extralight text-gray-900 mb-1">
                          ğŸ…¿ï¸ {selectedParking.places_disponibles}
                        </div>
                        <div className="text-xs text-gray-400 font-light">Places</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 text-center">
                        <div className="text-lg font-extralight text-gray-900 mb-1">
                          {selectedParking.tarif_horaire}â‚¬
                        </div>
                        <div className="text-xs text-gray-400 font-light">Par heure</div>
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2 mb-6">
                      {selectedParking.services.map(service => (
                        <span
                          key={service}
                          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-xs font-light"
                        >
                          {service}
                        </span>
                      ))}
                    </div>
                  </div>
                  <button
                    onClick={() => {
                      setSelectedParking(null);
                      setZoom(6);
                      setCenter([46.6034, 1.8883]);
                    }}
                    className="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center text-gray-600 text-lg ml-4"
                  >
                    âœ•
                  </button>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setCenter([selectedParking.latitude, selectedParking.longitude]);
                      setZoom(15);
                    }}
                    className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-light hover:bg-gray-200 transition-all text-sm"
                  >
                    ğŸ“ Centrer
                  </button>
                  <button
                    onClick={() => handleReserve(selectedParking)}
                    className="flex-1 bg-gray-900 text-white py-3 rounded-xl font-light hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl"
                  >
                    RÃ©server
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* LÃ©gende */}
        <div className="absolute bottom-6 right-6 z-[100] bg-white/95 backdrop-blur-2xl rounded-2xl border border-gray-200/50 shadow-2xl p-4 pointer-events-auto">
          <div className="text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">DisponibilitÃ©</div>
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-green-500"></div>
              <span className="text-xs text-gray-600 font-light">+50 places</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-amber-500"></div>
              <span className="text-xs text-gray-600 font-light">20-50 places</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-red-500"></div>
              <span className="text-xs text-gray-600 font-light">&lt;20 places</span>
            </div>
          </div>
        </div>
      </div>
      <Footer />
    </>
  );
};

export default Maps;



================================================
FILE: frontend/src/pages/MesReservations.jsx
================================================
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { apiService } from '../services/apiService';
import Header from '../components/Header';
import Footer from '../components/Footer';
import { 
  AlertCircle, 
  Plus, 
  Calendar, 
  MapPin, 
  Car, 
  Tag, 
  CheckCircle,
  X,
  LogIn,
  LogOut
} from 'lucide-react';

const MesReservations = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [reservations, setReservations] = useState([]);
  const [filter, setFilter] = useState('all'); // all, upcoming, past, cancelled

  useEffect(() => {
    loadReservations();
  }, []);

  const loadReservations = async () => {
    setLoading(true);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vous devez Ãªtre connectÃ© pour voir vos rÃ©servations');
        navigate('/login');
        return;
      }

      const response = await apiService.getReservations(token);
      if (response.success) {
        setReservations(response.reservations || []);
      } else {
        alert('Erreur lors du chargement des rÃ©servations');
      }
    } catch (error) {
      console.error('Erreur chargement rÃ©servations:', error);
      if (error.message.includes('Utilisateur non trouvÃ©') || error.message.includes('Token')) {
        alert('Session expirÃ©e. Veuillez vous reconnecter.');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        navigate('/login');
      } else {
        alert('Erreur: ' + error.message);
      }
    } finally {
      setLoading(false);
    }
  };

  const getFilteredReservations = () => {
    const now = new Date();
    
    switch (filter) {
      case 'upcoming':
        return reservations.filter(r => new Date(r.date_debut) > now);
      case 'past':
        return reservations.filter(r => new Date(r.date_fin) < now);
      case 'cancelled':
        return reservations.filter(r => r.statut === 'annulÃ©e');
      default:
        return reservations;
    }
  };

  const filteredReservations = getFilteredReservations();

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const getStatusBadge = (reservation) => {
    const now = new Date();
    const debut = new Date(reservation.date_debut);
    const fin = new Date(reservation.date_fin);

    if (reservation.statut === 'annulÃ©e') {
      return <span className="px-4 py-2 bg-red-100 text-red-700 rounded-full text-sm font-medium">AnnulÃ©e</span>;
    }
    if (now < debut) {
      return <span className="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">Ã€ venir</span>;
    }
    if (now >= debut && now <= fin) {
      return <span className="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm font-medium">En cours</span>;
    }
    return <span className="px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">TerminÃ©e</span>;
  };

  return (
    <>
      <Header />
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white pt-24 pb-20">
        <div className="max-w-6xl mx-auto px-6 py-12">
          {/* Header */}
          <div className="mb-12">
            <h1 className="text-5xl font-light text-gray-900 mb-4 tracking-tight">
              Mes rÃ©servations
            </h1>
            <p className="text-xl text-gray-500 font-light">
              GÃ©rez toutes vos rÃ©servations en un seul endroit
            </p>
          </div>

          {/* Filtres */}
          <div className="flex flex-wrap gap-3 mb-8">
            {[
              { value: 'all', label: 'Toutes', count: reservations.length },
              { value: 'upcoming', label: 'Ã€ venir', count: reservations.filter(r => new Date(r.date_debut) > new Date()).length },
              { value: 'past', label: 'PassÃ©es', count: reservations.filter(r => new Date(r.date_fin) < new Date()).length },
              { value: 'cancelled', label: 'AnnulÃ©es', count: reservations.filter(r => r.statut === 'annulÃ©e').length }
            ].map(item => (
              <button
                key={item.value}
                onClick={() => setFilter(item.value)}
                className={`px-6 py-3 rounded-2xl font-medium transition-all ${
                  filter === item.value
                    ? 'bg-gray-900 text-white shadow-lg'
                    : 'bg-white text-gray-700 border border-gray-200 hover:border-gray-300'
                }`}
              >
                {item.label} ({item.count})
              </button>
            ))}
          </div>

          {/* Bouton nouvelle rÃ©servation */}
          <div className="mb-8">
            <button
              onClick={() => navigate('/reservation')}
              className="bg-primary text-white px-8 py-4 rounded-2xl font-medium hover:bg-primary-dark transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
            >
              â• Nouvelle rÃ©servation
            </button>
          </div>

          {/* Liste des rÃ©servations */}
          {loading ? (
            <div className="flex items-center justify-center py-20">
              <div className="w-16 h-16 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
            </div>
          ) : filteredReservations.length === 0 ? (
            <div className="text-center py-20">
              <div className="text-6xl mb-4">ğŸ“…</div>
              <h3 className="text-2xl font-light text-gray-900 mb-2">
                Aucune rÃ©servation
              </h3>
              <p className="text-gray-500 mb-8">
                {filter === 'all' 
                  ? "Vous n'avez pas encore de rÃ©servation"
                  : `Vous n'avez pas de rÃ©servation ${filter === 'upcoming' ? 'Ã  venir' : filter === 'past' ? 'passÃ©e' : 'annulÃ©e'}`
                }
              </p>
              <button
                onClick={() => navigate('/reservation')}
                className="bg-gray-900 text-white px-8 py-4 rounded-2xl font-medium hover:bg-gray-800 transition-all shadow-lg"
              >
                Faire une rÃ©servation
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              {filteredReservations.map(reservation => (
                <ReservationCard
                  key={reservation.id}
                  reservation={reservation}
                  statusBadge={getStatusBadge(reservation)}
                  formatDate={formatDate}
                  onCancel={loadReservations}
                />
              ))}
            </div>
          )}
        </div>
      </div>
      <Footer />
    </>
  );
};

// Composant carte de rÃ©servation
const ReservationCard = ({ reservation, statusBadge, formatDate, onCancel }) => {
  const [showDetails, setShowDetails] = useState(false);
  const [cancelling, setCancelling] = useState(false);
  const [actionLoading, setActionLoading] = useState(false);
  
  const handleCancel = async () => {
    if (!window.confirm('ÃŠtes-vous sÃ»r de vouloir annuler cette rÃ©servation ?')) {
      return;
    }
    
    setCancelling(true);
    try {
      const token = localStorage.getItem('token');
      const response = await apiService.cancelReservation(token, reservation.id);
      
      if (response.success) {
        alert(`âœ… ${response.message}\n\nVotre place a Ã©tÃ© libÃ©rÃ©e et est maintenant disponible pour d'autres utilisateurs.`);
        onCancel(); // Recharger les rÃ©servations
      }
    } catch (error) {
      alert('âŒ ' + error.message);
    } finally {
      setCancelling(false);
    }
  };

  const handleEnter = async () => {
    setActionLoading(true);
    try {
      const token = localStorage.getItem('token');
      const response = await apiService.enterReservation(token, reservation.id);
      if (response.success) {
        alert(`âœ… ${response.message}`);
        onCancel();
      }
    } catch (error) {
      alert('âŒ ' + error.message);
    } finally {
      setActionLoading(false);
    }
  };

  const handleExit = async () => {
    if (!window.confirm('Confirmer la sortie du parking ? Cela arrÃªtera le compteur.')) return;
    setActionLoading(true);
    try {
      const token = localStorage.getItem('token');
      const response = await apiService.exitReservation(token, reservation.id);
      if (response.success) {
        alert(`âœ… ${response.message}\n\nğŸ’° Montant final : ${response.montant_final} â‚¬\nâ± DurÃ©e : ${response.duree_totale}`);
        onCancel();
      }
    } catch (error) {
      alert('âŒ ' + error.message);
    } finally {
      setActionLoading(false);
    }
  };

  const handleInvoice = async () => {
    try {
      // Pas besoin de token ici car cookie
      const htmlContent = await apiService.getInvoice(reservation.id);
      
      // Ouvrir une nouvelle fenÃªtre avec le HTML
      const win = window.open("", "_blank");
      win.document.write(htmlContent);
      win.document.close();
    } catch (error) {
      alert('âŒ Impossible de rÃ©cupÃ©rer la facture : ' + error.message);
    }
  };

  const canEnter = reservation.statut === 'confirmÃ©e' && !reservation.date_entree && !reservation.date_sortie;
  const canExit = reservation.statut === 'confirmÃ©e' && reservation.date_entree && !reservation.date_sortie;
  // Facture disponible si terminÃ©e et payÃ©e (ou montant final > 0)
  const canInvoice = reservation.date_sortie && reservation.montant_final;

  return (
    <div className="bg-white rounded-3xl border border-gray-200 overflow-hidden hover:shadow-xl transition-all duration-500">
      <div className="p-8">
        <div className="flex items-start justify-between mb-6">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-3">
              <h3 className="text-2xl font-medium text-gray-900">
                {reservation.parking_nom}
              </h3>
              {statusBadge}
            </div>
            <p className="text-gray-500 mb-2">
              ğŸ“ {reservation.parking_adresse || 'Adresse non disponible'}
            </p>
            <p className="text-gray-400 text-sm flex items-center gap-3">
              <span>RÃ©servation #{reservation.id}</span>
              {reservation.vehicule && <span>ğŸš— {reservation.vehicule}</span>}
              {reservation.immatriculation && <span>ğŸ”– {reservation.immatriculation}</span>}
            </p>
          </div>
          <div className="text-right">
            <div className="text-3xl font-light text-gray-900 mb-1">
              {reservation.montant_final ? reservation.montant_final : reservation.montant}â‚¬
            </div>
            <div className="text-sm text-gray-500">{reservation.montant_final ? 'Montant final' : 'Montant estimÃ©'}</div>
            
            {/* Bouton Facture */}
            {canInvoice && (
              <button
                onClick={handleInvoice}
                className="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center justify-end gap-1 w-full"
              >
                ğŸ“„ Facture
              </button>
            )}
          </div>
        </div>

        {/* Dates */}
        <div className="grid md:grid-cols-2 gap-4 mb-6 p-6 bg-gray-50 rounded-2xl">
          <div>
            <div className="text-sm text-gray-500 mb-1">DÃ©but</div>
            <div className="text-gray-900 font-medium">
              {formatDate(reservation.date_debut)}
            </div>
            {reservation.date_entree && (
                <div className="text-xs text-green-600 mt-1">
                    EntrÃ© Ã  {formatDate(reservation.date_entree)}
                </div>
            )}
          </div>
          <div>
            <div className="text-sm text-gray-500 mb-1">Fin</div>
            <div className="text-gray-900 font-medium">
              {formatDate(reservation.date_fin)}
            </div>
            {reservation.date_sortie && (
                <div className="text-xs text-red-600 mt-1">
                    Sorti Ã  {formatDate(reservation.date_sortie)}
                </div>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3 flex-wrap">
          <button
            onClick={() => setShowDetails(!showDetails)}
            className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all"
          >
            {showDetails ? 'Masquer' : 'DÃ©tails'}
          </button>
          
          {canEnter && (
            <button
                onClick={handleEnter}
                disabled={actionLoading}
                className="flex-1 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-all flex items-center justify-center gap-2"
            >
                <LogIn size={18} /> {actionLoading ? '...' : 'Entrer'}
            </button>
          )}

          {canExit && (
            <button
                onClick={handleExit}
                disabled={actionLoading}
                className="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 transition-all flex items-center justify-center gap-2"
            >
                <LogOut size={18} /> {actionLoading ? '...' : 'Sortir'}
            </button>
          )}

          {reservation.statut !== 'annulÃ©e' && !reservation.date_entree && new Date(reservation.date_debut) > new Date() && (
            <button
              onClick={handleCancel}
              disabled={cancelling}
              className="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-medium hover:bg-red-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {cancelling ? '...' : 'Annuler'}
            </button>
          )}
        </div>

        {/* DÃ©tails supplÃ©mentaires */}
        {showDetails && (
          <div className="mt-6 pt-6 border-t border-gray-100 space-y-3">
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">DurÃ©e prÃ©vue</span>
              <span className="text-gray-900 font-medium">
                {Math.ceil((new Date(reservation.date_fin) - new Date(reservation.date_debut)) / (1000 * 60 * 60))} heures
              </span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">Type de stationnement</span>
              <span className="text-gray-900 font-medium">Horaire</span>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default MesReservations;




================================================
FILE: frontend/src/pages/OwnerDashboard.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function OwnerDashboard() {
  const navigate = useNavigate();
  const [parkings, setParkings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [showAddForm, setShowAddForm] = useState(false);
  const [showEditForm, setShowEditForm] = useState(null);
  const userStr = localStorage.getItem("user");
  const user = userStr ? JSON.parse(userStr) : null;
  
  const [monthlyRevenue, setMonthlyRevenue] = useState(0);
  const [activeReservations, setActiveReservations] = useState(0);
  const [activeStationnements, setActiveStationnements] = useState(0);

  const [newParking, setNewParking] = useState({
    nom: "",
    adresse: "",
    nombre_places: "",
    tarif_horaire: "",
    tarif_journalier: "",
    tarif_mensuel: "",
    horaire_ouverture: "",
    horaire_fermeture: "",
  });

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!token) {
      navigate("/login");
      return;
    }

    loadData();
  }, [navigate]);

  const loadData = async () => {
    const token = localStorage.getItem("token");
    setLoading(true);
    setError("");

    try {
      const parkingsResult = await apiService.getOwnerParkings(token);
      if (parkingsResult.success) {
        setParkings(parkingsResult.parkings || []);
      }

      const revenueResult = await apiService.getMonthlyRevenue(token);
      if (revenueResult.success) {
        setMonthlyRevenue(revenueResult.revenus_mensuels || 0);
      }

      const reservationsResult = await apiService.getActiveReservations(token);
      if (reservationsResult.success) {
        setActiveReservations(reservationsResult.reservations_en_cours || 0);
      }

      const stationnementsResult = await apiService.getActiveStationnements(token);
      if (stationnementsResult.success) {
        setActiveStationnements(stationnementsResult.stationnements_actifs || 0);
      }
    } catch (err) {
      setError(err.message || "Erreur lors du chargement des donnÃ©es");
    } finally {
      setLoading(false);
    }
  };

  const handleAddParking = async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");
    setError("");

    try {
      const result = await apiService.addParking(token, newParking);
      
      if (result.success) {
        setParkings([...parkings, result.parking]);
        setNewParking({
          nom: "",
          adresse: "",
          nombre_places: "",
          tarif_horaire: "",
          tarif_journalier: "",
          tarif_mensuel: "",
          horaire_ouverture: "",
          horaire_fermeture: "",
        });
        setShowAddForm(false);
        loadData();
      }
    } catch (err) {
      setError(err.message || "Erreur lors de l'ajout du parking");
    }
  };

  const handleUpdateParking = async (parkingId, updatedData) => {
    setError("");
    try {
      setParkings(
        parkings.map((p) => (p.id === parkingId ? { ...p, ...updatedData } : p))
      );
      setShowEditForm(null);
    } catch (err) {
      setError(err.message || "Erreur lors de la modification");
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <Header />
      <main className="flex-1">
        {/* Hero Section */}
        <section className="bg-zenpark text-white py-12">
          <div className="container mx-auto px-6 lg:px-12">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-4xl font-serif font-normal mb-2">
            Espace propriÃ©taire
          </h1>
                <p className="text-white/90 text-lg">
                  GÃ©rez vos parkings et suivez vos revenus
                </p>
              </div>
          <button
            onClick={() => setShowAddForm(true)}
                className="hidden md:block bg-white text-zenpark px-6 py-3 rounded-xl hover:bg-gray-100 transition font-medium"
          >
            + Ajouter un parking
          </button>
        </div>
          </div>
        </section>

        <div className="container mx-auto px-6 lg:px-12 py-12">
        {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl mb-8">
            {error}
          </div>
        )}

          {/* Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div className="bg-white rounded-2xl shadow p-6">
              <h3 className="text-sm text-gray-600 mb-2">Revenus mensuels</h3>
              <p className="text-3xl font-bold text-zenpark">{monthlyRevenue.toFixed(2)} â‚¬</p>
          </div>

            <div className="bg-white rounded-2xl shadow p-6">
              <h3 className="text-sm text-gray-600 mb-2">RÃ©servations en cours</h3>
              <p className="text-3xl font-bold text-zenpark">{activeReservations}</p>
          </div>

            <div className="bg-white rounded-2xl shadow p-6">
              <h3 className="text-sm text-gray-600 mb-2">Stationnements actifs</h3>
              <p className="text-3xl font-bold text-zenpark">{activeStationnements}</p>
          </div>
        </div>

        {/* Formulaire d'ajout */}
        {showAddForm && (
            <div className="bg-white rounded-2xl shadow p-8 mb-12">
              <h2 className="text-2xl font-serif font-normal mb-6 text-gray-900">
                Ajouter un parking
              </h2>
              
              <form onSubmit={handleAddParking} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Nom du parking</label>
                <input
                  type="text"
                      placeholder="Ex: Parking Gare Lyon"
                  value={newParking.nom}
                      onChange={(e) => setNewParking({ ...newParking, nom: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Adresse</label>
                <input
                  type="text"
                      placeholder="123 Rue de la Gare"
                  value={newParking.adresse}
                      onChange={(e) => setNewParking({ ...newParking, adresse: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Nombre de places</label>
                <input
                  type="number"
                      placeholder="50"
                  value={newParking.nombre_places}
                      onChange={(e) => setNewParking({ ...newParking, nombre_places: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="1"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Tarif horaire (â‚¬)</label>
                <input
                  type="number"
                  step="0.01"
                      placeholder="2.50"
                  value={newParking.tarif_horaire}
                      onChange={(e) => setNewParking({ ...newParking, tarif_horaire: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="0"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Tarif journalier (â‚¬)</label>
                <input
                  type="number"
                  step="0.01"
                      placeholder="15.00"
                  value={newParking.tarif_journalier}
                      onChange={(e) => setNewParking({ ...newParking, tarif_journalier: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="0"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Tarif mensuel (â‚¬)</label>
                <input
                  type="number"
                  step="0.01"
                      placeholder="120.00"
                  value={newParking.tarif_mensuel}
                      onChange={(e) => setNewParking({ ...newParking, tarif_mensuel: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="0"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Heure d'ouverture</label>
                <input
                  type="time"
                  value={newParking.horaire_ouverture}
                      onChange={(e) => setNewParking({ ...newParking, horaire_ouverture: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Heure de fermeture</label>
                <input
                  type="time"
                  value={newParking.horaire_fermeture}
                      onChange={(e) => setNewParking({ ...newParking, horaire_fermeture: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
              </div>
                </div>
                
                <div className="flex gap-4">
                  <button type="submit" className="bg-zenpark text-white px-8 py-3 rounded-xl hover:bg-zenpark-700 transition font-medium">
                    Ajouter le parking
                </button>
                <button
                  type="button"
                  onClick={() => setShowAddForm(false)}
                    className="bg-gray-200 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-300 transition font-medium"
                >
                  Annuler
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Liste des parkings */}
        <section>
            <h2 className="text-3xl font-serif font-normal mb-6 text-gray-900">
              Mes parkings ({parkings.length})
          </h2>

          {loading ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
              <p className="text-gray-600">Chargement...</p>
            </div>
          ) : parkings.length === 0 ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
                <p className="text-gray-600 mb-6">
                Vous n'avez pas encore de parking. Ajoutez-en un !
              </p>
              <button
                onClick={() => setShowAddForm(true)}
                  className="bg-zenpark text-white px-8 py-3 rounded-xl hover:bg-zenpark-700 transition font-medium"
              >
                  Ajouter mon premier parking
              </button>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {parkings.map((parking) => (
                  <div key={parking.id} className="bg-white rounded-2xl shadow p-6">
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">{parking.nom}</h3>
                    <p className="text-gray-600 text-sm mb-4">{parking.adresse}</p>
                    
                    <div className="space-y-2 mb-4 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Places:</span>
                        <span className="font-medium">{parking.nombre_places}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Tarif horaire:</span>
                        <span className="font-medium text-zenpark">{parking.tarif_horaire} â‚¬</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Tarif journalier:</span>
                        <span className="font-medium text-zenpark">{parking.tarif_journalier} â‚¬</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Horaires:</span>
                        <span className="font-medium">{parking.horaire_ouverture} - {parking.horaire_fermeture}</span>
                      </div>
                  </div>

                    <button
                      onClick={() => setShowEditForm(showEditForm === parking.id ? null : parking.id)}
                      className="w-full bg-gray-100 text-gray-900 py-2 rounded-xl hover:bg-gray-200 transition font-medium"
                    >
                      {showEditForm === parking.id ? 'Annuler' : 'Modifier'}
                    </button>

                  {showEditForm === parking.id && (
                      <form
                        onSubmit={(e) => {
                          e.preventDefault();
                          const formData = new FormData(e.target);
                          const updatedData = {
                            tarif_horaire: formData.get("tarif_horaire"),
                            tarif_journalier: formData.get("tarif_journalier"),
                            tarif_mensuel: formData.get("tarif_mensuel"),
                            horaire_ouverture: formData.get("horaire_ouverture"),
                            horaire_fermeture: formData.get("horaire_fermeture"),
                          };
                          handleUpdateParking(parking.id, updatedData);
                        }}
                        className="mt-4 space-y-3 pt-4 border-t border-gray-100"
                      >
                        <input
                          type="number"
                          step="0.01"
                          name="tarif_horaire"
                          defaultValue={parking.tarif_horaire}
                          placeholder="Tarif horaire"
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="number"
                          step="0.01"
                          name="tarif_journalier"
                          defaultValue={parking.tarif_journalier}
                          placeholder="Tarif journalier"
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="number"
                          step="0.01"
                          name="tarif_mensuel"
                          defaultValue={parking.tarif_mensuel}
                          placeholder="Tarif mensuel"
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="time"
                          name="horaire_ouverture"
                          defaultValue={parking.horaire_ouverture}
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="time"
                          name="horaire_fermeture"
                          defaultValue={parking.horaire_fermeture}
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                          <button
                            type="submit"
                          className="w-full bg-zenpark text-white py-2 rounded-xl hover:bg-zenpark-700 transition font-medium"
                          >
                            Enregistrer
                          </button>
                      </form>
                  )}
                </div>
              ))}
            </div>
          )}
        </section>
        </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/pages/ParkingDetails.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate, useParams, Link } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function ParkingDetails() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [parking, setParking] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [showReservationForm, setShowReservationForm] = useState(false);
  const [reservationForm, setReservationForm] = useState({
    date_debut: "",
    date_fin: "",
    type: "journalier", // horaire, journalier, mensuel
  });

  useEffect(() => {
    loadParkingDetails();
  }, [id]);

  const loadParkingDetails = async () => {
    setLoading(true);
    setError("");

    try {
      const result = await apiService.getParkingDetails(id);
      if (result.success) {
        setParking(result.parking);
      }
    } catch (err) {
      setError(err.message || "Erreur lors du chargement des dÃ©tails du parking");
    } finally {
      setLoading(false);
    }
  };

  const handleReserve = async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");

    if (!token) {
      navigate("/login");
      return;
    }

    setError("");

    try {
      const result = await apiService.reserveParking(token, id, reservationForm);
      
      if (result.success) {
        alert("RÃ©servation confirmÃ©e avec succÃ¨s !");
        navigate("/dashboard-user");
      }
    } catch (err) {
      setError(err.message || "Erreur lors de la rÃ©servation");
    }
  };

  const calculatePrice = () => {
    if (!parking || !reservationForm.date_debut || !reservationForm.date_fin) {
      return 0;
    }

    const start = new Date(reservationForm.date_debut);
    const end = new Date(reservationForm.date_fin);
    const diffHours = (end - start) / (1000 * 60 * 60);

    switch (reservationForm.type) {
      case "horaire":
        return (diffHours * parseFloat(parking.tarif_horaire)).toFixed(2);
      case "journalier":
        const days = Math.ceil(diffHours / 24);
        return (days * parseFloat(parking.tarif_journalier)).toFixed(2);
      case "mensuel":
        return parseFloat(parking.tarif_mensuel).toFixed(2);
      default:
        return 0;
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col">
        <Header />
        <main className="flex-1 flex items-center justify-center">
          <p className="text-gray-600">Chargement...</p>
        </main>
        <Footer />
      </div>
    );
  }

  if (error && !parking) {
    return (
      <div className="min-h-screen flex flex-col">
        <Header />
        <main className="flex-1 flex items-center justify-center">
          <div className="text-center">
            <p className="text-red-600 mb-4">{error}</p>
            <Link
              to="/"
              className="text-[#34A853] hover:underline font-medium"
            >
              Retour Ã  l'accueil
            </Link>
          </div>
        </main>
        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-8">
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
            {error}
          </div>
        )}

        {parking && (
          <>
            {/* En-tÃªte du parking */}
            <div className="mb-8">
              <Link
                to="/"
                className="text-[#34A853] hover:underline font-medium mb-4 inline-block"
              >
                â† Retour Ã  la liste
              </Link>
              <h1 className="text-4xl font-bold mb-4 text-gray-800">
                {parking.nom}
              </h1>
              <p className="text-lg text-gray-600">{parking.adresse}</p>
            </div>

            {/* Informations du parking */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
              <div className="bg-white rounded-xl shadow-md p-6">
                <h2 className="text-2xl font-bold mb-4 text-gray-800">
                  Informations
                </h2>
                <div className="space-y-3">
                  <p>
                    <span className="font-semibold">Places disponibles:</span>{" "}
                    {parking.places_disponibles || parking.nombre_places} / {parking.nombre_places}
                  </p>
                  <p>
                    <span className="font-semibold">Horaires:</span>{" "}
                    {parking.horaire_ouverture} - {parking.horaire_fermeture}
                  </p>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-md p-6">
                <h2 className="text-2xl font-bold mb-4 text-gray-800">
                  Tarifs
                </h2>
                <div className="space-y-3">
                  <p>
                    <span className="font-semibold">Horaire:</span>{" "}
                    {parking.tarif_horaire} â‚¬
                  </p>
                  <p>
                    <span className="font-semibold">Journalier:</span>{" "}
                    {parking.tarif_journalier} â‚¬
                  </p>
                  <p>
                    <span className="font-semibold">Mensuel:</span>{" "}
                    {parking.tarif_mensuel} â‚¬
                  </p>
                </div>
              </div>
            </div>

            {/* Formulaire de rÃ©servation */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h2 className="text-2xl font-bold mb-4 text-gray-800">
                RÃ©server ce parking
              </h2>
              
              {!showReservationForm ? (
                <button
                  onClick={() => setShowReservationForm(true)}
                  className="bg-[#34A853] text-white px-6 py-3 rounded-lg hover:bg-[#2d8f45] transition font-medium"
                >
                  RÃ©server
                </button>
              ) : (
                <form onSubmit={handleReserve} className="space-y-4">
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">
                      Type de rÃ©servation
                    </label>
                    <div className="flex gap-4">
                      <label className="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="type"
                          value="horaire"
                          checked={reservationForm.type === "horaire"}
                          onChange={(e) =>
                            setReservationForm({
                              ...reservationForm,
                              type: e.target.value,
                            })
                          }
                          className="mr-2"
                        />
                        <span>Horaire</span>
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="type"
                          value="journalier"
                          checked={reservationForm.type === "journalier"}
                          onChange={(e) =>
                            setReservationForm({
                              ...reservationForm,
                              type: e.target.value,
                            })
                          }
                          className="mr-2"
                        />
                        <span>Journalier</span>
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="type"
                          value="mensuel"
                          checked={reservationForm.type === "mensuel"}
                          onChange={(e) =>
                            setReservationForm({
                              ...reservationForm,
                              type: e.target.value,
                            })
                          }
                          className="mr-2"
                        />
                        <span>Mensuel</span>
                      </label>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-gray-700 font-medium mb-2">
                        Date et heure de dÃ©but
                      </label>
                      <input
                        type="datetime-local"
                        value={reservationForm.date_debut}
                        onChange={(e) =>
                          setReservationForm({
                            ...reservationForm,
                            date_debut: e.target.value,
                          })
                        }
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#34A853]"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-gray-700 font-medium mb-2">
                        Date et heure de fin
                      </label>
                      <input
                        type="datetime-local"
                        value={reservationForm.date_fin}
                        onChange={(e) =>
                          setReservationForm({
                            ...reservationForm,
                            date_fin: e.target.value,
                          })
                        }
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#34A853]"
                        required
                      />
                    </div>
                  </div>

                  {reservationForm.date_debut && reservationForm.date_fin && (
                    <div className="bg-gray-50 rounded-lg p-4">
                      <p className="font-semibold text-gray-800">
                        Prix estimÃ©: {calculatePrice()} â‚¬
                      </p>
                    </div>
                  )}

                  <div className="flex gap-2">
                    <button
                      type="submit"
                      className="bg-[#34A853] text-white px-6 py-3 rounded-lg hover:bg-[#2d8f45] transition font-medium"
                    >
                      Confirmer la rÃ©servation
                    </button>
                    <button
                      type="button"
                      onClick={() => setShowReservationForm(false)}
                      className="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition"
                    >
                      Annuler
                    </button>
                  </div>
                </form>
              )}
            </div>
          </>
        )}
      </main>
      <Footer />
    </div>
  );
}




================================================
FILE: frontend/src/pages/Register.jsx
================================================
[Binary file]


================================================
FILE: frontend/src/pages/Reservation.jsx
================================================
import React, { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { apiService } from '../services/apiService';
import Header from '../components/Header';
import Footer from '../components/Footer';
import { 
  MapPin, 
  Search, 
  Calendar, 
  Car, 
  Bike, 
  Zap, 
  List, 
  Map, 
  Star, 
  X, 
  CheckCircle, 
  AlertCircle,
  CreditCard,
  SquareParking
} from 'lucide-react';

const Reservation = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const [loading, setLoading] = useState(false);
  const [parkings, setParkings] = useState([]);
  const [filteredParkings, setFilteredParkings] = useState([]);
  const [selectedParking, setSelectedParking] = useState(null);
  const [showBookingModal, setShowBookingModal] = useState(false);

  // ParamÃ¨tres de recherche
  const [searchParams, setSearchParams] = useState({
    ville: location.state?.ville || '',
    vehicule: location.state?.vehicule || 'Voiture',
    dateDebut: location.state?.dateDebut || '',
    dateFin: location.state?.dateFin || '',
    sort: 'distance'
  });

  // Filtres avancÃ©s
  const [filters, setFilters] = useState({
    prixMax: 10,
    noteMin: 0,
    services: []
  });

  const [activeFilter, setActiveFilter] = useState(null);
  const [viewMode, setViewMode] = useState('list'); // 'list' or 'map' for mobile

  // Charger les parkings au montage (toujours)
  useEffect(() => {
    loadParkings();
  }, []);

  // Filtrer les parkings quand les paramÃ¨tres changent
  useEffect(() => {
    applyFilters();
  }, [parkings, filters, searchParams]);

  const loadParkings = async () => {
    setLoading(true);
    try {
      const params = {
        ...searchParams,
        dateDebut: searchParams.dateDebut || undefined,
        dateFin: searchParams.dateFin || undefined
      };
      const response = await apiService.searchParkings(params);
      console.log('âœ… Parkings chargÃ©s:', response.parkings.length);
      setParkings(response.parkings || []);
      // Appliquer les filtres aprÃ¨s le chargement
      setTimeout(() => {
        applyFiltersToResults(response.parkings || []);
      }, 100);
    } catch (error) {
      console.error('âŒ Erreur chargement parkings:', error);
      setParkings([]);
      setFilteredParkings([]);
    } finally {
      setLoading(false);
    }
  };

  const applyFiltersToResults = (parkingsList) => {
    let results = [...parkingsList];
    results = results.filter(p => p.tarif_horaire <= filters.prixMax);
    results = results.filter(p => p.note >= filters.noteMin);
    if (filters.services.length > 0) {
      results = results.filter(p =>
        filters.services.every(service => p.services.includes(service))
      );
    }
    console.log('âœ… Parkings filtrÃ©s:', results.length);
    setFilteredParkings(results);
  };

  const applyFilters = () => {
    if (parkings.length === 0) return;
    applyFiltersToResults(parkings);
  };

  const handleSearch = () => {
    loadParkings();
  };

  const handleBooking = (parking) => {
    const token = localStorage.getItem('token');
    if (!token) {
      navigate('/login', { state: { from: '/reservation', parking } });
      return;
    }
    setSelectedParking(parking);
    setShowBookingModal(true);
  };

  const calculatePrice = (parking) => {
    if (!searchParams.dateDebut || !searchParams.dateFin) {
      return parking.tarif_horaire.toFixed(2) + '/h';
    }
    const debut = new Date(searchParams.dateDebut);
    const fin = new Date(searchParams.dateFin);
    const diffMs = fin - debut;
    const diffMinutes = diffMs / (1000 * 60);
    const diffHeures = diffMinutes / 60;
    const diffJours = diffHeures / 24;
    if (diffJours < 1) {
      const heures = Math.ceil(diffHeures);
      return (heures * parking.tarif_horaire).toFixed(2);
    }
    if (diffJours <= 30) {
      const jours = Math.ceil(diffJours);
      return (jours * parking.tarif_journalier).toFixed(2);
    }
    const mois = Math.ceil(diffJours / 30);
    return (mois * parking.tarif_mensuel).toFixed(2);
  };

  const servicesDisponibles = ['Couvert', 'GardÃ©', 'SÃ©curisÃ©', 'VidÃ©o-surveillance', 'Bornes Ã©lectriques', 'Lavage auto', 'Accessible PMR'];

  return (
    <div className="flex flex-col h-screen bg-white overflow-hidden">
        <Header />
        
        <div className="flex flex-1 pt-[72px] overflow-hidden">
            {/* COLONNE GAUCHE : LISTE + RECHERCHE */}
            <div className={`w-full lg:w-[650px] flex flex-col h-full border-r border-gray-200 bg-white z-10 shadow-xl ${viewMode === 'map' ? 'hidden lg:flex' : 'flex'}`}>
                
                {/* BARRE DE RECHERCHE (Sticky) */}
                <div className="p-4 border-b border-gray-200 bg-white shadow-sm z-20">
                    <div className="flex gap-2 mb-3">
                        <div className="relative flex-1">
                            <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                <Search className="w-5 h-5 text-gray-400" />
                            </div>
                            <input 
                                type="text" 
                                placeholder="OÃ¹ cherchez-vous ?" 
                                className="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg font-medium text-gray-900 focus:ring-2 focus:ring-black transition-all"
                                value={searchParams.ville}
                                onChange={(e) => setSearchParams({ ...searchParams, ville: e.target.value })}
                            />
                        </div>
                        <button onClick={handleSearch} className="bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-primary-600 transition-colors shadow-md">
                            Rechercher
                        </button>
                    </div>

                    {/* FILTRES RAPIDES */}
                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                         {/* Date Picker Button */}
                         <div className="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-full text-sm font-medium text-gray-700 cursor-pointer hover:border-black transition-colors whitespace-nowrap group relative">
                            <Calendar className="w-4 h-4 text-gray-500" />
                            <span>Dates</span>
                            {/* Date Inputs Popup (Simplified for demo) */}
                            <div className="absolute top-full left-0 mt-2 p-4 bg-white shadow-xl rounded-xl border border-gray-100 hidden group-hover:block min-w-[300px] z-50">
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase">DÃ©but</label>
                                        <input type="datetime-local" value={searchParams.dateDebut} onChange={(e) => setSearchParams({ ...searchParams, dateDebut: e.target.value })} className="w-full text-sm border-gray-200 rounded-md" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase">Fin</label>
                                        <input type="datetime-local" value={searchParams.dateFin} onChange={(e) => setSearchParams({ ...searchParams, dateFin: e.target.value })} className="w-full text-sm border-gray-200 rounded-md" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Vehicle Type */}
                        <select 
                            value={searchParams.vehicule}
                            onChange={(e) => setSearchParams({ ...searchParams, vehicule: e.target.value })}
                            className="bg-white border border-gray-200 px-3 py-2 rounded-full text-sm font-medium text-gray-700 cursor-pointer hover:border-black transition-colors outline-none appearance-none"
                        >
                            <option value="Voiture">Voiture</option>
                            <option value="Moto">Moto</option>
                            <option value="VÃ©lo">VÃ©lo</option>
                        </select>

                        {servicesDisponibles.slice(0, 3).map(service => (
                            <button
                                key={service}
                                onClick={() => {
                                    if (filters.services.includes(service)) {
                                        setFilters({ ...filters, services: filters.services.filter(s => s !== service) });
                                    } else {
                                        setFilters({ ...filters, services: [...filters.services, service] });
                                    }
                                }}
                                className={`px-3 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap border ${
                                    filters.services.includes(service)
                                        ? 'bg-black text-white border-black'
                                        : 'bg-white text-gray-700 border-gray-200 hover:border-black'
                                }`}
                            >
                                {service}
                            </button>
                        ))}
                    </div>
                </div>

                {/* LISTE DES RÃ‰SULTATS (Scrollable) */}
                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                    <div className="flex justify-between items-center mb-2 px-1">
                        <h2 className="text-xl font-bold text-gray-900">{filteredParkings.length} parkings disponibles</h2>
                        <span className="text-sm text-gray-500 font-medium cursor-pointer hover:text-black">Trier par pertinence â–¼</span>
                    </div>

                    {loading ? (
                         <div className="flex justify-center py-20"><div className="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div></div>
                    ) : (
                        filteredParkings.map(parking => (
                            <ParkingCard
                                key={parking.id}
                                parking={parking}
                                price={calculatePrice(parking)}
                                onBook={() => handleBooking(parking)}
                            />
                        ))
                    )}
                    {filteredParkings.length === 0 && !loading && (
                        <div className="text-center py-20 text-gray-500">Aucun parking trouvÃ© dans cette zone.</div>
                    )}
                </div>
            </div>

            {/* COLONNE DROITE : CARTE (Full height) */}
            <div className={`flex-1 bg-gray-200 relative ${viewMode === 'list' ? 'hidden lg:block' : 'block'}`}>
                {/* Placeholder Carte Type Google Maps */}
                <div className="absolute inset-0 bg-[#e5e7eb] flex items-center justify-center overflow-hidden">
                    <div className="text-center opacity-30 select-none pointer-events-none flex flex-col items-center">
                        <Map className="w-32 h-32 mb-4 text-gray-400" />
                        <p className="text-3xl font-bold text-gray-400">Carte Interactive</p>
                    </div>
                    {/* Fake Map Pins */}
                    {filteredParkings.map((p, i) => (
                        <div key={p.id} className="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group" style={{ top: `${30 + (i * 15) % 60}%`, left: `${30 + (i * 20) % 60}%` }}>
                            <div className="bg-white px-3 py-1.5 rounded-lg shadow-lg font-bold text-sm border border-gray-200 group-hover:bg-black group-hover:text-white transition-colors">
                                {calculatePrice(p)}â‚¬
                            </div>
                            <div className="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-white mx-auto group-hover:border-t-black"></div>
                        </div>
                    ))}
                </div>

                {/* Mobile Toggle Button */}
                <button 
                    className="lg:hidden absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full shadow-xl font-bold z-50 flex items-center gap-2"
                    onClick={() => setViewMode(viewMode === 'list' ? 'map' : 'list')}
                >
                    {viewMode === 'list' ? <><Map className="w-5 h-5" /> Carte</> : <><List className="w-5 h-5" /> Liste</>}
                </button>
            </div>
        </div>

        {/* Modal de rÃ©servation */}
        {showBookingModal && selectedParking && (
            <BookingModal
                parking={selectedParking}
                searchParams={searchParams}
                price={calculatePrice(selectedParking)}
                onClose={() => {
                    setShowBookingModal(false);
                    setSelectedParking(null);
                }}
                onSuccess={() => {
                    setShowBookingModal(false);
                    setSelectedParking(null);
                    navigate('/mes-reservations');
                }}
            />
        )}
    </div>
  );
};

// --- COMPOSANTS ENFANTS ---

const ParkingCard = ({ parking, price, onBook }) => {
    return (
        <div className="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all duration-200 cursor-pointer group flex gap-4">
            {/* Image */}
            <div className="w-32 h-32 bg-gray-100 rounded-lg flex-shrink-0 relative overflow-hidden">
                <div className="absolute inset-0 flex items-center justify-center"><SquareParking className="w-16 h-16 text-gray-300" /></div>
                {parking.note >= 4.5 && (
                    <div className="absolute top-2 left-2 bg-primary text-white text-[10px] font-bold px-2 py-0.5 rounded-sm uppercase tracking-wide">
                        Coup de cÅ“ur
                    </div>
                )}
            </div>

            {/* Content */}
            <div className="flex-1 flex flex-col justify-between">
                <div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-lg text-gray-900 leading-tight mb-1">{parking.nom}</h3>
                        <div className="flex items-center gap-1 bg-gray-50 px-1.5 py-0.5 rounded text-xs font-bold text-gray-900">
                            <Star className="w-3 h-3 fill-current" /> {parking.note}
                        </div>
                    </div>
                    <p className="text-gray-500 text-sm mb-2 truncate">{parking.adresse}</p>
                    
                    {/* Tags */}
                    <div className="flex flex-wrap gap-1 mb-2">
                        <span className="text-[10px] font-medium bg-gray-100 text-gray-600 px-2 py-0.5 rounded">{parking.places_disponibles} places dispo</span>
                        {parking.services.slice(0, 2).map(s => (
                            <span key={s} className="text-[10px] font-medium bg-gray-100 text-gray-600 px-2 py-0.5 rounded">{s}</span>
                        ))}
                    </div>
                </div>

                <div className="flex items-end justify-between mt-2">
                    <div>
                        <span className="text-lg font-bold text-primary">{price}â‚¬</span>
                        <span className="text-xs text-gray-500 ml-1">/ total</span>
                    </div>
                    <button 
                        onClick={(e) => {
                            e.stopPropagation();
                            onBook();
                        }}
                        className="bg-white border border-gray-300 text-gray-900 px-4 py-2 rounded-lg text-sm font-bold hover:bg-black hover:text-white hover:border-black transition-all"
                    >
                        RÃ©server
                    </button>
                </div>
            </div>
        </div>
    );
};

// Modal ultra-minimaliste
const BookingModal = ({ parking, searchParams, price, onClose, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    dateDebut: searchParams.dateDebut,
    dateFin: searchParams.dateFin,
    vehicule: searchParams.vehicule,
    immatriculation: ''
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const debut = new Date(formData.dateDebut);
    const fin = new Date(formData.dateFin);
    const now = new Date();
    
    if (debut < now) {
      alert('La date de dÃ©but ne peut pas Ãªtre dans le passÃ©');
      return;
    }
    
    if (fin <= debut) {
      alert('La date de fin doit Ãªtre aprÃ¨s la date de dÃ©but');
      return;
    }
    
    const diffMinutes = (fin - debut) / (1000 * 60);
    if (diffMinutes < 30) {
      alert('DurÃ©e minimum: 30 minutes');
      return;
    }
    
    setLoading(true);

    try {
      const token = localStorage.getItem('token');
      const response = await apiService.reserveParking(token, parking.id, {
        date_debut: formData.dateDebut,
        date_fin: formData.dateFin,
        vehicule: formData.vehicule,
        immatriculation: formData.immatriculation
      });

      if (response.success) {
        alert(`${response.message}\n\nMontant: ${response.reservation.montant}â‚¬`);
        onSuccess();
      }
    } catch (error) {
      alert(error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white border-b border-gray-100 px-8 py-6 flex items-center justify-between rounded-t-3xl">
          <h2 className="text-3xl font-extralight text-gray-900">Confirmer</h2>
          <button
            onClick={onClose}
            className="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center text-gray-600"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-8">
          <div className="bg-gray-50 rounded-2xl p-6 mb-8">
            <h3 className="text-xl font-extralight text-gray-900 mb-2">{parking.nom}</h3>
            <p className="text-gray-500 font-light mb-4 flex items-center gap-1"><MapPin className="w-4 h-4" /> {parking.adresse}</p>
            <div className="flex items-center justify-between pt-4 border-t border-gray-200">
              <span className="text-gray-500 font-light">Total</span>
              <span className="text-3xl font-extralight text-gray-900">{price}â‚¬</span>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <label className="block text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">
                DÃ©but
              </label>
              <input
                type="datetime-local"
                required
                value={formData.dateDebut}
                onChange={(e) => setFormData({ ...formData, dateDebut: e.target.value })}
                className="w-full px-6 py-4 bg-gray-50 rounded-xl border-0 focus:bg-white focus:ring-2 focus:ring-gray-900 transition-all text-gray-900 font-light"
              />
            </div>

            <div>
              <label className="block text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">
                Fin
              </label>
              <input
                type="datetime-local"
                required
                value={formData.dateFin}
                onChange={(e) => setFormData({ ...formData, dateFin: e.target.value })}
                className="w-full px-6 py-4 bg-gray-50 rounded-xl border-0 focus:bg-white focus:ring-2 focus:ring-gray-900 transition-all text-gray-900 font-light"
              />
            </div>

            <div>
              <label className="block text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">
                VÃ©hicule
              </label>
              <select
                required
                value={formData.vehicule}
                onChange={(e) => setFormData({ ...formData, vehicule: e.target.value })}
                className="w-full px-6 py-4 bg-gray-50 rounded-xl border-0 focus:bg-white focus:ring-2 focus:ring-gray-900 transition-all text-gray-900 font-light"
              >
                {parking.type_vehicules.map(type => (
                  <option key={type} value={type}>{type}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="flex gap-4 mt-8">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-4 bg-gray-100 text-gray-700 rounded-xl font-light hover:bg-gray-200 transition-all"
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 py-4 bg-gray-900 text-white rounded-xl font-light hover:bg-gray-800 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'RÃ©servation...' : 'Confirmer'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Reservation;



================================================
FILE: frontend/src/pages/Subscription.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { apiService } from "../services/apiService";

const Subscription = () => {
  const navigate = useNavigate();
  const [parkings, setParkings] = useState([]);
  const [selectedParking, setSelectedParking] = useState("");
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(false);

  // Semainier par dÃ©faut
  const daysOfWeek = [
    { id: 1, label: "Lundi", active: false, start: "08:00", end: "18:00" },
    { id: 2, label: "Mardi", active: false, start: "08:00", end: "18:00" },
    { id: 3, label: "Mercredi", active: false, start: "08:00", end: "18:00" },
    { id: 4, label: "Jeudi", active: false, start: "08:00", end: "18:00" },
    { id: 5, label: "Vendredi", active: false, start: "08:00", end: "18:00" },
    { id: 6, label: "Samedi", active: false, start: "08:00", end: "18:00" },
    { id: 7, label: "Dimanche", active: false, start: "08:00", end: "18:00" },
  ];

  const [schedule, setSchedule] = useState(daysOfWeek);
  const [months, setMonths] = useState(1);
  const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);

  useEffect(() => {
    fetchParkings();
  }, []);

  const fetchParkings = async () => {
    try {
      const response = await apiService.searchParkings();
      if (response.success && Array.isArray(response.parkings)) {
        setParkings(response.parkings);
        if (response.parkings.length > 0) setSelectedParking(response.parkings[0].id);
      } else {
        setParkings([]);
      }
    } catch (err) {
      setError("Impossible de charger les parkings.");
      setParkings([]);
    } finally {
      setLoading(false);
    }
  };

  const handleDayToggle = (id) => {
    setSchedule(schedule.map(day => 
      day.id === id ? { ...day, active: !day.active } : day
    ));
  };

  const handleTimeChange = (id, field, value) => {
    setSchedule(schedule.map(day => 
      day.id === id ? { ...day, [field]: value } : day
    ));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    setSuccess(false);

    // Formatage pour l'API
    // On ne garde que les jours actifs
    const weeklySlots = schedule
      .filter(day => day.active)
      .map(day => ({
        day_of_week: day.id,
        start_time: day.start,
        end_time: day.end
      }));

    if (weeklySlots.length === 0) {
      setError("Veuillez sÃ©lectionner au moins un jour.");
      return;
    }

    try {
      await apiService.createSubscription({
        parking_id: selectedParking,
        start_date: startDate,
        months: parseInt(months),
        weekly_slots: weeklySlots
      });
      setSuccess(true);
      setTimeout(() => navigate('/mes-reservations'), 2000);
    } catch (err) {
      setError(err.message || "Erreur lors de la crÃ©ation de l'abonnement");
    }
  };

  if (loading) return <div className="p-8 text-center">Chargement...</div>;

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
        <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">CrÃ©er un Abonnement</h2>
        
        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            {error}
          </div>
        )}

        {success && (
          <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            Abonnement crÃ©Ã© avec succÃ¨s ! Redirection...
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* SÃ©lection Parking */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Choisir un parking</label>
            <select
              value={selectedParking}
              onChange={(e) => setSelectedParking(e.target.value)}
              className="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            >
              {parkings.map(p => (
                <option key={p.id} value={p.id}>{p.nom} - {p.adresse}</option>
              ))}
            </select>
          </div>

          {/* DurÃ©e et DÃ©but */}
          <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Date de dÃ©but</label>
              <input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">DurÃ©e (mois)</label>
              <input
                type="number"
                min="1"
                max="12"
                value={months}
                onChange={(e) => setMonths(e.target.value)}
                className="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                required
              />
            </div>
          </div>

          {/* Semainier */}
          <div>
            <h3 className="text-lg font-medium text-gray-900 mb-4">Vos crÃ©neaux hebdomadaires</h3>
            <div className="space-y-3">
              {schedule.map((day) => (
                <div key={day.id} className={`flex items-center justify-between p-3 rounded-lg border ${day.active ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>
                  <div className="flex items-center">
                    <input
                      type="checkbox"
                      checked={day.active}
                      onChange={() => handleDayToggle(day.id)}
                      className="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-3"
                    />
                    <span className={`font-medium ${day.active ? 'text-indigo-900' : 'text-gray-500'}`}>{day.label}</span>
                  </div>
                  
                  {day.active && (
                    <div className="flex items-center space-x-2">
                      <input
                        type="time"
                        value={day.start}
                        onChange={(e) => handleTimeChange(day.id, 'start', e.target.value)}
                        className="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-indigo-500 focus:border-indigo-500"
                      />
                      <span className="text-gray-500">-</span>
                      <input
                        type="time"
                        value={day.end}
                        onChange={(e) => handleTimeChange(day.id, 'end', e.target.value)}
                        className="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-indigo-500 focus:border-indigo-500"
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>

          <div className="flex justify-end pt-4">
            <button
              type="submit"
              className="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
            >
              Valider l'abonnement
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Subscription;



================================================
FILE: frontend/src/pages/UserDashboard.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate, Link } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function UserDashboard() {
  const navigate = useNavigate();
  const [reservations, setReservations] = useState([]);
  const [stationnements, setStationnements] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const userStr = localStorage.getItem("user");
  const user = userStr ? JSON.parse(userStr) : null;

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!token) {
      navigate("/login");
      return;
    }

    loadData();
  }, [navigate]);

  const loadData = async () => {
    const token = localStorage.getItem("token");
    setLoading(true);
    setError("");

    try {
      const reservationsResult = await apiService.getReservations(token);
      if (reservationsResult.success) {
        const allReservations = reservationsResult.reservations || [];
        setReservations(allReservations);

        // Derive active stationnements (EntrÃ© mais pas encore sorti)
        const active = allReservations.filter(r => r.date_entree && !r.date_sortie);
        setStationnements(active);
      }
    } catch (err) {
      setError(err.message || "Erreur lors du chargement des donnÃ©es");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <Header />
      <main className="flex-1">
        {/* Hero Section */}
        <section className="bg-zenpark text-white py-12">
          <div className="container mx-auto px-6 lg:px-12">
            <h1 className="text-4xl font-serif font-normal mb-2">
              Bonjour {user?.firstname || 'Utilisateur'}
        </h1>
            <p className="text-white/90 text-lg">
              Bienvenue sur votre espace personnel
            </p>
          </div>
        </section>

        <div className="container mx-auto px-6 lg:px-12 py-12">
        {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl mb-8">
            {error}
          </div>
        )}

          {/* Quick Actions */}
          <div className="mb-12">
          <Link
            to="/"
              className="inline-block bg-zenpark text-white px-8 py-4 rounded-xl hover:bg-zenpark-700 transition font-medium"
          >
              Nouvelle rÃ©servation
          </Link>
        </div>

        {/* Section RÃ©servations */}
        <section className="mb-12">
            <h2 className="text-3xl font-serif font-normal mb-6 text-gray-900">
            Mes rÃ©servations
          </h2>

          {loading ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
              <p className="text-gray-600">Chargement...</p>
            </div>
          ) : reservations.length === 0 ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
                <p className="text-gray-600 mb-6">
                Vous n'avez aucune rÃ©servation pour le moment.
              </p>
              <Link
                to="/"
                  className="inline-block bg-zenpark text-white px-8 py-3 rounded-xl hover:bg-zenpark-700 transition font-medium"
              >
                RÃ©server une place
              </Link>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {reservations.map((reservation) => (
                <div
                  key={reservation.id}
                    className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition"
                >
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">
                    {reservation.parking_nom || "Parking"}
                  </h3>
                    
                  <div className="space-y-2 mb-4">
                    <p className="text-gray-600 text-sm">
                      {reservation.date_debut && reservation.date_fin
                        ? `${new Date(reservation.date_debut).toLocaleDateString('fr-FR')} - ${new Date(reservation.date_fin).toLocaleDateString('fr-FR')}`
                        : "Date non spÃ©cifiÃ©e"}
                    </p>
                    <p className="text-gray-700">
                        <span className="font-medium">Statut:</span>{" "}
                        <span className={`inline-block px-3 py-1 rounded-full text-xs font-medium ${
                        reservation.statut === 'confirmÃ©e' 
                          ? 'bg-green-100 text-green-800' 
                          : 'bg-yellow-100 text-yellow-800'
                      }`}>
                        {reservation.statut || "En attente"}
                      </span>
                    </p>
                    {reservation.montant && (
                        <p className="text-lg font-semibold text-zenpark">
                        {reservation.montant} â‚¬
                      </p>
                    )}
                  </div>
                    
                  <Link
                    to={`/parking/${reservation.parking_id}`}
                      className="block w-full text-center bg-gray-100 text-gray-900 py-2 rounded-xl hover:bg-gray-200 transition font-medium"
                  >
                    Voir les dÃ©tails
                  </Link>
                </div>
              ))}
            </div>
          )}
        </section>

          {/* Section Stationnements actifs */}
          {stationnements.length > 0 && (
        <section className="mb-12">
              <h2 className="text-3xl font-serif font-normal mb-6 text-gray-900">
                Stationnements actifs
          </h2>
              
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {stationnements.map((stationnement) => (
                <div
                  key={stationnement.id}
                    className="bg-white rounded-2xl shadow p-6"
                >
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="text-xl font-semibold text-gray-900">
                    {stationnement.parking_nom || "Parking"}
                  </h3>
                      <span className="flex h-3 w-3 relative">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                      </span>
                    </div>
                    
                    <p className="text-gray-600 text-sm">
                      DÃ©but: {stationnement.date_debut
                        ? new Date(stationnement.date_debut).toLocaleString('fr-FR')
                        : "N/A"}
                    </p>
                </div>
              ))}
            </div>
            </section>
          )}
          </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/routes/index.jsx
================================================
// Configuration des routes de l'application
export const routes = {
  home: '/',
  login: '/login',
  register: '/register',
  dashboardUser: '/dashboard-user',
  dashboardOwner: '/dashboard-owner',
  parkingDetails: '/parking/:id',
};




================================================
FILE: frontend/src/services/apiService.js
================================================
const API_BASE_URL = 'http://localhost:8001/api';

const handleResponse = async (response) => {
  // Gestion automatique du refresh token si 401
  if (response.status === 401 && !response.url.includes('/auth/refresh')) {
    try {
      // Tentative de refresh
      await apiService.refreshToken();
      // On rejoue la requÃªte initiale (attention aux boucles infinies, Ã  gÃ©rer dans l'implÃ©mentation finale)
      // Pour l'instant on throw pour que le composant redirige vers login
      throw new Error('Session expirÃ©e');
    } catch (e) {
      throw new Error('Session expirÃ©e');
    }
  }

  const data = await response.json();
  if (!response.ok) {
    const error = (data && data.error) || response.statusText;
    throw new Error(error);
  }
  return data;
};

export const apiService = {
  // --- AUTH ---

  /**
   * Connexion utilisateur
   * Payload: { email, password }
   * Retour: JWT via cookies (gÃ©rÃ© par le navigateur)
   */
  async login(email, password) {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
      credentials: 'include'
    });
    // Pas de return de token ici car cookie
    return handleResponse(response);
  },

  /**
   * Inscription utilisateur
   * Payload: { email, password, firstname, lastname, role }
   */
  async register(userData) {
    const response = await fetch(`${API_BASE_URL}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData),
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Refresh Token
   * Ã€ appeler automatiquement si 401
   */
  async refreshToken() {
    const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * DÃ©connexion
   */
  async logout() {
    const response = await fetch(`${API_BASE_URL}/auth/logout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * RÃ©cupÃ©rer l'utilisateur courant
   * Retour: { id, email, role }
   */
  async me() {
    const response = await fetch(`${API_BASE_URL}/me`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });
    return handleResponse(response);
  },

  // --- PARKINGS ---

  /**
   * Rechercher des parkings
   * Note: L'endpoint /parkings/availability n'est pas pour la recherche globale mais pour un parking spÃ©cifique
   * On garde l'endpoint existant s'il correspond, sinon on adapte selon la doc
   * Doc: GET /api/parkings/details?id={parkingId} -> DÃ©tail
   * Doc: GET /api/parkings/availability -> Dispo spÃ©cifique
   * Il manque un endpoint de recherche globale dans la doc fournie ("Recherche parkings" n'est pas explicite sur l'endpoint)
   * Je suppose que le backend a un endpoint GET /api/parkings (standard REST) comme vu dans le code prÃ©cÃ©dent
   * Mais je dois suivre STRICTEMENT la doc fournie.
   * La doc dit:
   * GET /api/parkings/details?id={parkingId}
   * GET /api/parkings/availability
   * GET /api/parkings/occupancy-now
   * 
   * Elle ne mentionne PAS de GET /api/parkings pour la liste.
   * Cependant, le code prÃ©cÃ©dent utilisait GET /api/parkings.
   * Je vais supposer que pour la liste, c'est GET /api/parkings (car sinon impossible de lister).
   * Si erreur 404, je le signalerai.
   */
  async searchParkings(params = {}) {
    const query = new URLSearchParams();
    if (params.ville) query.append('ville', params.ville);
    // Adaptation aux query params standards si besoin, ou on laisse tel quel si le backend le supporte
    const response = await fetch(`${API_BASE_URL}/parkings?${query.toString()}`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * RÃ©cupÃ©rer les dÃ©tails d'un parking
   * Doc: GET /api/parkings/details?id={parkingId}
   */
  async getParkingDetails(id) {
    const response = await fetch(`${API_BASE_URL}/parkings/details?id=${id}`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * VÃ©rifier la disponibilitÃ©
   * Doc: GET /api/parkings/availability
   * Query: parking_id, start_at, end_at
   */
  async checkAvailability(parkingId, startAt, endAt) {
    const query = new URLSearchParams({
      parking_id: parkingId,
      start_at: startAt,
      end_at: endAt
    });
    const response = await fetch(`${API_BASE_URL}/parkings/availability?${query.toString()}`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Occupation actuelle
   * Doc: GET /api/parkings/occupancy-now
   */
  async getOccupancyNow() {
    const response = await fetch(`${API_BASE_URL}/parkings/occupancy-now`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  // --- RESERVATIONS ---

  /**
   * CrÃ©er une rÃ©servation
   * Signature supportÃ©e: 
   * 1. (reservationData) -> { parkingId, date_debut, ... }
   * 2. (token, parkingId, data) -> compatibilitÃ© legacy
   */
  async reserveParking(arg1, arg2 = null, arg3 = null) {
    let reservationData = {};

    if (arg2 !== null && arg3 !== null) {
      // Cas legacy: (token, parkingId, data)
      reservationData = { 
        ...arg3, 
        parkingId: arg2 
      };
    } else {
      // Cas standard: (reservationData)
      reservationData = arg1;
    }

    const response = await fetch(`${API_BASE_URL}/reservations`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(reservationData),
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Mes rÃ©servations
   * Doc: GET /api/reservations/me
   */
  async getReservations() {
    const response = await fetch(`${API_BASE_URL}/reservations/me`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Entrer dans le parking
   * Doc: POST /api/reservations/{id}/enter
   */
  async enterReservation(id) {
    const response = await fetch(`${API_BASE_URL}/reservations/${id}/enter`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Sortir du parking
   * Doc: POST /api/reservations/{id}/exit
   */
  async exitReservation(id) {
    const response = await fetch(`${API_BASE_URL}/reservations/${id}/exit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Facture
   * Doc: GET /api/reservations/{id}/invoice
   */
  async getInvoice(id) {
    const response = await fetch(`${API_BASE_URL}/reservations/${id}/invoice`, {
      credentials: 'include'
    });
    // Ici on retourne le blob ou le text car c'est du HTML/PDF potentiellement
    if (!response.ok) throw new Error('Erreur facture');
    return response.text();
  },

  // --- ABONNEMENTS ---

  /**
   * CrÃ©er un abonnement
   * Payload: { parking_id, start_date, months, weekly_slots }
   */
  async createSubscription(subscriptionData) {
    const response = await fetch(`${API_BASE_URL}/subscriptions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(subscriptionData),
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Mes abonnements
   * Doc: GET /api/subscriptions/me
   */
  async getSubscriptions() {
    const response = await fetch(`${API_BASE_URL}/subscriptions/me`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  // --- OWNER ---

  /**
   * Mes parkings (Owner)
   * Doc: GET /api/owner/parkings
   */
  async getOwnerParkings() {
    const response = await fetch(`${API_BASE_URL}/owner/parkings`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * CrÃ©er un parking (Owner)
   * Doc: POST /api/owner/parkings
   */
  async createOwnerParking(parkingData) {
    const response = await fetch(`${API_BASE_URL}/owner/parkings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(parkingData),
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * RÃ©servations d'un parking (Owner)
   * Doc: GET /api/owner/parkings/{id}/reservations
   */
  async getOwnerParkingReservations(id) {
    const response = await fetch(`${API_BASE_URL}/owner/parkings/${id}/reservations`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Stationnements actifs (Owner)
   * Doc: GET /api/owner/parkings/{id}/stationnements/active
   */
  async getOwnerActiveParkings(id) {
    const response = await fetch(`${API_BASE_URL}/owner/parkings/${id}/stationnements/active`, {
      credentials: 'include'
    });
    return handleResponse(response);
  },

  /**
   * Revenus (Owner)
   * Doc: GET /api/owner/parkings/{id}/revenue?month=YYYY-MM
   */
  async getOwnerRevenue(id, month) {
    const response = await fetch(`${API_BASE_URL}/owner/parkings/${id}/revenue?month=${month}`, {
      credentials: 'include'
    });
    return handleResponse(response);
  }
};



================================================
FILE: frontend/src/UI/Countup.jsx
================================================
import { useInView, useMotionValue, useSpring } from 'motion/react';
import { useCallback, useEffect, useRef } from 'react';

export default function CountUp({
  to,
  from = 0,
  direction = 'up',
  delay = 0,
  duration = 2,
  className = '',
  startWhen = true,
  separator = '',
  onStart,
  onEnd
}) {
  const ref = useRef(null);
  const motionValue = useMotionValue(direction === 'down' ? to : from);

  const damping = 20 + 40 * (1 / duration);
  const stiffness = 100 * (1 / duration);

  const springValue = useSpring(motionValue, {
    damping,
    stiffness
  });

  const isInView = useInView(ref, { once: true, margin: '0px' });

  const getDecimalPlaces = num => {
    const str = num.toString();

    if (str.includes('.')) {
      const decimals = str.split('.')[1];

      if (parseInt(decimals) !== 0) {
        return decimals.length;
      }
    }

    return 0;
  };

  const maxDecimals = Math.max(getDecimalPlaces(from), getDecimalPlaces(to));

  const formatValue = useCallback(
    latest => {
      const hasDecimals = maxDecimals > 0;

      const options = {
        useGrouping: !!separator,
        minimumFractionDigits: hasDecimals ? maxDecimals : 0,
        maximumFractionDigits: hasDecimals ? maxDecimals : 0
      };

      const formattedNumber = Intl.NumberFormat('en-US', options).format(latest);

      return separator ? formattedNumber.replace(/,/g, separator) : formattedNumber;
    },
    [maxDecimals, separator]
  );

  useEffect(() => {
    if (ref.current) {
      ref.current.textContent = formatValue(direction === 'down' ? to : from);
    }
  }, [from, to, direction, formatValue]);

  useEffect(() => {
    if (isInView && startWhen) {
      if (typeof onStart === 'function') onStart();

      const timeoutId = setTimeout(() => {
        motionValue.set(direction === 'down' ? from : to);
      }, delay * 1000);

      const durationTimeoutId = setTimeout(
        () => {
          if (typeof onEnd === 'function') onEnd();
        },
        delay * 1000 + duration * 1000
      );

      return () => {
        clearTimeout(timeoutId);
        clearTimeout(durationTimeoutId);
      };
    }
  }, [isInView, startWhen, motionValue, direction, from, to, delay, onStart, onEnd, duration]);

  useEffect(() => {
    const unsubscribe = springValue.on('change', latest => {
      if (ref.current) {
        ref.current.textContent = formatValue(latest);
      }
    });

    return () => unsubscribe();
  }, [springValue, formatValue]);

  return <span className={className} ref={ref} />;
}



================================================
FILE: frontend/tailwind-test/README.md
================================================
# Getting Started with Create React App

This project was bootstrapped with [Create React App](https://github.com/facebook/create-react-app).

## Available Scripts

In the project directory, you can run:

### `npm start`

Runs the app in the development mode.\
Open [http://localhost:3000](http://localhost:3000) to view it in your browser.

The page will reload when you make changes.\
You may also see any lint errors in the console.

### `npm test`

Launches the test runner in the interactive watch mode.\
See the section about [running tests](https://facebook.github.io/create-react-app/docs/running-tests) for more information.

### `npm run build`

Builds the app for production to the `build` folder.\
It correctly bundles React in production mode and optimizes the build for the best performance.

The build is minified and the filenames include the hashes.\
Your app is ready to be deployed!

See the section about [deployment](https://facebook.github.io/create-react-app/docs/deployment) for more information.

### `npm run eject`

**Note: this is a one-way operation. Once you `eject`, you can't go back!**

If you aren't satisfied with the build tool and configuration choices, you can `eject` at any time. This command will remove the single build dependency from your project.

Instead, it will copy all the configuration files and the transitive dependencies (webpack, Babel, ESLint, etc) right into your project so you have full control over them. All of the commands except `eject` will still work, but they will point to the copied scripts so you can tweak them. At this point you're on your own.

You don't have to ever use `eject`. The curated feature set is suitable for small and middle deployments, and you shouldn't feel obligated to use this feature. However we understand that this tool wouldn't be useful if you couldn't customize it when you are ready for it.

## Learn More

You can learn more in the [Create React App documentation](https://facebook.github.io/create-react-app/docs/getting-started).

To learn React, check out the [React documentation](https://reactjs.org/).

### Code Splitting

This section has moved here: [https://facebook.github.io/create-react-app/docs/code-splitting](https://facebook.github.io/create-react-app/docs/code-splitting)

### Analyzing the Bundle Size

This section has moved here: [https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size](https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size)

### Making a Progressive Web App

This section has moved here: [https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app](https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app)

### Advanced Configuration

This section has moved here: [https://facebook.github.io/create-react-app/docs/advanced-configuration](https://facebook.github.io/create-react-app/docs/advanced-configuration)

### Deployment

This section has moved here: [https://facebook.github.io/create-react-app/docs/deployment](https://facebook.github.io/create-react-app/docs/deployment)

### `npm run build` fails to minify

This section has moved here: [https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify](https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify)



================================================
FILE: frontend/tailwind-test/package.json
================================================
{
  "name": "tailwind-test",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "@testing-library/dom": "^10.4.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^13.5.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-scripts": "5.0.1",
    "web-vitals": "^2.1.4"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "devDependencies": {
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.16"
  }
}



================================================
FILE: frontend/tailwind-test/public/index.html
================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>React App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>



================================================
FILE: frontend/tailwind-test/public/manifest.json
================================================
{
  "short_name": "React App",
  "name": "Create React App Sample",
  "icons": [
    {
      "src": "favicon.ico",
      "sizes": "64x64 32x32 24x24 16x16",
      "type": "image/x-icon"
    },
    {
      "src": "logo192.png",
      "type": "image/png",
      "sizes": "192x192"
    },
    {
      "src": "logo512.png",
      "type": "image/png",
      "sizes": "512x512"
    }
  ],
  "start_url": ".",
  "display": "standalone",
  "theme_color": "#000000",
  "background_color": "#ffffff"
}



================================================
FILE: frontend/tailwind-test/public/robots.txt
================================================
# https://www.robotstxt.org/robotstxt.html
User-agent: *
Disallow:



================================================
FILE: frontend/tailwind-test/src/App.css
================================================
.App {
  text-align: center;
}

.App-logo {
  height: 40vmin;
  pointer-events: none;
}

@media (prefers-reduced-motion: no-preference) {
  .App-logo {
    animation: App-logo-spin infinite 20s linear;
  }
}

.App-header {
  background-color: #282c34;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: calc(10px + 2vmin);
  color: white;
}

.App-link {
  color: #61dafb;
}

@keyframes App-logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}



================================================
FILE: frontend/tailwind-test/src/App.js
================================================
import logo from './logo.svg';
import './App.css';

function App() {
  return (
    <div className="App">
      <header className="App-header">
        <img src={logo} className="App-logo" alt="logo" />
        <p>
          Edit <code>src/App.js</code> and save to reload.
        </p>
        <a
          className="App-link"
          href="https://reactjs.org"
          target="_blank"
          rel="noopener noreferrer"
        >
          Learn React
        </a>
      </header>
    </div>
  );
}

export default App;



================================================
FILE: frontend/tailwind-test/src/App.test.js
================================================
import { render, screen } from '@testing-library/react';
import App from './App';

test('renders learn react link', () => {
  render(<App />);
  const linkElement = screen.getByText(/learn react/i);
  expect(linkElement).toBeInTheDocument();
});



================================================
FILE: frontend/tailwind-test/src/index.css
================================================
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}



================================================
FILE: frontend/tailwind-test/src/index.js
================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App';
import reportWebVitals from './reportWebVitals';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

// If you want to start measuring performance in your app, pass a function
// to log results (for example: reportWebVitals(console.log))
// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals
reportWebVitals();



================================================
FILE: frontend/tailwind-test/src/reportWebVitals.js
================================================
const reportWebVitals = onPerfEntry => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};

export default reportWebVitals;



================================================
FILE: frontend/tailwind-test/src/setupTests.js
================================================
// jest-dom adds custom jest matchers for asserting on DOM nodes.
// allows you to do things like:
// expect(element).toHaveTextContent(/react/i)
// learn more: https://github.com/testing-library/jest-dom
import '@testing-library/jest-dom';



================================================
FILE: sql/001_init_core.sql
================================================
<<<<<<< HEAD
CREATE DATABASE IF NOT EXISTS parking_app
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE `parking_app`;

-- ============================================
-- TABLE: users (fusion des deux schÃ©mas)
-- ============================================
CREATE TABLE IF NOT EXISTS users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,

  -- IdentitÃ©
  email VARCHAR(160) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  firstname VARCHAR(100) NOT NULL,
  lastname VARCHAR(100) NOT NULL,

  -- RÃ´les
  role ENUM('USER','OWNER','ADMIN') NOT NULL DEFAULT 'USER',

  -- Abonnement utilisateur (facultatif selon ton projet)
  type_abonnement ENUM('gratuit', 'premium', 'business') NOT NULL DEFAULT 'gratuit',
  debut_abonnement DATE NULL,
  fin_abonnement DATE NULL,

  -- 2FA
  two_factor_enabled TINYINT(1) NOT NULL DEFAULT 0,
  two_factor_method ENUM('email','totp') NOT NULL DEFAULT 'email',
  two_factor_last_code VARCHAR(10) DEFAULT NULL,
  two_factor_expires_at DATETIME DEFAULT NULL,

  -- MÃ©tadonnÃ©es
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_email (email),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parkings
-- ============================================
CREATE TABLE IF NOT EXISTS parkings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  owner_id BIGINT NOT NULL,

  nom VARCHAR(200) NOT NULL,
  adresse VARCHAR(255) NOT NULL,
  ville VARCHAR(100) NOT NULL,

  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,

  nombre_places INT NOT NULL DEFAULT 0,

  -- Tarifs
  tarif_horaire DECIMAL(5, 2) NOT NULL DEFAULT 0.00,
  tarif_journalier DECIMAL(6, 2) NOT NULL DEFAULT 0.00,
  tarif_mensuel DECIMAL(7, 2) NOT NULL DEFAULT 0.00,

  -- Horaires
  horaire_ouverture TIME NOT NULL DEFAULT '00:00:00',
  horaire_fermeture TIME NOT NULL DEFAULT '23:59:59',

  -- Divers
  note DECIMAL(2, 1) NOT NULL DEFAULT 0.0,
  image VARCHAR(255) NULL,

  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,

  INDEX idx_ville (ville),
  INDEX idx_owner (owner_id),
  INDEX idx_location (latitude, longitude)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_services
-- ============================================
CREATE TABLE IF NOT EXISTS parking_services (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  service VARCHAR(100) NOT NULL,

  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_service (parking_id, service),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_type_vehicules
-- ============================================
CREATE TABLE IF NOT EXISTS parking_type_vehicules (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  type_vehicule VARCHAR(50) NOT NULL,

  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_vehicule (parking_id, type_vehicule),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: reservations
-- ============================================
CREATE TABLE IF NOT EXISTS reservations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  parking_id BIGINT NOT NULL,

  date_debut DATETIME NOT NULL,
  date_fin DATETIME NOT NULL,

  vehicule VARCHAR(50) NOT NULL,
  immatriculation VARCHAR(20) NULL,

  montant DECIMAL(8, 2) NOT NULL,

  statut ENUM('confirmÃ©e', 'annulÃ©e', 'terminÃ©e') NOT NULL DEFAULT 'confirmÃ©e',

  date_creation DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  date_annulation DATETIME NULL,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,

  INDEX idx_user (user_id),
  INDEX idx_parking (parking_id),
  INDEX idx_dates (date_debut, date_fin),
  INDEX idx_statut (statut),
  INDEX idx_user_dates (user_id, date_debut, date_fin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
AULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: stationnements
-- ============================================
CREATE TABLE IF NOT EXISTS stationnements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  reservation_id BIGINT NOT NULL,

  date_entree DATETIME NOT NULL,
  date_sortie DATETIME NULL,

  statut ENUM('en_cours', 'termine') NOT NULL DEFAULT 'en_cours',

  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE,
  INDEX idx_reservation (reservation_id),
  INDEX idx_statut (statut)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- DONNÃ‰ES DE TEST
-- ============================================

-- Utilisateurs de test
-- IMPORTANT: Les hash de mots de passe doivent Ãªtre gÃ©nÃ©rÃ©s avec password_hash() en PHP
-- Utiliser le script sql/003_generate_password_hash.php pour gÃ©nÃ©rer les hash
-- 
-- Exemple de hash pour 'password123':
-- $2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi
--
-- Pour crÃ©er les utilisateurs, exÃ©cuter:
-- php sql/003_generate_password_hash.php
-- Puis copier-coller les commandes SQL gÃ©nÃ©rÃ©es
--
-- OU utiliser cette commande SQL (hash pour 'password123'):
INSERT INTO users (email, password_hash, firstname, lastname, role, type_abonnement)
VALUES
('user@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Jean', 'Dupont', 'USER', 'gratuit'),
('owner@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Marie', 'Martin', 'OWNER', 'premium')
ON DUPLICATE KEY UPDATE email=email;

-- Note: Le password_hash correspond Ã  'password123' (bcrypt)
-- Pour gÃ©nÃ©rer un nouveau hash: php -r "echo password_hash('votre_mot_de_passe', PASSWORD_BCRYPT);"
=======
-- ============================================
-- SCHÃ‰MA DE BASE DE DONNÃ‰ES COMPLET
-- ParkingPartagÃ© - SystÃ¨me de rÃ©servation
-- ============================================

CREATE DATABASE IF NOT EXISTS parking_app
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE parking_app;

-- ============================================
-- TABLE: users
-- ============================================
CREATE TABLE IF NOT EXISTS users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  email VARCHAR(160) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  firstname VARCHAR(100) NOT NULL,
  lastname VARCHAR(100) NOT NULL,
  role ENUM('user', 'owner') NOT NULL DEFAULT 'user',
  type_abonnement ENUM('gratuit', 'premium', 'business') NOT NULL DEFAULT 'gratuit',
  debut_abonnement DATE NULL,
  fin_abonnement DATE NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_email (email),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parkings
-- ============================================
CREATE TABLE IF NOT EXISTS parkings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  owner_id BIGINT NOT NULL,
  nom VARCHAR(200) NOT NULL,
  adresse VARCHAR(255) NOT NULL,
  ville VARCHAR(100) NOT NULL,
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  nombre_places INT NOT NULL DEFAULT 0,
  tarif_horaire DECIMAL(5, 2) NOT NULL DEFAULT 0.00,
  tarif_journalier DECIMAL(6, 2) NOT NULL DEFAULT 0.00,
  tarif_mensuel DECIMAL(7, 2) NOT NULL DEFAULT 0.00,
  horaire_ouverture TIME NOT NULL DEFAULT '00:00:00',
  horaire_fermeture TIME NOT NULL DEFAULT '23:59:59',
  note DECIMAL(2, 1) NOT NULL DEFAULT 0.0,
  image VARCHAR(255) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_ville (ville),
  INDEX idx_owner (owner_id),
  INDEX idx_location (latitude, longitude)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_services
-- ============================================
CREATE TABLE IF NOT EXISTS parking_services (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  service VARCHAR(100) NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_service (parking_id, service),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_type_vehicules
-- ============================================
CREATE TABLE IF NOT EXISTS parking_type_vehicules (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  type_vehicule VARCHAR(50) NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_vehicule (parking_id, type_vehicule),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: reservations
-- ============================================
CREATE TABLE IF NOT EXISTS reservations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  parking_id BIGINT NOT NULL,
  date_debut DATETIME NOT NULL,
  date_fin DATETIME NOT NULL,
  vehicule VARCHAR(50) NOT NULL,
  immatriculation VARCHAR(20) NULL,
  montant DECIMAL(8, 2) NOT NULL,
  statut ENUM('confirmÃ©e', 'annulÃ©e', 'terminÃ©e') NOT NULL DEFAULT 'confirmÃ©e',
  date_creation DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  date_annulation DATETIME NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  INDEX idx_user (user_id),
  INDEX idx_parking (parking_id),
  INDEX idx_dates (date_debut, date_fin),
  INDEX idx_statut (statut),
  -- EmpÃªcher les chevauchements de dates pour le mÃªme utilisateur
  INDEX idx_user_dates (user_id, date_debut, date_fin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: stationnements
-- ============================================
CREATE TABLE IF NOT EXISTS stationnements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  reservation_id BIGINT NOT NULL,
  date_entree DATETIME NOT NULL,
  date_sortie DATETIME NULL,
  statut ENUM('en_cours', 'termine') NOT NULL DEFAULT 'en_cours',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE,
  INDEX idx_reservation (reservation_id),
  INDEX idx_statut (statut)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- DONNÃ‰ES DE TEST
-- ============================================

-- Utilisateurs de test
-- IMPORTANT: Les hash de mots de passe doivent Ãªtre gÃ©nÃ©rÃ©s avec password_hash() en PHP
-- Utiliser le script sql/003_generate_password_hash.php pour gÃ©nÃ©rer les hash
-- 
-- Exemple de hash pour 'password123':
-- $2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi
--
-- Pour crÃ©er les utilisateurs, exÃ©cuter:
-- php sql/003_generate_password_hash.php
-- Puis copier-coller les commandes SQL gÃ©nÃ©rÃ©es
--
-- OU utiliser cette commande SQL (hash pour 'password123'):
INSERT INTO users (email, password_hash, firstname, lastname, role, type_abonnement) VALUES
('user@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Jean', 'Dupont', 'user', 'gratuit'),
('owner@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Marie', 'Martin', 'owner', 'premium')
ON DUPLICATE KEY UPDATE email=email;

-- Note: Le password_hash correspond Ã  'password123' (bcrypt)
-- Pour gÃ©nÃ©rer un nouveau hash: php -r "echo password_hash('votre_mot_de_passe', PASSWORD_BCRYPT);"
>>>>>>> origin/Rayane



================================================
FILE: sql/002_insert_parkings.sql
================================================
-- ============================================
-- INSERTION DES PARKINGS DE TEST
-- ============================================

USE parking_app;

-- RÃ©cupÃ©rer l'ID du propriÃ©taire
SET @owner_id = (SELECT id FROM users WHERE email = 'owner@example.com' LIMIT 1);

-- Parkings Paris
INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES
(@owner_id, 'Parking OpÃ©ra Premium', '15 Rue Scribe, 75009 Paris', 'Paris', 48.8706, 2.3319, 150, 3.50, 25.00, 280.00, '00:00:00', '23:59:59', 4.8),
(@owner_id, 'Station ChÃ¢telet', '1 Place du ChÃ¢telet, 75001 Paris', 'Paris', 48.8584, 2.3470, 200, 4.00, 30.00, 320.00, '00:00:00', '23:59:59', 4.9),
(@owner_id, 'Parking Gare du Nord', '18 Rue de Dunkerque, 75010 Paris', 'Paris', 48.8809, 2.3553, 300, 3.00, 22.00, 250.00, '00:00:00', '23:59:59', 4.6),
(@owner_id, 'Park Saint-Lazare', '108 Rue Saint-Lazare, 75008 Paris', 'Paris', 48.8756, 2.3262, 120, 4.50, 35.00, 350.00, '06:00:00', '22:00:00', 4.7),
(@owner_id, 'Parking Bastille Central', '120 Rue de Lyon, 75012 Paris', 'Paris', 48.8522, 2.3697, 180, 3.20, 24.00, 270.00, '00:00:00', '23:59:59', 4.5)
ON DUPLICATE KEY UPDATE nom=nom;

-- Parkings Lyon
INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES
(@owner_id, 'Lyon Part-Dieu Premium', '21 Boulevard Vivier Merle, 69003 Lyon', 'Lyon', 45.7606, 4.8564, 250, 2.80, 20.00, 220.00, '00:00:00', '23:59:59', 4.9),
(@owner_id, 'Station Bellecour', '12 Place Bellecour, 69002 Lyon', 'Lyon', 45.7578, 4.8320, 180, 3.50, 26.00, 280.00, '00:00:00', '23:59:59', 4.7)
ON DUPLICATE KEY UPDATE nom=nom;

-- Parking Marseille
INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES
(@owner_id, 'Parking Vieux-Port', '46 Quai du Port, 13002 Marseille', 'Marseille', 43.2965, 5.3698, 220, 3.00, 22.00, 240.00, '00:00:00', '23:59:59', 4.6)
ON DUPLICATE KEY UPDATE nom=nom;

-- Services pour chaque parking
INSERT INTO parking_services (parking_id, service)
SELECT id, 'Couvert' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
UNION ALL SELECT id, 'SÃ©curisÃ©' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
UNION ALL SELECT id, 'VidÃ©o-surveillance' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
UNION ALL SELECT id, 'Bornes Ã©lectriques' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
ON DUPLICATE KEY UPDATE service=service;

-- Type de vÃ©hicules
INSERT INTO parking_type_vehicules (parking_id, type_vehicule)
SELECT id, 'Voiture' FROM parkings WHERE ville = 'Paris'
UNION ALL SELECT id, 'Moto' FROM parkings WHERE ville = 'Paris'
ON DUPLICATE KEY UPDATE type_vehicule=type_vehicule;








================================================
FILE: sql/003_generate_password_hash.php
================================================
<?php
/**
 * Script pour gÃ©nÃ©rer les hash de mots de passe
 * 
 * Usage: php sql/003_generate_password_hash.php
 * 
 * Ce script gÃ©nÃ¨re les hash bcrypt pour les mots de passe de test
 * et affiche les commandes SQL Ã  exÃ©cuter.
 */

$password = 'password123';

echo "=== GÃ©nÃ©ration des hash de mots de passe ===\n\n";

$hash = password_hash($password, PASSWORD_BCRYPT);

echo "Mot de passe: {$password}\n";
echo "Hash gÃ©nÃ©rÃ©: {$hash}\n\n";

echo "=== Commandes SQL Ã  exÃ©cuter ===\n\n";

echo "-- Mettre Ã  jour les utilisateurs existants\n";
echo "UPDATE users SET password_hash = '{$hash}' WHERE email = 'user@example.com';\n";
echo "UPDATE users SET password_hash = '{$hash}' WHERE email = 'owner@example.com';\n\n";

echo "-- Ou insÃ©rer de nouveaux utilisateurs\n";
echo "INSERT INTO users (email, password_hash, firstname, lastname, role, type_abonnement) VALUES\n";
echo "('user@example.com', '{$hash}', 'Jean', 'Dupont', 'user', 'gratuit'),\n";
echo "('owner@example.com', '{$hash}', 'Marie', 'Martin', 'owner', 'premium')\n";
echo "ON DUPLICATE KEY UPDATE password_hash = VALUES(password_hash);\n\n";

echo "=== VÃ©rification ===\n\n";
echo "Pour vÃ©rifier que le hash fonctionne:\n";
echo "php -r \"var_dump(password_verify('password123', '{$hash}'));\"\n";
echo "Devrait afficher: bool(true)\n";








================================================
FILE: sql/004_add_api_token.sql
================================================
ALTER TABLE users ADD COLUMN api_token VARCHAR(64) NULL AFTER role;
ALTER TABLE users ADD INDEX idx_api_token (api_token);



================================================
FILE: sql/sqlite_init.sql
================================================
-- SQLite Schema

CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  firstname TEXT NOT NULL,
  lastname TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'user',
  api_token TEXT NULL,
  type_abonnement TEXT NOT NULL DEFAULT 'gratuit',
  debut_abonnement DATE NULL,
  fin_abonnement DATE NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS parkings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  owner_id INTEGER NOT NULL,
  nom TEXT NOT NULL,
  adresse TEXT NOT NULL,
  ville TEXT NOT NULL,
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  nombre_places INTEGER NOT NULL DEFAULT 0,
  tarif_horaire DECIMAL(5, 2) NOT NULL DEFAULT 0.00,
  tarif_journalier DECIMAL(6, 2) NOT NULL DEFAULT 0.00,
  tarif_mensuel DECIMAL(7, 2) NOT NULL DEFAULT 0.00,
  horaire_ouverture TIME NOT NULL DEFAULT '00:00:00',
  horaire_fermeture TIME NOT NULL DEFAULT '23:59:59',
  note DECIMAL(2, 1) NOT NULL DEFAULT 0.0,
  image TEXT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS parking_services (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  parking_id INTEGER NOT NULL,
  service TEXT NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE(parking_id, service)
);

CREATE TABLE IF NOT EXISTS parking_type_vehicules (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  parking_id INTEGER NOT NULL,
  type_vehicule TEXT NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE(parking_id, type_vehicule)
);

CREATE TABLE IF NOT EXISTS reservations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  parking_id INTEGER NOT NULL,
  date_debut DATETIME NOT NULL,
  date_fin DATETIME NOT NULL,
  vehicule TEXT NOT NULL,
  immatriculation TEXT NULL,
  montant DECIMAL(8, 2) NOT NULL,
  statut TEXT NOT NULL DEFAULT 'confirmÃ©e',
  date_creation DATETIME DEFAULT CURRENT_TIMESTAMP,
  date_annulation DATETIME NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE
);

-- Index
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_token ON users(api_token);
CREATE INDEX idx_parkings_ville ON parkings(ville);


