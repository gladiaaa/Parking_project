arborescence: 

Directory structure:
â””â”€â”€ gladiaaa-parking_project/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ ARCHITECTURE.md
    â”œâ”€â”€ CONNEXION_BACKEND.md
    â”œâ”€â”€ parking_Postman.json
    â”œâ”€â”€ SETUP.md
    â”œâ”€â”€ .env.exemple
    â”œâ”€â”€ Backend/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ composer.json
    â”‚   â”œâ”€â”€ phpunit.xml.dist
    â”‚   â”œâ”€â”€ public/
    â”‚   â”‚   â””â”€â”€ index.php
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”œâ”€â”€ bootstrap.php
    â”‚   â”‚   â”œâ”€â”€ seed.php
    â”‚   â”‚   â”œâ”€â”€ Application/
    â”‚   â”‚   â”‚   â””â”€â”€ UseCase/
    â”‚   â”‚   â”‚       â””â”€â”€ ReservationManagement.php
    â”‚   â”‚   â”œâ”€â”€ Controller/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Auth2FAController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ AuthController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ MeController.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ ParkingController.php
    â”‚   â”‚   â”‚   â””â”€â”€ ReservationController.php
    â”‚   â”‚   â”œâ”€â”€ Domain/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Entity/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ parking.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Reservation.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ User.php
    â”‚   â”‚   â”‚   â””â”€â”€ Repository/
    â”‚   â”‚   â”‚       â”œâ”€â”€ ParkingRepository.php
    â”‚   â”‚   â”‚       â”œâ”€â”€ ParkingReservationRepository.php
    â”‚   â”‚   â”‚       â”œâ”€â”€ ReservationRepository.php
    â”‚   â”‚   â”‚       â””â”€â”€ UserRepository.php
    â”‚   â”‚   â”œâ”€â”€ Infrastructure/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Http/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IsGranted.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Response.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Router.php
    â”‚   â”‚   â”‚   â”œâ”€â”€ Persistence/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlParkingRepository.php
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SqlReservationRepository.php
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SqlUserRepository.php
    â”‚   â”‚   â”‚   â””â”€â”€ Security/
    â”‚   â”‚   â”‚       â”œâ”€â”€ JwtManager.php
    â”‚   â”‚   â”‚       â””â”€â”€ PasswordHasher.php
    â”‚   â”‚   â””â”€â”€ UseCase/
    â”‚   â”‚       â”œâ”€â”€ CreateReservation.php
    â”‚   â”‚       â”œâ”€â”€ ReserverParking.php
    â”‚   â”‚       â”œâ”€â”€ Auth/
    â”‚   â”‚       â”‚   â”œâ”€â”€ ConfigureTwoFactorMethod.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetCurrentUser.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ LoginUser.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ Mailer.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ RefreshToken.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ RegisterUser.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ SmsSender.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ StartTwoFactor.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ TotpVerifier.php
    â”‚   â”‚       â”‚   â””â”€â”€ VerifyTwoFactor.php
    â”‚   â”‚       â”œâ”€â”€ Parking/
    â”‚   â”‚       â”‚   â”œâ”€â”€ CheckAvailability.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ CreateParking.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetOwnerParkings.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetOwnerStatistics.php
    â”‚   â”‚       â”‚   â”œâ”€â”€ GetParkingDetails.php
    â”‚   â”‚       â”‚   â””â”€â”€ SearchParkings.php
    â”‚   â”‚       â””â”€â”€ Reservation/
    â”‚   â”‚           â”œâ”€â”€ CancelReservation.php
    â”‚   â”‚           â”œâ”€â”€ CreateReservation.php
    â”‚   â”‚           â””â”€â”€ GetUserReservations.php
    â”‚   â””â”€â”€ tests/
    â”‚       â”œâ”€â”€ Domain/
    â”‚       â”‚   â””â”€â”€ JwtManagerTest.php
    â”‚       â”œâ”€â”€ Infrastructure/
    â”‚       â”‚   â””â”€â”€ Security/
    â”‚       â”‚       â””â”€â”€ PasswordHasherTest.php
    â”‚       â””â”€â”€ UseCase/
    â”‚           â””â”€â”€ Auth/
    â”‚               â”œâ”€â”€ InMemoryUserRepository.php
    â”‚               â””â”€â”€ LoginUserTest.php
    â”œâ”€â”€ frontend/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ AUTHENTIFICATION.md
    â”‚   â”œâ”€â”€ package.json
    â”‚   â”œâ”€â”€ postcss.config.js
    â”‚   â”œâ”€â”€ tailwind.config.js
    â”‚   â”œâ”€â”€ public/
    â”‚   â”‚   â””â”€â”€ index.html
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ App.jsx
    â”‚       â”œâ”€â”€ index.css
    â”‚       â”œâ”€â”€ index.js
    â”‚       â”œâ”€â”€ components/
    â”‚       â”‚   â”œâ”€â”€ Footer.jsx
    â”‚       â”‚   â”œâ”€â”€ Header.jsx
    â”‚       â”‚   â”œâ”€â”€ LoadingScreen.jsx
    â”‚       â”‚   â”œâ”€â”€ ParkingCard.jsx
    â”‚       â”‚   â”œâ”€â”€ ProtectedRoute.jsx
    â”‚       â”‚   â””â”€â”€ SearchBar.jsx
    â”‚       â”œâ”€â”€ pages/
    â”‚       â”‚   â”œâ”€â”€ Dashboard.jsx
    â”‚       â”‚   â”œâ”€â”€ Login.jsx
    â”‚       â”‚   â”œâ”€â”€ Maps.jsx
    â”‚       â”‚   â”œâ”€â”€ MesReservations.jsx
    â”‚       â”‚   â”œâ”€â”€ OwnerDashboard.jsx
    â”‚       â”‚   â”œâ”€â”€ ParkingDetails.jsx
    â”‚       â”‚   â”œâ”€â”€ Register.jsx
    â”‚       â”‚   â”œâ”€â”€ Reservation.jsx
    â”‚       â”‚   â””â”€â”€ UserDashboard.jsx
    â”‚       â”œâ”€â”€ routes/
    â”‚       â”‚   â””â”€â”€ index.jsx
    â”‚       â”œâ”€â”€ services/
    â”‚       â”‚   â””â”€â”€ apiService.js
    â”‚       â””â”€â”€ UI/
    â”‚           â””â”€â”€ Countup.jsx
    â””â”€â”€ sql/
        â”œâ”€â”€ 001_init_core.sql
        â”œâ”€â”€ 002_insert_parkings.sql
        â”œâ”€â”€ 003_generate_password_hash.php
        â”œâ”€â”€ 004_add_api_token.sql
        â””â”€â”€ sqlite_init.sql




================================================
FILE: README.md
================================================
# ğŸ…¿ï¸ ParkingPartagÃ©

SystÃ¨me de rÃ©servation de parkings en temps rÃ©el - Projet de groupe

## ğŸ¯ Description

Application web moderne permettant de rÃ©server des places de parking dans toute la France. Interface ultra-Ã©purÃ©e et minimaliste inspirÃ©e des grandes marques (Apple, Tesla, Airbnb).

## ğŸ—ï¸ Architecture

```
Parking_project/
â”œâ”€â”€ frontend/          # React + Tailwind CSS
â”œâ”€â”€ Backend/           # API PHP + MySQL
â”œâ”€â”€ sql/               # Scripts de base de donnÃ©es
â””â”€â”€ README.md          # Ce fichier
```

## ğŸš€ Installation rapide

### Frontend

```bash
cd frontend
npm install
npm start
# Ouvre http://localhost:3000
```

### Backend

```bash
# 1. CrÃ©er la base de donnÃ©es
mysql -u root -p < sql/001_init_core.sql
mysql -u root -p < sql/002_insert_parkings.sql

# 2. Configurer .env
cp .env.example .env
# Ã‰diter .env avec vos paramÃ¨tres

# 3. DÃ©marrer le serveur
cd Backend
php -S localhost:8001 -t public
```

## ğŸ“Š Base de donnÃ©es

### Tables principales

- **users** : Utilisateurs (email, password, role, abonnement)
- **parkings** : Parkings (nom, adresse, coordonnÃ©es GPS, tarifs)
- **reservations** : RÃ©servations (dates, montant, statut)
- **stationnements** : Stationnements actifs
- **parking_services** : Services proposÃ©s
- **parking_type_vehicules** : Types de vÃ©hicules acceptÃ©s

### Scripts SQL

1. `sql/001_init_core.sql` - CrÃ©ation des tables
2. `sql/002_insert_parkings.sql` - DonnÃ©es de test

## ğŸ” Comptes de test

**Utilisateur :**
- Email: `user@example.com`
- Password: `password123`

**PropriÃ©taire :**
- Email: `owner@example.com`
- Password: `password123`

## âœ¨ FonctionnalitÃ©s

- âœ… Authentification complÃ¨te (login/register)
- âœ… Recherche de parkings avec filtres avancÃ©s
- âœ… Carte interactive avec tous les parkings
- âœ… SystÃ¨me de rÃ©servation complet
- âœ… Gestion des rÃ©servations
- âœ… EmpÃªchement des rÃ©servations simultanÃ©es
- âœ… Calcul automatique des prix
- âœ… Design ultra-moderne et minimaliste

## ğŸ› ï¸ Technologies

**Frontend :**
- React 18
- Tailwind CSS
- React Router
- Leaflet (cartes)

**Backend :**
- PHP 8.0+
- MySQL 8.0+
- PDO

## ğŸ“ Structure du projet

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/          # Pages principales
â”‚   â”œâ”€â”€ components/      # Composants rÃ©utilisables
â”‚   â”œâ”€â”€ services/        # API service (mock pour l'instant)
â”‚   â””â”€â”€ App.jsx         # Routeur principal

Backend/
â”œâ”€â”€ public/             # Point d'entrÃ©e API
â”œâ”€â”€ src/                # Code source PHP
â””â”€â”€ README.md

sql/
â”œâ”€â”€ 001_init_core.sql   # SchÃ©ma de base de donnÃ©es
â””â”€â”€ 002_insert_parkings.sql  # DonnÃ©es de test
```

## ğŸ‘¥ Pour les membres du groupe

### PremiÃ¨re installation

1. **Cloner le projet**
   ```bash
   git clone [url-du-repo]
   cd Parking_project
   ```

2. **Installer les dÃ©pendances frontend**
   ```bash
   cd frontend
   npm install
   ```

3. **Configurer la base de donnÃ©es**
   ```bash
   mysql -u root -p < sql/001_init_core.sql
   mysql -u root -p < sql/002_insert_parkings.sql
   ```

4. **Configurer l'environnement**
   ```bash
   cp .env.example .env
   # Ã‰diter .env avec vos paramÃ¨tres MySQL
   ```

5. **DÃ©marrer les serveurs**
   ```bash
   # Terminal 1 - Frontend
   cd frontend
   npm start

   # Terminal 2 - Backend
   cd Backend
   php -S localhost:8001 -t public
   ```

### Utilisation quotidienne

- **Frontend** : http://localhost:3000 (ou 4000)
- **Backend API** : http://localhost:8001
- **Health check** : http://localhost:8001/health

## ğŸ“ Notes importantes

- Le frontend utilise actuellement un **mock API** (`apiService.js`)
- Pour connecter le vrai backend, modifier `API_BASE_URL` dans `frontend/src/services/apiService.js`
- Les utilisateurs sont persistÃ©s dans `localStorage` (frontend)
- Les rÃ©servations sont stockÃ©es en mÃ©moire (sera remplacÃ© par la DB)

## ğŸ”„ Prochaines Ã©tapes

1. Connecter le frontend au vrai backend PHP
2. ImplÃ©menter l'authentification JWT
3. Ajouter la gÃ©olocalisation
4. SystÃ¨me de paiement
5. Notifications en temps rÃ©el

## ğŸ“ Support

Pour toute question, consulter :
- `frontend/AUTHENTIFICATION.md` - Documentation authentification
- `Backend/README.md` - Documentation backend
- `sql/001_init_core.sql` - SchÃ©ma de base de donnÃ©es

---

**DÃ©veloppÃ© avec â¤ï¸ pour le projet de groupe**



================================================
FILE: ARCHITECTURE.md
================================================
# ğŸ—ï¸ Architecture du Projet - ParkingPartagÃ©

Documentation complÃ¨te de l'architecture pour le travail en groupe.

## ğŸ“ Vue d'ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â”‚    Frontend     â”‚ â”€â”€â”€â”€â”€â”€> â”‚    Backend      â”‚ â”€â”€â”€â”€â”€â”€> â”‚   MySQL DB      â”‚
â”‚   (React)       â”‚  HTTP   â”‚     (PHP)       â”‚   SQL   â”‚                 â”‚
â”‚   Port 4000     â”‚         â”‚   Port 8001     â”‚         â”‚   Port 3306     â”‚
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flux de donnÃ©es

### 1. Authentification

```
User â†’ Frontend (Login.jsx)
  â†“
apiService.login()
  â†“
Backend POST /api/auth/login
  â†“
MySQL SELECT users WHERE email
  â†“
Retour token + user data
  â†“
localStorage.setItem('token', token)
```

### 2. Recherche de parkings

```
User â†’ Frontend (Reservation.jsx)
  â†“
apiService.searchParkings()
  â†“
Backend GET /api/parkings?ville=Paris
  â†“
MySQL SELECT parkings + calcul places disponibles
  â†“
Retour liste parkings
```

### 3. RÃ©servation

```
User â†’ Frontend (BookingModal)
  â†“
apiService.reserveParking()
  â†“
Backend POST /api/reservations
  â†“
MySQL INSERT reservations + vÃ©rification disponibilitÃ©
  â†“
Retour confirmation
```

## ğŸ“ Structure des fichiers

### Frontend (`frontend/`)

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Home.jsx              # Page d'accueil
â”‚   â”‚   â”œâ”€â”€ Login.jsx              # Connexion
â”‚   â”‚   â”œâ”€â”€ Register.jsx           # Inscription
â”‚   â”‚   â”œâ”€â”€ Reservation.jsx        # Recherche/RÃ©servation
â”‚   â”‚   â”œâ”€â”€ Maps.jsx               # Carte interactive
â”‚   â”‚   â””â”€â”€ MesReservations.jsx    # Gestion rÃ©servations
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Header.jsx             # Navigation
â”‚   â”‚   â”œâ”€â”€ Footer.jsx             # Pied de page
â”‚   â”‚   â””â”€â”€ LoadingScreen.jsx     # Ã‰cran de chargement
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ apiService.js          # âš ï¸ MOCK API (Ã  connecter)
â”‚   â””â”€â”€ App.jsx                    # Routeur principal
â””â”€â”€ package.json
```

### Backend (`Backend/`)

```
Backend/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.php                  # Point d'entrÃ©e API
â”œâ”€â”€ src/
â”‚   â””â”€â”€ bootstrap.php              # Configuration DB + helpers
â””â”€â”€ README.md
```

### Base de donnÃ©es (`sql/`)

```
sql/
â”œâ”€â”€ 001_init_core.sql              # SchÃ©ma complet
â””â”€â”€ 002_insert_parkings.sql        # DonnÃ©es de test
```

## ğŸ—„ï¸ SchÃ©ma de base de donnÃ©es

### Relations principales

```
users (1) â”€â”€â”€â”€< (N) parkings
  â”‚                    â”‚
  â”‚                    â”‚
  â””â”€â”€â”€< (N) reservations >â”€â”€â”€â”˜
              â”‚
              â”‚
              â””â”€â”€â”€< (1) stationnements
```

### Tables dÃ©taillÃ©es

#### `users`
- `id` (PK)
- `email` (UNIQUE)
- `password_hash`
- `firstname`, `lastname`
- `role` (user/owner)
- `type_abonnement` (gratuit/premium/business)

#### `parkings`
- `id` (PK)
- `owner_id` (FK â†’ users)
- `nom`, `adresse`, `ville`
- `latitude`, `longitude`
- `nombre_places`
- `tarif_horaire`, `tarif_journalier`, `tarif_mensuel`
- `note` (rating)

#### `reservations`
- `id` (PK)
- `user_id` (FK â†’ users)
- `parking_id` (FK â†’ parkings)
- `date_debut`, `date_fin`
- `vehicule`, `immatriculation`
- `montant`
- `statut` (confirmÃ©e/annulÃ©e/terminÃ©e)

## ğŸ”Œ API Endpoints

### Actuellement implÃ©mentÃ©s

| MÃ©thode | Route | Description |
|---------|-------|-------------|
| GET | `/health` | Health check |
| GET | `/db/ping` | Test connexion DB |
| GET | `/api/parkings` | Liste tous les parkings |
| GET | `/api/parkings/:id` | DÃ©tails d'un parking |
| POST | `/api/auth/login` | Connexion |
| GET | `/api/users` | Liste utilisateurs (debug) |

### Ã€ implÃ©menter

- `POST /api/auth/register` - Inscription
- `GET /api/auth/profile` - Profil utilisateur
- `GET /api/parkings/search` - Recherche avec filtres
- `POST /api/reservations` - CrÃ©er rÃ©servation
- `GET /api/reservations` - Mes rÃ©servations
- `DELETE /api/reservations/:id` - Annuler rÃ©servation

## ğŸ”„ Ã‰tat actuel

### âœ… Fonctionnel

- **Frontend** : Interface complÃ¨te avec mock API
- **Base de donnÃ©es** : SchÃ©ma complet et logique
- **Backend** : Structure de base avec quelques endpoints

### âš ï¸ Ã€ connecter

Le frontend utilise actuellement `apiService.js` qui simule un backend. Pour connecter au vrai backend :

1. Modifier `API_BASE_URL` dans `apiService.js`
2. Adapter les fonctions pour faire de vrais appels HTTP
3. GÃ©rer les tokens JWT
4. GÃ©rer les erreurs rÃ©seau

## ğŸ” SÃ©curitÃ©

### Actuellement

- Hashage des mots de passe (bcrypt)
- Validation des donnÃ©es cÃ´tÃ© backend
- CORS configurÃ©

### Ã€ amÃ©liorer

- Tokens JWT au lieu de tokens simples
- Validation cÃ´tÃ© frontend
- Rate limiting
- Sanitization des inputs

## ğŸ“ Pour le groupe

### Chaque membre doit comprendre

1. **Frontend** : React + Tailwind, composants rÃ©utilisables
2. **Backend** : PHP simple, PDO pour MySQL
3. **Base de donnÃ©es** : Relations claires, schÃ©ma logique
4. **API** : RESTful, JSON, CORS

### Workflow recommandÃ©

1. **DÃ©veloppement local** : Chacun sur sa machine
2. **Base de donnÃ©es** : SchÃ©ma partagÃ© (mÃªme structure)
3. **Git** : Branches par fonctionnalitÃ©
4. **Tests** : VÃ©rifier avec les comptes de test

### Partage de code

- âœ… **Partager** : Code source, schÃ©ma DB, documentation
- âŒ **Ne pas partager** : `.env`, `node_modules`, fichiers de log

## ğŸš€ Prochaines Ã©tapes

1. Connecter frontend au vrai backend
2. ImplÃ©menter tous les endpoints API
3. Ajouter authentification JWT
4. Tests unitaires
5. DÃ©ploiement

---

**Documentation maintenue pour faciliter le travail en groupe**








================================================
FILE: CONNEXION_BACKEND.md
================================================
# ğŸ”Œ Guide de Connexion Frontend â†” Backend

Comment connecter le frontend React au backend PHP rÃ©el.

## ğŸ“ Ã‰tat actuel

Le frontend utilise actuellement un **mock API** (`apiService.js`) qui simule toutes les fonctionnalitÃ©s en mÃ©moire et localStorage.

## ğŸ¯ Objectif

Remplacer le mock par de vrais appels HTTP vers le backend PHP.

## ğŸ”„ Ã‰tapes de migration

### 1. VÃ©rifier que le backend fonctionne

```bash
# DÃ©marrer le backend
cd Backend
php -S localhost:8001 -t public

# Tester
curl http://localhost:8001/health
# Devrait retourner: {"ok":true,"php":"8.x"}
```

### 2. Modifier `apiService.js`

Le fichier `frontend/src/services/apiService.js` contient dÃ©jÃ  `API_BASE_URL = 'http://localhost:8001/api'`.

**Option A : Migration progressive**

CrÃ©er une fonction helper pour les appels HTTP :

```javascript
const apiCall = async (endpoint, options = {}) => {
  const token = localStorage.getItem('token');
  
  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` }),
      ...options.headers,
    },
  });
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  return response.json();
};
```

**Option B : Remplacer fonction par fonction**

Commencer par `login()` :

```javascript
export const login = async (email, password) => {
  try {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    
    const data = await response.json();
    
    if (data.success) {
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      return data;
    } else {
      throw new Error(data.error || 'Erreur de connexion');
    }
  } catch (error) {
    throw new Error(error.message || 'Erreur rÃ©seau');
  }
};
```

### 3. Endpoints Ã  implÃ©menter dans le backend

#### Authentification

```php
// POST /api/auth/login
// Body: { "email": "...", "password": "..." }
// Retour: { "success": true, "token": "...", "user": {...} }

// POST /api/auth/register
// Body: { "email": "...", "password": "...", "firstname": "...", "lastname": "...", "role": "user" }
// Retour: { "success": true, "token": "...", "user": {...} }

// GET /api/auth/profile
// Header: Authorization: Bearer {token}
// Retour: { "success": true, "user": {...} }
```

#### Parkings

```php
// GET /api/parkings
// Query: ?ville=Paris&prixMax=50
// Retour: { "success": true, "parkings": [...], "total": 10 }

// GET /api/parkings/:id
// Retour: { "success": true, "parking": {...} }
```

#### RÃ©servations

```php
// POST /api/reservations
// Body: { "parking_id": 1, "date_debut": "...", "date_fin": "...", "vehicule": "..." }
// Retour: { "success": true, "reservation": {...} }

// GET /api/reservations
// Header: Authorization: Bearer {token}
// Retour: { "success": true, "reservations": [...] }

// DELETE /api/reservations/:id
// Header: Authorization: Bearer {token}
// Retour: { "success": true }
```

## ğŸ” Gestion des tokens

### Backend : GÃ©nÃ©rer un token JWT

```php
// Installer: composer require firebase/php-jwt

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

function generateToken($user) {
    $payload = [
        'user_id' => $user['id'],
        'email' => $user['email'],
        'role' => $user['role'],
        'exp' => time() + (60 * 60 * 24) // 24h
    ];
    
    return JWT::encode($payload, env('JWT_SECRET'), 'HS256');
}

function verifyToken($token) {
    try {
        return JWT::decode($token, new Key(env('JWT_SECRET'), 'HS256'));
    } catch (Exception $e) {
        return null;
    }
}
```

### Frontend : Utiliser le token

```javascript
// Dans apiService.js
const getAuthHeaders = () => {
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': `Bearer ${token}` } : {};
};

// Exemple d'appel authentifiÃ©
const getMyReservations = async () => {
  const response = await fetch(`${API_BASE_URL}/reservations`, {
    headers: {
      'Content-Type': 'application/json',
      ...getAuthHeaders(),
    },
  });
  return response.json();
};
```

## ğŸ§ª Tests

### Tester chaque endpoint

```bash
# Login
curl -X POST http://localhost:8001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password123"}'

# Liste parkings
curl http://localhost:8001/api/parkings

# CrÃ©er rÃ©servation (avec token)
curl -X POST http://localhost:8001/api/reservations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"parking_id":1,"date_debut":"2025-01-20 10:00:00","date_fin":"2025-01-20 12:00:00","vehicule":"Voiture"}'
```

## ğŸ“ Checklist de migration

- [ ] Backend dÃ©marrÃ© et accessible
- [ ] Endpoint `/health` fonctionne
- [ ] Endpoint `/api/auth/login` implÃ©mentÃ©
- [ ] Frontend `login()` utilise le vrai backend
- [ ] Token stockÃ© et envoyÃ© dans les headers
- [ ] Endpoint `/api/parkings` implÃ©mentÃ©
- [ ] Frontend `searchParkings()` utilise le vrai backend
- [ ] Endpoint `/api/reservations` implÃ©mentÃ©
- [ ] Frontend `reserveParking()` utilise le vrai backend
- [ ] Gestion des erreurs rÃ©seau
- [ ] Tests de bout en bout

## âš ï¸ Points d'attention

1. **CORS** : Le backend doit autoriser les requÃªtes depuis `http://localhost:4000`
2. **Validation** : Valider toutes les donnÃ©es cÃ´tÃ© backend
3. **Erreurs** : Retourner des messages d'erreur clairs
4. **SÃ©curitÃ©** : Ne jamais exposer les mots de passe en clair
5. **Performance** : Optimiser les requÃªtes SQL (indexes)

## ğŸš€ Exemple complet

### Backend : `Backend/public/index.php`

```php
// POST /api/auth/login
if ($route === 'auth/login' && $method === 'POST') {
    $data = json_decode(file_get_contents('php://input'), true);
    $email = trim(strtolower($data['email'] ?? ''));
    $password = $data['password'] ?? '';
    
    $stmt = pdo()->prepare('SELECT * FROM users WHERE email = ?');
    $stmt->execute([$email]);
    $user = $stmt->fetch();
    
    if ($user && password_verify($password, $user['password_hash'])) {
        $token = generateToken($user);
        
        echo json_encode([
            'success' => true,
            'token' => $token,
            'user' => [
                'id' => $user['id'],
                'email' => $user['email'],
                'firstname' => $user['firstname'],
                'lastname' => $user['lastname'],
                'role' => $user['role']
            ]
        ]);
    } else {
        http_response_code(401);
        echo json_encode(['success' => false, 'error' => 'Email ou mot de passe incorrect']);
    }
    exit;
}
```

### Frontend : `frontend/src/services/apiService.js`

```javascript
export const login = async (email, password) => {
  const response = await fetch(`${API_BASE_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      email: email.trim().toLowerCase(), 
      password 
    }),
  });
  
  const data = await response.json();
  
  if (data.success) {
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user));
    return data;
  }
  
  throw new Error(data.error || 'Erreur de connexion');
};
```

---

**Guide pour connecter progressivement le frontend au backend rÃ©el**








================================================
FILE: parking_Postman.json
================================================
{
  "info": {
    "_postman_id": "e0c08f67-43d8-4d09-8a7a-b305ead55551",
    "name": "Parking Project - Auth & Security Tests",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Login",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"email\": \"test@test.com\",\n    \"password\": \"Test123456789\"\n}"
        },
        "url": {
          "raw": "http://localhost:8001/api/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "login"]
        }
      },
      "response": []
    },

    {
      "name": "Get Me (Authenticated)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status is 200\", function () {",
              "  pm.response.to.have.status(200);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:8001/api/me",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "me"]
        }
      },
      "response": []
    },

    {
      "name": "Get Me (Unauthorized)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:8001/api/me",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "me"]
        }
      },
      "response": [],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Force suppression des cookies",
              "pm.cookies.jar().clear(pm.request.url.getHost());"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Unauthorized\", function () {",
              "   pm.response.to.have.status(401);",
              "});"
            ]
          }
        }
      ]
    },

    {
      "name": "Refresh Token",
      "request": {
        "method": "POST",
        "header": [],
        "url": {
          "raw": "http://localhost:8001/api/auth/refresh",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "refresh"]
        }
      },
      "response": []
    },

    {
      "name": "Role Test - Owner Only",
      "request": {
        "method": "GET",
        "url": {
          "raw": "http://localhost:8001/api/owner/dashboard",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "owner", "dashboard"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Forbidden\", function () {",
              "  pm.response.to.have.status(403);",
              "});"
            ]
          }
        }
      ]
    },

    {
      "name": "Start 2FA",
      "request": {
        "method": "POST",
        "url": {
          "raw": "http://localhost:8001/api/auth/2fa/start",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "2fa", "start"]
        }
      }
    },

    {
      "name": "Verify 2FA",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"code\": \"123456\"\n}"
        },
        "url": {
          "raw": "http://localhost:8001/api/auth/2fa/verify",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8001",
          "path": ["api", "auth", "2fa", "verify"]
        }
      }
    }
  ]
}



================================================
FILE: SETUP.md
================================================
# ğŸš€ Guide d'Installation - ParkingPartagÃ©

Guide complet pour installer et configurer le projet en groupe.

## ğŸ“‹ PrÃ©requis

- **Node.js** 16+ et npm
- **PHP** 8.0+ avec extensions PDO et MySQL
- **MySQL** 8.0+
- **Git**

## ğŸ”§ Installation Ã©tape par Ã©tape

### 1. Cloner le projet

```bash
git clone [url-du-repo]
cd Parking_project
```

### 2. Configuration de la base de donnÃ©es

```bash
# Se connecter Ã  MySQL
mysql -u root -p

# Ou crÃ©er un utilisateur dÃ©diÃ©
mysql -u root -p
CREATE USER 'parking_user'@'localhost' IDENTIFIED BY 'votre_mot_de_passe';
GRANT ALL PRIVILEGES ON parking_app.* TO 'parking_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# CrÃ©er la base de donnÃ©es et les tables
mysql -u root -p < sql/001_init_core.sql

# InsÃ©rer les donnÃ©es de test
mysql -u root -p < sql/002_insert_parkings.sql
```

### 3. Configuration Backend

```bash
# CrÃ©er le fichier .env Ã  la racine du projet
cat > .env << EOF
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=parking_app
DB_USER=root
DB_PASS=votre_mot_de_passe_mysql
API_BASE_URL=http://localhost:8001/api
FRONTEND_URL=http://localhost:4000
JWT_SECRET=changez-moi-en-production
APP_ENV=development
APP_DEBUG=true
EOF
```

### 4. Installation Frontend

```bash
cd frontend
npm install
```

### 5. DÃ©marrer les serveurs

**Terminal 1 - Backend :**
```bash
cd Backend
php -S localhost:8001 -t public
```

**Terminal 2 - Frontend :**
```bash
cd frontend
PORT=4000 npm start
```

## âœ… VÃ©rification

1. **Backend** : http://localhost:8001/health
   - Devrait retourner : `{"ok":true,"php":"8.x"}`

2. **Base de donnÃ©es** : http://localhost:8001/db/ping
   - Devrait retourner : `{"ok":true,"mysql_version":"8.x"}`

3. **Frontend** : http://localhost:4000
   - Devrait afficher la page d'accueil

## ğŸ” Comptes de test

**Utilisateur :**
- Email: `user@example.com`
- Password: `password123`

**PropriÃ©taire :**
- Email: `owner@example.com`
- Password: `password123`

## ğŸ“Š Structure de la base de donnÃ©es

### Tables crÃ©Ã©es

1. **users** - Utilisateurs (user/owner)
2. **parkings** - Parkings disponibles
3. **parking_services** - Services par parking
4. **parking_type_vehicules** - Types de vÃ©hicules acceptÃ©s
5. **reservations** - RÃ©servations
6. **stationnements** - Stationnements actifs

### Relations

- `users` â†’ `parkings` (owner_id)
- `users` â†’ `reservations` (user_id)
- `parkings` â†’ `reservations` (parking_id)
- `reservations` â†’ `stationnements` (reservation_id)

## ğŸ› DÃ©pannage

### Erreur de connexion MySQL

```bash
# VÃ©rifier que MySQL tourne
sudo service mysql status

# RedÃ©marrer MySQL
sudo service mysql restart
```

### Port dÃ©jÃ  utilisÃ©

```bash
# Changer le port dans .env
DB_PORT=3307

# Ou pour le frontend
PORT=4001 npm start
```

### Erreur "Table doesn't exist"

```bash
# RÃ©exÃ©cuter les scripts SQL
mysql -u root -p < sql/001_init_core.sql
mysql -u root -p < sql/002_insert_parkings.sql
```

## ğŸ“ Notes importantes

- Le frontend utilise actuellement un **mock API** (`apiService.js`)
- Pour connecter au vrai backend, modifier `API_BASE_URL` dans `frontend/src/services/apiService.js`
- Les donnÃ©es sont persistÃ©es dans MySQL (backend) et localStorage (frontend mock)

## ğŸ‘¥ Pour le groupe

Chaque membre doit :
1. Cloner le repo
2. Installer les dÃ©pendances
3. Configurer sa base de donnÃ©es locale
4. CrÃ©er son fichier `.env`
5. DÃ©marrer les serveurs

**Tous les membres partagent le mÃªme schÃ©ma de base de donnÃ©es !**








================================================
FILE: .env.exemple
================================================
# ===========================
#   APP CONFIG
# ===========================
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8001

# ===========================
#   DATABASE CONFIG
# ===========================
DB_DRIVER=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=parking_project
DB_USER=root
DB_PASSWORD=

# Pour SQLite si vous l'utilisez en stockage secondaire
SQLITE_PATH=/path/to/storage/database.sqlite

# ===========================
#   JWT CONFIG
# ===========================
JWT_SECRET=changemeTousDeSuiteParceQueSinonCestLaHonte
JWT_ISSUER=parking-app
JWT_EXPIRES_IN=3600

# ===========================
#   STORAGE CONFIG
# ===========================
STORAGE_PATH=/path/to/storage

# ===========================
#   LOGS
# ===========================
LOG_PATH=/path/to/logs
LOG_LEVEL=debug

# ===========================
#   MAIL (si vous faites 2FA, reset password, etc.)
# ===========================
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=super-secret
MAIL_FROM=your-email@example.com
MAIL_FROM_NAME="Parking App"

# ===========================
#   OPTIONS PARKING
# ===========================
# Tranches durÃ©e tarifaires
PARKING_BILLING_INTERVAL=15
PARKING_PENALITY_AMOUNT=20



================================================
FILE: Backend/README.md
================================================
# ğŸš€ Backend - ParkingPartagÃ©

API REST en PHP pour le systÃ¨me de rÃ©servation de parkings.

## ğŸ“‹ PrÃ©requis

- PHP 8.0+
- MySQL 8.0+
- Composer (optionnel)

## ğŸ› ï¸ Installation

### 1. Configuration de la base de donnÃ©es

```bash
# CrÃ©er la base de donnÃ©es
mysql -u root -p < sql/001_init_core.sql

# InsÃ©rer les donnÃ©es de test
mysql -u root -p < sql/002_insert_parkings.sql
```

### 2. Configuration de l'environnement

```bash
# Copier le fichier .env.example
cp .env.example .env

# Ã‰diter .env avec vos paramÃ¨tres
nano .env
```

### 3. DÃ©marrer le serveur PHP

```bash
# Depuis le dossier Backend
cd Backend
php -S localhost:8001 -t public
```

## ğŸ“Š Structure de la base de donnÃ©es

### Tables principales

- **users** : Utilisateurs (user/owner)
- **parkings** : Parkings disponibles
- **parking_services** : Services proposÃ©s par parking
- **parking_type_vehicules** : Types de vÃ©hicules acceptÃ©s
- **reservations** : RÃ©servations des utilisateurs
- **stationnements** : Stationnements actifs

## ğŸ”Œ Endpoints API

### Authentification
- `POST /api/auth/login` - Connexion
- `POST /api/auth/register` - Inscription
- `GET /api/auth/profile` - Profil utilisateur

### Parkings
- `GET /api/parkings` - Liste des parkings
- `GET /api/parkings/search` - Recherche de parkings
- `GET /api/parkings/:id` - DÃ©tails d'un parking

### RÃ©servations
- `GET /api/reservations` - Mes rÃ©servations
- `POST /api/reservations` - CrÃ©er une rÃ©servation
- `DELETE /api/reservations/:id` - Annuler une rÃ©servation

## ğŸ” SÃ©curitÃ©

- Hashage des mots de passe avec bcrypt
- Tokens JWT pour l'authentification
- Validation des donnÃ©es
- Protection CORS

## ğŸ‘¥ Pour le groupe

1. Cloner le projet
2. Installer MySQL
3. ExÃ©cuter les scripts SQL dans l'ordre
4. Configurer le `.env`
5. DÃ©marrer le serveur PHP

## ğŸ“ Notes

- Le frontend utilise actuellement un mock API (`apiService.js`)
- Pour connecter le vrai backend, modifier `API_BASE_URL` dans `apiService.js`
- Les mots de passe de test : `password123` (hashÃ© avec bcrypt)








================================================
FILE: Backend/composer.json
================================================
{
  "require": {
    "php": "^8.2",
    "firebase/php-jwt": "^6.10",
    "vlucas/phpdotenv": "^5.6"
  },
  "autoload": {
    "psr-4": {
      "App\\": "src/"
    }
  },
  "require-dev": {
    "phpunit/phpunit": "11"
  }
}



================================================
FILE: Backend/phpunit.xml.dist
================================================
<?xml version="1.0" encoding="UTF-8"?>
<phpunit
    bootstrap="vendor/autoload.php"
    colors="true"
>
    <testsuites>
        <testsuite name="Parking Test Suite">
            <directory>tests</directory>
        </testsuite>
    </testsuites>

    <source>
        <include>
            <directory suffix=".php">src</directory>
        </include>
    </source>
</phpunit>



================================================
FILE: Backend/public/index.php
================================================
<?php
declare(strict_types=1);

require __DIR__ . '/../src/bootstrap.php';

cors();

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204);
    exit;
}

use App\Controller\AuthController;
use App\Controller\MeController;
use App\Controller\Auth2FAController;

/** @var \App\Infrastructure\Http\Router $router */
/** @var AuthController $authController */
/** @var MeController $meController */
/** @var Auth2FAController $auth2FAController */

// ROUTES AUTH
$router->post('/api/auth/login', [$authController, 'login']);
$router->post('/api/auth/register', [$authController, 'register']);
$router->post('/api/auth/refresh', [$authController, 'refresh']);
$router->post('/api/auth/logout', [$authController, 'logout']);

// 2FA
$router->post('/api/auth/2fa/start', [$auth2FAController, 'start']);
$router->post('/api/auth/2fa/verify', [$auth2FAController, 'verify']);

// ME
$router->get('/api/me', [$meController, 'me']);

$method = $_SERVER['REQUEST_METHOD'];
$path   = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH) ?? '/';

$router->dispatch($method, $path);



================================================
FILE: Backend/src/bootstrap.php
================================================
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';
error_log("BOOT OK");

use Dotenv\Dotenv;

// =======================================
// Load ENV
// =======================================
$dotenv = Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

// =======================================
// Imports
// =======================================
use App\Infrastructure\Persistence\SqlUserRepository;
use App\Infrastructure\Persistence\SqlParkingRepository;
use App\Infrastructure\Persistence\SqlReservationRepository;
use App\Infrastructure\Security\JwtManager;
use App\Infrastructure\Security\PasswordHasher;
use App\Infrastructure\Http\Router;

use App\Controller\AuthController;
use App\Controller\Auth2FAController;
use App\Controller\MeController;
use App\Controller\ReservationController;


use App\UseCase\CreateReservation;
use App\UseCase\Auth\LoginUser;
use App\UseCase\Auth\RegisterUser;
use App\UseCase\Auth\RefreshToken;
use App\UseCase\Auth\StartTwoFactor;
use App\UseCase\Auth\VerifyTwoFactor;
use App\UseCase\Auth\Mailer;
use App\UseCase\Auth\SmsSender;
use App\UseCase\Auth\TotpVerifier;


// =======================================
// Config
// =======================================

function cors(): void {
    header('Access-Control-Allow-Origin: ' . $_ENV['APP_ORIGIN']);
    header('Access-Control-Allow-Credentials: true');
    header('Access-Control-Allow-Headers: Content-Type, X-Requested-With');
    header('Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS');
    header('Content-Type: application/json; charset=utf-8');
}

function json($data, int $status = 200): void {
    http_response_code($status);
    echo json_encode($data, JSON_UNESCAPED_UNICODE);
}

function pdo(): PDO {
    static $pdo = null;
    if ($pdo) return $pdo;

    $dsn = 'mysql:host=' . $_ENV['DB_HOST'] .
           ';dbname=' . $_ENV['DB_NAME'] .
           ';charset=' . $_ENV['DB_CHARSET'];

    $pdo = new PDO($dsn, $_ENV['DB_USER'], $_ENV['DB_PASS'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ]);

    return $pdo;
}

// =======================================
// Dependency Container
// =======================================

$pdo = pdo();

$userRepository = new SqlUserRepository($pdo);
$passwordHasher = new PasswordHasher();
$parkingRepository = new SqlParkingRepository($pdo);
$reservationRepository = new SqlReservationRepository($pdo);


$jwtManager = new JwtManager(
    $_ENV['JWT_SECRET'],
    (int)$_ENV['JWT_ACCESS_TTL'],
    (int)$_ENV['JWT_REFRESH_TTL']
);

// Fake mailer
$mailer = new class implements Mailer {
    public function sendTwoFactorCodeEmail(string $to, string $code): void {
        error_log("[2FA EMAIL] $to -> code $code");
    }
};

// Fake SMS
$smsSender = new class implements SmsSender {
    public function sendTwoFactorSms(string $phone, string $code): void {
        error_log("[2FA SMS] $phone -> code $code");
    }
};

// Fake TOTP
$totpVerifier = new class implements TotpVerifier {
    public function verify(string $secret, string $code): bool {
        return true;
    }
};

// =======================================
// Use cases
// =======================================

$loginUser = new LoginUser($userRepository, $passwordHasher);
$registerUser = new RegisterUser($userRepository, $passwordHasher);
$refreshToken = new RefreshToken($jwtManager, $userRepository);
$startTwoFA = new StartTwoFactor($userRepository, $mailer, $smsSender);
$verify2FA = new VerifyTwoFactor($userRepository, $jwtManager, $totpVerifier);
$createReservation = new CreateReservation(
    $parkingRepository,
    $reservationRepository
);


// =======================================
// Controllers
// =======================================

$meController = new MeController($jwtManager, $userRepository);
$authController = new AuthController(
    $loginUser,
    $refreshToken,
    $registerUser,
    $startTwoFA,
    $jwtManager
);
$auth2FAController = new Auth2FAController($verify2FA, $jwtManager);
$reservationController = new ReservationController($createReservation, $reservationRepository, $jwtManager);

// =======================================
// Router
// =======================================

$router = new Router();

$router

    ->get('/health', fn() => json(['ok' => true, 'php' => PHP_VERSION]))
    ->get('/api/me', [$meController, 'me'])
    ->get('/api/reservations/me', [$reservationController, 'myReservations'])

    ->post('/api/auth/login', [$authController, 'login'])
    ->post('/api/auth/register', [$authController, 'register'])
    ->post('/api/auth/refresh', [$authController, 'refresh'])
    ->post('/api/auth/logout', [$authController, 'logout'])

    ->post('/api/auth/2fa/verify', [$auth2FAController, 'verify'])

    ->post('/api/reservations', [$reservationController, 'create']);
// =======================================


================================================
FILE: Backend/src/seed.php
================================================
<?php
require __DIR__ . '/bootstrap.php';

$pdo = pdo();

echo "Seeding database...\n";

// 1. Create Owner
$stmt = $pdo->prepare('SELECT id FROM users WHERE email = ?');
$stmt->execute(['owner@example.com']);
$owner = $stmt->fetch();

if (!$owner) {
    $stmt = $pdo->prepare("INSERT INTO users (email, password_hash, firstname, lastname, role, api_token) VALUES (?, ?, ?, ?, ?, ?)");
    $hash = password_hash('password123', PASSWORD_DEFAULT);
    $token = bin2hex(random_bytes(32));
    $stmt->execute(['owner@example.com', $hash, 'Owner', 'Demo', 'owner', $token]);
    $ownerId = $pdo->lastInsertId();
    echo "Created owner (id: $ownerId)\n";
} else {
    $ownerId = $owner['id'];
    echo "Owner exists (id: $ownerId)\n";
}

// 2. Insert Parkings
$parkings = [
    ['Parking OpÃ©ra Premium', '15 Rue Scribe, 75009 Paris', 'Paris', 48.8706, 2.3319, 150, 3.50, 25.00, 280.00, '00:00:00', '23:59:59', 4.8],
    ['Station ChÃ¢telet', '1 Place du ChÃ¢telet, 75001 Paris', 'Paris', 48.8584, 2.3470, 200, 4.00, 30.00, 320.00, '00:00:00', '23:59:59', 4.9],
    ['Parking Gare du Nord', '18 Rue de Dunkerque, 75010 Paris', 'Paris', 48.8809, 2.3553, 300, 3.00, 22.00, 250.00, '00:00:00', '23:59:59', 4.6],
    ['Park Saint-Lazare', '108 Rue Saint-Lazare, 75008 Paris', 'Paris', 48.8756, 2.3262, 120, 4.50, 35.00, 350.00, '06:00:00', '22:00:00', 4.7],
    ['Parking Bastille Central', '120 Rue de Lyon, 75012 Paris', 'Paris', 48.8522, 2.3697, 180, 3.20, 24.00, 270.00, '00:00:00', '23:59:59', 4.5],
    ['Lyon Part-Dieu Premium', '21 Boulevard Vivier Merle, 69003 Lyon', 'Lyon', 45.7606, 4.8564, 250, 2.80, 20.00, 220.00, '00:00:00', '23:59:59', 4.9],
    ['Station Bellecour', '12 Place Bellecour, 69002 Lyon', 'Lyon', 45.7578, 4.8320, 180, 3.50, 26.00, 280.00, '00:00:00', '23:59:59', 4.7],
    ['Parking Vieux-Port', '46 Quai du Port, 13002 Marseille', 'Marseille', 43.2965, 5.3698, 220, 3.00, 22.00, 240.00, '00:00:00', '23:59:59', 4.6]
];

$stmtCheck = $pdo->prepare('SELECT id FROM parkings WHERE nom = ?');
$stmtInsert = $pdo->prepare("INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

foreach ($parkings as $p) {
    $stmtCheck->execute([$p[0]]);
    if (!$stmtCheck->fetch()) {
        $stmtInsert->execute(array_merge([$ownerId], $p));
        echo "Inserted parking: {$p[0]}\n";
        $pId = $pdo->lastInsertId();

        // Add services and vehicles
        $services = ['Couvert', 'SÃ©curisÃ©', 'VidÃ©o-surveillance', 'Bornes Ã©lectriques', 'AccÃ¨s handicapÃ©'];
        $vehicles = ['Voiture', 'Moto', 'VÃ©lo', 'Utilitaire'];
        
        // Randomly assign services and vehicles
        $myServices = array_rand(array_flip($services), rand(2, 5));
        if (!is_array($myServices)) $myServices = [$myServices];
        
        $stmtSvc = $pdo->prepare("INSERT INTO parking_services (parking_id, service) VALUES (?, ?)");
        foreach ($myServices as $svc) {
            $stmtSvc->execute([$pId, $svc]);
        }

        $myVehicles = array_rand(array_flip($vehicles), rand(1, 3));
        if (!is_array($myVehicles)) $myVehicles = [$myVehicles];

        $stmtVeh = $pdo->prepare("INSERT INTO parking_type_vehicules (parking_id, type_vehicule) VALUES (?, ?)");
        foreach ($myVehicles as $veh) {
            $stmtVeh->execute([$pId, $veh]);
        }
    }
}

echo "Seeding complete.\n";



================================================
FILE: Backend/src/Application/UseCase/ReservationManagement.php
================================================
<?php
declare(strict_types=1);

namespace App\Application\UseCase;

use App\Domain\Repository\ParkingReservationRepository;
use App\Domain\Entity\parking;
use Exception;

/**
 * La classe ReservationManagement regroupe les Cas d'Utilisation (Use Cases) liÃ©s Ã  la rÃ©servation.
 * Elle sert de point d'entrÃ©e pour la logique d'application depuis le ContrÃ´leur.
 */
class ReservationManagement
{

    public function __construct(
        private ParkingReservationRepository $parkingRepository
    ) {
    }

    /**
     * Cas d'utilisation: RÃ©server une place de parking.
     * C'est ici que la logique mÃ©tier rÃ©side (vÃ©rification des rÃ¨gles).
     * @param int $placeId L'identifiant de la place Ã  rÃ©server.
     * @param int $userId L'identifiant de l'utilisateur.
     * @throws Exception Si la place est dÃ©jÃ  serve.
     */
    public function reserverPlace(int $placeId, int $userId): void
    {

    }

}


================================================
FILE: Backend/src/Controller/Auth2FAController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Auth\VerifyTwoFactor;

final class Auth2FAController
{
    public function __construct(
        private VerifyTwoFactor $verifyTwoFactor,
        private JwtManager $jwt,
    ) {}

    public function verify(): void
    {
        $data = json_decode(file_get_contents('php://input'), true) ?? [];
        $code = (string)($data['code'] ?? '');

        // On lit le token "pending 2FA" (P2_AUTH)
        $p2 = $this->jwt->readPending2FA();
        if (!$p2 || ($p2['typ'] ?? '') !== 'p2') {
            Response::json(['error' => 'Missing 2FA session'], 401);
            return;
        }

        $userId = (int)($p2['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['error' => 'Invalid 2FA context'], 401);
            return;
        }

        try {
            // Use case = logique mÃ©tier
            $tokens = $this->verifyTwoFactor->execute($userId, $code);
        } catch (\Throwable) {
            Response::json(['error' => 'Invalid 2FA'], 401);
            return;
        }

        // Pose les cookies ACCESS / REFRESH
        $this->jwt->setAccessCookie($tokens['access_token']);
        $this->jwt->setRefreshCookie($tokens['refresh_token']);

        // On dÃ©truit le cookie P2_AUTH
        $this->jwt->setPending2FACookie(''); // ou setcookie('P2_AUTH', '', time()-3600, '/');

        Response::json(['ok' => true]);
    }

    public function resend(): void
    {
        // Ã  implÃ©menter si tu veux renvoyer un code, pour lâ€™instant juste OK
        Response::json(['ok' => true]);
    }
}



================================================
FILE: Backend/src/Controller/AuthController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\Auth\LoginUser;
use App\UseCase\Auth\RefreshToken;
use App\UseCase\Auth\RegisterUser;
use App\UseCase\Auth\StartTwoFactor;

final class AuthController
{
    public function __construct(
        private LoginUser $loginUser,
        private RefreshToken $refreshToken,
        private RegisterUser $registerUser,
        private StartTwoFactor $startTwoFactor,
        private JwtManager $jwt,
    ) {
    }

    /** POST /api/auth/login */
    public function login(): void
    {
        $data = json_decode(file_get_contents('php://input'), true) ?? [];
        $email = (string) ($data['email'] ?? '');
        $password = (string) ($data['password'] ?? '');

        try {
            $result = $this->loginUser->execute($email, $password);

            if (!$result['success']) {
                Response::json(['error' => 'Invalid credentials'], 401);
                return;
            }

            // Si 2FA requise : pas de JWT dÃ©finitifs, juste un pending token
            if (!empty($result['two_factor_required']) && $result['two_factor_required'] === true) {
                $userId = $result['user_id'];

                $p2 = $this->jwt->issuePending2FAToken($userId);
                $this->jwt->setPending2FACookie($p2);

                $this->startTwoFactor->execute($userId);

                Response::json(['status' => '2fa_required']);
                return;
            }

            // Pas de 2FA â†’ on gÃ©nÃ¨re les vrais tokens
            $userId = $result['user_id'];
            $role = $result['role'];

            [$access, $refresh] = $this->jwt->issueFor($userId, $role);
            $this->jwt->setAccessCookie($access);
            $this->jwt->setRefreshCookie($refresh);

            Response::json(['ok' => true]);
        } catch (\Throwable) {
            Response::json(['error' => 'Invalid credentials'], 401);
        }
    }

    /** POST /api/auth/register */
    public function register(): void
{
    $data = json_decode(file_get_contents('php://input'), true) ?? [];

    $email = $data['email'] ?? '';
    $password = $data['password'] ?? '';
    $role = $data['role'] ?? 'USER';
    $firstname = $data['firstname'] ?? null;
    $lastname = $data['lastname'] ?? null;

    try {
        $user = $this->registerUser->execute(
            $email,
            $password,
            strtoupper($role),
            $firstname,
            $lastname
        );

        // Login automatique
        [$access, $refresh] = $this->jwt->issueFor($user['id'], $user['role']);
        $this->jwt->setAccessCookie($access);
        $this->jwt->setRefreshCookie($refresh);

        Response::json([
            'success' => true,
            'user' => $user,
        ], 201);

    } catch (\RuntimeException $e) {
        Response::json(['error' => $e->getMessage()], 409);
    } catch (\Throwable $e) {
        Response::json(['error' => 'Error registering user'], 400);
    }
}

    /** POST /api/auth/refresh */
    public function refresh(): void
    {
        $result = $this->refreshToken->execute();

        if (!$result) {
            Response::json(['error' => 'Invalid refresh'], 401);
            return;
        }

        $this->jwt->setAccessCookie($result['access']);
        Response::json(['ok' => true]);
    }

    /** POST /api/auth/logout */
    public function logout(): void
    {
        $this->jwt->clearAuthCookies();
        Response::json(['ok' => true]);
    }
}



================================================
FILE: Backend/src/Controller/MeController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\Domain\Repository\UserRepository;

final class MeController
{
    public function __construct(
        private JwtManager $jwt,
        private UserRepository $users,
    ) {}

    /** GET /api/me */
    public function me(): void
    {
        // On lit le JWT d'accÃ¨s depuis le cookie ACCESS_TOKEN
        $payload = $this->jwt->readAccessFromCookie();

        if (!$payload || ($payload['typ'] ?? '') !== 'access') {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $user = $this->users->findById($userId);
        if (!$user) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        Response::json([
            'id'    => $user->id(),
            'email' => $user->email(),
            'role'  => $user->role(),
            'firstname' => $user->firstname(),
            'lastname' => $user->lastname(),
        ]);
    }
}



================================================
FILE: Backend/src/Controller/ParkingController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\UseCase\Parking\SearchParkings;
use App\UseCase\Parking\CheckAvailability;
use App\UseCase\Parking\GetParkingDetails;
use App\UseCase\Parking\GetOwnerParkings;
use App\UseCase\Parking\CreateParking;
use App\UseCase\Parking\GetOwnerStatistics;
use Exception;

class ParkingController {
    
    // Note: Plus besoin d'injecter les repos ici car les UseCases s'en occupent

    public function list(array $params): array {
        $useCase = new SearchParkings();
        $result = $useCase->execute($params);

        return [
            'status' => 200,
            'data' => [
                'success' => true,
                'parkings' => $result['parkings'],
                'total' => $result['total']
            ]
        ];
    }

    public function detail(int $id): array {
        try {
            $useCase = new GetParkingDetails();
            $parking = $useCase->execute($id);

            return ['status' => 200, 'data' => ['success' => true, 'parking' => $parking]];
        } catch (Exception $e) {
            $code = $e->getCode() ?: 404;
            return ['status' => $code, 'data' => ['success' => false, 'error' => $e->getMessage()]];
        }
    }

    public function checkAvailability(array $data): array {
        try {
            $useCase = new CheckAvailability();
            $result = $useCase->execute($data);

            return [
                'status' => 200,
                'data' => array_merge(['success' => true], $result)
            ];
        } catch (Exception $e) {
            $code = $e->getCode() ?: 400;
            if ($code < 100 || $code > 599) $code = 400;

            return [
                'status' => $code,
                'data' => ['success' => false, 'error' => $e->getMessage()]
            ];
        }
    }

    public function listByOwner(?array $user): array {
        if (!$user) return ['status' => 401, 'data' => ['success' => false, 'error' => 'Non autorisÃ©']];

        try {
            $useCase = new GetOwnerParkings();
            $result = $useCase->execute($user);
            
            return [
                'status' => 200,
                'data' => array_merge(['success' => true], $result)
            ];
        } catch (Exception $e) {
            $code = $e->getCode() ?: 401;
            if ($code < 100 || $code > 599) $code = 401;
            
            return ['status' => $code, 'data' => ['success' => false, 'error' => $e->getMessage()]];
        }
    }

    public function create(?array $user, array $data): array {
        if (!$user) return ['status' => 401, 'data' => ['success' => false, 'error' => 'Non autorisÃ©']];

        try {
            $useCase = new CreateParking();
            $result = $useCase->execute($user, $data);
            
            return [
                'status' => 201,
                'data' => array_merge(['success' => true], $result)
            ];
        } catch (Exception $e) {
            $code = $e->getCode() ?: 400;
            if ($code < 100 || $code > 599) $code = 400;
            
            return ['status' => $code, 'data' => ['success' => false, 'error' => $e->getMessage()]];
        }
    }

    public function getStatistics(?array $user): array {
        if (!$user) return ['status' => 401, 'data' => ['success' => false, 'error' => 'Non autorisÃ©']];

        try {
            $useCase = new GetOwnerStatistics();
            $result = $useCase->execute($user);
            
            return [
                'status' => 200,
                'data' => array_merge(['success' => true], $result)
            ];
        } catch (Exception $e) {
            $code = $e->getCode() ?: 401;
            if ($code < 100 || $code > 599) $code = 401;
            
            return ['status' => $code, 'data' => ['success' => false, 'error' => $e->getMessage()]];
        }
    }
}



================================================
FILE: Backend/src/Controller/ReservationController.php
================================================
<?php
declare(strict_types=1);

namespace App\Controller;

use App\Domain\Repository\ReservationRepository;
use App\Infrastructure\Http\IsGranted;
use App\Infrastructure\Http\Response;
use App\Infrastructure\Security\JwtManager;
use App\UseCase\CreateReservation;

final class ReservationController
{
    public JwtManager $jwt;

    public function __construct(
        private CreateReservation $createReservation,
        private ReservationRepository $reservationRepository,
        JwtManager $jwt
    ) {
        $this->jwt = $jwt;
    }

    #[IsGranted('USER')]
    public function create(): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload || ($payload['typ'] ?? '') !== 'access') {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $data = json_decode(file_get_contents('php://input'), true) ?? [];

        $parkingId = (int)($data['parking_id'] ?? 0);
        $startAt = (string)($data['start_at'] ?? '');
        $endAt = (string)($data['end_at'] ?? '');
        $vehicleType = (string)($data['vehicle_type'] ?? '');
        $amount = (float)($data['amount'] ?? -1);

        if ($parkingId <= 0 || $startAt === '' || $endAt === '' || $vehicleType === '' || $amount < 0) {
            Response::json(['error' => 'Missing fields'], 400);
            return;
        }

        try {
            $res = $this->createReservation->execute(
                $userId,
                $parkingId,
                $startAt,
                $endAt,
                $vehicleType,
                $amount
            );

            Response::json([
                'id' => $res->id(),
                'user_id' => $res->userId(),
                'parking_id' => $res->parkingId(),
                'start_at' => $res->startAt()->format(DATE_ATOM),
                'end_at' => $res->endAt()->format(DATE_ATOM),
                'vehicle_type' => $res->vehicleType(),
                'amount' => $res->amount(),
                'created_at' => $res->createdAt()->format(DATE_ATOM),
            ], 201);
        } catch (\Throwable $e) {
            Response::json(['error' => $e->getMessage()], 400);
        }
    }

    #[IsGranted('USER')]
    public function myReservations(): void
    {
        $payload = $this->jwt->readAccessFromCookie();
        if (!$payload || ($payload['typ'] ?? '') !== 'access') {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        $userId = (int)($payload['sub'] ?? 0);
        if ($userId <= 0) {
            Response::json(['error' => 'Unauthorized'], 401);
            return;
        }

        try {
            $rows = $this->reservationRepository->findByUserId($userId);

            Response::json([
                'data' => array_map(static fn($r) => [
                    'id' => $r->id(),
                    'user_id' => $r->userId(),
                    'parking_id' => $r->parkingId(),
                    'start_at' => $r->startAt()->format(DATE_ATOM),
                    'end_at' => $r->endAt()->format(DATE_ATOM),
                    'vehicle_type' => $r->vehicleType(),
                    'amount' => $r->amount(),
                    'created_at' => $r->createdAt()->format(DATE_ATOM),
                ], $rows)
            ], 200);
        } catch (\Throwable $e) {
            Response::json(['error' => $e->getMessage()], 400);
        }
    }
}



================================================
FILE: Backend/src/Domain/Entity/parking.php
================================================
<?php

namespace App\Domain\Entity;

use DateTimeImmutable;

final class Parking
{
    private int $id;
    private int $nbPlaces;

    private string $gps; // OK en mode â€œrapideâ€ (ex: "48.8566,2.3522")
    private float $tarif;
    private DateTimeImmutable $heureDebut;
    private DateTimeImmutable $heureFin;

    private array $list_reservation;
    private array $list_stationnement;

    public function __construct(
        int $id,
        int $nbPlaces,
        string $gps,
        float $tarif,
        DateTimeImmutable $heureDebut,
        DateTimeImmutable $heureFin,
        array $list_stationnement = [],
        array $list_reservation = []
    ) {
        if ($nbPlaces < 0) {
            throw new \InvalidArgumentException("nbPlaces must be >= 0");
        }

        $this->id = $id;
        $this->nbPlaces = $nbPlaces;
        $this->gps = $gps;
        $this->tarif = $tarif;
        $this->heureDebut = $heureDebut;
        $this->heureFin = $heureFin;
        $this->list_reservation = $list_reservation;
        $this->list_stationnement = $list_stationnement;
    }

    public function id(): int { return $this->id; }
    public function getNbPlaces(): int { return $this->nbPlaces; }

    public function getGps(): string { return $this->gps; }
    public function getTarif(): float { return $this->tarif; }

    public function getHeureDebut(): DateTimeImmutable { return $this->heureDebut; }
    public function getHeureFin(): DateTimeImmutable { return $this->heureFin; }

    public function getListReservation(): array { return $this->list_reservation; }
    public function getListStationnement(): array { return $this->list_stationnement; }
}



================================================
FILE: Backend/src/Domain/Entity/Reservation.php
================================================
<?php

namespace App\Domain\Entity;

final class Reservation
{
    public function __construct(
        private ?int $id,
        private int $userId,
        private int $parkingId,
        private \DateTimeImmutable $startAt,
        private \DateTimeImmutable $endAt,
        private \DateTimeImmutable $createdAt,
        private string $vehicleType,
        private float $amount,
    ) {
        if ($endAt <= $startAt) {
            throw new \InvalidArgumentException("endAt must be after startAt");
        }
        if ($this->vehicleType === '') {
            throw new \InvalidArgumentException("vehicleType is required");
        }
        if ($this->amount < 0) {
            throw new \InvalidArgumentException("amount must be >= 0");
        }
    }

    public static function create(
        int $userId,
        int $parkingId,
        \DateTimeImmutable $startAt,
        \DateTimeImmutable $endAt,
        string $vehicleType,
        float $amount
    ): self {
        return new self(
            null,
            $userId,
            $parkingId,
            $startAt,
            $endAt,
            new \DateTimeImmutable('now'),
            $vehicleType,
            $amount
        );
    }

    public function id(): ?int { return $this->id; }
    public function userId(): int { return $this->userId; }
    public function parkingId(): int { return $this->parkingId; }
    public function startAt(): \DateTimeImmutable { return $this->startAt; }
    public function endAt(): \DateTimeImmutable { return $this->endAt; }
    public function createdAt(): \DateTimeImmutable { return $this->createdAt; }
    public function vehicleType(): string { return $this->vehicleType; }
    public function amount(): float { return $this->amount; }

    public function withId(int $id): self
    {
        return new self(
            $id,
            $this->userId,
            $this->parkingId,
            $this->startAt,
            $this->endAt,
            $this->createdAt,
            $this->vehicleType,
            $this->amount
        );
    }
}



================================================
FILE: Backend/src/Domain/Entity/User.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Entity;

final class User
{
    public function __construct(
        private int $id,
        private string $email,
        private string $passwordHash,
        private string $role = 'USER',

        private ?string $firstname = null,
        private ?string $lastname = null,

        // Config 2FA
        private bool $twoFactorEnabled = true,
        // 'email' | 'sms' | 'totp'
        private string $twoFactorMethod = 'email',

        // 2FA par code (email / sms)
        private ?string $twoFactorLastCode = null,
        private ?\DateTimeImmutable $twoFactorExpiresAt = null,

        // 2FA SMS
        private ?string $twoFactorPhone = null,

        // 2FA TOTP (Google Authenticator, etc.)
        private ?string $twoFactorTotpSecret = null,
    ) {
    }

    // ====================
    // Getters de base
    // ====================

    public function id(): int
    {
        return $this->id;
    }

    public function email(): string
    {
        return $this->email;
    }

    public function passwordHash(): string
    {
        return $this->passwordHash;
    }

    public function role(): string
    {
        return $this->role;
    }

    public function firstname(): ?string
    {
        return $this->firstname;
    }
    public function lastname(): ?string
    {
        return $this->lastname;
    }
    // ====================
    // 2FA - configuration
    // ====================

    public function twoFactorEnabled(): bool
    {
        return $this->twoFactorEnabled;
    }

    public function twoFactorMethod(): string
    {
        return $this->twoFactorMethod;
    }

    public function twoFactorPhone(): ?string
    {
        return $this->twoFactorPhone;
    }

    public function twoFactorTotpSecret(): ?string
    {
        return $this->twoFactorTotpSecret;
    }

    // immuable : config complÃ¨te de la 2FA (mÃ©thode + Ã©ventuel numÃ©ro)
    public function withTwoFactorConfig(
        bool $enabled,
        string $method,
        ?string $phone = null
    ): self {
        $allowed = ['email', 'sms', 'totp'];
        if (!\in_array($method, $allowed, true)) {
            throw new \InvalidArgumentException('Invalid 2FA method');
        }

        $c = clone $this;
        $c->twoFactorEnabled = $enabled;
        $c->twoFactorMethod = $method;
        $c->twoFactorPhone = $phone;

        return $c;
    }

    // Pour TOTP uniquement
    public function withTotpSecret(string $secret): self
    {
        $c = clone $this;
        $c->twoFactorTotpSecret = $secret;
        return $c;
    }

    public function hasTotpConfigured(): bool
    {
        return $this->twoFactorTotpSecret !== null && $this->twoFactorTotpSecret !== '';
    }

    // ====================
    // 2FA - challenge code (email / sms)
    // ====================

    public function twoFactorLastCode(): ?string
    {
        return $this->twoFactorLastCode;
    }

    public function twoFactorExpiresAt(): ?\DateTimeImmutable
    {
        return $this->twoFactorExpiresAt;
    }

    public function with2FACode(string $code, \DateTimeImmutable $expires): self
    {
        $c = clone $this;
        $c->twoFactorLastCode = $code;
        $c->twoFactorExpiresAt = $expires;
        return $c;
    }

    public function clear2FA(): self
    {
        $c = clone $this;
        $c->twoFactorLastCode = null;
        $c->twoFactorExpiresAt = null;
        return $c;
    }

    public function hasValid2FACode(string $code, \DateTimeImmutable $now): bool
    {
        if ($this->twoFactorLastCode === null || $this->twoFactorExpiresAt === null) {
            return false;
        }

        if ($this->twoFactorExpiresAt < $now) {
            return false;
        }

        return hash_equals($this->twoFactorLastCode, $code);
    }
}



================================================
FILE: Backend/src/Domain/Repository/ParkingRepository.php
================================================
<?php

namespace App\Domain\Repository;

use App\Domain\Entity\Parking;

interface ParkingRepository
{
    public function findById(int $id): ?Parking;
}



================================================
FILE: Backend/src/Domain/Repository/ParkingReservationRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Repository;


use App\Domain\Entity\Parking; // Parking equivaut Ã  rÃ©servation c'est juste mal nommÃ©
use DateTimeImmutable;

/**
 * Interface dÃ©finissant les contrats pour l'accÃ¨s aux donnÃ©es des RÃ©servations.
 */
interface ParkingReservationRepository
{

    public function save(parking $reservation): void;

    public function getById(int $reservationId): ?parking;
    public function delete(parking $reservation): void;

    public function isPlaceReserved(int $placeId, DateTimeImmutable $heureDebut, DateTimeImmutable $heureFin): bool;
}


================================================
FILE: Backend/src/Domain/Repository/ReservationRepository.php
================================================
<?php

namespace App\Domain\Repository;

use App\Domain\Entity\Reservation;

interface ReservationRepository
{
    public function save(Reservation $reservation): Reservation;

    /** @return Reservation[] */
    public function findByUserId(int $userId): array;

    /** @return Reservation[] */
    public function findByParkingId(int $parkingId): array;

    public function countOverlappingForParking(
        int $parkingId,
        \DateTimeImmutable $startAt,
        \DateTimeImmutable $endAt
    ): int;
}



================================================
FILE: Backend/src/Domain/Repository/UserRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Domain\Repository;

use App\Domain\Entity\User;

interface UserRepository
{
    public function findById(int $id): ?User;
    public function findByEmail(string $email): ?User;

    // ğŸ‘‡ on remplace save2FA par Ã§a
    public function save(User $user): void;
  public function create(
    string $email,
    string $passwordHash,
    string $role = 'USER',
    ?string $firstname = null,
    ?string $lastname = null
): User;
}



================================================
FILE: Backend/src/Infrastructure/Http/IsGranted.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Http;

use App\Infrastructure\Security\JwtManager;

#[\Attribute(\Attribute::TARGET_METHOD)]
final class IsGranted
{
    public function __construct(private string $role = 'USER') {}

    public function assert(JwtManager $jwt): void
    {
        $payload = $jwt->readAccessFromCookie();

        if (!$payload) {
            Response::json(['error' => 'Unauthorized'], 401);
            exit;
        }

        $userRole = $payload['role'] ?? 'USER';

        $ranks = [
            'USER' => 1,
            'OWNER' => 2,
            'ADMIN' => 3,
        ];

        if (($ranks[$userRole] ?? 0) < ($ranks[$this->role] ?? 99)) {
            Response::json(['error' => 'Forbidden'], 403);
            exit;
        }
    }
}



================================================
FILE: Backend/src/Infrastructure/Http/Response.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Http;

final class Response
{
    public static function json(array $data, int $status = 200): void
    {
        http_response_code($status);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($data, JSON_UNESCAPED_UNICODE);
    }
}



================================================
FILE: Backend/src/Infrastructure/Http/Router.php
================================================
<?php

declare(strict_types=1);

namespace App\Infrastructure\Http;

use ReflectionMethod;

final class Router
{
    private array $routes = [];

    public function get(string $path, $handler): self
    {
        return $this->map('GET', $path, $handler);
    }

    public function post(string $path, $handler): self
    {
        return $this->map('POST', $path, $handler);
    }

    public function map(string $method, string $path, $handler): self
    {
        $path = rtrim($path, '/');
        if ($path === '') $path = '/';

        $this->routes[$method][$path] = $handler;
        return $this;
    }

    public function dispatch(string $method, string $path)
    {
        $path = rtrim($path, '/');
        if ($path === '') $path = '/';

        $handler = $this->routes[$method][$path] ?? null;

        if (!$handler) {
            http_response_code(404);
            echo json_encode(['error' => 'Not found']);
            return;
        }

        if (is_array($handler) && is_object($handler[0])) {
            $controller = $handler[0];
            $methodName = $handler[1];

            $ref = new ReflectionMethod($controller, $methodName);
            $attributes = $ref->getAttributes(IsGranted::class);

            foreach ($attributes as $attribute) {
                $instance = $attribute->newInstance();

                if (!property_exists($controller, 'jwt')) {
                    Response::json(['error' => 'Controller missing JWT'], 500);
                    exit;
                }

                $instance->assert($controller->jwt);
            }

            return call_user_func($handler);
        }

        if (is_array($handler) && is_string($handler[0])) {
            $obj = new $handler[0]();
            return $obj->{$handler[1]}();
        }

        return call_user_func($handler);
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlParkingRepository.php
================================================
<?php

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\Parking;
use App\Domain\Repository\ParkingRepository;
use PDO;

final class SqlParkingRepository implements ParkingRepository
{
    public function __construct(private PDO $db) {}

    public function findById(int $id): ?Parking
    {
        $stmt = $this->db->prepare("
            SELECT
              id,
              latitude,
              longitude,
              capacity,
              hourly_rate,
              opening_time,
              closing_time
            FROM parkings
            WHERE id = :id
        ");
        $stmt->execute([':id' => $id]);
        $row = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$row) return null;

        $gps = $row['latitude'] . "," . $row['longitude'];

        return new Parking(
            (int)$row['id'],
            (int)$row['capacity'],
            (string)$gps,
            (float)$row['hourly_rate'],
            new \DateTimeImmutable((string)$row['opening_time']),
            new \DateTimeImmutable((string)$row['closing_time']),
            [],
            []
        );
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlReservationRepository.php
================================================
<?php

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\Reservation;
use App\Domain\Repository\ReservationRepository;
use PDO;

final class SqlReservationRepository implements ReservationRepository
{
    public function __construct(private PDO $db) {}

    public function save(Reservation $reservation): Reservation
    {
        if ($reservation->id() === null) {
            $stmt = $this->db->prepare("
                INSERT INTO reservations (user_id, parking_id, start_at, end_at, vehicle_type, amount, created_at)
                VALUES (:user_id, :parking_id, :start_at, :end_at, :vehicle_type, :amount, :created_at)
            ");

            $stmt->execute([
                ':user_id' => $reservation->userId(),
                ':parking_id' => $reservation->parkingId(),
                ':start_at' => $reservation->startAt()->format('Y-m-d H:i:s'),
                ':end_at' => $reservation->endAt()->format('Y-m-d H:i:s'),
                ':vehicle_type' => $reservation->vehicleType(),
                ':amount' => $reservation->amount(),
                ':created_at' => $reservation->createdAt()->format('Y-m-d H:i:s'),
            ]);

            return $reservation->withId((int)$this->db->lastInsertId());
        }

        // optional update later
        return $reservation;
    }

    public function findByUserId(int $userId): array
    {
        $stmt = $this->db->prepare("
            SELECT *
            FROM reservations
            WHERE user_id = :uid
            ORDER BY start_at DESC
        ");
        $stmt->execute([':uid' => $userId]);

        return array_map([$this, 'hydrate'], $stmt->fetchAll(PDO::FETCH_ASSOC));
    }

    public function findByParkingId(int $parkingId): array
    {
        $stmt = $this->db->prepare("
            SELECT *
            FROM reservations
            WHERE parking_id = :pid
            ORDER BY start_at DESC
        ");
        $stmt->execute([':pid' => $parkingId]);

        return array_map([$this, 'hydrate'], $stmt->fetchAll(PDO::FETCH_ASSOC));
    }

    public function countOverlappingForParking(int $parkingId, \DateTimeImmutable $startAt, \DateTimeImmutable $endAt): int
    {
        $stmt = $this->db->prepare("
            SELECT COUNT(*) as c
            FROM reservations
            WHERE parking_id = :pid
              AND start_at < :end_at
              AND end_at > :start_at
        ");
        $stmt->execute([
            ':pid' => $parkingId,
            ':start_at' => $startAt->format('Y-m-d H:i:s'),
            ':end_at' => $endAt->format('Y-m-d H:i:s'),
        ]);

        return (int)($stmt->fetch(PDO::FETCH_ASSOC)['c'] ?? 0);
    }

    private function hydrate(array $row): Reservation
    {
        return new Reservation(
            (int)$row['id'],
            (int)$row['user_id'],
            (int)$row['parking_id'],
            new \DateTimeImmutable($row['start_at']),
            new \DateTimeImmutable($row['end_at']),
            new \DateTimeImmutable($row['created_at']),
            (string)$row['vehicle_type'],
            (float)$row['amount']
        );
    }
}



================================================
FILE: Backend/src/Infrastructure/Persistence/SqlUserRepository.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Persistence;

use App\Domain\Entity\User;
use App\Domain\Repository\UserRepository;
use PDO;

final class SqlUserRepository implements UserRepository
{
    public function __construct(private PDO $pdo) {}

    private function hydrate(array $r): User
    {
        return new User(
            (int)$r['id'],
            (string)$r['email'],
            (string)$r['password_hash'],
            (string)$r['role'],

            $r['firstname'] ?? null,
            $r['lastname'] ?? null,

            (bool)$r['two_factor_enabled'],
            (string)$r['two_factor_method'],
            $r['two_factor_last_code'] ?? null,
            !empty($r['two_factor_expires_at']) ? new \DateTimeImmutable($r['two_factor_expires_at']) : null,
            $r['two_factor_phone'] ?? null,
            $r['two_factor_totp_secret'] ?? null,
        );
    }

    public function findById(int $id): ?User
    {
        $st = $this->pdo->prepare('SELECT * FROM users WHERE id = ?');
        $st->execute([$id]);
        $r = $st->fetch(PDO::FETCH_ASSOC);
        return $r ? $this->hydrate($r) : null;
    }

    public function findByEmail(string $email): ?User
    {
        $st = $this->pdo->prepare('SELECT * FROM users WHERE email = ?');
        $st->execute([$email]);
        $r = $st->fetch(PDO::FETCH_ASSOC);
        return $r ? $this->hydrate($r) : null;
    }

    public function create(
        string $email,
        string $passwordHash,
        string $role = 'user',
        ?string $firstname = null,
        ?string $lastname = null
    ): User {
        $st = $this->pdo->prepare(
            "INSERT INTO users (email, password_hash, role, firstname, lastname, two_factor_enabled, two_factor_method)
             VALUES (?, ?, ?, ?, ?, 0, 'email')"
        );

        $st->execute([$email, $passwordHash, $role, $firstname, $lastname]);
        $id = (int)$this->pdo->lastInsertId();

        return new User(
            $id, $email, $passwordHash, $role,
            $firstname, $lastname,
            false, 'email', null, null, null, null
        );
    }

    public function save(User $u): void
    {
        $st = $this->pdo->prepare(
            "UPDATE users SET
                email = ?,
                password_hash = ?,
                role = ?,
                firstname = ?,
                lastname = ?,
                two_factor_enabled = ?,
                two_factor_method = ?,
                two_factor_last_code = ?,
                two_factor_expires_at = ?,
                two_factor_phone = ?,
                two_factor_totp_secret = ?
             WHERE id = ?"
        );

        $exp = $u->twoFactorExpiresAt()?->format('Y-m-d H:i:s');

        $st->execute([
            $u->email(),
            $u->passwordHash(),
            $u->role(),
            $u->firstname(),
            $u->lastname(),
            $u->twoFactorEnabled() ? 1 : 0,
            $u->twoFactorMethod(),
            $u->twoFactorLastCode(),
            $exp,
            $u->twoFactorPhone(),
            $u->twoFactorTotpSecret(),
            $u->id(),
        ]);
    }
}



================================================
FILE: Backend/src/Infrastructure/Security/JwtManager.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Security;

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

final class JwtManager
{
    public function __construct(
        private string $secret,
        private int $accessTtl,
        private int $refreshTtl
    ) {
    }

    public function issueFor(int $userId, string $role): array
    {
        $now = time();
        $access = [
            'iat' => $now,
            'nbf' => $now,
            'exp' => $now + $this->accessTtl,
            'sub' => $userId,
            'role' => $role,
            'typ' => 'access'
        ];
        $refresh = [
            'iat' => $now,
            'nbf' => $now,
            'exp' => $now + $this->refreshTtl,
            'sub' => $userId,
            'typ' => 'refresh'
        ];
        return [$this->encode($access), $this->encode($refresh)];
    }

    public function encode(array $payload): string
    {
        return JWT::encode($payload, $this->secret, 'HS256');
    }

    public function decode(string $jwt): ?array
    {
        try {
            return (array) JWT::decode($jwt, new Key($this->secret, 'HS256'));
        } catch (\Throwable) {
            return null;
        }
    }

    // --- Cookies (HttpOnly)
    public function setAccessCookie(string $token): void
    {
        $this->cookie('ACCESS_TOKEN', $token, $this->accessTtl);
    }
    public function setRefreshCookie(string $token): void
    {
        $this->cookie('REFRESH_TOKEN', $token, $this->refreshTtl);
    }
    public function clearAuthCookies(): void
    {
        $this->cookie('ACCESS_TOKEN', '', -3600);
        $this->cookie('REFRESH_TOKEN', '', -3600);
        $this->cookie('P2_AUTH', '', -3600);
    }
    private function cookie(string $name, string $value, int $ttl): void
    {
        $secure = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on';
        setcookie($name, $value, [
            'expires' => time() + $ttl,
            'path' => '/',
            'secure' => $secure,
            'httponly' => true,
            'samesite' => $secure ? 'None' : 'Lax'
        ]);
    }

    // --- Helpers â€œlectureâ€
    public function readAccessFromCookie(): ?array
    {
        $raw = $_COOKIE['ACCESS_TOKEN'] ?? '';
        return $raw ? $this->decode($raw) : null;
    }
    public function readRefreshFromCookie(): ?array
    {
        $raw = $_COOKIE['REFRESH_TOKEN'] ?? '';
        return $raw ? $this->decode($raw) : null;
    }

    // --- 2FA (pending token court)
    public function issuePending2FAToken(int $userId): string
    {
        $now = time();
        $p2 = ['iat' => $now, 'nbf' => $now, 'exp' => $now + 300, 'sub' => $userId, 'typ' => 'p2'];
        return $this->encode($p2);
    }
    public function setPending2FACookie(string $token): void
    {
        $this->cookie('P2_AUTH', $token, 300);
    }
    public function readPending2FA(): ?array
    {
        $raw = $_COOKIE['P2_AUTH'] ?? '';
        return $raw ? $this->decode($raw) : null;
    }
}



================================================
FILE: Backend/src/Infrastructure/Security/PasswordHasher.php
================================================
<?php
declare(strict_types=1);

namespace App\Infrastructure\Security;

final class PasswordHasher {
  public function hash(string $plain): string {
    return password_hash($plain, PASSWORD_ARGON2ID);
  }
  public function verify(string $plain, string $hash): bool {
    return password_verify($plain, $hash);
  }
}



================================================
FILE: Backend/src/UseCase/CreateReservation.php
================================================
<?php

namespace App\UseCase;

use App\Domain\Entity\Reservation;
use App\Domain\Repository\ReservationRepository;
use App\Domain\Repository\ParkingRepository;

final class CreateReservation
{
    public function __construct(
        private ParkingRepository $parkingRepo,
        private ReservationRepository $reservationRepo,
    ) {}

    public function execute(
        int $userId,
        int $parkingId,
        string $startAt,
        string $endAt,
        string $vehicleType,
        float $amount
    ): Reservation {
        $start = new \DateTimeImmutable($startAt);
        $end = new \DateTimeImmutable($endAt);

        $parking = $this->parkingRepo->findById($parkingId);
        if ($parking === null) {
            throw new \RuntimeException("Parking not found");
        }

        $capacity = $parking->getNbPlaces(); // later rename to capacity()

        $overlapping = $this->reservationRepo->countOverlappingForParking($parkingId, $start, $end);

        if ($overlapping >= $capacity) {
            throw new \RuntimeException("Parking full for this time slot");
        }

        $reservation = Reservation::create($userId, $parkingId, $start, $end, $vehicleType, $amount);
        return $this->reservationRepo->save($reservation);
    }
}



================================================
FILE: Backend/src/UseCase/ReserverParking.php
================================================
<?php

namespace App\UseCase;

use App\Domain\Entity\parking;
use App\Domain\Repository\ParkingReservationRepository;
use DateTimeImmutable;
use InvalidArgumentException;

class ReserverParking
{
// Le Use Case dÃ©pend du CONTRAT (l'Interface Repository), pas de l'implÃ©mentation BDD concrÃ¨te.
    public function __construct(
        private ParkingReservationRepository $repository
    ) {}

    /**
     * ExÃ©cute le processus de rÃ©servation.
     * * @param string $gps La localisation GPS de l'emplacement.
     * @param float $tarif Le tarif applicable.
     * @param DateTimeImmutable $heureDebut L'heure de dÃ©but de la rÃ©servation.
     * @param DateTimeImmutable $heureFin L'heure de fin de la rÃ©servation.
     * @param int $placeId L'identifiant de la place Ã  rÃ©server (hypothÃ¨se pour la vÃ©rification).
     * @return Parking L'entitÃ© de rÃ©servation nouvellement crÃ©Ã©e.
     * @throws InvalidArgumentException Si la place est dÃ©jÃ  rÃ©servÃ©e ou si les heures sont invalides.
     */
    public function execute(
        string $gps,
        float $tarif,
        DateTimeImmutable $heureDebut,
        DateTimeImmutable $heureFin,
        int $placeId
    ): Parking {

        // --- 1. Logique mÃ©tier / Validation des donnÃ©es ---

        if ($heureDebut >= $heureFin) {
            throw new InvalidArgumentException("L'heure de fin doit Ãªtre postÃ©rieure Ã  l'heure de dÃ©but.");
        }

        if ($heureDebut < new DateTimeImmutable()) {
            throw new InvalidArgumentException("Impossible de rÃ©server dans le passÃ©.");
        }

        // --- 2. Utilisation du Repository (VÃ©rification de la disponibilitÃ©) ---

        // Le Use Case utilise la mÃ©thode dÃ©finie dans l'Interface pour vÃ©rifier si le crÃ©neau est libre.
        if ($this->repository->isPlaceReserved($placeId, $heureDebut, $heureFin)) {
            // L'exception mÃ©tier (Business Exception) est levÃ©e ici.
            throw new InvalidArgumentException(sprintf(
                "La place %d est dÃ©jÃ  rÃ©servÃ©e pour ce crÃ©neau horaire.",
                $placeId
            ));
        }
        $parkingEntity = new Parking(
            $gps,
            $tarif,
            \DateTime::createFromImmutable($heureDebut),
            \DateTime::createFromImmutable($heureFin),
            [] // list_stationnement, non gÃ©rÃ© dans ce use case
        );

        // --- 4. Persistance (Sauvegarde) ---


        $this->repository->save($parkingEntity);

        return $parkingEntity;
    }
}


================================================
FILE: Backend/src/UseCase/Auth/ConfigureTwoFactorMethod.php
================================================
class ConfigureTwoFactorMethod
{
    public function __construct(
        private UserRepository $userRepository
    ) {}

    public function execute(int $userId, string $method): array
    {
        $allowed = ['email', 'sms', 'totp'];
        if (!in_array($method, $allowed, true)) {
            throw new \InvalidArgumentException('Invalid 2FA method');
        }

        $user = $this->userRepository->findById($userId);

        if (!$user) {
            throw new \RuntimeException('User not found');
        }

        $user->enableTwoFactor($method);

        $qrData = null;

        if ($method === 'totp') {
            // GÃ©nÃ©ration dâ€™un secret TOTP (genre base32)
            $secret = $this->generateTotpSecret();
            $user->setTotpSecret($secret);

            // URI TOTP standard (pour les apps)
            $qrData = $this->buildTotpProvisioningUri($user->getEmail(), $secret);
        }

        $this->userRepository->save($user);

        return [
            'method' => $method,
            'totp_uri' => $qrData, // null si pas TOTP
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Auth/GetCurrentUser.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Infrastructure\Security\JwtManager;
use App\Domain\Repository\UserRepository;

final class GetCurrentUser {
  public function __construct(private JwtManager $jwt, private UserRepository $users) {}

  public function __invoke(): ?array {
    $p = $this->jwt->readAccessFromCookie();
    if (!$p || ($p['typ'] ?? '') !== 'access') return null;
    $u = $this->users->findById((int)$p['sub']);
    if (!$u) return null;
    return ['id'=>$u->id(), 'email'=>$u->email(), 'role'=>$u->role()];
  }
}



================================================
FILE: Backend/src/UseCase/Auth/LoginUser.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\PasswordHasher;

final class LoginUser
{
    public function __construct(
        private UserRepository $users,
        private PasswordHasher $hasher,
    ) {}

    public function execute(string $email, string $password): array
    {
        $u = $this->users->findByEmail($email);

        if (!$u || !$this->hasher->verify($password, $u->passwordHash())) {
            return ['success' => false];
        }

        if ($u->twoFactorEnabled()) {
            return [
                'success'             => true,
                'two_factor_required' => true,
                'user_id'             => $u->id(),
                'role'                => $u->role(),
            ];
        }

        return [
            'success'             => true,
            'two_factor_required' => false,
            'user_id'             => $u->id(),
            'role'                => $u->role(),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Auth/Mailer.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

interface Mailer
{
    public function sendTwoFactorCodeEmail(string $to, string $code): void;
}



================================================
FILE: Backend/src/UseCase/Auth/RefreshToken.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Infrastructure\Security\JwtManager;
use App\Domain\Repository\UserRepository;

final class RefreshToken
{
  public function execute(): ?array
  {
    return $this->__invoke();
  }

  public function __construct(private JwtManager $jwt, private UserRepository $users)
  {
  }

  /** @return array{access:string}|null */
  public function __invoke(): ?array
  {
    $refresh = $this->jwt->readRefreshFromCookie();
    if (!$refresh || ($refresh['typ'] ?? '') !== 'refresh') {
      return null;
    }
    $u = $this->users->findById((int) $refresh['sub']);
    if (!$u) {
      return null;
    }
    [$access,] = $this->jwt->issueFor($u->id(), $u->role());
    return ['access' => $access];
  }
}



================================================
FILE: Backend/src/UseCase/Auth/RegisterUser.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\PasswordHasher;

final class RegisterUser
{
    public function __construct(
        private UserRepository $repo,
        private PasswordHasher $hasher
    ) {}

    public function execute(
        string $email,
        string $password,
        string $role= 'USER',
        ?string $firstname,
        ?string $lastname
    ): array {
        if ($this->repo->findByEmail($email)) {
            throw new \RuntimeException("Email already in use");
        }

        $hash = $this->hasher->hash($password);

        $user = $this->repo->create(
            $email,
            $hash,
            $role,
            $firstname,
            $lastname
        );

        return [
            'id' => $user->id(),
            'email' => $user->email(),
            'firstname' => $user->firstname(),
            'lastname' => $user->lastname(),
            'role' => $user->role(),
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Auth/SmsSender.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

interface SmsSender
{
    public function sendTwoFactorSms(string $phone, string $code): void;
}



================================================
FILE: Backend/src/UseCase/Auth/StartTwoFactor.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;

final class StartTwoFactor
{
    public function __construct(
        private UserRepository $userRepository,
        private Mailer $mailer,
        private SmsSender $smsSender
    ) {}

    public function execute(int $userId): void
    {
        $user = $this->userRepository->findById($userId);

        if (!$user) {
            throw new \RuntimeException('User not found');
        }

        $method = $user->twoFactorMethod();

        // TOTP : pas de code Ã  gÃ©nÃ©rer, lâ€™app TOTP a dÃ©jÃ  le secret
        if ($method === 'totp') {
            return;
        }

        $code = str_pad((string) random_int(0, 999999), 6, '0', STR_PAD_LEFT);
        $expiresAt = (new \DateTimeImmutable())->modify('+5 minutes');

        // User est immuable -> on rÃ©cupÃ¨re la nouvelle instance
        $user = $user->with2FACode($code, $expiresAt);
        $this->userRepository->save($user);

        if ($method === 'email') {
            $this->mailer->sendTwoFactorCodeEmail($user->email(), $code);
        } elseif ($method === 'sms') {
            $phone = $user->twoFactorPhone();
            if ($phone === null) {
                throw new \RuntimeException('User has no phone number for SMS 2FA');
            }
            $this->smsSender->sendTwoFactorSms($phone, $code);
        } else {
            throw new \RuntimeException('Unknown 2FA method: '.$method);
        }
    }
}



================================================
FILE: Backend/src/UseCase/Auth/TotpVerifier.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

interface TotpVerifier
{
    public function verify(string $secret, string $code): bool;
}



================================================
FILE: Backend/src/UseCase/Auth/VerifyTwoFactor.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Auth;

use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\JwtManager;

final class VerifyTwoFactor
{
  public function __construct(
    private UserRepository $userRepository,
    private JwtManager $jwtManager,
    private TotpVerifier $totpVerifier
  ) {
  }

  public function execute(int $userId, string $code): array
  {
    $user = $this->userRepository->findById($userId);

    if (!$user) {
      throw new \RuntimeException('User not found');
    }

    $method = $user->twoFactorMethod();
    $now = new \DateTimeImmutable();

    $valid = false;

    if ($method === 'email' || $method === 'sms') {
      // helper du domaine
      $valid = $user->hasValid2FACode($code, $now);
    } elseif ($method === 'totp') {
      if (!$user->hasTotpConfigured()) {
        throw new \RuntimeException('TOTP not configured');
      }

      $secret = $user->twoFactorTotpSecret();
      if ($secret === null) {
        throw new \RuntimeException('Missing TOTP secret');
      }

      $valid = $this->totpVerifier->verify($secret, $code);
    } else {
      throw new \RuntimeException('Unknown 2FA method: ' . $method);
    }

    if (!$valid) {
      throw new \RuntimeException('Invalid 2FA code');
    }

    // Nettoyer le challenge pour email/sms
    if ($method === 'email' || $method === 'sms') {
      $user = $user->clear2FA();
      $this->userRepository->save($user);
    }

    // GÃ©nÃ©ration des JWT
    [$accessToken, $refreshToken] = $this->jwtManager->issueFor(
      $user->id(),
      $user->role()
    );

    return [
      'access_token' => $accessToken,
      'refresh_token' => $refreshToken,
    ];
  }
}



================================================
FILE: Backend/src/UseCase/Parking/CheckAvailability.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ParkingRepository;
use App\Infrastructure\Repository\ReservationRepository;
use Exception;

class CheckAvailability {
    private ParkingRepository $parkingRepo;
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $data): array {
        $parkingId = $data['parkingId'] ?? 0;
        $dateDebut = $data['dateDebut'] ?? '';
        $dateFin = $data['dateFin'] ?? '';

        if (!$parkingId || !$dateDebut || !$dateFin) {
            throw new Exception('DonnÃ©es incomplÃ¨tes', 400);
        }

        $parking = $this->parkingRepo->findById((int)$parkingId);
        if (!$parking) {
            throw new Exception('Parking non trouvÃ©', 404);
        }

        $reserved = $this->reservationRepo->countConfirmed((int)$parkingId, $dateDebut, $dateFin);
        $available = max(0, $parking['nombre_places'] - $reserved);

        return [
            'available' => $available > 0,
            'places_disponibles' => $available,
            'parking' => $parking
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/CreateParking.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ParkingRepository;
use Exception;

class CreateParking {
    private ParkingRepository $parkingRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
    }

    public function execute(array $user, array $data): array {
        if ($user['role'] !== 'owner') {
            throw new Exception('Non autorisÃ©', 401);
        }

        if (empty($data['nom']) || empty($data['adresse']) || empty($data['nombre_places'])) {
            throw new Exception('DonnÃ©es incomplÃ¨tes', 400);
        }

        $id = $this->parkingRepo->create((int)$user['id'], $data);
        $parking = $this->parkingRepo->findById($id);

        return ['parking' => $parking];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/GetOwnerParkings.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ParkingRepository;
use Exception;

class GetOwnerParkings {
    private ParkingRepository $parkingRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
    }

    public function execute(array $user): array {
        if ($user['role'] !== 'owner') {
            throw new Exception('Non autorisÃ©', 401);
        }

        $parkings = $this->parkingRepo->findByOwner((int)$user['id']);
        return ['parkings' => $parkings];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/GetOwnerStatistics.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ReservationRepository;
use Exception;

class GetOwnerStatistics {
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $user): array {
        if ($user['role'] !== 'owner') {
            throw new Exception('Non autorisÃ©', 401);
        }

        $revenue = $this->reservationRepo->getMonthlyRevenue((int)$user['id']);
        $activeReservations = $this->reservationRepo->countActiveByOwner((int)$user['id']);
        $activeStationnements = $this->reservationRepo->countActiveStationnementsByOwner((int)$user['id']);

        return [
            'revenus_mensuels' => $revenue,
            'reservations_en_cours' => $activeReservations,
            'stationnements_actifs' => $activeStationnements
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Parking/GetParkingDetails.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ParkingRepository;
use Exception;

class GetParkingDetails {
    private ParkingRepository $parkingRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
    }

    public function execute(int $id): array {
        $parking = $this->parkingRepo->findById($id);
        
        if (!$parking) {
            throw new Exception('Parking non trouvÃ©', 404);
        }

        return $parking;
    }
}



================================================
FILE: Backend/src/UseCase/Parking/SearchParkings.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Parking;

use App\Infrastructure\Repository\ParkingRepository;
use App\Infrastructure\Repository\ReservationRepository;

class SearchParkings {
    private ParkingRepository $parkingRepo;
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->parkingRepo = new ParkingRepository();
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $params): array {
        $filters = [
            'ville' => $params['ville'] ?? '',
            'vehicule' => $params['vehicule'] ?? ''
        ];
        $sort = $params['sort'] ?? null;
        $dateDebut = $params['dateDebut'] ?? null;
        $dateFin = $params['dateFin'] ?? null;

        $parkings = $this->parkingRepo->findAll($filters, $sort);

        // Si on a des dates, on calcule la dispo rÃ©elle
        if ($dateDebut && $dateFin) {
            foreach ($parkings as &$parking) {
                $reserved = $this->reservationRepo->countConfirmed((int)$parking['id'], $dateDebut, $dateFin);
                $parking['places_disponibles'] = max(0, $parking['nombre_places'] - $reserved);
            }
        } else {
            // Sinon on affiche le total
            foreach ($parkings as &$parking) {
                $parking['places_disponibles'] = $parking['nombre_places'];
            }
        }

        return [
            'parkings' => $parkings,
            'total' => count($parkings)
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/CancelReservation.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Infrastructure\Repository\ReservationRepository;
use Exception;

class CancelReservation {
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(int $id, array $user): array {
        $reservation = $this->reservationRepo->findByIdAndUser($id, (int)$user['id']);
        
        if (!$reservation) {
            throw new Exception('RÃ©servation non trouvÃ©e', 404);
        }

        $this->reservationRepo->cancel($id);
        
        return ['message' => 'RÃ©servation annulÃ©e'];
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/CreateReservation.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Infrastructure\Repository\ReservationRepository;
use App\Infrastructure\Repository\ParkingRepository;
use DateTime;
use Exception;

class CreateReservation {
    private ReservationRepository $reservationRepo;
    private ParkingRepository $parkingRepo;

    public function __construct() {
        $this->reservationRepo = new ReservationRepository();
        $this->parkingRepo = new ParkingRepository();
    }

    public function execute(array $data, array $user): array {
        $parkingId = $data['parkingId'] ?? 0;
        $dateDebut = $data['date_debut'] ?? '';
        $dateFin = $data['date_fin'] ?? '';
        $vehicule = $data['vehicule'] ?? '';
        $immatriculation = $data['immatriculation'] ?? '';
        $montant = $data['montant'] ?? 0;

        // Validations
        if (empty($dateDebut) || empty($dateFin)) {
            throw new Exception('Dates manquantes', 400);
        }

        $now = new DateTime();
        $start = new DateTime($dateDebut);
        $end = new DateTime($dateFin);

        if ($end <= $start) {
            throw new Exception('La date de fin doit Ãªtre aprÃ¨s la date de dÃ©but', 400);
        }
        
        if ($start < $now) {
             // On tolÃ¨re une petite marge ou on bloque ? Pour l'instant on bloque si c'est vraiment dans le passÃ©
             // throw new Exception('La date de dÃ©but ne peut pas Ãªtre dans le passÃ©', 400);
        }

        if ($this->reservationRepo->hasOverlapForUser((int)$user['id'], $dateDebut, $dateFin)) {
            throw new Exception('Vous avez dÃ©jÃ  une rÃ©servation sur cette pÃ©riode', 409);
        }

        $parking = $this->parkingRepo->findById((int)$parkingId);
        if (!$parking) {
            throw new Exception('Parking non trouvÃ©', 404);
        }

        $reserved = $this->reservationRepo->countConfirmed((int)$parkingId, $dateDebut, $dateFin);

        if (($parking['nombre_places'] - $reserved) <= 0) {
            throw new Exception('Plus de places disponibles pour cette pÃ©riode', 409);
        }

        // CrÃ©ation
        $id = $this->reservationRepo->create(
            (int)$user['id'], 
            (int)$parkingId, 
            $dateDebut, 
            $dateFin, 
            $vehicule, 
            $immatriculation, 
            (float)$montant
        );

        return [
            'success' => true, 
            'message' => 'RÃ©servation confirmÃ©e',
            'reservation' => [
                'id' => $id,
                'montant' => $montant,
                'date_debut' => $dateDebut,
                'date_fin' => $dateFin,
                'parking_id' => $parkingId
            ]
        ];
    }
}



================================================
FILE: Backend/src/UseCase/Reservation/GetUserReservations.php
================================================
<?php
declare(strict_types=1);

namespace App\UseCase\Reservation;

use App\Infrastructure\Repository\ReservationRepository;

class GetUserReservations {
    private ReservationRepository $reservationRepo;

    public function __construct() {
        $this->reservationRepo = new ReservationRepository();
    }

    public function execute(array $user): array {
        $reservations = $this->reservationRepo->findByUser((int)$user['id']);
        return ['reservations' => $reservations];
    }
}



================================================
FILE: Backend/tests/Domain/JwtManagerTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\Domain;

use App\Infrastructure\Security\JwtManager;
use PHPUnit\Framework\TestCase;

final class JwtManagerTest extends TestCase
{
    private JwtManager $jwt;

    protected function setUp(): void
    {

        $this->jwt = new JwtManager('test-secret-key', 3600, 7200);
    }

    public function testIssueForReturnsTwoValidTokens(): void
    {
        [$access, $refresh] = $this->jwt->issueFor(42, 'USER');


        $this->assertIsString($access);
        $this->assertIsString($refresh);
        $this->assertNotSame($access, $refresh);


        $accessPayload  = $this->jwt->decode($access);
        $refreshPayload = $this->jwt->decode($refresh);

        $this->assertNotNull($accessPayload);
        $this->assertNotNull($refreshPayload);

        // Access token : bon sub / role / typ
        $this->assertSame(42, $accessPayload['sub'] ?? null);
        $this->assertSame('USER', $accessPayload['role'] ?? null);
        $this->assertSame('access', $accessPayload['typ'] ?? null);

        // Refresh token : bon sub / typ
        $this->assertSame(42, $refreshPayload['sub'] ?? null);
        $this->assertSame('refresh', $refreshPayload['typ'] ?? null);

        // Les deux ont un exp
        $this->assertArrayHasKey('exp', $accessPayload);
        $this->assertArrayHasKey('exp', $refreshPayload);
    }

    public function testDecodeReturnsNullForInvalidToken(): void
    {
        $result = $this->jwt->decode('ceci-n-est-pas-un-jwt');
        $this->assertNull($result);
    }

    public function testIssuePending2FATokenHasTypeP2(): void
    {
        $token   = $this->jwt->issuePending2FAToken(99);
        $payload = $this->jwt->decode($token);

        $this->assertNotNull($payload);
        $this->assertSame(99, $payload['sub'] ?? null);
        $this->assertSame('p2', $payload['typ'] ?? null);
    }
}



================================================
FILE: Backend/tests/Infrastructure/Security/PasswordHasherTest.php
================================================
<?php

declare(strict_types=1);

namespace Tests\Infrastructure\Security;

use App\Infrastructure\Security\PasswordHasher;
use PHPUnit\Framework\TestCase;

final class PasswordHasherTest extends TestCase
{
    public function testHashIsNotPlainPassword(): void
    {
        $hasher = new PasswordHasher();
        $plain  = 'MySecurePassword123!';
        $hash   = $hasher->hash($plain);

        $this->assertIsString($hash);
        $this->assertNotSame($plain, $hash, 'Le hash ne doit pas Ãªtre le mot de passe en clair');
        $this->assertGreaterThan(20, strlen($hash), 'Le hash doit Ãªtre suffisamment long');
    }

    public function testVerifyReturnsTrueWithCorrectPassword(): void
    {
        $hasher = new PasswordHasher();
        $plain  = 'Secret123!';
        $hash   = $hasher->hash($plain);

        $this->assertTrue($hasher->verify($plain, $hash));
    }

    public function testVerifyReturnsFalseWithWrongPassword(): void
    {
        $hasher = new PasswordHasher();
        $hash   = $hasher->hash('correct-password');

        $this->assertFalse($hasher->verify('wrong-password', $hash));
    }
}



================================================
FILE: Backend/tests/UseCase/Auth/InMemoryUserRepository.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Auth;

use App\Domain\Entity\User;
use App\Domain\Repository\UserRepository;

final class InMemoryUserRepository implements UserRepository
{
    /** @var User[] */
    private array $users = [];
    private int $autoIncrement = 1;

    public function __construct(User ...$users)
    {
        foreach ($users as $user) {
            $this->save($user);
        }
    }

    public function create(
        string $email,
        string $passwordHash,
        string $role = 'USER',
        ?string $firstname = null,
        ?string $lastname = null
    ): User {
        $user = new User(
            $this->autoIncrement++,
            $email,
            $passwordHash,
            $role,
            $firstname,
            $lastname,
        );
        $this->save($user);
        return $user;
    }

    public function findById(int $id): ?User
    {
        return $this->users[$id] ?? null;
    }

    public function findByEmail(string $email): ?User
    {
        foreach ($this->users as $user) {
            if ($user->email() === $email) {
                return $user;
            }
        }
        return null;
    }

    public function save(User $user): void
    {
        $this->users[$user->id()] = $user;

        if ($user->id() >= $this->autoIncrement) {
            $this->autoIncrement = $user->id() + 1;
        }
    }
}



================================================
FILE: Backend/tests/UseCase/Auth/LoginUserTest.php
================================================
<?php
declare(strict_types=1);

namespace Tests\UseCase\Auth;

use App\Domain\Entity\User;
use App\Domain\Repository\UserRepository;
use App\Infrastructure\Security\PasswordHasher;
use App\UseCase\Auth\LoginUser;
use PHPUnit\Framework\TestCase;

/**
 * Petit repository en mÃ©moire uniquement pour les tests.
 */
final class InMemoryUserRepository implements UserRepository
{
    /** @var User[] */
    private array $users = [];
    private int $autoIncrement = 1;

    public function __construct(User ...$users)
    {
        foreach ($users as $user) {
            $this->save($user);
        }
    }

    public function create(string $email, string $passwordHash, string $role = 'USER',    ?string $firstname = null,
    ?string $lastname = null): User
    {
        $user = new User($this->autoIncrement++, $email, $passwordHash, $role);
        $this->save($user);
        return $user;
    }

    public function findById(int $id): ?User
    {
        return $this->users[$id] ?? null;
    }

    public function findByEmail(string $email): ?User
    {
        foreach ($this->users as $user) {
            if ($user->email() === $email) {
                return $user;
            }
        }
        return null;
    }

    public function save(User $user): void
    {
        $this->users[$user->id()] = $user;

        if ($user->id() >= $this->autoIncrement) {
            $this->autoIncrement = $user->id() + 1;
        }
    }
}

/**
 * Tests du cas dâ€™usage LoginUser.
 */
final class LoginUserTest extends TestCase
{
    private PasswordHasher $hasher;

    protected function setUp(): void
    {
        $this->hasher = new PasswordHasher();
    }

    public function testLoginSucceedsWithValidCredentialsAnd2FAEnabled(): void
    {
        $plain = 'MyStrongPassword!';
        $hash  = $this->hasher->hash($plain);

        // 2FA activÃ©e par dÃ©faut
        $user = new User(
            1,
            'user@example.com',
            $hash,
            'USER'
        );

        $repo    = new InMemoryUserRepository($user);
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('user@example.com', $plain);

        $this->assertTrue($result['success'] ?? false);
        $this->assertTrue($result['two_factor_required'] ?? false);
        $this->assertSame(1, $result['user_id'] ?? null);
        $this->assertSame('USER', $result['role'] ?? null);
    }

    public function testLoginSucceedsWithValidCredentialsAnd2FADisabled(): void
    {
        $plain = 'MyStrongPassword!';
        $hash  = $this->hasher->hash($plain);

        // On dÃ©sactive la 2FA via withTwoFactorConfig
        $user = new User(
            2,
            'no2fa@example.com',
            $hash,
            'USER'
        );
        $user = $user->withTwoFactorConfig(false, 'email');

        $repo    = new InMemoryUserRepository($user);
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('no2fa@example.com', $plain);

        $this->assertTrue($result['success'] ?? false);
        $this->assertFalse($result['two_factor_required'] ?? true);
        $this->assertSame(2, $result['user_id'] ?? null);
        $this->assertSame('USER', $result['role'] ?? null);
    }

    public function testLoginFailsWithWrongPassword(): void
    {
        $plain = 'MyStrongPassword!';
        $hash  = $this->hasher->hash($plain);

        $user = new User(
            3,
            'user@example.com',
            $hash,
            'USER'
        );

        $repo    = new InMemoryUserRepository($user);
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('user@example.com', 'wrong-password');

        $this->assertFalse($result['success'] ?? true);
        $this->assertArrayNotHasKey('user_id', $result);
        $this->assertArrayNotHasKey('role', $result);
    }

    public function testLoginFailsWithUnknownUser(): void
    {
        $repo    = new InMemoryUserRepository(); // aucun user enregistrÃ©
        $useCase = new LoginUser($repo, $this->hasher);

        $result = $useCase->execute('doesnotexist@example.com', 'whatever');

        $this->assertFalse($result['success'] ?? true);
        $this->assertArrayNotHasKey('user_id', $result);
        $this->assertArrayNotHasKey('role', $result);
    }
}



================================================
FILE: frontend/README.md
================================================
# SystÃ¨me de Parking PartagÃ© - Frontend

Application React pour la gestion de parkings partagÃ©s - Projet HETIC 2025

## Installation

```bash
npm install
npm start
```

L'application sera accessible sur http://localhost:3000

## Technologies

- React 19.2.0
- React Router DOM 6.30.1
- TailwindCSS 3.4.18
- PostCSS + Autoprefixer

## Structure

```
src/
â”œâ”€â”€ components/      # Composants rÃ©utilisables
â”œâ”€â”€ pages/           # Pages de l'application
â”œâ”€â”€ routes/          # Configuration des routes
â”œâ”€â”€ services/        # Appels API
â”œâ”€â”€ App.jsx          # Configuration Router
â””â”€â”€ index.js         # Point d'entrÃ©e
```

## Pages principales

- `/` - Accueil
- `/login` - Connexion
- `/register` - Inscription (utilisateur/propriÃ©taire)
- `/dashboard-user` - Espace utilisateur
- `/dashboard-owner` - Espace propriÃ©taire
- `/parking/:id` - DÃ©tails d'un parking

## FonctionnalitÃ©s

### Utilisateurs

- Inscription avec choix de rÃ´le
- RÃ©servation de parking
- Suivi des rÃ©servations et stationnements

### PropriÃ©taires

- Ajout et gestion de parkings
- Visualisation des statistiques (CA, rÃ©servations, stationnements)
- Modification des tarifs et horaires

## Configuration

Configuration TailwindCSS dans `tailwind.config.js` et `postcss.config.js`

Couleur principale : #34A853

## Scripts

```bash
npm start     # DÃ©veloppement
npm run build # Production
npm test      # Tests
```

## Backend

Application prÃªte Ã  Ãªtre connectÃ©e au backend PHP sur http://localhost:8001

Tous les appels API sont simulÃ©s dans `src/services/apiService.js`



================================================
FILE: frontend/AUTHENTIFICATION.md
================================================
# ğŸ” Documentation Authentification - ParkingPartagÃ©

## ğŸ“‹ Structure ComplÃ¨te de l'Utilisateur

Chaque utilisateur dans le systÃ¨me possÃ¨de les champs suivants :

### Champs de Base
| Champ | Type | Description | Obligatoire |
|-------|------|-------------|-------------|
| `id` | number | Identifiant unique | âœ… |
| `email` | string | Email de connexion | âœ… |
| `password` | string | Mot de passe (hashÃ© en production) | âœ… |
| `firstname` | string | PrÃ©nom | âœ… |
| `lastname` | string | Nom | âœ… |
| `role` | string | 'user' ou 'owner' | âœ… |

### Champs AvancÃ©s
| Champ | Type | Description | Par dÃ©faut |
|-------|------|-------------|------------|
| `reservations` | array | Liste des rÃ©servations | `[]` |
| `stationnements` | array | Liste des stationnements | `[]` |
| `typeAbonnement` | string | 'gratuit', 'premium', 'business' | `'gratuit'` |
| `debutAbonnement` | string/null | Date de dÃ©but (YYYY-MM-DD) | `null` |
| `finAbonnement` | string/null | Date de fin (YYYY-MM-DD) | `null` |

---

## ğŸ¯ Types d'Abonnements

### 1. **Gratuit** (par dÃ©faut)
- âœ… AccÃ¨s aux fonctionnalitÃ©s de base
- âœ… RÃ©servations limitÃ©es
- âŒ Pas de prioritÃ©
- âŒ Pas de rÃ©ductions

### 2. **Premium**
- âœ… RÃ©servations illimitÃ©es
- âœ… PrioritÃ© sur les places
- âœ… 20% de rÃ©duction
- âœ… Support prioritaire

### 3. **Business**
- âœ… Tout de Premium +
- âœ… Facturation mensuelle
- âœ… Gestion multi-vÃ©hicules
- âœ… API d'intÃ©gration

---

## ğŸ”§ Fonctions API Disponibles

### 1. **Authentification**

#### `login(email, password)`
Connecte un utilisateur existant.

```javascript
const result = await apiService.login('user@example.com', 'password123');
// Retourne: { success, token, user }
```

#### `register(userData)`
CrÃ©e un nouveau compte utilisateur.

```javascript
const result = await apiService.register({
  email: 'nouveau@email.com',
  password: 'motdepasse123',
  firstname: 'Jean',
  lastname: 'Dupont',
  role: 'user'
});
// Retourne: { success, message, token, user }
```

---

### 2. **Gestion Utilisateur**

#### `getUserProfile(token)`
RÃ©cupÃ¨re les informations complÃ¨tes de l'utilisateur.

```javascript
const result = await apiService.getUserProfile(token);
// Retourne: { success, user }
```

#### `upgradeAbonnement(token, typeAbonnement, dureeEnMois)`
Met Ã  niveau l'abonnement de l'utilisateur.

```javascript
const result = await apiService.upgradeAbonnement(token, 'premium', 12);
// Retourne: { success, message, user }
```

---

### 3. **RÃ©servations**

#### `getReservations(token)`
RÃ©cupÃ¨re toutes les rÃ©servations de l'utilisateur.

```javascript
const result = await apiService.getReservations(token);
// Retourne: { success, reservations }
```

#### `reserveParking(token, parkingId, reservationData)`
CrÃ©e une nouvelle rÃ©servation.

```javascript
const result = await apiService.reserveParking(token, 1, {
  date_debut: '2025-01-15T10:00:00',
  date_fin: '2025-01-15T18:00:00',
  montant: 20
});
// Retourne: { success, reservation }
```

---

### 4. **Stationnements**

#### `getStationnements(token)`
RÃ©cupÃ¨re les stationnements actifs de l'utilisateur.

```javascript
const result = await apiService.getStationnements(token);
// Retourne: { success, stationnements }
```

---

### 5. **PropriÃ©taires (Owner)**

#### `getOwnerParkings(token)`
RÃ©cupÃ¨re tous les parkings du propriÃ©taire.

```javascript
const result = await apiService.getOwnerParkings(token);
// Retourne: { success, parkings }
```

#### `addParking(token, parkingData)`
Ajoute un nouveau parking.

```javascript
const result = await apiService.addParking(token, {
  nom: 'Mon Parking',
  adresse: '123 Rue Example',
  nombre_places: 50,
  tarif_horaire: 2.5,
  tarif_journalier: 15,
  tarif_mensuel: 120,
  horaire_ouverture: '06:00',
  horaire_fermeture: '23:00'
});
// Retourne: { success, parking }
```

#### `getMonthlyRevenue(token)`
RÃ©cupÃ¨re les revenus mensuels du propriÃ©taire.

```javascript
const result = await apiService.getMonthlyRevenue(token);
// Retourne: { success, revenus_mensuels }
```

---

## ğŸ“¦ Exemple d'Utilisation ComplÃ¨te

### Inscription et Connexion

```javascript
// 1. Inscription d'un nouvel utilisateur
try {
  const registerResult = await apiService.register({
    email: 'jean.dupont@email.com',
    password: 'motdepasse123',
    firstname: 'Jean',
    lastname: 'Dupont',
    role: 'user'
  });
  
  // Stocker le token et les infos utilisateur
  localStorage.setItem('token', registerResult.token);
  localStorage.setItem('user', JSON.stringify(registerResult.user));
  
  console.log('Compte crÃ©Ã©:', registerResult.user);
  // user.typeAbonnement === 'gratuit' par dÃ©faut
  
} catch (error) {
  console.error('Erreur inscription:', error.message);
}

// 2. Connexion d'un utilisateur existant
try {
  const loginResult = await apiService.login(
    'jean.dupont@email.com',
    'motdepasse123'
  );
  
  localStorage.setItem('token', loginResult.token);
  localStorage.setItem('user', JSON.stringify(loginResult.user));
  
  console.log('ConnectÃ©:', loginResult.user);
  
} catch (error) {
  console.error('Erreur connexion:', error.message);
}
```

### Mise Ã  Niveau d'Abonnement

```javascript
const token = localStorage.getItem('token');

try {
  const upgradeResult = await apiService.upgradeAbonnement(
    token,
    'premium',
    12 // 12 mois
  );
  
  console.log(upgradeResult.message);
  // "Abonnement premium activÃ© avec succÃ¨s"
  
  // Mettre Ã  jour les infos utilisateur en local
  const userStr = localStorage.getItem('user');
  const user = JSON.parse(userStr);
  user.typeAbonnement = upgradeResult.user.typeAbonnement;
  user.debutAbonnement = upgradeResult.user.debutAbonnement;
  user.finAbonnement = upgradeResult.user.finAbonnement;
  localStorage.setItem('user', JSON.stringify(user));
  
} catch (error) {
  console.error('Erreur upgrade:', error.message);
}
```

### RÃ©server un Parking

```javascript
const token = localStorage.getItem('token');

try {
  const reservationResult = await apiService.reserveParking(
    token,
    1, // ID du parking
    {
      date_debut: '2025-01-15T10:00:00',
      date_fin: '2025-01-15T18:00:00',
      montant: 20
    }
  );
  
  console.log('RÃ©servation confirmÃ©e:', reservationResult.reservation);
  
} catch (error) {
  console.error('Erreur rÃ©servation:', error.message);
}
```

---

## ğŸ”’ SÃ©curitÃ©

### En Production (Backend PHP)

1. **Hachage des mots de passe**
   - Utiliser `password_hash()` en PHP
   - Ne jamais stocker les mots de passe en clair

2. **Tokens JWT**
   - GÃ©nÃ©rer des tokens JWT sÃ©curisÃ©s
   - Expiration aprÃ¨s 24h
   - Refresh tokens pour renouvellement

3. **Validation des donnÃ©es**
   - Valider tous les inputs cÃ´tÃ© serveur
   - Protection contre les injections SQL
   - Sanitization des donnÃ©es

4. **HTTPS**
   - Toujours utiliser HTTPS en production
   - SÃ©curiser les cookies

---

## âœ… Checklist Trello - Status

- âœ… **email** - ImplÃ©mentÃ©
- âœ… **password** - ImplÃ©mentÃ©
- âœ… **nom** - ImplÃ©mentÃ© (lastname)
- âœ… **prÃ©nom** - ImplÃ©mentÃ© (firstname)
- âœ… **une liste de rÃ©servations** - ImplÃ©mentÃ© (reservations: [])
- âœ… **une liste de stationnements** - ImplÃ©mentÃ© (stationnements: [])
- âœ… **type d'abonnement** - ImplÃ©mentÃ© (typeAbonnement)
- âœ… **dÃ©but abonnement** - ImplÃ©mentÃ© (debutAbonnement)
- âœ… **fin abonnement** - ImplÃ©mentÃ© (finAbonnement)

---

## ğŸ¨ IntÃ©gration Frontend

### Afficher les Infos Utilisateur

```jsx
// Dans un composant React
const user = JSON.parse(localStorage.getItem('user'));

return (
  <div>
    <h2>Profil de {user.firstname} {user.lastname}</h2>
    <p>Email: {user.email}</p>
    <p>RÃ´le: {user.role}</p>
    <p>Abonnement: {user.typeAbonnement}</p>
    {user.typeAbonnement !== 'gratuit' && (
      <>
        <p>DÃ©but: {user.debutAbonnement}</p>
        <p>Fin: {user.finAbonnement}</p>
      </>
    )}
    <p>RÃ©servations: {user.reservations.length}</p>
    <p>Stationnements: {user.stationnements.length}</p>
  </div>
);
```

---

## ğŸš€ Prochaines Ã‰tapes

1. **Backend PHP**
   - CrÃ©er les endpoints API rÃ©els
   - ImplÃ©menter l'authentification JWT
   - Connecter Ã  MySQL

2. **Paiements**
   - IntÃ©grer Stripe pour les abonnements
   - GÃ©rer les renouvellements automatiques

3. **Notifications**
   - Email de confirmation
   - Rappels de rÃ©servation
   - Alertes d'expiration d'abonnement

---

**Documentation mise Ã  jour le:** 2025-11-20  
**Version:** 1.0.0





================================================
FILE: frontend/package.json
================================================
{
  "name": "frontend",
  "version": "1.0.0",
  "description": "Application React pour le systÃ¨me de parking partagÃ© - Projet HETIC 2025",
  "main": "src/main.jsx",
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "eslintConfig": {
    "extends": [
      "react-app"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "dependencies": {
    "motion": "^12.23.24",
    "leaflet": "^1.9.4",
    "lucide-react": "^0.560.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-leaflet": "^5.0.0",
    "react-router-dom": "^6.30.1",
    "react-scripts": "5.0.1"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.18"
  }
}



================================================
FILE: frontend/postcss.config.js
================================================
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};




================================================
FILE: frontend/tailwind.config.js
================================================
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{js,jsx,ts,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: '#E6375F', // Rose Yespark
        'primary-50': '#fdf2f4',
        'primary-100': '#fbe5e9',
        'primary-200': '#f7ccd5',
        'primary-300': '#f0a3b3',
        'primary-400': '#e6375f', // Main color
        'primary-500': '#d12f54',
        'primary-600': '#ab1f40',
        'primary-700': '#8a1632',
        'primary-800': '#6b1126',
        'primary-900': '#500c1c',
      },
      fontFamily: {
        sans: ['Inter', 'SF Pro Display', 'system-ui', '-apple-system', 'sans-serif'],
        display: ['Cabinet Grotesk', 'Inter', 'sans-serif'],
      },
    },
  },
  plugins: [],
}




================================================
FILE: frontend/public/index.html
================================================
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#34A853" />
    <meta
      name="description"
      content="SystÃ¨me de Parking PartagÃ© - Trouvez et rÃ©servez votre place de parking facilement"
    />
    <title>ParkingPartagÃ© - SystÃ¨me de Parking PartagÃ©</title>
  </head>
  <body>
    <noscript>Vous devez activer JavaScript pour utiliser cette application.</noscript>
    <div id="root"></div>
  </body>
</html>




================================================
FILE: frontend/src/App.jsx
================================================
import React from "react";
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import Home from "./pages/Home.jsx";
import Login from "./pages/Login.jsx";
import Register from "./pages/Register.jsx";
import Reservation from "./pages/Reservation.jsx";
import MesReservations from "./pages/MesReservations.jsx";
import Maps from "./pages/Maps.jsx";
import UserDashboard from "./pages/UserDashboard.jsx";
import OwnerDashboard from "./pages/OwnerDashboard.jsx";
import ParkingDetails from "./pages/ParkingDetails.jsx";
import ProtectedRoute from "./components/ProtectedRoute.jsx";

function App() {
  return (
    <BrowserRouter>
      <Routes>
        {/* Routes publiques */}
        <Route path="/" element={<Home />} />
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        <Route path="/reservation" element={<Reservation />} />
        <Route path="/maps" element={<Maps />} />
        
        {/* Routes protÃ©gÃ©es */}
        <Route
          path="/mes-reservations"
          element={
            <ProtectedRoute>
              <MesReservations />
            </ProtectedRoute>
          }
        />
        <Route
          path="/dashboard-user"
          element={
            <ProtectedRoute role="user">
              <UserDashboard />
            </ProtectedRoute>
          }
        />
        <Route
          path="/dashboard-owner"
          element={
            <ProtectedRoute role="owner">
              <OwnerDashboard />
            </ProtectedRoute>
          }
        />

        {/* Route publique pour les dÃ©tails de parking */}
        <Route path="/parking/:id" element={<ParkingDetails />} />

        {/* Redirection pour les routes obsolÃ¨tes */}
        <Route path="/dashboard" element={<Navigate to="/dashboard-user" replace />} />
        <Route path="/owner" element={<Navigate to="/dashboard-owner" replace />} />

        {/* Route 404 */}
        <Route path="*" element={<Navigate to="/" />} />
      </Routes>
    </BrowserRouter>
  );
}

export default App;



================================================
FILE: frontend/src/index.css
================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

@layer base {
body {
  margin: 0;
    font-family: 'Inter', 'SF Pro Display', system-ui, -apple-system, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
    scroll-behavior: smooth;
    letter-spacing: -0.01em;
  }
  
  /* Curseur personnalisÃ© */
  * {
    cursor: default;
  }
  
  button, a, input, [role="button"] {
    cursor: pointer;
  }
  
  /* Typographie moderne */
  h1, h2, h3, h4, h5, h6 {
    letter-spacing: -0.02em;
    /* font-weight: 300; - REMOVED to allow utility classes to work */
  }
}

@layer utilities {
  /* Animations ultra-fun style Framer */
  .animate-float {
    animation: float 3s ease-in-out infinite;
  }
  
  .animate-pulse-fun {
    animation: pulseFun 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  .animate-bounce-subtle {
    animation: bounceSubtle 1s ease-in-out;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  
  @keyframes pulseFun {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.9; transform: scale(1.02); }
  }
  
  @keyframes bounceSubtle {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  
  /* Glass effect fun */
  .glass-effect {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  
  /* Gradient texts fun */
  .gradient-text {
    background: linear-gradient(135deg, #4A7C59 0%, #6B9E7B 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
}

/* Styles Leaflet personnalisÃ©s - Ultra-moderne */
.leaflet-popup-content-wrapper {
  border-radius: 1.5rem !important;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
  border: 1px solid rgba(0, 0, 0, 0.05) !important;
  padding: 0 !important;
}

.leaflet-popup-content {
  margin: 0 !important;
}

.leaflet-popup-tip {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
}

.leaflet-container {
  font-family: 'Inter', system-ui, -apple-system, sans-serif !important;
}

.leaflet-control-zoom {
  border: none !important;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1) !important;
  border-radius: 1rem !important;
  overflow: hidden;
}

.leaflet-control-zoom a {
  background-color: white !important;
  color: #1f2937 !important;
  border: none !important;
  font-size: 18px !important;
  line-height: 30px !important;
  transition: all 0.2s !important;
}

.leaflet-control-zoom a:hover {
  background-color: #f9fafb !important;
}

.leaflet-control-zoom-in,
.leaflet-control-zoom-out {
  width: 40px !important;
  height: 40px !important;
}

/* Animation fade-in */
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fade-in 0.4s ease-out;
}



================================================
FILE: frontend/src/index.js
================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);



================================================
FILE: frontend/src/components/Footer.jsx
================================================
import React from "react";
import { Link } from "react-router-dom";

export default function Footer() {
  return (
    <footer className="bg-gray-50 text-gray-600 border-t border-gray-100">
      <div className="container mx-auto px-6 lg:px-12 py-20">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
          {/* Logo & Description */}
          <div className="md:col-span-2 space-y-6">
            <div className="flex items-center space-x-2">
              <div className="w-8 h-8 bg-primary rounded-full"></div>
              <span className="text-xl font-light text-gray-900">parkingpartagÃ©</span>
            </div>
            <p className="text-gray-500 leading-relaxed max-w-md font-light">
              La solution simple et moderne pour trouver et rÃ©server votre place de parking partout en France.
            </p>
            <div className="flex space-x-4">
              <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors">
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
              </a>
              <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors">
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                </svg>
              </a>
              <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors">
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/>
                </svg>
              </a>
            </div>
          </div>

          {/* Links */}
          <div>
            <h3 className="text-gray-900 font-light mb-4 text-lg">Liens</h3>
            <ul className="space-y-3">
              <li>
                <Link to="/" className="text-gray-500 hover:text-gray-900 transition-colors font-light">
                  Accueil
                </Link>
              </li>
              <li>
                <Link to="/login" className="text-gray-500 hover:text-gray-900 transition-colors font-light">
                  Connexion
                </Link>
              </li>
              <li>
                <Link to="/register" className="text-gray-500 hover:text-gray-900 transition-colors font-light">
                  Inscription
                </Link>
              </li>
            </ul>
          </div>

          {/* Contact */}
          <div>
            <h3 className="text-gray-900 font-light mb-4 text-lg">Contact</h3>
            <ul className="space-y-3 text-gray-500 font-light">
              <li>support@parkingpartage.fr</li>
              <li>01 23 45 67 89</li>
            </ul>
          </div>
        </div>

        <div className="border-t border-gray-200 pt-8 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
          <p className="text-gray-400 text-sm font-light">
            Â© 2025 ParkingPartagÃ©. Tous droits rÃ©servÃ©s.
          </p>
          <div className="flex space-x-8 text-sm">
            <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors font-light">
              ConfidentialitÃ©
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors font-light">
              Conditions
            </a>
            <a href="#" className="text-gray-400 hover:text-gray-600 transition-colors font-light">
              Mentions lÃ©gales
            </a>
          </div>
        </div>
      </div>
    </footer>
  );
}



================================================
FILE: frontend/src/components/Header.jsx
================================================
import React from "react";
import { Link, useNavigate } from "react-router-dom";
import { apiService } from "../services/apiService";

export default function Header() {
  const navigate = useNavigate();
  const userStr = localStorage.getItem("user");
  const user = userStr ? JSON.parse(userStr) : null;
  const userRole = user?.role?.toLowerCase()?.trim() || null;

  const isLoggedIn = !!user;

  const handleLogout = async () => {
    try {
      await apiService.logout();
    } catch (e) {
      console.error("Erreur lors de la dÃ©connexion :", e);
    }
    localStorage.removeItem("user");
    navigate("/");
  };



  return (
    <header className="fixed top-6 left-0 right-0 z-50 px-6">
      <div className="max-w-7xl mx-auto flex justify-between items-center">
        {/* Logo Ã  gauche */}
        <Link to="/" className="flex items-center space-x-2">
          <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg">
            <span className="text-primary font-bold text-xl">P</span>
          </div>
        </Link>

        {/* Navigation centrale - Arrondie et sÃ©parÃ©e */}
        <nav className="flex items-center bg-gray-900 rounded-full shadow-2xl px-2 py-2">
          <Link
            to="/"
            className="px-6 py-2.5 bg-white text-gray-900 rounded-full font-medium text-sm transition-all duration-300 hover:bg-gray-100"
          >
            Accueil
          </Link>
          <Link 
            to="/reservation" 
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300"
          >
            RÃ©server
          </Link>
          <Link 
            to="/maps" 
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300"
          >
            Carte
          </Link>
          <a 
            href="#services" 
            onClick={(e) => {
              e.preventDefault();
              document.querySelector('#services')?.scrollIntoView({ behavior: 'smooth' });
            }}
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300 cursor-pointer"
          >
            Services
          </a>
          <a
            href="#tarifs"
            onClick={(e) => {
              e.preventDefault();
              document.querySelector('#tarifs')?.scrollIntoView({ behavior: 'smooth' });
            }}
            className="px-6 py-2.5 text-white font-light text-sm transition-all duration-300 hover:text-gray-300 cursor-pointer"
          >
            Tarifs
          </a>
        </nav>

        {/* Boutons Connexion/Inscription ou Dashboard */}
        {isLoggedIn ? (
          <div className="flex items-center gap-3">
            {userRole === "owner" ? (
              <Link
                to="/dashboard-owner"
                className="bg-gray-900 text-white px-6 py-2.5 rounded-full text-sm shadow-lg hover:bg-gray-800 transition-all duration-300"
              >
                Dashboard
              </Link>
            ) : (
              <>
                <Link 
                  to="/mes-reservations" 
                  className="text-gray-900 bg-white border border-gray-200 px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-gray-50 transition-all duration-300"
                >
                  Mes rÃ©servations
                </Link>
                <Link 
                  to="/dashboard-user" 
                  className="bg-gray-900 text-white px-6 py-2.5 rounded-full font-light text-sm shadow-lg hover:bg-gray-800 transition-all duration-300"
                >
                  Mon compte
                </Link>
              </>
            )}
            <button
              onClick={handleLogout}
              className="bg-white text-gray-900 px-5 py-2.5 rounded-full text-sm shadow-lg hover:bg-gray-100 transition-all duration-300"
            >
              DÃ©connexion
            </button>
          </div>
        ) : (
          <div className="flex items-center gap-3">
            <Link
              to="/login"
              className="bg-white text-gray-900 px-5 py-2.5 rounded-full text-sm shadow-lg hover:bg-gray-100 transition-all duration-300"
            >
              Se connecter
            </Link>
            <Link
              to="/register"
              className="bg-primary text-white px-5 py-2.5 rounded-full text-sm shadow-lg hover:bg-primary/90 transition-all duration-300"
            >
              S'inscrire
            </Link>
          </div>
        )}

      </div>
    </header>
  );
}



================================================
FILE: frontend/src/components/LoadingScreen.jsx
================================================
import React, { useEffect, useState } from 'react';

export default function LoadingScreen({ onLoadingComplete }) {
  const [progress, setProgress] = useState(0);
  const [isComplete, setIsComplete] = useState(false);

  useEffect(() => {
    // Animation de la barre de progression
    const interval = setInterval(() => {
      setProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          setIsComplete(true);
          setTimeout(() => {
            onLoadingComplete();
          }, 500);
          return 100;
        }
        return prev + 2;
      });
    }, 30);

    return () => clearInterval(interval);
  }, [onLoadingComplete]);

  return (
    <div
      className={`fixed inset-0 z-[9999] bg-white flex items-center justify-center transition-opacity duration-500 ${
        isComplete ? 'opacity-0 pointer-events-none' : 'opacity-100'
      }`}
    >
      <div className="max-w-md w-full px-8">
        {/* Logo / IcÃ´ne */}
        <div className="flex justify-center mb-12">
          <div className="relative">
            <div className="w-20 h-20 bg-gray-900 rounded-full flex items-center justify-center animate-pulse">
              <span className="text-white text-3xl font-bold">P</span>
            </div>
            {/* Cercle animÃ© autour */}
            <div className="absolute inset-0 border-4 border-gray-900 rounded-full animate-spin" style={{ borderTopColor: 'transparent', borderRightColor: 'transparent' }}></div>
          </div>
        </div>

        {/* Titre */}
        <h2 className="text-3xl font-light text-gray-900 text-center mb-3 tracking-tight">
          ParkingPartagÃ©
        </h2>
        <p className="text-sm text-gray-500 font-light text-center mb-12">
          Chargement en cours...
        </p>

        {/* Barre de progression minimaliste */}
        <div className="relative">
          <div className="w-full h-1 bg-gray-100 rounded-full overflow-hidden">
            <div
              className="h-full bg-gray-900 rounded-full transition-all duration-300 ease-out"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
          {/* Pourcentage */}
          <div className="text-xs text-gray-400 font-light text-center mt-4">
            {progress}%
          </div>
        </div>

        {/* Dots animÃ©s */}
        <div className="flex justify-center gap-2 mt-12">
          <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style={{ animationDelay: '0s' }}></div>
          <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
          <div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style={{ animationDelay: '0.4s' }}></div>
        </div>
      </div>
    </div>
  );
}





================================================
FILE: frontend/src/components/ParkingCard.jsx
================================================
import React from "react";
import { useNavigate } from "react-router-dom";

export default function ParkingCard({ parking }) {
  const navigate = useNavigate();
  const token = localStorage.getItem("token");

  const handleReserve = () => {
    if (!token) {
      navigate("/login");
      return;
    }
    navigate(`/parking/${parking.id}/reserve`);
  };

  return (
    <div className="bg-white rounded-2xl shadow hover:shadow-lg transition overflow-hidden cursor-pointer">
      {/* Image du parking */}
      <div className="relative h-48 bg-gray-200 overflow-hidden">
        {parking.image ? (
          <img
            src={parking.image}
            alt={parking.nom}
            className="w-full h-full object-cover hover:scale-110 transition duration-500"
          />
        ) : (
          <div className="w-full h-full bg-gradient-to-br from-zenpark-100 to-zenpark-200 flex items-center justify-center">
            <svg className="w-16 h-16 text-zenpark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
            </svg>
          </div>
        )}
        
        {/* Badge disponibilitÃ© */}
        {parking.nombre_places && (
          <div className="absolute top-4 right-4 bg-white px-3 py-1.5 rounded-full shadow">
            <span className="text-sm font-semibold text-zenpark">
              {parking.nombre_places} places
            </span>
          </div>
        )}
      </div>

      {/* Contenu */}
      <div className="p-6">
        <h3 className="text-xl font-semibold mb-2 text-gray-900">
          {parking.nom || "Parking"}
        </h3>
        
        <div className="flex items-start mb-4">
          <svg className="w-4 h-4 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <p className="text-gray-600 text-sm">
          {parking.adresse || "Adresse non disponible"}
        </p>
        </div>

        {/* Informations tarifaires */}
        <div className="space-y-2 mb-5">
          {parking.tarif_horaire && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Horaire</span>
              <span className="font-semibold text-zenpark">{parking.tarif_horaire} â‚¬</span>
            </div>
          )}
          {parking.tarif_journalier && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Journalier</span>
              <span className="font-semibold text-zenpark">{parking.tarif_journalier} â‚¬</span>
            </div>
          )}
          {parking.tarif_mensuel && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Mensuel</span>
              <span className="font-semibold text-zenpark">{parking.tarif_mensuel} â‚¬</span>
            </div>
          )}
        </div>

        {/* Bouton rÃ©server */}
        <button
          onClick={handleReserve}
          className="w-full bg-zenpark text-white py-3 rounded-xl hover:bg-zenpark-700 transition font-medium"
        >
          RÃ©server
        </button>
      </div>
    </div>
  );
}



================================================
FILE: frontend/src/components/ProtectedRoute.jsx
================================================
import React, { useEffect, useState } from "react";
import { Navigate } from "react-router-dom";
import { apiService } from "../services/apiService";

export default function ProtectedRoute({ children }) {
  const [allowed, setAllowed] = useState(null);

  useEffect(() => {
    apiService
      .getCurrentUser()
      .then((user) => {
        if (user) setAllowed(true);
        else setAllowed(false);
      })
      .catch(() => setAllowed(false));
  }, []);

  if (allowed === null) return <div>Chargement...</div>;
  if (!allowed) return <Navigate to="/login" />;

  return children;
}



================================================
FILE: frontend/src/components/SearchBar.jsx
================================================
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";

export default function SearchBar() {
  const [location, setLocation] = useState("");
  const [date, setDate] = useState("");
  const [focused, setFocused] = useState(null);
  const navigate = useNavigate();

  const handleSearch = async (e) => {
    e.preventDefault();
    if (location) {
      try {
        const response = await fetch(
          `http://localhost:8001/api/parkings?location=${encodeURIComponent(location)}`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}` || "",
            },
          }
        );
        if (response.ok) {
          const data = await response.json();
          console.log("Parkings trouvÃ©s:", data);
        }
      } catch (error) {
        console.error("Erreur lors de la recherche:", error);
      }
    }
  };

  return (
    <form onSubmit={handleSearch} className="w-full max-w-4xl mx-auto scale-in">
      <div className="bg-white rounded-3xl shadow-2xl overflow-hidden hover:shadow-3xl transition-all duration-500 border border-gray-100">
        <div className="flex flex-col md:flex-row divide-y md:divide-y-0 md:divide-x divide-gray-100">
          {/* Location Input */}
          <div 
            className={`flex-1 p-6 md:p-8 transition-all duration-300 ${
              focused === 'location' ? 'bg-gray-50' : 'bg-white'
            }`}
          >
            <label className="block text-xs font-medium text-gray-500 mb-3 uppercase tracking-wider">
              Destination
            </label>
        <input
          type="text"
              placeholder="OÃ¹ souhaitez-vous vous garer ?"
          value={location}
          onChange={(e) => setLocation(e.target.value)}
              onFocus={() => setFocused('location')}
              onBlur={() => setFocused(null)}
              className="w-full text-lg md:text-xl text-gray-900 font-light focus:outline-none placeholder-gray-300 bg-transparent"
            />
          </div>

          {/* Date Input */}
          <div 
            className={`flex-1 p-6 md:p-8 transition-all duration-300 ${
              focused === 'date' ? 'bg-gray-50' : 'bg-white'
            }`}
          >
            <label className="block text-xs font-medium text-gray-500 mb-3 uppercase tracking-wider">
              Date & heure
            </label>
            <input
              type="datetime-local"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              onFocus={() => setFocused('date')}
              onBlur={() => setFocused(null)}
              className="w-full text-lg md:text-xl text-gray-900 font-light focus:outline-none bg-transparent"
        />
          </div>

          {/* Search Button */}
          <div className="p-4 md:p-6 flex items-center justify-center">
        <button
          type="submit"
              className="w-full md:w-auto bg-zenpark text-white px-10 py-4 rounded-2xl hover:bg-zenpark-700 transition-all duration-300 font-light text-lg shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center justify-center space-x-2"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span>Rechercher</span>
            </button>
          </div>
        </div>
      </div>

      {/* Quick suggestions */}
      <div className="mt-6 flex flex-wrap justify-center gap-3">
        {['Paris', 'Lyon', 'Marseille', 'Toulouse', 'Nice'].map((city) => (
          <button
            key={city}
            type="button"
            onClick={() => setLocation(city)}
            className="px-5 py-2 bg-white/20 backdrop-blur-xl border border-white/30 text-white rounded-full hover:bg-white/30 transition-all duration-300 text-sm font-light"
          >
            {city}
        </button>
        ))}
      </div>
    </form>
  );
}



================================================
FILE: frontend/src/pages/Dashboard.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";

export default function Dashboard() {
  const navigate = useNavigate();
  const [reservations, setReservations] = useState([]);
  const [abonnements, setAbonnements] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!token) {
      navigate("/login");
      return;
    }

    // RÃ©cupÃ©rer les rÃ©servations
    fetch("http://localhost:8001/api/reservations", {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (res.status === 401) {
          localStorage.removeItem("token");
          navigate("/login");
          return null;
        }
        return res.json();
      })
      .then((data) => {
        if (data) {
          setReservations(data.reservations || data || []);
        }
      })
      .catch((err) => {
        console.error("Erreur lors de la rÃ©cupÃ©ration des rÃ©servations:", err);
        setError("Erreur lors du chargement des donnÃ©es");
      });

    // RÃ©cupÃ©rer les abonnements
    fetch("http://localhost:8001/api/abonnements", {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (res.status === 401) {
          return null;
        }
        return res.json();
      })
      .then((data) => {
        if (data) {
          setAbonnements(data.abonnements || data || []);
        }
        setLoading(false);
      })
      .catch((err) => {
        console.error("Erreur lors de la rÃ©cupÃ©ration des abonnements:", err);
        setLoading(false);
      });
  }, [navigate]);

  const handleEnterParking = (reservationId) => {
    // Simuler l'entrÃ©e dans un parking
    const token = localStorage.getItem("token");
    fetch(`http://localhost:8001/api/reservations/${reservationId}/enter`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    })
      .then((res) => res.json())
      .then((data) => {
        alert("Vous Ãªtes entrÃ© dans le parking !");
        // Recharger les donnÃ©es
        window.location.reload();
      })
      .catch((err) => {
        alert("Erreur lors de l'entrÃ©e dans le parking");
      });
  };

  const handleExitParking = (reservationId) => {
    // Simuler la sortie d'un parking
    const token = localStorage.getItem("token");
    fetch(`http://localhost:8001/api/reservations/${reservationId}/exit`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    })
      .then((res) => res.json())
      .then((data) => {
        alert("Vous Ãªtes sorti du parking !");
        // Recharger les donnÃ©es
        window.location.reload();
      })
      .catch((err) => {
        alert("Erreur lors de la sortie du parking");
      });
  };

  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold mb-8 text-gray-800">
          Mon tableau de bord
        </h1>

          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
              {error}
            </div>
          )}

          {/* RÃ©servations */}
          <section className="mb-12">
            <h2 className="text-2xl font-semibold mb-4 text-gray-700">
              Mes rÃ©servations
            </h2>
            {loading ? (
              <p className="text-gray-500">Chargement...</p>
            ) : reservations.length === 0 ? (
              <div className="bg-gray-50 rounded-lg p-8 text-center">
                <p className="text-gray-600">
                  Vous n'avez aucune rÃ©servation pour le moment.
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {reservations.map((reservation) => (
                  <div
                    key={reservation.id}
                    className="bg-white rounded-xl shadow-md p-6"
                  >
                    <h3 className="text-xl font-bold mb-2">
                      {reservation.parking_nom || "Parking"}
                    </h3>
                    <p className="text-gray-600 mb-2">
                      {reservation.date_debut && reservation.date_fin
                        ? `${new Date(reservation.date_debut).toLocaleDateString()} - ${new Date(reservation.date_fin).toLocaleDateString()}`
                        : "Date non spÃ©cifiÃ©e"}
                    </p>
                    <p className="text-gray-700 mb-4">
                      <span className="font-semibold">Statut:</span>{" "}
                      {reservation.statut || "En attente"}
                    </p>
                    <div className="flex gap-2">
                      {reservation.statut === "confirmÃ©e" && (
                        <>
                          <button
                            onClick={() => handleEnterParking(reservation.id)}
                            className="flex-1 bg-[#34A853] text-white py-2 rounded-lg hover:bg-[#2d8f45] transition font-medium"
                          >
                            Entrer
                          </button>
                          <button
                            onClick={() => handleExitParking(reservation.id)}
                            className="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition font-medium"
                          >
                            Sortir
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </section>

          {/* Abonnements */}
          <section>
            <h2 className="text-2xl font-semibold mb-4 text-gray-700">
              Mes abonnements
            </h2>
            {loading ? (
              <p className="text-gray-500">Chargement...</p>
            ) : abonnements.length === 0 ? (
              <div className="bg-gray-50 rounded-lg p-8 text-center">
                <p className="text-gray-600">
                  Vous n'avez aucun abonnement pour le moment.
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {abonnements.map((abonnement) => (
                  <div
                    key={abonnement.id}
                    className="bg-white rounded-xl shadow-md p-6"
                  >
                    <h3 className="text-xl font-bold mb-2">
                      {abonnement.parking_nom || "Parking"}
                    </h3>
                    <p className="text-gray-600 mb-2">
                      Abonnement mensuel
                    </p>
                    <p className="text-gray-700">
                      <span className="font-semibold">Prix:</span>{" "}
                      {abonnement.prix_mensuel || "N/A"} â‚¬/mois
                    </p>
                  </div>
                ))}
              </div>
            )}
          </section>
      </main>
      <Footer />
    </div>
  );
}
  


================================================
FILE: frontend/src/pages/Login.jsx
================================================
// frontend/src/pages/Login.jsx
import React, { useState } from "react";
import { useNavigate, Link } from "react-router-dom";
import { apiService } from "../services/apiService";
import Header from "../components/Header";
import Footer from "../components/Footer";

export default function Login() {
  const navigate = useNavigate();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");
    
    // Validation cÃ´tÃ© client
    if (!email || !password) {
      setError("Veuillez remplir tous les champs");
      return;
    }
    
    if (!email.includes('@')) {
      setError("Veuillez entrer une adresse email valide");
      return;
    }
    
    if (password.length < 6) {
      setError("Le mot de passe doit contenir au moins 6 caractÃ¨res");
      return;
    }
    
    setLoading(true);

    try {
      const result = await apiService.login(email, password);

      if (result.success) {
        // âŒ remove localStorage
        // localStorage.setItem("user", JSON.stringify(result.user));

        if (result.user.role === "owner") {
          navigate("/dashboard-owner");
        } else {
          navigate("/dashboard-user", { replace: true });
        }
      } else {
        setError("Erreur lors de la connexion. Veuillez rÃ©essayer.");
      }
    } catch (err) {
      console.error('âŒ Erreur connexion:', err);
      console.error('ğŸ“§ Email utilisÃ©:', email.trim().toLowerCase());
      console.error('ğŸ”‘ Mot de passe utilisÃ©:', password);
      
      // Message d'erreur plus dÃ©taillÃ©
      let errorMessage = err.message || "Email ou mot de passe incorrect";
      if (errorMessage.includes('Email ou mot de passe incorrect')) {
        errorMessage += "\n\nğŸ’¡ VÃ©rifiez que vous avez bien crÃ©Ã© un compte. Si c'est le cas, vÃ©rifiez l'email et le mot de passe dans la console (F12).";
      }
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-br from-gray-50 to-white">
      <Header />
      <main className="flex-1 flex items-center justify-center py-32 px-6">
        <div className="w-full max-w-md">
          <div className="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
            {/* Logo */}
            <div className="flex justify-center mb-8">
              <div className="w-16 h-16 bg-gray-900 rounded-full flex items-center justify-center">
                <span className="text-white text-2xl font-bold">P</span>
              </div>
            </div>

            <h1 className="text-4xl font-light text-center mb-3 text-gray-900 tracking-tight">
              Connexion
            </h1>
            <p className="text-center text-gray-500 mb-10 font-light">
              Bienvenue ! Connectez-vous Ã  votre compte
            </p>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-gray-700 font-light mb-3 text-sm">
                  Adresse email
                </label>
                <input
                  type="email"
                  placeholder="votre@email.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                  required
                />
              </div>

              <div>
                <label className="block text-gray-700 font-light mb-3 text-sm">
                  Mot de passe
                </label>
                <input
                  type="password"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                  required
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-5 py-4 rounded-2xl text-sm font-light flex items-center gap-2 animate-pulse">
                  <span>âŒ</span>
                  <span>{error}</span>
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gray-900 text-white py-5 rounded-2xl hover:bg-gray-800 transition-all duration-300 font-light text-base disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl hover:-translate-y-0.5"
              >
                {loading ? "Connexion en cours..." : "Se connecter"}
              </button>
            </form>

            <div className="mt-10 text-center">
              <p className="text-gray-500 font-light text-sm">
                Pas encore de compte ?{" "}
                <Link
                  to="/register"
                  className="text-gray-900 hover:text-gray-700 font-medium transition-colors"
                >
                  CrÃ©er un compte
                </Link>
              </p>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/pages/Maps.jsx
================================================
import React, { useState, useEffect } from 'react';
import { MapContainer, TileLayer, Marker, Popup, useMap, CircleMarker } from 'react-leaflet';
import L from 'leaflet';
import { apiService } from '../services/apiService';
import Header from '../components/Header';
import Footer from '../components/Footer';
import 'leaflet/dist/leaflet.css';

// Fix pour les icÃ´nes Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// Composant pour centrer la carte
const MapController = ({ center, zoom }) => {
  const map = useMap();
  useEffect(() => {
    map.setView(center, zoom);
  }, [map, center, zoom]);
  return null;
};

const Maps = () => {
  const [parkings, setParkings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedParking, setSelectedParking] = useState(null);
  const [mapStyle, setMapStyle] = useState('light'); // light, dark, satellite
  const [center, setCenter] = useState([46.6034, 1.8883]);
  const [zoom, setZoom] = useState(6);

  useEffect(() => {
    loadParkings();
  }, []);

  const loadParkings = async () => {
    setLoading(true);
    try {
      const response = await apiService.searchParkings({});
      setParkings(response.parkings || []);
    } catch (error) {
      console.error('Erreur chargement parkings:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleMarkerClick = (parking) => {
    setSelectedParking(parking);
    setCenter([parking.latitude, parking.longitude]);
    setZoom(13);
  };

  const handleReserve = (parking) => {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
      return;
    }
    window.location.href = `/reservation?parking=${parking.id}`;
  };

  const getTileUrl = () => {
    switch (mapStyle) {
      case 'dark':
        return 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
      case 'satellite':
        return 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
      default:
        return 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
    }
  };

  if (loading) {
    return (
      <>
        <Header />
        <div className="min-h-screen bg-white pt-24 flex items-center justify-center">
          <div className="w-16 h-16 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
        </div>
        <Footer />
      </>
    );
  }

  return (
    <>
      <Header />
      <div className="min-h-screen bg-white relative">
        {/* Header Flottant Ultra-Moderne */}
        <div className="absolute top-24 left-0 right-0 z-[100] pointer-events-none">
          <div className="max-w-7xl mx-auto px-6 py-6">
            <div className="flex items-center justify-between gap-4">
              <div className="bg-white/95 backdrop-blur-2xl rounded-3xl border border-gray-200/50 shadow-2xl p-6 pointer-events-auto">
                <h1 className="text-4xl font-extralight text-gray-900 tracking-tighter mb-1">
                  Carte des parkings
                </h1>
                <p className="text-xs text-gray-400 font-light uppercase tracking-wider">
                  {parkings.length} parkings disponibles
                </p>
              </div>

              {/* SÃ©lecteur de style de carte */}
              <div className="bg-white/95 backdrop-blur-2xl rounded-3xl border border-gray-200/50 shadow-2xl p-2 pointer-events-auto flex gap-2">
                {[
                  { value: 'light', label: 'Clair', icon: 'â˜€ï¸' },
                  { value: 'dark', label: 'Sombre', icon: 'ğŸŒ™' },
                  { value: 'satellite', label: 'Satellite', icon: 'ğŸ›°ï¸' }
                ].map(style => (
                  <button
                    key={style.value}
                    onClick={() => setMapStyle(style.value)}
                    className={`px-4 py-2.5 rounded-2xl text-sm font-light transition-all ${
                      mapStyle === style.value
                        ? 'bg-gray-900 text-white shadow-lg'
                        : 'text-gray-600 hover:bg-gray-50'
                    }`}
                  >
                    <span className="mr-2">{style.icon}</span>
                    {style.label}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Carte Plein Ã‰cran */}
        <div className="relative h-screen w-full">
          <MapContainer
            center={center}
            zoom={zoom}
            style={{ height: '100%', width: '100%', zIndex: 0 }}
            scrollWheelZoom={true}
            zoomControl={true}
            className="modern-map"
          >
            <TileLayer
              attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>'
              url={getTileUrl()}
            />
            <MapController center={center} zoom={zoom} />
            
            {parkings.map((parking) => {
              if (!parking.latitude || !parking.longitude) return null;
              
              return (
                <React.Fragment key={parking.id}>
                  {/* Cercle animÃ© autour du marqueur */}
                  <CircleMarker
                    center={[parking.latitude, parking.longitude]}
                    radius={8}
                    pathOptions={{
                      fillColor: parking.places_disponibles > 50 ? '#10b981' : parking.places_disponibles > 20 ? '#f59e0b' : '#ef4444',
                      fillOpacity: 0.3,
                      color: parking.places_disponibles > 50 ? '#10b981' : parking.places_disponibles > 20 ? '#f59e0b' : '#ef4444',
                      weight: 2
                    }}
                  />
                  <Marker
                    position={[parking.latitude, parking.longitude]}
                    eventHandlers={{
                      click: () => handleMarkerClick(parking),
                    }}
                  >
                    <Popup className="modern-popup" autoClose={false} closeOnClick={false}>
                      <div className="p-5 min-w-[300px]">
                        <div className="flex items-start justify-between mb-4">
                          <div className="flex-1">
                            <h3 className="text-xl font-extralight text-gray-900 mb-2">
                              {parking.nom}
                            </h3>
                            <p className="text-sm text-gray-500 font-light mb-3">
                              ğŸ“ {parking.adresse}
                            </p>
                            <div className="flex items-center gap-4 mb-4 text-xs text-gray-400 font-light">
                              <span className="flex items-center gap-1">
                                â­ {parking.note}
                              </span>
                              <span className="flex items-center gap-1">
                                ğŸ…¿ï¸ {parking.places_disponibles} places
                              </span>
                              <span className="flex items-center gap-1">
                                ğŸ’° {parking.tarif_horaire}â‚¬/h
                              </span>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-4">
                              {parking.services.slice(0, 3).map(service => (
                                <span
                                  key={service}
                                  className="px-2.5 py-1 bg-gray-100 text-gray-600 rounded-lg text-xs font-light"
                                >
                                  {service}
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={() => handleReserve(parking)}
                          className="w-full bg-gray-900 text-white py-3 px-4 rounded-xl text-sm font-light hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl"
                        >
                          RÃ©server maintenant
                        </button>
                      </div>
                    </Popup>
                  </Marker>
                </React.Fragment>
              );
            })}
          </MapContainer>
        </div>

        {/* Card sÃ©lectionnÃ©e - Design Ultra-Moderne */}
        {selectedParking && (
          <div className="fixed bottom-6 left-6 right-6 z-[100] pointer-events-none animate-fade-in">
            <div className="max-w-lg mx-auto">
              <div className="bg-white/98 backdrop-blur-2xl rounded-3xl border border-gray-200/50 shadow-2xl p-8 pointer-events-auto transform transition-all duration-500">
                <div className="flex items-start justify-between mb-6">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-12 h-12 bg-gray-900 rounded-2xl flex items-center justify-center text-white text-xl">
                        ğŸ…¿ï¸
                      </div>
                      <div>
                        <h3 className="text-2xl font-extralight text-gray-900 mb-1">
                          {selectedParking.nom}
                        </h3>
                        <p className="text-xs text-gray-400 font-light uppercase tracking-wider">
                          {selectedParking.ville}
                        </p>
                      </div>
                    </div>
                    <p className="text-gray-500 font-light text-sm mb-4">
                      ğŸ“ {selectedParking.adresse}
                    </p>
                    <div className="grid grid-cols-3 gap-3 mb-6">
                      <div className="bg-gray-50 rounded-xl p-3 text-center">
                        <div className="text-lg font-extralight text-gray-900 mb-1">
                          â­ {selectedParking.note}
                        </div>
                        <div className="text-xs text-gray-400 font-light">Note</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 text-center">
                        <div className="text-lg font-extralight text-gray-900 mb-1">
                          ğŸ…¿ï¸ {selectedParking.places_disponibles}
                        </div>
                        <div className="text-xs text-gray-400 font-light">Places</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 text-center">
                        <div className="text-lg font-extralight text-gray-900 mb-1">
                          {selectedParking.tarif_horaire}â‚¬
                        </div>
                        <div className="text-xs text-gray-400 font-light">Par heure</div>
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2 mb-6">
                      {selectedParking.services.map(service => (
                        <span
                          key={service}
                          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-xs font-light"
                        >
                          {service}
                        </span>
                      ))}
                    </div>
                  </div>
                  <button
                    onClick={() => {
                      setSelectedParking(null);
                      setZoom(6);
                      setCenter([46.6034, 1.8883]);
                    }}
                    className="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center text-gray-600 text-lg ml-4"
                  >
                    âœ•
                  </button>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setCenter([selectedParking.latitude, selectedParking.longitude]);
                      setZoom(15);
                    }}
                    className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-light hover:bg-gray-200 transition-all text-sm"
                  >
                    ğŸ“ Centrer
                  </button>
                  <button
                    onClick={() => handleReserve(selectedParking)}
                    className="flex-1 bg-gray-900 text-white py-3 rounded-xl font-light hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl"
                  >
                    RÃ©server
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* LÃ©gende */}
        <div className="absolute bottom-6 right-6 z-[100] bg-white/95 backdrop-blur-2xl rounded-2xl border border-gray-200/50 shadow-2xl p-4 pointer-events-auto">
          <div className="text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">DisponibilitÃ©</div>
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-green-500"></div>
              <span className="text-xs text-gray-600 font-light">+50 places</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-amber-500"></div>
              <span className="text-xs text-gray-600 font-light">20-50 places</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-red-500"></div>
              <span className="text-xs text-gray-600 font-light">&lt;20 places</span>
            </div>
          </div>
        </div>
      </div>
      <Footer />
    </>
  );
};

export default Maps;



================================================
FILE: frontend/src/pages/MesReservations.jsx
================================================
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { apiService } from '../services/apiService';
import Header from '../components/Header';
import Footer from '../components/Footer';

const MesReservations = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [reservations, setReservations] = useState([]);
  const [filter, setFilter] = useState('all'); // all, upcoming, past, cancelled

  useEffect(() => {
    loadReservations();
  }, []);

  const loadReservations = async () => {
    setLoading(true);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('âŒ Vous devez Ãªtre connectÃ© pour voir vos rÃ©servations');
        navigate('/login');
        return;
      }

      const response = await apiService.getReservations(token);
      if (response.success) {
        setReservations(response.reservations || []);
      } else {
        alert('âŒ Erreur lors du chargement des rÃ©servations');
      }
    } catch (error) {
      console.error('Erreur chargement rÃ©servations:', error);
      if (error.message.includes('Utilisateur non trouvÃ©') || error.message.includes('Token')) {
        alert('âŒ Session expirÃ©e. Veuillez vous reconnecter.');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        navigate('/login');
      } else {
        alert('âŒ Erreur: ' + error.message);
      }
    } finally {
      setLoading(false);
    }
  };

  const getFilteredReservations = () => {
    const now = new Date();
    
    switch (filter) {
      case 'upcoming':
        return reservations.filter(r => new Date(r.date_debut) > now);
      case 'past':
        return reservations.filter(r => new Date(r.date_fin) < now);
      case 'cancelled':
        return reservations.filter(r => r.statut === 'annulÃ©e');
      default:
        return reservations;
    }
  };

  const filteredReservations = getFilteredReservations();

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const getStatusBadge = (reservation) => {
    const now = new Date();
    const debut = new Date(reservation.date_debut);
    const fin = new Date(reservation.date_fin);

    if (reservation.statut === 'annulÃ©e') {
      return <span className="px-4 py-2 bg-red-100 text-red-700 rounded-full text-sm font-medium">AnnulÃ©e</span>;
    }
    if (now < debut) {
      return <span className="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">Ã€ venir</span>;
    }
    if (now >= debut && now <= fin) {
      return <span className="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm font-medium">En cours</span>;
    }
    return <span className="px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">TerminÃ©e</span>;
  };

  return (
    <>
      <Header />
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white pt-24 pb-20">
        <div className="max-w-6xl mx-auto px-6 py-12">
          {/* Header */}
          <div className="mb-12">
            <h1 className="text-5xl font-light text-gray-900 mb-4 tracking-tight">
              Mes rÃ©servations
            </h1>
            <p className="text-xl text-gray-500 font-light">
              GÃ©rez toutes vos rÃ©servations en un seul endroit
            </p>
          </div>

          {/* Filtres */}
          <div className="flex flex-wrap gap-3 mb-8">
            {[
              { value: 'all', label: 'Toutes', count: reservations.length },
              { value: 'upcoming', label: 'Ã€ venir', count: reservations.filter(r => new Date(r.date_debut) > new Date()).length },
              { value: 'past', label: 'PassÃ©es', count: reservations.filter(r => new Date(r.date_fin) < new Date()).length },
              { value: 'cancelled', label: 'AnnulÃ©es', count: reservations.filter(r => r.statut === 'annulÃ©e').length }
            ].map(item => (
              <button
                key={item.value}
                onClick={() => setFilter(item.value)}
                className={`px-6 py-3 rounded-2xl font-medium transition-all ${
                  filter === item.value
                    ? 'bg-gray-900 text-white shadow-lg'
                    : 'bg-white text-gray-700 border border-gray-200 hover:border-gray-300'
                }`}
              >
                {item.label} ({item.count})
              </button>
            ))}
          </div>

          {/* Bouton nouvelle rÃ©servation */}
          <div className="mb-8">
            <button
              onClick={() => navigate('/reservation')}
              className="bg-primary text-white px-8 py-4 rounded-2xl font-medium hover:bg-primary-dark transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
            >
              â• Nouvelle rÃ©servation
            </button>
          </div>

          {/* Liste des rÃ©servations */}
          {loading ? (
            <div className="flex items-center justify-center py-20">
              <div className="w-16 h-16 border-4 border-gray-200 border-t-gray-900 rounded-full animate-spin"></div>
            </div>
          ) : filteredReservations.length === 0 ? (
            <div className="text-center py-20">
              <div className="text-6xl mb-4">ğŸ“…</div>
              <h3 className="text-2xl font-light text-gray-900 mb-2">
                Aucune rÃ©servation
              </h3>
              <p className="text-gray-500 mb-8">
                {filter === 'all' 
                  ? "Vous n'avez pas encore de rÃ©servation"
                  : `Vous n'avez pas de rÃ©servation ${filter === 'upcoming' ? 'Ã  venir' : filter === 'past' ? 'passÃ©e' : 'annulÃ©e'}`
                }
              </p>
              <button
                onClick={() => navigate('/reservation')}
                className="bg-gray-900 text-white px-8 py-4 rounded-2xl font-medium hover:bg-gray-800 transition-all shadow-lg"
              >
                Faire une rÃ©servation
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              {filteredReservations.map(reservation => (
                <ReservationCard
                  key={reservation.id}
                  reservation={reservation}
                  statusBadge={getStatusBadge(reservation)}
                  formatDate={formatDate}
                  onCancel={loadReservations}
                />
              ))}
            </div>
          )}
        </div>
      </div>
      <Footer />
    </>
  );
};

// Composant carte de rÃ©servation
const ReservationCard = ({ reservation, statusBadge, formatDate, onCancel }) => {
  const [showDetails, setShowDetails] = useState(false);
  const [cancelling, setCancelling] = useState(false);
  
  const handleCancel = async () => {
    if (!window.confirm('ÃŠtes-vous sÃ»r de vouloir annuler cette rÃ©servation ?')) {
      return;
    }
    
    setCancelling(true);
    try {
      const token = localStorage.getItem('token');
      const response = await apiService.cancelReservation(token, reservation.id);
      
      if (response.success) {
        alert(`âœ… ${response.message}\n\nVotre place a Ã©tÃ© libÃ©rÃ©e et est maintenant disponible pour d'autres utilisateurs.`);
        onCancel(); // Recharger les rÃ©servations
      }
    } catch (error) {
      alert('âŒ ' + error.message);
    } finally {
      setCancelling(false);
    }
  };

  return (
    <div className="bg-white rounded-3xl border border-gray-200 overflow-hidden hover:shadow-xl transition-all duration-500">
      <div className="p-8">
        <div className="flex items-start justify-between mb-6">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-3">
              <h3 className="text-2xl font-medium text-gray-900">
                {reservation.parking_nom}
              </h3>
              {statusBadge}
            </div>
            <p className="text-gray-500 mb-2">
              ğŸ“ {reservation.parking_adresse || 'Adresse non disponible'}
            </p>
            <p className="text-gray-400 text-sm flex items-center gap-3">
              <span>RÃ©servation #{reservation.id}</span>
              {reservation.vehicule && <span>ğŸš— {reservation.vehicule}</span>}
              {reservation.immatriculation && <span>ğŸ”– {reservation.immatriculation}</span>}
            </p>
          </div>
          <div className="text-right">
            <div className="text-3xl font-light text-gray-900 mb-1">
              {reservation.montant}â‚¬
            </div>
            <div className="text-sm text-gray-500">Montant total</div>
          </div>
        </div>

        {/* Dates */}
        <div className="grid md:grid-cols-2 gap-4 mb-6 p-6 bg-gray-50 rounded-2xl">
          <div>
            <div className="text-sm text-gray-500 mb-1">DÃ©but</div>
            <div className="text-gray-900 font-medium">
              {formatDate(reservation.date_debut)}
            </div>
          </div>
          <div>
            <div className="text-sm text-gray-500 mb-1">Fin</div>
            <div className="text-gray-900 font-medium">
              {formatDate(reservation.date_fin)}
            </div>
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={() => setShowDetails(!showDetails)}
            className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all"
          >
            {showDetails ? 'Masquer les dÃ©tails' : 'Voir les dÃ©tails'}
          </button>
          {reservation.statut !== 'annulÃ©e' && new Date(reservation.date_debut) > new Date() && (
            <button
              onClick={handleCancel}
              disabled={cancelling}
              className="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-medium hover:bg-red-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {cancelling ? 'Annulation...' : 'Annuler la rÃ©servation'}
            </button>
          )}
        </div>

        {/* DÃ©tails supplÃ©mentaires */}
        {showDetails && (
          <div className="mt-6 pt-6 border-t border-gray-100 space-y-3">
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">DurÃ©e</span>
              <span className="text-gray-900 font-medium">
                {Math.ceil((new Date(reservation.date_fin) - new Date(reservation.date_debut)) / (1000 * 60 * 60))} heures
              </span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">Type de stationnement</span>
              <span className="text-gray-900 font-medium">Horaire</span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">Date de rÃ©servation</span>
              <span className="text-gray-900 font-medium">
                {new Date().toLocaleDateString('fr-FR')}
              </span>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default MesReservations;




================================================
FILE: frontend/src/pages/OwnerDashboard.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function OwnerDashboard() {
  const navigate = useNavigate();
  const [parkings, setParkings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [showAddForm, setShowAddForm] = useState(false);
  const [showEditForm, setShowEditForm] = useState(null);
  const userStr = localStorage.getItem("user");
  const user = userStr ? JSON.parse(userStr) : null;

  const [monthlyRevenue, setMonthlyRevenue] = useState(0);
  const [activeReservations, setActiveReservations] = useState(0);
  const [activeStationnements, setActiveStationnements] = useState(0);

  const [newParking, setNewParking] = useState({
    nom: "",
    adresse: "",
    nombre_places: "",
    tarif_horaire: "",
    tarif_journalier: "",
    tarif_mensuel: "",
    horaire_ouverture: "",
    horaire_fermeture: "",
  });

  useEffect(() => {
    apiService.getCurrentUser().then((me) => {
      if (!me || me.role !== "owner") {
        navigate("/login");
      }
    });

    loadData();
  }, [navigate]);

  const loadData = async () => {
    const token = localStorage.getItem("token");
    setLoading(true);
    setError("");

    try {
      const parkingsResult = await apiService.getOwnerParkings(token);
      if (parkingsResult.success) {
        setParkings(parkingsResult.parkings || []);
      }

      const revenueResult = await apiService.getMonthlyRevenue(token);
      if (revenueResult.success) {
        setMonthlyRevenue(revenueResult.revenus_mensuels || 0);
      }

      const reservationsResult = await apiService.getActiveReservations(token);
      if (reservationsResult.success) {
        setActiveReservations(reservationsResult.reservations_en_cours || 0);
      }

      const stationnementsResult = await apiService.getActiveStationnements(token);
      if (stationnementsResult.success) {
        setActiveStationnements(stationnementsResult.stationnements_actifs || 0);
      }
    } catch (err) {
      setError(err.message || "Erreur lors du chargement des donnÃ©es");
    } finally {
      setLoading(false);
    }
  };

  const handleAddParking = async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");
    setError("");

    try {
      const result = await apiService.addParking(token, newParking);

      if (result.success) {
        setParkings([...parkings, result.parking]);
        setNewParking({
          nom: "",
          adresse: "",
          nombre_places: "",
          tarif_horaire: "",
          tarif_journalier: "",
          tarif_mensuel: "",
          horaire_ouverture: "",
          horaire_fermeture: "",
        });
        setShowAddForm(false);
        loadData();
      }
    } catch (err) {
      setError(err.message || "Erreur lors de l'ajout du parking");
    }
  };

  const handleUpdateParking = async (parkingId, updatedData) => {
    setError("");
    try {
      setParkings(
        parkings.map((p) => (p.id === parkingId ? { ...p, ...updatedData } : p))
      );
      setShowEditForm(null);
    } catch (err) {
      setError(err.message || "Erreur lors de la modification");
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <Header />
      <main className="flex-1">
        {/* Hero Section */}
        <section className="bg-zenpark text-white py-12">
          <div className="container mx-auto px-6 lg:px-12">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-4xl font-serif font-normal mb-2">
            Espace propriÃ©taire
          </h1>
                <p className="text-white/90 text-lg">
                  GÃ©rez vos parkings et suivez vos revenus
                </p>
              </div>
          <button
            onClick={() => setShowAddForm(true)}
                className="hidden md:block bg-white text-zenpark px-6 py-3 rounded-xl hover:bg-gray-100 transition font-medium"
          >
            + Ajouter un parking
          </button>
        </div>
          </div>
        </section>

        <div className="container mx-auto px-6 lg:px-12 py-12">
        {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl mb-8">
            {error}
          </div>
        )}

          {/* Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div className="bg-white rounded-2xl shadow p-6">
              <h3 className="text-sm text-gray-600 mb-2">Revenus mensuels</h3>
              <p className="text-3xl font-bold text-zenpark">{monthlyRevenue.toFixed(2)} â‚¬</p>
          </div>

            <div className="bg-white rounded-2xl shadow p-6">
              <h3 className="text-sm text-gray-600 mb-2">RÃ©servations en cours</h3>
              <p className="text-3xl font-bold text-zenpark">{activeReservations}</p>
          </div>

            <div className="bg-white rounded-2xl shadow p-6">
              <h3 className="text-sm text-gray-600 mb-2">Stationnements actifs</h3>
              <p className="text-3xl font-bold text-zenpark">{activeStationnements}</p>
          </div>
        </div>

        {/* Formulaire d'ajout */}
        {showAddForm && (
            <div className="bg-white rounded-2xl shadow p-8 mb-12">
              <h2 className="text-2xl font-serif font-normal mb-6 text-gray-900">
                Ajouter un parking
              </h2>

              <form onSubmit={handleAddParking} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Nom du parking</label>
                <input
                  type="text"
                      placeholder="Ex: Parking Gare Lyon"
                  value={newParking.nom}
                      onChange={(e) => setNewParking({ ...newParking, nom: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Adresse</label>
                <input
                  type="text"
                      placeholder="123 Rue de la Gare"
                  value={newParking.adresse}
                      onChange={(e) => setNewParking({ ...newParking, adresse: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Nombre de places</label>
                <input
                  type="number"
                      placeholder="50"
                  value={newParking.nombre_places}
                      onChange={(e) => setNewParking({ ...newParking, nombre_places: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="1"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Tarif horaire (â‚¬)</label>
                <input
                  type="number"
                  step="0.01"
                      placeholder="2.50"
                  value={newParking.tarif_horaire}
                      onChange={(e) => setNewParking({ ...newParking, tarif_horaire: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="0"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Tarif journalier (â‚¬)</label>
                <input
                  type="number"
                  step="0.01"
                      placeholder="15.00"
                  value={newParking.tarif_journalier}
                      onChange={(e) => setNewParking({ ...newParking, tarif_journalier: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="0"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Tarif mensuel (â‚¬)</label>
                <input
                  type="number"
                  step="0.01"
                      placeholder="120.00"
                  value={newParking.tarif_mensuel}
                      onChange={(e) => setNewParking({ ...newParking, tarif_mensuel: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                      min="0"
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Heure d'ouverture</label>
                <input
                  type="time"
                  value={newParking.horaire_ouverture}
                      onChange={(e) => setNewParking({ ...newParking, horaire_ouverture: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
                  </div>
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">Heure de fermeture</label>
                <input
                  type="time"
                  value={newParking.horaire_fermeture}
                      onChange={(e) => setNewParking({ ...newParking, horaire_fermeture: e.target.value })}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark focus:border-zenpark transition"
                  required
                />
              </div>
                </div>

                <div className="flex gap-4">
                  <button type="submit" className="bg-zenpark text-white px-8 py-3 rounded-xl hover:bg-zenpark-700 transition font-medium">
                    Ajouter le parking
                </button>
                <button
                  type="button"
                  onClick={() => setShowAddForm(false)}
                    className="bg-gray-200 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-300 transition font-medium"
                >
                  Annuler
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Liste des parkings */}
        <section>
            <h2 className="text-3xl font-serif font-normal mb-6 text-gray-900">
              Mes parkings ({parkings.length})
          </h2>

          {loading ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
              <p className="text-gray-600">Chargement...</p>
            </div>
          ) : parkings.length === 0 ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
                <p className="text-gray-600 mb-6">
                Vous n'avez pas encore de parking. Ajoutez-en un !
              </p>
              <button
                onClick={() => setShowAddForm(true)}
                  className="bg-zenpark text-white px-8 py-3 rounded-xl hover:bg-zenpark-700 transition font-medium"
              >
                  Ajouter mon premier parking
              </button>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {parkings.map((parking) => (
                  <div key={parking.id} className="bg-white rounded-2xl shadow p-6">
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">{parking.nom}</h3>
                    <p className="text-gray-600 text-sm mb-4">{parking.adresse}</p>

                    <div className="space-y-2 mb-4 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Places:</span>
                        <span className="font-medium">{parking.nombre_places}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Tarif horaire:</span>
                        <span className="font-medium text-zenpark">{parking.tarif_horaire} â‚¬</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Tarif journalier:</span>
                        <span className="font-medium text-zenpark">{parking.tarif_journalier} â‚¬</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Horaires:</span>
                        <span className="font-medium">{parking.horaire_ouverture} - {parking.horaire_fermeture}</span>
                      </div>
                  </div>

                    <button
                      onClick={() => setShowEditForm(showEditForm === parking.id ? null : parking.id)}
                      className="w-full bg-gray-100 text-gray-900 py-2 rounded-xl hover:bg-gray-200 transition font-medium"
                    >
                      {showEditForm === parking.id ? 'Annuler' : 'Modifier'}
                    </button>

                  {showEditForm === parking.id && (
                      <form
                        onSubmit={(e) => {
                          e.preventDefault();
                          const formData = new FormData(e.target);
                          const updatedData = {
                            tarif_horaire: formData.get("tarif_horaire"),
                            tarif_journalier: formData.get("tarif_journalier"),
                            tarif_mensuel: formData.get("tarif_mensuel"),
                            horaire_ouverture: formData.get("horaire_ouverture"),
                            horaire_fermeture: formData.get("horaire_fermeture"),
                          };
                          handleUpdateParking(parking.id, updatedData);
                        }}
                        className="mt-4 space-y-3 pt-4 border-t border-gray-100"
                      >
                        <input
                          type="number"
                          step="0.01"
                          name="tarif_horaire"
                          defaultValue={parking.tarif_horaire}
                          placeholder="Tarif horaire"
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="number"
                          step="0.01"
                          name="tarif_journalier"
                          defaultValue={parking.tarif_journalier}
                          placeholder="Tarif journalier"
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="number"
                          step="0.01"
                          name="tarif_mensuel"
                          defaultValue={parking.tarif_mensuel}
                          placeholder="Tarif mensuel"
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="time"
                          name="horaire_ouverture"
                          defaultValue={parking.horaire_ouverture}
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                        <input
                          type="time"
                          name="horaire_fermeture"
                          defaultValue={parking.horaire_fermeture}
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-zenpark"
                        />
                          <button
                            type="submit"
                          className="w-full bg-zenpark text-white py-2 rounded-xl hover:bg-zenpark-700 transition font-medium"
                          >
                            Enregistrer
                          </button>
                      </form>
                  )}
                </div>
              ))}
            </div>
          )}
        </section>
        </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/pages/ParkingDetails.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate, useParams, Link } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function ParkingDetails() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [parking, setParking] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [showReservationForm, setShowReservationForm] = useState(false);
  const [reservationForm, setReservationForm] = useState({
    date_debut: "",
    date_fin: "",
    type: "journalier", // horaire, journalier, mensuel
  });

  useEffect(() => {
    loadParkingDetails();
  }, [id]);

  const loadParkingDetails = async () => {
    setLoading(true);
    setError("");

    try {
      const result = await apiService.getParkingDetails(id);
      if (result.success) {
        setParking(result.parking);
      }
    } catch (err) {
      setError(err.message || "Erreur lors du chargement des dÃ©tails du parking");
    } finally {
      setLoading(false);
    }
  };

  const handleReserve = async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");

    if (!token) {
      navigate("/login");
      return;
    }

    setError("");

    try {
      const result = await apiService.reserveParking(token, id, reservationForm);
      
      if (result.success) {
        alert("RÃ©servation confirmÃ©e avec succÃ¨s !");
        navigate("/dashboard-user");
      }
    } catch (err) {
      setError(err.message || "Erreur lors de la rÃ©servation");
    }
  };

  const calculatePrice = () => {
    if (!parking || !reservationForm.date_debut || !reservationForm.date_fin) {
      return 0;
    }

    const start = new Date(reservationForm.date_debut);
    const end = new Date(reservationForm.date_fin);
    const diffHours = (end - start) / (1000 * 60 * 60);

    switch (reservationForm.type) {
      case "horaire":
        return (diffHours * parseFloat(parking.tarif_horaire)).toFixed(2);
      case "journalier":
        const days = Math.ceil(diffHours / 24);
        return (days * parseFloat(parking.tarif_journalier)).toFixed(2);
      case "mensuel":
        return parseFloat(parking.tarif_mensuel).toFixed(2);
      default:
        return 0;
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col">
        <Header />
        <main className="flex-1 flex items-center justify-center">
          <p className="text-gray-600">Chargement...</p>
        </main>
        <Footer />
      </div>
    );
  }

  if (error && !parking) {
    return (
      <div className="min-h-screen flex flex-col">
        <Header />
        <main className="flex-1 flex items-center justify-center">
          <div className="text-center">
            <p className="text-red-600 mb-4">{error}</p>
            <Link
              to="/"
              className="text-[#34A853] hover:underline font-medium"
            >
              Retour Ã  l'accueil
            </Link>
          </div>
        </main>
        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-8">
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
            {error}
          </div>
        )}

        {parking && (
          <>
            {/* En-tÃªte du parking */}
            <div className="mb-8">
              <Link
                to="/"
                className="text-[#34A853] hover:underline font-medium mb-4 inline-block"
              >
                â† Retour Ã  la liste
              </Link>
              <h1 className="text-4xl font-bold mb-4 text-gray-800">
                {parking.nom}
              </h1>
              <p className="text-lg text-gray-600">{parking.adresse}</p>
            </div>

            {/* Informations du parking */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
              <div className="bg-white rounded-xl shadow-md p-6">
                <h2 className="text-2xl font-bold mb-4 text-gray-800">
                  Informations
                </h2>
                <div className="space-y-3">
                  <p>
                    <span className="font-semibold">Places disponibles:</span>{" "}
                    {parking.places_disponibles || parking.nombre_places} / {parking.nombre_places}
                  </p>
                  <p>
                    <span className="font-semibold">Horaires:</span>{" "}
                    {parking.horaire_ouverture} - {parking.horaire_fermeture}
                  </p>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-md p-6">
                <h2 className="text-2xl font-bold mb-4 text-gray-800">
                  Tarifs
                </h2>
                <div className="space-y-3">
                  <p>
                    <span className="font-semibold">Horaire:</span>{" "}
                    {parking.tarif_horaire} â‚¬
                  </p>
                  <p>
                    <span className="font-semibold">Journalier:</span>{" "}
                    {parking.tarif_journalier} â‚¬
                  </p>
                  <p>
                    <span className="font-semibold">Mensuel:</span>{" "}
                    {parking.tarif_mensuel} â‚¬
                  </p>
                </div>
              </div>
            </div>

            {/* Formulaire de rÃ©servation */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h2 className="text-2xl font-bold mb-4 text-gray-800">
                RÃ©server ce parking
              </h2>
              
              {!showReservationForm ? (
                <button
                  onClick={() => setShowReservationForm(true)}
                  className="bg-[#34A853] text-white px-6 py-3 rounded-lg hover:bg-[#2d8f45] transition font-medium"
                >
                  RÃ©server
                </button>
              ) : (
                <form onSubmit={handleReserve} className="space-y-4">
                  <div>
                    <label className="block text-gray-700 font-medium mb-2">
                      Type de rÃ©servation
                    </label>
                    <div className="flex gap-4">
                      <label className="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="type"
                          value="horaire"
                          checked={reservationForm.type === "horaire"}
                          onChange={(e) =>
                            setReservationForm({
                              ...reservationForm,
                              type: e.target.value,
                            })
                          }
                          className="mr-2"
                        />
                        <span>Horaire</span>
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="type"
                          value="journalier"
                          checked={reservationForm.type === "journalier"}
                          onChange={(e) =>
                            setReservationForm({
                              ...reservationForm,
                              type: e.target.value,
                            })
                          }
                          className="mr-2"
                        />
                        <span>Journalier</span>
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="type"
                          value="mensuel"
                          checked={reservationForm.type === "mensuel"}
                          onChange={(e) =>
                            setReservationForm({
                              ...reservationForm,
                              type: e.target.value,
                            })
                          }
                          className="mr-2"
                        />
                        <span>Mensuel</span>
                      </label>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-gray-700 font-medium mb-2">
                        Date et heure de dÃ©but
                      </label>
                      <input
                        type="datetime-local"
                        value={reservationForm.date_debut}
                        onChange={(e) =>
                          setReservationForm({
                            ...reservationForm,
                            date_debut: e.target.value,
                          })
                        }
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#34A853]"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-gray-700 font-medium mb-2">
                        Date et heure de fin
                      </label>
                      <input
                        type="datetime-local"
                        value={reservationForm.date_fin}
                        onChange={(e) =>
                          setReservationForm({
                            ...reservationForm,
                            date_fin: e.target.value,
                          })
                        }
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#34A853]"
                        required
                      />
                    </div>
                  </div>

                  {reservationForm.date_debut && reservationForm.date_fin && (
                    <div className="bg-gray-50 rounded-lg p-4">
                      <p className="font-semibold text-gray-800">
                        Prix estimÃ©: {calculatePrice()} â‚¬
                      </p>
                    </div>
                  )}

                  <div className="flex gap-2">
                    <button
                      type="submit"
                      className="bg-[#34A853] text-white px-6 py-3 rounded-lg hover:bg-[#2d8f45] transition font-medium"
                    >
                      Confirmer la rÃ©servation
                    </button>
                    <button
                      type="button"
                      onClick={() => setShowReservationForm(false)}
                      className="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition"
                    >
                      Annuler
                    </button>
                  </div>
                </form>
              )}
            </div>
          </>
        )}
      </main>
      <Footer />
    </div>
  );
}




================================================
FILE: frontend/src/pages/Register.jsx
================================================
import React, { useState } from "react";
import { useNavigate, Link } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function Register() {
  const navigate = useNavigate();
  const [form, setForm] = useState({
    firstname: "",
    lastname: "",
    email: "",
    password: "",
    role: "user",
  });
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");
  const [loading, setLoading] = useState(false);

  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

const handleSubmit = async (e) => {
  e.preventDefault();
  setError("");
  setSuccess("");
    
    // Validations cÃ´tÃ© client
    if (!form.firstname || !form.lastname || !form.email || !form.password) {
      setError("Veuillez remplir tous les champs");
      return;
    }
    
    if (form.firstname.length < 2) {
      setError("Le prÃ©nom doit contenir au moins 2 caractÃ¨res");
      return;
    }
    
    if (form.lastname.length < 2) {
      setError("Le nom doit contenir au moins 2 caractÃ¨res");
      return;
    }
    
    if (!form.email.includes('@') || !form.email.includes('.')) {
      setError("Veuillez entrer une adresse email valide");
      return;
    }
    
    if (form.password.length < 6) {
      setError("Le mot de passe doit contenir au moins 6 caractÃ¨res");
      return;
    }
    
    if (!form.role) {
      setError("Veuillez sÃ©lectionner un type de compte");
      return;
    }
    
  setLoading(true);

  try {
      // PrÃ©parer les donnÃ©es
    const userData = {
        firstname: form.firstname.trim(),
        lastname: form.lastname.trim(),
        email: form.email.trim().toLowerCase(),
        password: form.password,
        role: form.role
      };
      
      const result = await apiService.register(userData);

    if (result.success && result.token && result.user) {
        // Sauvegarder dans localStorage
      // PLUS DE TOKEN, on stocke juste le user
      localStorage.setItem("user", JSON.stringify(result.user));

        console.log('âœ… Token sauvegardÃ©:', result.token);
        console.log('âœ… Utilisateur sauvegardÃ©:', result.user);
        
      setSuccess("âœ… Compte crÃ©Ã© avec succÃ¨s ! Redirection en cours...");
        
        // Redirection selon le rÃ´le
      setTimeout(() => {
        if (result.user.role === "owner") {
          navigate("/dashboard-owner", { replace: true });
        } else {
          navigate("/dashboard-user", { replace: true });
        }
      }, 1500);
      } else {
        setError("Erreur lors de la crÃ©ation du compte. Veuillez rÃ©essayer.");
      }
  } catch (err) {
      console.error('Erreur inscription:', err);
    setError(err.message || "Erreur lors de l'inscription. Veuillez rÃ©essayer.");
  } finally {
    setLoading(false);
  }
};

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-br from-gray-50 to-white">
      <Header />
      <main className="flex-1 flex items-center justify-center py-32 px-6">
        <div className="w-full max-w-md">
          <div className="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
            {/* Logo */}
            <div className="flex justify-center mb-8">
              <div className="w-16 h-16 bg-gray-900 rounded-full flex items-center justify-center">
                <span className="text-white text-2xl font-bold">P</span>
              </div>
            </div>

            <h1 className="text-4xl font-light text-center mb-3 text-gray-900 tracking-tight">
              Inscription
            </h1>
            <p className="text-center text-gray-500 mb-10 font-light">
              CrÃ©ez votre compte en quelques instants
            </p>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-gray-700 font-light mb-3 text-sm">
                    PrÃ©nom
                  </label>
                  <input
                    name="firstname"
                    placeholder="John"
                    value={form.firstname}
                    onChange={handleChange}
                    className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                    required
                  />
                </div>
                <div>
                  <label className="block text-gray-700 font-light mb-3 text-sm">
                    Nom
                  </label>
                  <input
                    name="lastname"
                    placeholder="Doe"
                    value={form.lastname}
                    onChange={handleChange}
                    className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                    required
                  />
                </div>
              </div>

              <div>
                <label className="block text-gray-700 font-light mb-3 text-sm">
                  Adresse email
                </label>
                <input
                  type="email"
                  name="email"
                  placeholder="votre@email.com"
                  value={form.email}
                  onChange={handleChange}
                  className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                  required
                />
              </div>

              <div>
                <label className="block text-gray-700 font-light mb-3 text-sm">
                  Mot de passe
                </label>
                <input
                  type="password"
                  name="password"
                  placeholder="Minimum 6 caractÃ¨res"
                  value={form.password}
                  onChange={handleChange}
                  className="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 focus:bg-white transition-all duration-300 font-light"
                  required
                  minLength="6"
                />
              </div>

              <div>
                <label className="block text-gray-700 font-light mb-4 text-sm">
                  Je m'inscris en tant que
                </label>
                <div className="grid grid-cols-2 gap-4">
                  <label className={`cursor-pointer rounded-2xl border-2 p-5 transition-all duration-300 ${
                    form.role === "user" 
                      ? 'border-gray-900 bg-gray-900 text-white shadow-lg' 
                      : 'border-gray-200 bg-gray-50 hover:border-gray-300 hover:bg-white'
                  }`}>
                    <input
                      type="radio"
                      name="role"
                      value="user"
                      checked={form.role === "user"}
                      onChange={handleChange}
                      className="sr-only"
                      required
                    />
                    <div className="text-center">
                      <div className={`font-medium mb-2 ${form.role === "user" ? 'text-white' : 'text-gray-900'}`}>
                        Utilisateur
                      </div>
                      <div className={`text-xs ${form.role === "user" ? 'text-white/80' : 'text-gray-500'} font-light`}>
                        Je cherche un parking
                      </div>
                    </div>
                  </label>
                  
                  <label className={`cursor-pointer rounded-2xl border-2 p-5 transition-all duration-300 ${
                    form.role === "owner" 
                      ? 'border-gray-900 bg-gray-900 text-white shadow-lg' 
                      : 'border-gray-200 bg-gray-50 hover:border-gray-300 hover:bg-white'
                  }`}>
                    <input
                      type="radio"
                      name="role"
                      value="owner"
                      checked={form.role === "owner"}
                      onChange={handleChange}
                      className="sr-only"
                      required
                    />
                    <div className="text-center">
                      <div className={`font-medium mb-2 ${form.role === "owner" ? 'text-white' : 'text-gray-900'}`}>
                        PropriÃ©taire
                      </div>
                      <div className={`text-xs ${form.role === "owner" ? 'text-white/80' : 'text-gray-500'} font-light`}>
                        Je loue mon parking
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              {success && (
                <div className="bg-green-50 border border-green-200 text-green-700 px-5 py-4 rounded-2xl text-sm font-light flex items-center gap-2">
                  <span>âœ…</span>
                  <span>{success}</span>
                </div>
              )}

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-5 py-4 rounded-2xl text-sm font-light flex items-center gap-2 animate-pulse">
                  <span>âŒ</span>
                  <span>{error}</span>
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gray-900 text-white py-5 rounded-2xl hover:bg-gray-800 transition-all duration-300 font-light text-base disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl hover:-translate-y-0.5"
              >
                {loading ? "CrÃ©ation en cours..." : "CrÃ©er mon compte"}
              </button>
            </form>

            <div className="mt-10 text-center">
              <p className="text-gray-500 font-light text-sm">
                DÃ©jÃ  un compte ?{" "}
                <Link
                  to="/login"
                  className="text-gray-900 hover:text-gray-700 font-medium transition-colors"
                >
                  Se connecter
                </Link>
              </p>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/pages/Reservation.jsx
================================================
import React, { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { apiService } from '../services/apiService';
import Header from '../components/Header';
import Footer from '../components/Footer';

const Reservation = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const [loading, setLoading] = useState(false);
  const [parkings, setParkings] = useState([]);
  const [filteredParkings, setFilteredParkings] = useState([]);
  const [selectedParking, setSelectedParking] = useState(null);
  const [showBookingModal, setShowBookingModal] = useState(false);

  // ParamÃ¨tres de recherche
  const [searchParams, setSearchParams] = useState({
    ville: location.state?.ville || '',
    vehicule: location.state?.vehicule || 'Voiture',
    dateDebut: location.state?.dateDebut || '',
    dateFin: location.state?.dateFin || '',
    sort: 'distance'
  });

  // Filtres avancÃ©s
  const [filters, setFilters] = useState({
    prixMax: 10,
    noteMin: 0,
    services: []
  });

  const [activeFilter, setActiveFilter] = useState(null);
  const [viewMode, setViewMode] = useState('list'); // 'list' or 'map' for mobile

  // Charger les parkings au montage (toujours)
  useEffect(() => {
    loadParkings();
  }, []);

  // Filtrer les parkings quand les paramÃ¨tres changent
  useEffect(() => {
    applyFilters();
  }, [parkings, filters, searchParams]);

  const loadParkings = async () => {
    setLoading(true);
    try {
      const params = {
        ...searchParams,
        dateDebut: searchParams.dateDebut || undefined,
        dateFin: searchParams.dateFin || undefined
      };
      const response = await apiService.searchParkings(params);
      console.log('âœ… Parkings chargÃ©s:', response.parkings.length);
      setParkings(response.parkings || []);
      // Appliquer les filtres aprÃ¨s le chargement
      setTimeout(() => {
        applyFiltersToResults(response.parkings || []);
      }, 100);
    } catch (error) {
      console.error('âŒ Erreur chargement parkings:', error);
      setParkings([]);
      setFilteredParkings([]);
    } finally {
      setLoading(false);
    }
  };

  const applyFiltersToResults = (parkingsList) => {
    let results = [...parkingsList];
    results = results.filter(p => p.tarif_horaire <= filters.prixMax);
    results = results.filter(p => p.note >= filters.noteMin);
    if (filters.services.length > 0) {
      results = results.filter(p =>
        filters.services.every(service => p.services.includes(service))
      );
    }
    console.log('âœ… Parkings filtrÃ©s:', results.length);
    setFilteredParkings(results);
  };

  const applyFilters = () => {
    if (parkings.length === 0) return;
    applyFiltersToResults(parkings);
  };

  const handleSearch = () => {
    loadParkings();
  };

  const handleBooking = (parking) => {
    const token = localStorage.getItem('token');
    if (!token) {
      navigate('/login', { state: { from: '/reservation', parking } });
      return;
    }
    setSelectedParking(parking);
    setShowBookingModal(true);
  };

  const calculatePrice = (parking) => {
    if (!searchParams.dateDebut || !searchParams.dateFin) {
      return parking.tarif_horaire.toFixed(2) + '/h';
    }
    const debut = new Date(searchParams.dateDebut);
    const fin = new Date(searchParams.dateFin);
    const diffMs = fin - debut;
    const diffMinutes = diffMs / (1000 * 60);
    const diffHeures = diffMinutes / 60;
    const diffJours = diffHeures / 24;
    if (diffJours < 1) {
      const heures = Math.ceil(diffHeures);
      return (heures * parking.tarif_horaire).toFixed(2);
    }
    if (diffJours <= 30) {
      const jours = Math.ceil(diffJours);
      return (jours * parking.tarif_journalier).toFixed(2);
    }
    const mois = Math.ceil(diffJours / 30);
    return (mois * parking.tarif_mensuel).toFixed(2);
  };

  const servicesDisponibles = ['Couvert', 'GardÃ©', 'SÃ©curisÃ©', 'VidÃ©o-surveillance', 'Bornes Ã©lectriques', 'Lavage auto', 'Accessible PMR'];

  return (
    <div className="flex flex-col h-screen bg-white overflow-hidden">
        <Header />
        
        <div className="flex flex-1 pt-[72px] overflow-hidden">
            {/* COLONNE GAUCHE : LISTE + RECHERCHE */}
            <div className={`w-full lg:w-[650px] flex flex-col h-full border-r border-gray-200 bg-white z-10 shadow-xl ${viewMode === 'map' ? 'hidden lg:flex' : 'flex'}`}>
                
                {/* BARRE DE RECHERCHE (Sticky) */}
                <div className="p-4 border-b border-gray-200 bg-white shadow-sm z-20">
                    <div className="flex gap-2 mb-3">
                        <div className="relative flex-1">
                            <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            </div>
                            <input 
                                type="text" 
                                placeholder="OÃ¹ cherchez-vous ?" 
                                className="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg font-medium text-gray-900 focus:ring-2 focus:ring-black transition-all"
                                value={searchParams.ville}
                                onChange={(e) => setSearchParams({ ...searchParams, ville: e.target.value })}
                            />
                        </div>
                        <button onClick={handleSearch} className="bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-primary-600 transition-colors shadow-md">
                            Rechercher
                        </button>
                    </div>

                    {/* FILTRES RAPIDES */}
                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                         {/* Date Picker Button */}
                         <div className="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-full text-sm font-medium text-gray-700 cursor-pointer hover:border-black transition-colors whitespace-nowrap group relative">
                            <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <span>Dates</span>
                            {/* Date Inputs Popup (Simplified for demo) */}
                            <div className="absolute top-full left-0 mt-2 p-4 bg-white shadow-xl rounded-xl border border-gray-100 hidden group-hover:block min-w-[300px] z-50">
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase">DÃ©but</label>
                                        <input type="datetime-local" value={searchParams.dateDebut} onChange={(e) => setSearchParams({ ...searchParams, dateDebut: e.target.value })} className="w-full text-sm border-gray-200 rounded-md" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase">Fin</label>
                                        <input type="datetime-local" value={searchParams.dateFin} onChange={(e) => setSearchParams({ ...searchParams, dateFin: e.target.value })} className="w-full text-sm border-gray-200 rounded-md" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Vehicle Type */}
                        <select 
                            value={searchParams.vehicule}
                            onChange={(e) => setSearchParams({ ...searchParams, vehicule: e.target.value })}
                            className="bg-white border border-gray-200 px-3 py-2 rounded-full text-sm font-medium text-gray-700 cursor-pointer hover:border-black transition-colors outline-none appearance-none"
                        >
                            <option value="Voiture">ğŸš— Voiture</option>
                            <option value="Moto">ğŸï¸ Moto</option>
                            <option value="VÃ©lo">ğŸš² VÃ©lo</option>
                        </select>

                        {servicesDisponibles.slice(0, 3).map(service => (
                            <button
                                key={service}
                                onClick={() => {
                                    if (filters.services.includes(service)) {
                                        setFilters({ ...filters, services: filters.services.filter(s => s !== service) });
                                    } else {
                                        setFilters({ ...filters, services: [...filters.services, service] });
                                    }
                                }}
                                className={`px-3 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap border ${
                                    filters.services.includes(service)
                                        ? 'bg-black text-white border-black'
                                        : 'bg-white text-gray-700 border-gray-200 hover:border-black'
                                }`}
                            >
                                {service}
                            </button>
                        ))}
                    </div>
                </div>

                {/* LISTE DES RÃ‰SULTATS (Scrollable) */}
                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                    <div className="flex justify-between items-center mb-2 px-1">
                        <h2 className="text-xl font-bold text-gray-900">{filteredParkings.length} parkings disponibles</h2>
                        <span className="text-sm text-gray-500 font-medium cursor-pointer hover:text-black">Trier par pertinence â–¼</span>
                    </div>

                    {loading ? (
                         <div className="flex justify-center py-20"><div className="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div></div>
                    ) : (
                        filteredParkings.map(parking => (
                            <ParkingCard
                                key={parking.id}
                                parking={parking}
                                price={calculatePrice(parking)}
                                onBook={() => handleBooking(parking)}
                            />
                        ))
                    )}
                    {filteredParkings.length === 0 && !loading && (
                        <div className="text-center py-20 text-gray-500">Aucun parking trouvÃ© dans cette zone.</div>
                    )}
                </div>
            </div>

            {/* COLONNE DROITE : CARTE (Full height) */}
            <div className={`flex-1 bg-gray-200 relative ${viewMode === 'list' ? 'hidden lg:block' : 'block'}`}>
                {/* Placeholder Carte Type Google Maps */}
                <div className="absolute inset-0 bg-[#e5e7eb] flex items-center justify-center overflow-hidden">
                    <div className="text-center opacity-30 select-none pointer-events-none">
                        <div className="text-9xl mb-4">ğŸ—ºï¸</div>
                        <p className="text-3xl font-bold text-gray-400">Carte Interactive</p>
                    </div>
                    {/* Fake Map Pins */}
                    {filteredParkings.map((p, i) => (
                        <div key={p.id} className="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group" style={{ top: `${30 + (i * 15) % 60}%`, left: `${30 + (i * 20) % 60}%` }}>
                            <div className="bg-white px-3 py-1.5 rounded-lg shadow-lg font-bold text-sm border border-gray-200 group-hover:bg-black group-hover:text-white transition-colors">
                                {calculatePrice(p)}â‚¬
                            </div>
                            <div className="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-white mx-auto group-hover:border-t-black"></div>
                        </div>
                    ))}
                </div>

                {/* Mobile Toggle Button */}
                <button 
                    className="lg:hidden absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full shadow-xl font-bold z-50 flex items-center gap-2"
                    onClick={() => setViewMode(viewMode === 'list' ? 'map' : 'list')}
                >
                    {viewMode === 'list' ? 'ğŸ—ºï¸ Carte' : 'ğŸ“‹ Liste'}
                </button>
            </div>
        </div>

        {/* Modal de rÃ©servation */}
        {showBookingModal && selectedParking && (
            <BookingModal
                parking={selectedParking}
                searchParams={searchParams}
                price={calculatePrice(selectedParking)}
                onClose={() => {
                    setShowBookingModal(false);
                    setSelectedParking(null);
                }}
                onSuccess={() => {
                    setShowBookingModal(false);
                    setSelectedParking(null);
                    navigate('/mes-reservations');
                }}
            />
        )}
    </div>
  );
};

// --- COMPOSANTS ENFANTS ---

const ParkingCard = ({ parking, price, onBook }) => {
    return (
        <div className="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all duration-200 cursor-pointer group flex gap-4">
            {/* Image */}
            <div className="w-32 h-32 bg-gray-100 rounded-lg flex-shrink-0 relative overflow-hidden">
                <div className="absolute inset-0 flex items-center justify-center text-4xl">ğŸ…¿ï¸</div>
                {parking.note >= 4.5 && (
                    <div className="absolute top-2 left-2 bg-primary text-white text-[10px] font-bold px-2 py-0.5 rounded-sm uppercase tracking-wide">
                        Coup de cÅ“ur
                    </div>
                )}
            </div>

            {/* Content */}
            <div className="flex-1 flex flex-col justify-between">
                <div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-lg text-gray-900 leading-tight mb-1">{parking.nom}</h3>
                        <div className="flex items-center gap-1 bg-gray-50 px-1.5 py-0.5 rounded text-xs font-bold text-gray-900">
                            <span>â˜…</span> {parking.note}
                        </div>
                    </div>
                    <p className="text-gray-500 text-sm mb-2 truncate">{parking.adresse}</p>
                    
                    {/* Tags */}
                    <div className="flex flex-wrap gap-1 mb-2">
                        <span className="text-[10px] font-medium bg-gray-100 text-gray-600 px-2 py-0.5 rounded">{parking.places_disponibles} places dispo</span>
                        {parking.services.slice(0, 2).map(s => (
                            <span key={s} className="text-[10px] font-medium bg-gray-100 text-gray-600 px-2 py-0.5 rounded">{s}</span>
                        ))}
                    </div>
                </div>

                <div className="flex items-end justify-between mt-2">
                    <div>
                        <span className="text-lg font-bold text-primary">{price}â‚¬</span>
                        <span className="text-xs text-gray-500 ml-1">/ total</span>
                    </div>
                    <button 
                        onClick={(e) => {
                            e.stopPropagation();
                            onBook();
                        }}
                        className="bg-white border border-gray-300 text-gray-900 px-4 py-2 rounded-lg text-sm font-bold hover:bg-black hover:text-white hover:border-black transition-all"
                    >
                        RÃ©server
                    </button>
                </div>
            </div>
        </div>
    );
};

// Modal ultra-minimaliste
const BookingModal = ({ parking, searchParams, price, onClose, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    dateDebut: searchParams.dateDebut,
    dateFin: searchParams.dateFin,
    vehicule: searchParams.vehicule,
    immatriculation: ''
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const debut = new Date(formData.dateDebut);
    const fin = new Date(formData.dateFin);
    const now = new Date();
    
    if (debut < now) {
      alert('âŒ La date de dÃ©but ne peut pas Ãªtre dans le passÃ©');
      return;
    }
    
    if (fin <= debut) {
      alert('âŒ La date de fin doit Ãªtre aprÃ¨s la date de dÃ©but');
      return;
    }
    
    const diffMinutes = (fin - debut) / (1000 * 60);
    if (diffMinutes < 30) {
      alert('âŒ DurÃ©e minimum: 30 minutes');
      return;
    }
    
    setLoading(true);

    try {
      const token = localStorage.getItem('token');
      const response = await apiService.reserveParking(token, parking.id, {
        date_debut: formData.dateDebut,
        date_fin: formData.dateFin,
        vehicule: formData.vehicule,
        immatriculation: formData.immatriculation
      });

      if (response.success) {
        alert(`âœ… ${response.message}\n\nğŸ’° ${response.reservation.montant}â‚¬`);
        onSuccess();
      }
    } catch (error) {
      alert('âŒ ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white border-b border-gray-100 px-8 py-6 flex items-center justify-between rounded-t-3xl">
          <h2 className="text-3xl font-extralight text-gray-900">Confirmer</h2>
          <button
            onClick={onClose}
            className="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center text-gray-600"
          >
            âœ•
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-8">
          <div className="bg-gray-50 rounded-2xl p-6 mb-8">
            <h3 className="text-xl font-extralight text-gray-900 mb-2">{parking.nom}</h3>
            <p className="text-gray-500 font-light mb-4">ğŸ“ {parking.adresse}</p>
            <div className="flex items-center justify-between pt-4 border-t border-gray-200">
              <span className="text-gray-500 font-light">Total</span>
              <span className="text-3xl font-extralight text-gray-900">{price}â‚¬</span>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <label className="block text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">
                DÃ©but
              </label>
              <input
                type="datetime-local"
                required
                value={formData.dateDebut}
                onChange={(e) => setFormData({ ...formData, dateDebut: e.target.value })}
                className="w-full px-6 py-4 bg-gray-50 rounded-xl border-0 focus:bg-white focus:ring-2 focus:ring-gray-900 transition-all text-gray-900 font-light"
              />
            </div>

            <div>
              <label className="block text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">
                Fin
              </label>
              <input
                type="datetime-local"
                required
                value={formData.dateFin}
                onChange={(e) => setFormData({ ...formData, dateFin: e.target.value })}
                className="w-full px-6 py-4 bg-gray-50 rounded-xl border-0 focus:bg-white focus:ring-2 focus:ring-gray-900 transition-all text-gray-900 font-light"
              />
            </div>

            <div>
              <label className="block text-xs font-light text-gray-500 mb-2 uppercase tracking-wider">
                VÃ©hicule
              </label>
              <select
                required
                value={formData.vehicule}
                onChange={(e) => setFormData({ ...formData, vehicule: e.target.value })}
                className="w-full px-6 py-4 bg-gray-50 rounded-xl border-0 focus:bg-white focus:ring-2 focus:ring-gray-900 transition-all text-gray-900 font-light"
              >
                {parking.type_vehicules.map(type => (
                  <option key={type} value={type}>{type}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="flex gap-4 mt-8">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-4 bg-gray-100 text-gray-700 rounded-xl font-light hover:bg-gray-200 transition-all"
            >
              Annuler
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 py-4 bg-gray-900 text-white rounded-xl font-light hover:bg-gray-800 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'RÃ©servation...' : 'Confirmer'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Reservation;



================================================
FILE: frontend/src/pages/UserDashboard.jsx
================================================
import React, { useState, useEffect } from "react";
import { useNavigate, Link } from "react-router-dom";
import Header from "../components/Header";
import Footer from "../components/Footer";
import { apiService } from "../services/apiService";

export default function UserDashboard() {
  const navigate = useNavigate();

  const [user, setUser] = useState(() => {
    const userStr = localStorage.getItem("user");
    return userStr ? JSON.parse(userStr) : null;
  });

  const [reservations, setReservations] = useState([]);
  const [stationnements, setStationnements] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  // RÃ©cupÃ©rer les infos de l'utilisateur depuis le back
  useEffect(() => {
    const fetchUser = async () => {
      setLoading(true);
      setError("");

      try {
        const currentUser = await apiService.getCurrentUser();

        if (!currentUser) {
          // Pas connectÃ© cÃ´tÃ© back â†’ on redirige
          navigate("/login");
          return;
        }

        setUser(currentUser);
        // On synchronise localStorage au cas oÃ¹
        localStorage.setItem("user", JSON.stringify(currentUser));

        // TODO: plus tard, quand les API existeront :
        // const reservationsRes = await apiService.getReservations();
        // setReservations(reservationsRes.reservations || []);
        // const stationnementsRes = await apiService.getStationnements();
        // setStationnements(stationnementsRes.stationnements || []);
      } catch (err) {
        console.error(err);
        setError(
          err.message || "Erreur lors du chargement des informations utilisateur"
        );
        navigate("/login");
      } finally {
        setLoading(false);
      }
    };

    fetchUser();
  }, [navigate]);

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <Header />
      <main className="flex-1 pt-28">
        {/* Hero Section */}
        <section className="bg-zenpark text-white py-12">
          <div className="container mx-auto px-6 lg:px-12">
            <h1 className="text-4xl font-serif font-normal mb-2">
              Bonjour {user?.firstname || 'Utilisateur'}
        </h1>
            <p className="text-white/90 text-lg">
              Bienvenue sur votre espace personnel
            </p>
            {user?.role && (
              <p className="mt-2 text-white/80 text-sm">
                RÃ´le :{" "}
                <span className="inline-block px-3 py-1 rounded-full bg-white/10 border border-white/20">
                  {user.role === "owner" ? "PropriÃ©taire de parking" : "Client"}
                </span>
              </p>
            )}
          </div>
        </section>

        <div className="container mx-auto px-6 lg:px-12 py-12">
        {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl mb-8">
            {error}
          </div>
        )}

          {/* Quick Actions */}
          <div className="mb-12">
          <Link
            to="/"
              className="inline-block bg-zenpark text-white px-8 py-4 rounded-xl hover:bg-zenpark-700 transition font-medium"
          >
              Nouvelle rÃ©servation
          </Link>
        </div>

        {/* Section RÃ©servations */}
        <section className="mb-12">
            <h2 className="text-3xl font-serif font-normal mb-6 text-gray-900">
            Mes rÃ©servations
          </h2>

          {loading ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
              <p className="text-gray-600">Chargement...</p>
            </div>
          ) : reservations.length === 0 ? (
              <div className="bg-white rounded-2xl shadow p-12 text-center">
                <p className="text-gray-600 mb-6">
                Vous n'avez aucune rÃ©servation pour le moment.
              </p>
              <Link
                to="/"
                  className="inline-block bg-zenpark text-white px-8 py-3 rounded-xl hover:bg-zenpark-700 transition font-medium"
              >
                RÃ©server une place
              </Link>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {reservations.map((reservation) => (
                <div
                  key={reservation.id}
                    className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition"
                >
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">
                    {reservation.parking_nom || "Parking"}
                  </h3>
                    
                  <div className="space-y-2 mb-4">
                    <p className="text-gray-600 text-sm">
                      {reservation.date_debut && reservation.date_fin
                        ? `${new Date(reservation.date_debut).toLocaleDateString('fr-FR')} - ${new Date(reservation.date_fin).toLocaleDateString('fr-FR')}`
                        : "Date non spÃ©cifiÃ©e"}
                    </p>
                    <p className="text-gray-700">
                        <span className="font-medium">Statut:</span>{" "}
                        <span className={`inline-block px-3 py-1 rounded-full text-xs font-medium ${
                        reservation.statut === 'confirmÃ©e' 
                          ? 'bg-green-100 text-green-800' 
                          : 'bg-yellow-100 text-yellow-800'
                      }`}>
                        {reservation.statut || "En attente"}
                      </span>
                    </p>
                    {reservation.montant && (
                        <p className="text-lg font-semibold text-zenpark">
                        {reservation.montant} â‚¬
                      </p>
                    )}
                  </div>
                    
                  <Link
                    to={`/parking/${reservation.parking_id}`}
                      className="block w-full text-center bg-gray-100 text-gray-900 py-2 rounded-xl hover:bg-gray-200 transition font-medium"
                  >
                    Voir les dÃ©tails
                  </Link>
                </div>
              ))}
            </div>
          )}
        </section>

          {/* Section Stationnements actifs */}
          {stationnements.length > 0 && (
        <section className="mb-12">
              <h2 className="text-3xl font-serif font-normal mb-6 text-gray-900">
                Stationnements actifs
          </h2>
              
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {stationnements.map((stationnement) => (
                <div
                  key={stationnement.id}
                    className="bg-white rounded-2xl shadow p-6"
                >
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="text-xl font-semibold text-gray-900">
                    {stationnement.parking_nom || "Parking"}
                  </h3>
                      <span className="flex h-3 w-3 relative">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                      </span>
                    </div>

                    <p className="text-gray-600 text-sm">
                      DÃ©but :{" "}
                      {stationnement.date_debut
                        ? new Date(
                            stationnement.date_debut
                          ).toLocaleString("fr-FR")
                        : "N/A"}
                    </p>
                </div>
              ))}
            </div>
            </section>
          )}
          </div>
      </main>
      <Footer />
    </div>
  );
}



================================================
FILE: frontend/src/routes/index.jsx
================================================
// Configuration des routes de l'application
export const routes = {
  home: '/',
  login: '/login',
  register: '/register',
  dashboardUser: '/dashboard-user',
  dashboardOwner: '/dashboard-owner',
  parkingDetails: '/parking/:id',
};




================================================
FILE: frontend/src/services/apiService.js
================================================
<<<<<<< HEAD
// frontend/src/services/apiService.js
const API_BASE_URL = "http://localhost:8001";

async function handleResponse(response) {
  let data = null;
  try {
    data = await response.json();
  } catch {
    // certains endpoints peuvent ne pas renvoyer de JSON
  }

  if (!response.ok) {
    const message =
      data?.error ||
      data?.message ||
      `Erreur API (${response.status})`;
    throw new Error(message);
  }

  return data;
}

/**
 * Helper interne :
 * - fait le fetch avec credentials: "include"
 * - sur 401, tente un refresh puis rejoue la requÃªte une fois
 */
async function authFetch(path, options = {}, retry = true) {
  const res = await fetch(`${API_BASE_URL}${path}`, {
    credentials: "include",
    ...options,
  });

  if (res.status === 401 && retry) {
    // tentative de refresh silencieux
    const refreshed = await apiService.refresh();
    if (!refreshed) {
      return res; // token mort, on laisse la 401
    }

    // on rejoue la requÃªte UNE seule fois
    return authFetch(path, options, false);
  }

  return res;
}

=======
const API_BASE_URL = 'http://localhost:8001/api';

const handleResponse = async (response) => {
  const data = await response.json();
  if (!response.ok) {
    const error = (data && data.error) || response.statusText;
    throw new Error(error);
  }
  return data;
};

>>>>>>> origin/Rayane
export const apiService = {
  /**
   * Connexion utilisateur :
   * - POST /api/auth/login
   * - puis /api/me via authFetch (token fraÃ®chement posÃ©)
   */
  async login(email, password) {
<<<<<<< HEAD
    const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ email, password }),
    });

    const data = await handleResponse(res);

    if (data.status === "2fa_required") {
      throw new Error(
        "Double authentification requise (2FA), pas encore gÃ©rÃ©e cÃ´tÃ© interface."
      );
    }

    const meRes = await authFetch("/api/me", {
      method: "GET",
    });

    const me = await handleResponse(meRes);

    return {
      success: true,
      user: {
        id: me.id,
        email: me.email,
        firstname: me.firstname,
        lastname: me.lastname,
        role: me.role ? me.role.toLowerCase().trim() : "user",

      },
    };
  },

  /**
   * Inscription :
   * - POST /api/auth/register
   * - puis login auto
   */
  async register(form) {
    const res = await fetch(`${API_BASE_URL}/api/auth/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        firstname: form.firstname,
        lastname: form.lastname,
        email: form.email,
        password: form.password,
        role: form.role === "owner" ? "OWNER" : "USER",
      }),
    });

    const data = await handleResponse(res);

    // le back pose dÃ©jÃ  les cookies ici.
    // maintenant on rÃ©cupÃ¨re /api/me comme dans login()
    const meRes = await authFetch("/api/me", { method: "GET" });
    const me = await handleResponse(meRes);

    return {
      success: true,
      user: {
        id: me.id,
        email: me.email,
        role: me.role ? me.role.toLowerCase().trim() : "user",
        firstname: me.firstname,
        lastname: me.lastname,
      },
    };
  }
  ,

  /**
   * RÃ©cupÃ¨re l'utilisateur courant :
   * - GET /api/me
   * - si 401 â†’ tente un refresh â†’ rejoue /api/me
   * - si toujours 401 â†’ retourne null
   */
  async getCurrentUser() {
    const res = await authFetch("/api/me", { method: "GET" });

    if (res.status === 401) {
      return null;
    }

    const me = await handleResponse(res);

    return {
      id: me.id,
      email: me.email,
      firstname: me.firstname ?? null,
      lastname: me.lastname ?? null,
      role: me.role ? me.role.toLowerCase().trim() : "user",
    };
  },

  /**
   * Appelle /api/auth/refresh pour obtenir un nouveau ACCESS_TOKEN
   * Retourne true si Ã§a a marchÃ©, false sinon.
   */
  async refresh() {
    try {
      const res = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
        method: "POST",
        credentials: "include",
      });

      try {
        await handleResponse(res);
        return true;
      } catch {
        return false;
      }

    } catch {
      return false;
=======
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    return handleResponse(response);
  },

  /**
   * Inscription utilisateur
   */
  async register(userData) {
    const response = await fetch(`${API_BASE_URL}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData),
    });
    return handleResponse(response);
  },

  /**
   * Rechercher des parkings avec disponibilitÃ© en temps rÃ©el
   */
  async searchParkings(params = {}) {
    const query = new URLSearchParams();
    if (params.ville) query.append('ville', params.ville);
    if (params.vehicule) query.append('vehicule', params.vehicule);
    if (params.dateDebut) query.append('dateDebut', params.dateDebut);
    if (params.dateFin) query.append('dateFin', params.dateFin);
    if (params.sort) query.append('sort', params.sort);

    const response = await fetch(`${API_BASE_URL}/parkings?${query.toString()}`);
    return handleResponse(response);
  },

  /**
   * RÃ©cupÃ©rer les dÃ©tails d'un parking
   */
  async getParkingDetails(id) {
    const response = await fetch(`${API_BASE_URL}/parkings/${id}`);
    return handleResponse(response);
  },

  /**
   * VÃ©rifier la disponibilitÃ© d'un parking pour une pÃ©riode
   */
  async checkAvailability(parkingId, dateDebut, dateFin) {
    const response = await fetch(`${API_BASE_URL}/parkings/check-availability`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ parkingId, dateDebut, dateFin }),
    });
    return handleResponse(response);
  },

  /**
   * RÃ©server un parking
   */
  async reserveParking(token, parkingId, reservationData) {
    const response = await fetch(`${API_BASE_URL}/reservations`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        parkingId,
        ...reservationData
      }),
    });
    return handleResponse(response);
  },

  /**
   * RÃ©cupÃ©rer les rÃ©servations de l'utilisateur
   */
  async getReservations(token) {
    const response = await fetch(`${API_BASE_URL}/reservations`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    return handleResponse(response);
  },
  
  /**
   * Annuler une rÃ©servation
   */
  async cancelReservation(token, reservationId) {
      const response = await fetch(`${API_BASE_URL}/reservations/${reservationId}/cancel`, {
          method: 'POST',
           headers: {
            'Authorization': `Bearer ${token}`
          }
      });
      return handleResponse(response);
  },

  /**
   * RÃ©cupÃ©rer les stationnements actifs (dÃ©rivÃ© des rÃ©servations)
   */
  async getStationnements(token) {
    try {
        const data = await this.getReservations(token);
        const now = new Date();
        const active = (data.reservations || []).filter(r => {
            const start = new Date(r.date_debut);
            const end = new Date(r.date_fin);
            return r.statut === 'confirmÃ©e' && start <= now && end >= now;
        });
        return { success: true, stationnements: active };
    } catch (error) {
        console.error("Erreur getStationnements:", error);
        return { success: false, stationnements: [] };
>>>>>>> origin/Rayane
    }
  },

  /**
<<<<<<< HEAD
   * DÃ©connexion : purge les cookies cÃ´tÃ© back
   */
  async logout() {
    await fetch(`${API_BASE_URL}/api/auth/logout`, {
      method: "POST",
      credentials: "include",
    });
  },
};

export default apiService;
=======
   * --- OWNER METHODS ---
   */
  async getOwnerParkings(token) {
    const response = await fetch(`${API_BASE_URL}/owner/parkings`, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    return handleResponse(response);
  },

  async addParking(token, parkingData) {
    const response = await fetch(`${API_BASE_URL}/parkings`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(parkingData)
    });
    return handleResponse(response);
  },

  async getMonthlyRevenue(token) {
      const response = await fetch(`${API_BASE_URL}/owner/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
      });
      return handleResponse(response);
  },

  async getActiveReservations(token) {
      const response = await fetch(`${API_BASE_URL}/owner/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
      });
      return handleResponse(response);
  },

  async getActiveStationnements(token) {
      const response = await fetch(`${API_BASE_URL}/owner/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
      });
      return handleResponse(response);
  }
};
>>>>>>> origin/Rayane



================================================
FILE: frontend/src/UI/Countup.jsx
================================================
import { useInView, useMotionValue, useSpring } from 'motion/react';
import { useCallback, useEffect, useRef } from 'react';

export default function CountUp({
  to,
  from = 0,
  direction = 'up',
  delay = 0,
  duration = 2,
  className = '',
  startWhen = true,
  separator = '',
  onStart,
  onEnd
}) {
  const ref = useRef(null);
  const motionValue = useMotionValue(direction === 'down' ? to : from);

  const damping = 20 + 40 * (1 / duration);
  const stiffness = 100 * (1 / duration);

  const springValue = useSpring(motionValue, {
    damping,
    stiffness
  });

  const isInView = useInView(ref, { once: true, margin: '0px' });

  const getDecimalPlaces = num => {
    const str = num.toString();

    if (str.includes('.')) {
      const decimals = str.split('.')[1];

      if (parseInt(decimals) !== 0) {
        return decimals.length;
      }
    }

    return 0;
  };

  const maxDecimals = Math.max(getDecimalPlaces(from), getDecimalPlaces(to));

  const formatValue = useCallback(
    latest => {
      const hasDecimals = maxDecimals > 0;

      const options = {
        useGrouping: !!separator,
        minimumFractionDigits: hasDecimals ? maxDecimals : 0,
        maximumFractionDigits: hasDecimals ? maxDecimals : 0
      };

      const formattedNumber = Intl.NumberFormat('en-US', options).format(latest);

      return separator ? formattedNumber.replace(/,/g, separator) : formattedNumber;
    },
    [maxDecimals, separator]
  );

  useEffect(() => {
    if (ref.current) {
      ref.current.textContent = formatValue(direction === 'down' ? to : from);
    }
  }, [from, to, direction, formatValue]);

  useEffect(() => {
    if (isInView && startWhen) {
      if (typeof onStart === 'function') onStart();

      const timeoutId = setTimeout(() => {
        motionValue.set(direction === 'down' ? from : to);
      }, delay * 1000);

      const durationTimeoutId = setTimeout(
        () => {
          if (typeof onEnd === 'function') onEnd();
        },
        delay * 1000 + duration * 1000
      );

      return () => {
        clearTimeout(timeoutId);
        clearTimeout(durationTimeoutId);
      };
    }
  }, [isInView, startWhen, motionValue, direction, from, to, delay, onStart, onEnd, duration]);

  useEffect(() => {
    const unsubscribe = springValue.on('change', latest => {
      if (ref.current) {
        ref.current.textContent = formatValue(latest);
      }
    });

    return () => unsubscribe();
  }, [springValue, formatValue]);

  return <span className={className} ref={ref} />;
}



================================================
FILE: sql/001_init_core.sql
================================================
<<<<<<< HEAD
CREATE DATABASE IF NOT EXISTS parking_app
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE `parking_app`;

-- ============================================
-- TABLE: users (fusion des deux schÃ©mas)
-- ============================================
CREATE TABLE IF NOT EXISTS users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,

  -- IdentitÃ©
  email VARCHAR(160) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  firstname VARCHAR(100) NOT NULL,
  lastname VARCHAR(100) NOT NULL,

  -- RÃ´les
  role ENUM('USER','OWNER','ADMIN') NOT NULL DEFAULT 'USER',

  -- Abonnement utilisateur (facultatif selon ton projet)
  type_abonnement ENUM('gratuit', 'premium', 'business') NOT NULL DEFAULT 'gratuit',
  debut_abonnement DATE NULL,
  fin_abonnement DATE NULL,

  -- 2FA
  two_factor_enabled TINYINT(1) NOT NULL DEFAULT 0,
  two_factor_method ENUM('email','totp') NOT NULL DEFAULT 'email',
  two_factor_last_code VARCHAR(10) DEFAULT NULL,
  two_factor_expires_at DATETIME DEFAULT NULL,

  -- MÃ©tadonnÃ©es
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_email (email),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parkings
-- ============================================
CREATE TABLE IF NOT EXISTS parkings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  owner_id BIGINT NOT NULL,

  nom VARCHAR(200) NOT NULL,
  adresse VARCHAR(255) NOT NULL,
  ville VARCHAR(100) NOT NULL,

  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,

  nombre_places INT NOT NULL DEFAULT 0,

  -- Tarifs
  tarif_horaire DECIMAL(5, 2) NOT NULL DEFAULT 0.00,
  tarif_journalier DECIMAL(6, 2) NOT NULL DEFAULT 0.00,
  tarif_mensuel DECIMAL(7, 2) NOT NULL DEFAULT 0.00,

  -- Horaires
  horaire_ouverture TIME NOT NULL DEFAULT '00:00:00',
  horaire_fermeture TIME NOT NULL DEFAULT '23:59:59',

  -- Divers
  note DECIMAL(2, 1) NOT NULL DEFAULT 0.0,
  image VARCHAR(255) NULL,

  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,

  INDEX idx_ville (ville),
  INDEX idx_owner (owner_id),
  INDEX idx_location (latitude, longitude)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_services
-- ============================================
CREATE TABLE IF NOT EXISTS parking_services (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  service VARCHAR(100) NOT NULL,

  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_service (parking_id, service),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_type_vehicules
-- ============================================
CREATE TABLE IF NOT EXISTS parking_type_vehicules (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  type_vehicule VARCHAR(50) NOT NULL,

  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_vehicule (parking_id, type_vehicule),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: reservations
-- ============================================
CREATE TABLE IF NOT EXISTS reservations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  parking_id BIGINT NOT NULL,

  date_debut DATETIME NOT NULL,
  date_fin DATETIME NOT NULL,

  vehicule VARCHAR(50) NOT NULL,
  immatriculation VARCHAR(20) NULL,

  montant DECIMAL(8, 2) NOT NULL,

  statut ENUM('confirmÃ©e', 'annulÃ©e', 'terminÃ©e') NOT NULL DEFAULT 'confirmÃ©e',

  date_creation DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  date_annulation DATETIME NULL,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,

  INDEX idx_user (user_id),
  INDEX idx_parking (parking_id),
  INDEX idx_dates (date_debut, date_fin),
  INDEX idx_statut (statut),
  INDEX idx_user_dates (user_id, date_debut, date_fin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
AULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: stationnements
-- ============================================
CREATE TABLE IF NOT EXISTS stationnements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  reservation_id BIGINT NOT NULL,

  date_entree DATETIME NOT NULL,
  date_sortie DATETIME NULL,

  statut ENUM('en_cours', 'termine') NOT NULL DEFAULT 'en_cours',

  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE,
  INDEX idx_reservation (reservation_id),
  INDEX idx_statut (statut)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- DONNÃ‰ES DE TEST
-- ============================================

-- Utilisateurs de test
-- IMPORTANT: Les hash de mots de passe doivent Ãªtre gÃ©nÃ©rÃ©s avec password_hash() en PHP
-- Utiliser le script sql/003_generate_password_hash.php pour gÃ©nÃ©rer les hash
-- 
-- Exemple de hash pour 'password123':
-- $2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi
--
-- Pour crÃ©er les utilisateurs, exÃ©cuter:
-- php sql/003_generate_password_hash.php
-- Puis copier-coller les commandes SQL gÃ©nÃ©rÃ©es
--
-- OU utiliser cette commande SQL (hash pour 'password123'):
INSERT INTO users (email, password_hash, firstname, lastname, role, type_abonnement)
VALUES
('user@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Jean', 'Dupont', 'USER', 'gratuit'),
('owner@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Marie', 'Martin', 'OWNER', 'premium')
ON DUPLICATE KEY UPDATE email=email;

-- Note: Le password_hash correspond Ã  'password123' (bcrypt)
-- Pour gÃ©nÃ©rer un nouveau hash: php -r "echo password_hash('votre_mot_de_passe', PASSWORD_BCRYPT);"
=======
-- ============================================
-- SCHÃ‰MA DE BASE DE DONNÃ‰ES COMPLET
-- ParkingPartagÃ© - SystÃ¨me de rÃ©servation
-- ============================================

CREATE DATABASE IF NOT EXISTS parking_app
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE parking_app;

-- ============================================
-- TABLE: users
-- ============================================
CREATE TABLE IF NOT EXISTS users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  email VARCHAR(160) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  firstname VARCHAR(100) NOT NULL,
  lastname VARCHAR(100) NOT NULL,
  role ENUM('user', 'owner') NOT NULL DEFAULT 'user',
  type_abonnement ENUM('gratuit', 'premium', 'business') NOT NULL DEFAULT 'gratuit',
  debut_abonnement DATE NULL,
  fin_abonnement DATE NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_email (email),
  INDEX idx_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parkings
-- ============================================
CREATE TABLE IF NOT EXISTS parkings (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  owner_id BIGINT NOT NULL,
  nom VARCHAR(200) NOT NULL,
  adresse VARCHAR(255) NOT NULL,
  ville VARCHAR(100) NOT NULL,
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  nombre_places INT NOT NULL DEFAULT 0,
  tarif_horaire DECIMAL(5, 2) NOT NULL DEFAULT 0.00,
  tarif_journalier DECIMAL(6, 2) NOT NULL DEFAULT 0.00,
  tarif_mensuel DECIMAL(7, 2) NOT NULL DEFAULT 0.00,
  horaire_ouverture TIME NOT NULL DEFAULT '00:00:00',
  horaire_fermeture TIME NOT NULL DEFAULT '23:59:59',
  note DECIMAL(2, 1) NOT NULL DEFAULT 0.0,
  image VARCHAR(255) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_ville (ville),
  INDEX idx_owner (owner_id),
  INDEX idx_location (latitude, longitude)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_services
-- ============================================
CREATE TABLE IF NOT EXISTS parking_services (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  service VARCHAR(100) NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_service (parking_id, service),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: parking_type_vehicules
-- ============================================
CREATE TABLE IF NOT EXISTS parking_type_vehicules (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  parking_id BIGINT NOT NULL,
  type_vehicule VARCHAR(50) NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE KEY unique_parking_vehicule (parking_id, type_vehicule),
  INDEX idx_parking (parking_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: reservations
-- ============================================
CREATE TABLE IF NOT EXISTS reservations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  parking_id BIGINT NOT NULL,
  date_debut DATETIME NOT NULL,
  date_fin DATETIME NOT NULL,
  vehicule VARCHAR(50) NOT NULL,
  immatriculation VARCHAR(20) NULL,
  montant DECIMAL(8, 2) NOT NULL,
  statut ENUM('confirmÃ©e', 'annulÃ©e', 'terminÃ©e') NOT NULL DEFAULT 'confirmÃ©e',
  date_creation DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  date_annulation DATETIME NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  INDEX idx_user (user_id),
  INDEX idx_parking (parking_id),
  INDEX idx_dates (date_debut, date_fin),
  INDEX idx_statut (statut),
  -- EmpÃªcher les chevauchements de dates pour le mÃªme utilisateur
  INDEX idx_user_dates (user_id, date_debut, date_fin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- TABLE: stationnements
-- ============================================
CREATE TABLE IF NOT EXISTS stationnements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  reservation_id BIGINT NOT NULL,
  date_entree DATETIME NOT NULL,
  date_sortie DATETIME NULL,
  statut ENUM('en_cours', 'termine') NOT NULL DEFAULT 'en_cours',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE,
  INDEX idx_reservation (reservation_id),
  INDEX idx_statut (statut)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- DONNÃ‰ES DE TEST
-- ============================================

-- Utilisateurs de test
-- IMPORTANT: Les hash de mots de passe doivent Ãªtre gÃ©nÃ©rÃ©s avec password_hash() en PHP
-- Utiliser le script sql/003_generate_password_hash.php pour gÃ©nÃ©rer les hash
-- 
-- Exemple de hash pour 'password123':
-- $2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi
--
-- Pour crÃ©er les utilisateurs, exÃ©cuter:
-- php sql/003_generate_password_hash.php
-- Puis copier-coller les commandes SQL gÃ©nÃ©rÃ©es
--
-- OU utiliser cette commande SQL (hash pour 'password123'):
INSERT INTO users (email, password_hash, firstname, lastname, role, type_abonnement) VALUES
('user@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Jean', 'Dupont', 'user', 'gratuit'),
('owner@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Marie', 'Martin', 'owner', 'premium')
ON DUPLICATE KEY UPDATE email=email;

-- Note: Le password_hash correspond Ã  'password123' (bcrypt)
-- Pour gÃ©nÃ©rer un nouveau hash: php -r "echo password_hash('votre_mot_de_passe', PASSWORD_BCRYPT);"
>>>>>>> origin/Rayane



================================================
FILE: sql/002_insert_parkings.sql
================================================
-- ============================================
-- INSERTION DES PARKINGS DE TEST
-- ============================================

USE parking_app;

-- RÃ©cupÃ©rer l'ID du propriÃ©taire
SET @owner_id = (SELECT id FROM users WHERE email = 'owner@example.com' LIMIT 1);

-- Parkings Paris
INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES
(@owner_id, 'Parking OpÃ©ra Premium', '15 Rue Scribe, 75009 Paris', 'Paris', 48.8706, 2.3319, 150, 3.50, 25.00, 280.00, '00:00:00', '23:59:59', 4.8),
(@owner_id, 'Station ChÃ¢telet', '1 Place du ChÃ¢telet, 75001 Paris', 'Paris', 48.8584, 2.3470, 200, 4.00, 30.00, 320.00, '00:00:00', '23:59:59', 4.9),
(@owner_id, 'Parking Gare du Nord', '18 Rue de Dunkerque, 75010 Paris', 'Paris', 48.8809, 2.3553, 300, 3.00, 22.00, 250.00, '00:00:00', '23:59:59', 4.6),
(@owner_id, 'Park Saint-Lazare', '108 Rue Saint-Lazare, 75008 Paris', 'Paris', 48.8756, 2.3262, 120, 4.50, 35.00, 350.00, '06:00:00', '22:00:00', 4.7),
(@owner_id, 'Parking Bastille Central', '120 Rue de Lyon, 75012 Paris', 'Paris', 48.8522, 2.3697, 180, 3.20, 24.00, 270.00, '00:00:00', '23:59:59', 4.5)
ON DUPLICATE KEY UPDATE nom=nom;

-- Parkings Lyon
INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES
(@owner_id, 'Lyon Part-Dieu Premium', '21 Boulevard Vivier Merle, 69003 Lyon', 'Lyon', 45.7606, 4.8564, 250, 2.80, 20.00, 220.00, '00:00:00', '23:59:59', 4.9),
(@owner_id, 'Station Bellecour', '12 Place Bellecour, 69002 Lyon', 'Lyon', 45.7578, 4.8320, 180, 3.50, 26.00, 280.00, '00:00:00', '23:59:59', 4.7)
ON DUPLICATE KEY UPDATE nom=nom;

-- Parking Marseille
INSERT INTO parkings (owner_id, nom, adresse, ville, latitude, longitude, nombre_places, tarif_horaire, tarif_journalier, tarif_mensuel, horaire_ouverture, horaire_fermeture, note) VALUES
(@owner_id, 'Parking Vieux-Port', '46 Quai du Port, 13002 Marseille', 'Marseille', 43.2965, 5.3698, 220, 3.00, 22.00, 240.00, '00:00:00', '23:59:59', 4.6)
ON DUPLICATE KEY UPDATE nom=nom;

-- Services pour chaque parking
INSERT INTO parking_services (parking_id, service)
SELECT id, 'Couvert' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
UNION ALL SELECT id, 'SÃ©curisÃ©' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
UNION ALL SELECT id, 'VidÃ©o-surveillance' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
UNION ALL SELECT id, 'Bornes Ã©lectriques' FROM parkings WHERE nom = 'Parking OpÃ©ra Premium'
ON DUPLICATE KEY UPDATE service=service;

-- Type de vÃ©hicules
INSERT INTO parking_type_vehicules (parking_id, type_vehicule)
SELECT id, 'Voiture' FROM parkings WHERE ville = 'Paris'
UNION ALL SELECT id, 'Moto' FROM parkings WHERE ville = 'Paris'
ON DUPLICATE KEY UPDATE type_vehicule=type_vehicule;








================================================
FILE: sql/003_generate_password_hash.php
================================================
<?php
/**
 * Script pour gÃ©nÃ©rer les hash de mots de passe
 * 
 * Usage: php sql/003_generate_password_hash.php
 * 
 * Ce script gÃ©nÃ¨re les hash bcrypt pour les mots de passe de test
 * et affiche les commandes SQL Ã  exÃ©cuter.
 */

$password = 'password123';

echo "=== GÃ©nÃ©ration des hash de mots de passe ===\n\n";

$hash = password_hash($password, PASSWORD_BCRYPT);

echo "Mot de passe: {$password}\n";
echo "Hash gÃ©nÃ©rÃ©: {$hash}\n\n";

echo "=== Commandes SQL Ã  exÃ©cuter ===\n\n";

echo "-- Mettre Ã  jour les utilisateurs existants\n";
echo "UPDATE users SET password_hash = '{$hash}' WHERE email = 'user@example.com';\n";
echo "UPDATE users SET password_hash = '{$hash}' WHERE email = 'owner@example.com';\n\n";

echo "-- Ou insÃ©rer de nouveaux utilisateurs\n";
echo "INSERT INTO users (email, password_hash, firstname, lastname, role, type_abonnement) VALUES\n";
echo "('user@example.com', '{$hash}', 'Jean', 'Dupont', 'user', 'gratuit'),\n";
echo "('owner@example.com', '{$hash}', 'Marie', 'Martin', 'owner', 'premium')\n";
echo "ON DUPLICATE KEY UPDATE password_hash = VALUES(password_hash);\n\n";

echo "=== VÃ©rification ===\n\n";
echo "Pour vÃ©rifier que le hash fonctionne:\n";
echo "php -r \"var_dump(password_verify('password123', '{$hash}'));\"\n";
echo "Devrait afficher: bool(true)\n";








================================================
FILE: sql/004_add_api_token.sql
================================================
ALTER TABLE users ADD COLUMN api_token VARCHAR(64) NULL AFTER role;
ALTER TABLE users ADD INDEX idx_api_token (api_token);



================================================
FILE: sql/sqlite_init.sql
================================================
-- SQLite Schema

CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  firstname TEXT NOT NULL,
  lastname TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'user',
  api_token TEXT NULL,
  type_abonnement TEXT NOT NULL DEFAULT 'gratuit',
  debut_abonnement DATE NULL,
  fin_abonnement DATE NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS parkings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  owner_id INTEGER NOT NULL,
  nom TEXT NOT NULL,
  adresse TEXT NOT NULL,
  ville TEXT NOT NULL,
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  nombre_places INTEGER NOT NULL DEFAULT 0,
  tarif_horaire DECIMAL(5, 2) NOT NULL DEFAULT 0.00,
  tarif_journalier DECIMAL(6, 2) NOT NULL DEFAULT 0.00,
  tarif_mensuel DECIMAL(7, 2) NOT NULL DEFAULT 0.00,
  horaire_ouverture TIME NOT NULL DEFAULT '00:00:00',
  horaire_fermeture TIME NOT NULL DEFAULT '23:59:59',
  note DECIMAL(2, 1) NOT NULL DEFAULT 0.0,
  image TEXT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS parking_services (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  parking_id INTEGER NOT NULL,
  service TEXT NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE(parking_id, service)
);

CREATE TABLE IF NOT EXISTS parking_type_vehicules (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  parking_id INTEGER NOT NULL,
  type_vehicule TEXT NOT NULL,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE,
  UNIQUE(parking_id, type_vehicule)
);

CREATE TABLE IF NOT EXISTS reservations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  parking_id INTEGER NOT NULL,
  date_debut DATETIME NOT NULL,
  date_fin DATETIME NOT NULL,
  vehicule TEXT NOT NULL,
  immatriculation TEXT NULL,
  montant DECIMAL(8, 2) NOT NULL,
  statut TEXT NOT NULL DEFAULT 'confirmÃ©e',
  date_creation DATETIME DEFAULT CURRENT_TIMESTAMP,
  date_annulation DATETIME NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (parking_id) REFERENCES parkings(id) ON DELETE CASCADE
);

-- Index
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_token ON users(api_token);
CREATE INDEX idx_parkings_ville ON parkings(ville);


